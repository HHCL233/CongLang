/*! For license information please see crc_stage_heart.597c18ca.js.LICENSE.txt */
"use strict";(self.webpackChunkneko=self.webpackChunkneko||[]).push([[9415],{9425:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(61211),o=i(43180),a=(i(76715),i(84877)),s=i(71962),_=function(){function t(t,e,i){this.registry=t,this.event_bus=e,this.u=i,this.states=[]}return t.prototype.clear=function(){this.states=[]},t.prototype.perform_automatic_state_transitions=function(){for(var t=0;t<this.states.length;t++){var e=this.states[t];if("one_frame"!==e.spec.statefulness.automatic_transitions){var i=e.spec.statefulness.automatic_transitions[e.value];void 0!=i&&(e.value=i)}else e.value=""}},t.prototype.update=function(t){this.perform_automatic_state_transitions();for(var e=0;e<t.length;e++){var i=t[e];if(void 0!=i.value){var o=a.namespaced_id(i.namespace,i.id),s=this.registry.get_action_type(o);if(void 0!=s){if(void 0!=s.statefulness){var _={sub_type:i.sub_type,entity_id:i.entity_id},c={id:o},u=n(this.states,r.__assign(r.__assign({},_),{spec:c}));void 0!=u?u.value=i.value:this.states.push({namespace:i.namespace,entity_id:i.entity_id,sub_type:i.sub_type,value:i.value,spec:s})}}else this.event_bus.error.runtime.send({error:this.u.ohno.system.action_received_without_spec({action:i})})}}},t.prototype.get_action_state_value=function(t){var e={namespace:t.action_namespace},i={id:t.action_id};void 0!=t.entity_id&&(e.entity_id=t.entity_id),void 0!=t.sub_type&&(e.sub_type=t.sub_type);var o=n(this.states,r.__assign(r.__assign({},e),{spec:i}));if(void 0!=o)return o.value;var s=a.namespaced_id(t.action_namespace,t.action_id),_=this.registry.get_action_type(s);if(void 0==_)throw this.u.ohno.system.state_query_received_without_spec({query_params:t});if(void 0==_.statefulness)throw this.u.ohno.system.state_query_for_non_stateful_action({query_params:t});return _.statefulness.default_value},t=r.__decorate([o.injectable(),r.__param(0,o.inject(s.BINDING.Registry)),r.__param(1,o.inject(s.BINDING.EventBus)),r.__param(2,o.inject(s.BINDING.Util)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}();e.ActionStateStoreImpl=_},90352:function(t,e){function i(t,e,i){return t*e%i}function r(t,e){if(t===e)return!0;for(var r=0,n=t-1;!(1&n);r++)n>>=1;for(var o=1,a=e%t,s=n;s;s>>>=1)1&s&&(o=i(o,a,t)),a=i(a,a,t);if(1===o||o===t-1)return!0;for(;r-- >1;){if(1===(o=i(o,o,t)))return!1;if(o===t-1)return!0}return!1}Object.defineProperty(e,"__esModule",{value:!0}),e.is_prime=function(t){return t>1&&t===Math.round(t)&&!(t>73&&!(t%2&&t%3&&t%5&&t%7&&t%11&&t%13&&t%17&&t%19&&t%23&&t%29&&t%31&&t%37&&t%41&&t%43&&t%47&&t%53&&t%59&&t%61&&t%67&&t%71&&t%73))&&r(t,2)&&r(t,7)&&r(t,61)}},34409:function(t,e){function i(t){var e=t.params.TEXT;if(e)return e}function r(t,e){var i=!1,n=!1,o=!1;if(void 0==t)return{all_branches_return:i,has_filled_return_block:n,has_empty_return_block:o};if(e.is.controls_if_no_else(t)){var a=t.child_block[0];if(void 0!==a)n=(u=r(a,e)).has_filled_return_block,o=u.has_empty_return_block}if(e.is.controls_if(t)||e.is.controls_if_dropdown(t)){for(var s=(e.is.controls_if(t)?t.conditions.length:t.if_dropdown_conditions.length)+1,_=0,c=0;c<s;c++){var u=r(t.child_block[c],e);n=n||u.has_filled_return_block,o=o||u.has_empty_return_block,u.all_branches_return&&_++}i=i||_===s}if(e.is.procedures_return_value(t)){i=!0;var p=t.params.VALUE;n=void 0!=p,o=void 0==p}if(e.is.loop_block(t)&&void 0!==t.child_block[0]){u=r(t.child_block[0],e);i=i||u.all_branches_return,n=n||u.has_filled_return_block,o=o||u.has_empty_return_block}var d=t.next_block;if(void 0!==d){u=r(d,e);i=i||u.all_branches_return,n=n||u.has_filled_return_block,o=o||u.has_empty_return_block}return{all_branches_return:i,has_filled_return_block:n,has_empty_return_block:o}}Object.defineProperty(e,"__esModule",{value:!0}),e.get_block_linters=function(t){return[function(e,i,n,o){for(var a=[],s=0;s<e.length;s++){var _=e[s];for(var c in _.procedures){var u=_.procedures[c],p=u.child_block[0];if(void 0!=u&&void 0!=p){var d=r(p,i),l=d.has_filled_return_block&&!d.all_branches_return,h=d.has_filled_return_block&&d.has_empty_return_block;(l||h)&&a.push(t.user.procedure_not_return_all_branches({block_id:u.id,entity_id:_.id}))}}}return a},function(e,i,r,n){for(var o=[],a=function(r){var n=e[r],a=function(e){var r=n.procedures[e];if(void 0==r)return"continue";var a=r.child_block[0];if(void 0==a)return"continue";var s=r.params;i.ast_for_each(a,(function(e){if(i.is.procedures_parameter(e)){var r=e.params.param_name;void 0==s[r]&&(a=e.id,_=n.id,o.push(t.user.procedure_no_such_parameter({block_id:a,entity_id:_})))}var a,_}))};for(var s in n.procedures)a(s);for(var _ in n.compiled_block_map){var c=n.compiled_block_map[_];i.ast_for_each(c,(function(e){var r,a;i.is.procedures_parameter(e)&&(r=e.id,a=n.id,o.push(t.user.procedure_parameter_outside({block_id:r,entity_id:a})))}))}},s=0;s<e.length;s++)a(s);return o},function(e,r,n,o){for(var a=[],s=new Set,_=new Set,c=0,u=e;c<u.length;c++){var p=u[c];for(var d in p.compiled_block_map){var l=p.compiled_block_map[d];if("self_listen"==l.type||"self_listen_with_param"==l.type){var h=l.params.message;if(r.is.compiled_block(h)){var f=i(h);f&&_.add(f)}}r.ast_for_each(l,(function(t){t.parent_block&&("self_broadcast"==t.parent_block.type||"self_broadcast_with_param"==t.parent_block.type)&&s.add(t)}))}}return s.forEach((function(e){var r=i(e);if(void 0!=r&&!_.has(r)){var n=[];_.forEach((function(t){var e=function(t,e){if(0===t.length)return e.length;if(0===e.length)return t.length;for(var i=[],r=0;r<=e.length;r++)i[r]=[r];for(var n=0;n<=t.length;n++)i[0][n]=n;for(r=1;r<=e.length;r++)for(n=1;n<=t.length;n++)e.charAt(r-1)==t.charAt(n-1)?i[r][n]=i[r-1][n-1]:i[r][n]=Math.min(i[r-1][n-1]+1,Math.min(i[r][n-1]+1,i[r-1][n]+1));return i[e.length][t.length]}(r,t);n.push({id:t,distance:e})})),a.push(t.warning.broadcast_with_no_listener({block_id:e.id,similar_indentities:n}))}})),a}]}},23094:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DEFAULT_DAY_NAMES={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"}},70542:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(27711),n=i(58121),o=i(18111),a=i(82066),s=i(14064),_=i(42582),c=i(763),u=i(90352);e.get_domain_functions=function(t,e,i,p,d,l){var h={year:function(){return(new Date).getFullYear()},month:function(){return(new Date).getMonth()+1},date:function(){return(new Date).getDate()},week:function(){return d[(new Date).getDay()]},hour:function(){return(new Date).getHours()},minute:function(){return(new Date).getMinutes()},second:function(){return(new Date).getSeconds()}},f={EQ:function(t){return o(t.A,t.B)},NEQ:function(t){return!o(t.A,t.B)},LT:function(t){return t.A<t.B},LTE:function(t){return t.A<=t.B},GT:function(t){return t.A>t.B},GTE:function(t){return t.A>=t.B},AND:function(t){return t.A&&t.B},OR:function(t){return t.A||t.B},TRUE:!0,FALSE:!1};function g(t,e){var i=Math.pow(10,e);return Math.round(t*i)/i}var y={ROUND:function(t){return Math.floor(t.NUM+.5)},ROUNDUP:function(t){return Math.ceil(t.NUM)},ROUNDDOWN:function(t){return Math.floor(t.NUM)},EVEN:function(t){return t.NUMBER_TO_CHECK%2===0},ODD:function(t){return 1===Math.abs(t.NUMBER_TO_CHECK%2)},PRIME:function(t){return u.is_prime(t.NUMBER_TO_CHECK)},WHOLE:function(t){return t.NUMBER_TO_CHECK===Math.floor(t.NUMBER_TO_CHECK)},POSITIVE:function(t){return t.NUMBER_TO_CHECK>0},NEGATIVE:function(t){return t.NUMBER_TO_CHECK<0},DIVISIBLE_BY:function(t){return t.NUMBER_TO_CHECK%t.DIVISOR===0},SIN:function(t){return g(Math.sin(t.NUM*Math.PI/180),2)},ASIN:function(t){return g(Math.asin(t.NUM)/Math.PI*180,2)},COS:function(t){return g(Math.cos(t.NUM*Math.PI/180),2)},ACOS:function(t){return g(Math.acos(t.NUM)/Math.PI*180,2)},TAN:function(t){return g(Math.tan(t.NUM*Math.PI/180),2)},ATAN:function(t){return g(Math.atan(t.NUM)/Math.PI*180,2)},ROOT:function(t){return Math.pow(t.NUM,.5)},ABS:function(t){return Math.abs(t.NUM)},NEG:function(t){return-t.NUM},LN:function(t){return Math.log(t.NUM)},LOG10:function(t){return Math.log(t.NUM)/Math.log(10)},EXP:function(t){return Math.pow(Math.E,t.NUM)},POW10:function(t){return Math.pow(10,t.NUM)},ADD:function(t){return t.A+t.B},MINUS:function(t){return t.A-t.B},MULTIPLY:function(t){return t.A*t.B},DIVIDE:function(t){return t.A/t.B},POWER:function(t){return Math.pow(t.A,t.B)}};function m(i,r,n){var o=t.get_list_id(n,r);o&&(t.is_entity_variable(o)?e.report_entity_list_updated(o,n,r):e.report_list_updated(o,n))}var v={text_indexOf:function(t,e,i,r){return"FIRST"===t.END?t.VALUE.indexOf(t.FIND)+1:"LAST"===t.END?t.VALUE.lastIndexOf(t.FIND)+1:void 0},text_append:function(t,e,i,r){r.runtime_manager.set_variable(t.VAR,r.runtime_manager.get_variable(t.VAR,e,i)+t.TEXT,e,i)},text_implicit:function(t,e,i,r){var n=t.TEXT;return""===n?"":n==Number(n)?Number(n):n},text_join:function(t,e,i,r){for(var n="",o=0;;){var a=t["ADD"+o];if(void 0===a)break;n+=""+a,o++}return n},text_length:function(t,e,i,r){return isNaN(t.VALUE)?t.VALUE.length:t.VALUE.toString().length},text_select:function(t,e,i,r){var n=isNaN(t.string)?t.string:t.string.toString(),o=t.char_start_index,a=t.char_end_index-1;return o<=a?n.substring(o-1,a+1):n.substring(a,o).split("").reverse().join("")},text_contain:function(t,e,i,r){var n=String(t.TEXT1),o=String(t.TEXT2);return-1!==n.indexOf(o)},logic_operation:function(t,e,i,r){return f[t.OP](t)},logic_negate:function(t,e,i,r){return!t.BOOL},logic_boolean:function(t,e,i,r){return f[t.BOOL]},logic_compare:function(t,e,i,r){return f[t.OP](t)},math_arithmetic:function(t,e,i,r){return y[t.OP](t)},math_number_property:function(t,e,i,r){return y[t.PROPERTY](t)},divisible_by:function(t,e,i,r){return y.DIVISIBLE_BY(t)},math_modulo:function(t,e,i,r){return t.DIVIDEND%t.DIVISOR},math_trig:function(t,e,i,r){return y[t.OP](t)},math_single:function(t,e,i,r){return y[t.OP](t)},math_round:function(t,e,i,r){return y[t.OP](t)},start_on_click:function(){},start_on_click_2:function(){},get_time:function(t,e,i,r){return h[t.op](t)},get_cur_frames:function(t,e,i,r){return r.runtime_manager.get_elapsed_frames()},variables_get:function(t,e,i,r){return r.runtime_manager.get_variable(t.VAR,e,i)},variables_set:function(t,e,i,r){r.runtime_manager.set_variable(t.VAR,t.VALUE,e,i)},days_after_2000:function(){var t=((new Date).valueOf()-new Date("2000-01-01").valueOf())/864e5;return Math.floor(t)},self_broadcast:function(t,e,i,r){var n=t.message;r.runtime_manager.broadcaster_sending_message(e,n,!1)},self_broadcast_and_wait:function(t,e,i,r){var n=t.message;r.runtime_manager.broadcaster_sending_message(e,n,!0)},self_listen:function(t,i,r,n){var o=e.get_action_state_value({action_id:"broadcast",action_namespace:"",sub_type:t.message});return""!==o&&n.runtime_manager.broadcast_responder_bind_broadcaster(i,t.message),""!==o},when:function(t){return t.condition},wait:function(t,e,i,r){var n,o=l.get().nan_to_zero_conversion_blocks,a=t.time;(null===(n=o)||void 0===n?void 0:n.includes("wait"))&&(a="string"===typeof t.time||isNaN(t.time)?0:t.time),r.runtime_manager.thread_wait(i,e,1e3*a)},change_variable:function(t,e,i,r){var n=t.valname,o=t.method||"increase",a=t.n,s=r.runtime_manager.get_variable(n,e,i);"object"!==typeof s&&("increase"===o?r.runtime_manager.set_variable(n,s+a,e,i):r.runtime_manager.set_variable(n,s-a,e,i))},random:function(t,e,i,r){var n=t.a,o=t.b,a=r.runtime_manager.get_random_number();return Math.floor(n+a*(o-n+1))},reset_timer:function(t,e,i,r){r.runtime_manager.reset_timer()},destruct:function(t,e,i,r){r.runtime_manager.destruct_entity(i)},get_timer:function(t,e,i,r){return r.runtime_manager.get_timer_elapsed_s()},terminate:function(t,e,i,r){r.runtime_manager.disable_interpreter_restarts_automatically(),r.runtime_manager.dispose_all()},restart:function(t,e,i,r){r.runtime_manager.restart()},stop:function(t,e,i,r){var n=parseInt(t.scope);0===n?r.runtime_manager.dispose_all():1===n?r.runtime_manager.dispose_block_group(e):2===n?r.runtime_manager.dispose_other_block_groups_of_entity(i,e):3===n&&r.runtime_manager.dispose_block_groups_of_other_entities(i)},lists_get:function(t,e,i,r){return r.runtime_manager.lists_get(t.VAR,e,i)},lists_append:function(t,e,i,r){var n=t.VAR;n.push(t.VALUE),m(0,i,n)},lists_delete:function(t,e,i,r){var n=t.INDEX,o=t.VAR;0!==n&&("last"===t.TYPE?o.pop():(n=n>0?n-1:n,o.splice(n,1)),m(0,i,o))},lists_insert_value:function(t,e,i,r){var n=t.INDEX,o=t.VAR;0!==n&&(-1===n?o.push(t.VALUE):(n=n>0?n-1:n+1,o.splice(n,0,t.VALUE)),m(0,i,o))},lists_replace:function(t,e,i,r){var n=t.INDEX,o=t.VAR;0!==n&&("last"===t.TYPE&&(n=o.length),n=n>0?n-1:n,o.splice(n,1,t.VALUE),m(0,i,o))},lists_get_value:function(t,e,i,r){var n=t.INDEX,o=t.VAR;if("last"===t.TYPE&&(n=o.length),0!==n){var a=o[n=n>0?n-1:o.length+n];if(void 0==a&&0==l.get().legacy.lists_get_value_allow_return_undefined)throw p.user.lists_get_value_bad_index({list:o,index:n>0?n:-1,args:t});return a}if(0==l.get().legacy.lists_get_value_allow_return_undefined)throw p.user.lists_get_value_bad_index({list:o,index:-1,args:t})},lists_is_exist:function(t,e,i,r){var n=t.VALUE.toString(),o=t.VAR;return s(o,(function(e){return e==t.VALUE||e==n}))},lists_index_of:function(t,e,i,r){var n=t.VALUE,o=t.VAR.indexOf(n);return"number"===typeof o?o+1:0},lists_length:function(t,e,i,r){return t.VAR.length},calculate:function(t,e,i,n){try{return r.lex(t.input).toPostfix().postfixEval()}catch(o){throw p.user.block_bad_math_expression({block_args:t})}},lists_copy:function(t,e,i,r){var o=n(t.VALUE),a=t.TARGET;a.length=0,o=o||[];for(var s=0;s<o.length;s++){var _=o[s];a.push(_)}m(0,i,a)},text_split:function(t,e,i,r){var n=t.TEXT_TO_SPLIT;return"number"===typeof n&&(n=n.toString()),(n.split(t.SPLIT_TEXT)||[]).map((function(t){var e=t.indexOf(" ")<0&&""!==t?_(t):t;return a(e)?t:e}))},multiline_text:function(t,e,i,r){return t.TEXT},default_value:function(t,e,i,r){var n=t.TEXT,o=Number(n);return a(o)?n:o},traverse_number_param:function(){return"INIT"},traverse_number_value:function(t,r,n,o,a,s){var _=t.owner_id?e.get_arbitrary_data(t.owner_id):void 0;return c.isNil(_)&&i.warning.runtime.send({error:p.warning.disabled_param(new Error,{block_id:a,source_entity_id:n,block_type:"traverse_number_value",current_frame:s})}),_}};return function(){return v}}},34751:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(84877);e.get_action_specs=function(){return[{id:"broadcast",entity_specific:!1,responder_blocks:[],statefulness:{default_value:"",automatic_transitions:"one_frame",use_sub_type:!0}},{id:"running_group_activated",entity_specific:!1,responder_blocks:[{id:"on_running_group_activated",type:r.ResponderType.Action,async:!1}]}]}},54895:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=(i(76715),i(71962)),a=i(34409),s=i(70542),_=i(34751),c=function(){function t(t,e,i,r,n,o,a){this.registry=t,this.config=e,this.day_names=i,this.event_bus=r,this.ohno=n,this.runtime_data=o,this.runtime_manager=a,this.namespace=""}return t.prototype.get_runtime_provider=function(){var t=this;return{namespace:function(){return t.namespace},domain_functions:s.get_domain_functions(this.runtime_manager,this.runtime_data,this.event_bus,this.ohno,this.day_names,this.config),action_types:_.get_action_specs,block_metadata:{restart_when_finished:["self_listen","self_listen_with_param","when"],finish_out_of_run_group:["on_running_group_activated"]}}},t.prototype.load_domain_functions=function(){var t=this.get_runtime_provider(),e=this.registry,i=t.namespace(),r=t.domain_functions();for(var n in r){var o=r[n];e.register({namespace:i,id:n,domain_function:o})}for(var a=t.action_types(),s=0;s<a.length;s++){var _=a[s],c={namespace:i,id:_.id};void 0!=_.statefulness&&(c.statefulness=_.statefulness),e.register_action_type(c);for(var u=0;u<_.responder_blocks.length;u++){var p=_.responder_blocks[u];e.register({namespace:i,id:p.id,respond:{to_action:{namespace:i,id:_.id},type:p.type,async:p.async,priority:p.priority,entity_specific:_.entity_specific,trigger_function:p.trigger_function,filter_arg_names:p.filter_arg_names}})}}if(void 0!==t.block_metadata){if(void 0!=t.block_metadata.restart_when_finished)for(s=0;s<t.block_metadata.restart_when_finished.length;s++){var d=t.block_metadata.restart_when_finished[s];e.register({namespace:i,id:d,metadata:{restart_when_finished:!0}})}if(void 0!=t.block_metadata.finish_out_of_run_group)for(s=0;s<t.block_metadata.finish_out_of_run_group.length;s++){d=t.block_metadata.finish_out_of_run_group[s];e.register({namespace:i,id:d,metadata:{finish_out_of_run_group:!0}})}}},t.prototype.load_linters=function(){for(var t=this.registry,e=a.get_block_linters(this.ohno),i=0;i<e.length;i++){var r=e[i];t.register_linter(r)}},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Registry)),r.__param(1,n.inject(o.BINDING.Config)),r.__param(2,n.inject(o.BINDING.DayNames)),r.__param(3,n.inject(o.BINDING.EventBus)),r.__param(4,n.inject(o.BINDING.Ohno)),r.__param(5,n.inject(o.BINDING.RuntimeData)),r.__param(6,n.inject(o.BINDING.RuntimeManagerFacade)),r.__metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object])],t)}();e.BasicBlockProviderFactoryImpl=c},88073:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Unknown=0]="Unknown",t[t.Known=1]="Known",t[t.Destructing=2]="Destructing",t[t.Disposed=3]="Disposed"}(e.EntityState||(e.EntityState={})),function(t){t[t.global=0]="global",t[t.entity=1]="entity"}(e.VariableScope||(e.VariableScope={})),function(t){t[t.yielding=0]="yielding",t[t.finished=1]="finished"}(e.StepResult||(e.StepResult={}))},19406:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(68787),o=i(43180),a=i(71962),s=(i(76715),function(){function t(t,e,i){this.u=t,this.config=e,this.block=i,this.pool=[];for(var r=e.get().block_pool_preallocation_size,n=[],o=0;o<r;o++)n.push(this.create());for(o=0;o<r;o++)this.release(n.pop())}return t.prototype.create=function(){return{params:{},kind:"",type:"",id:"",parent_block:void 0,next_block:void 0,child_block:[],first_evaluation:!0,done_evaluating:!1,output_type:"",last_call:void 0,waiting_for_procedure:void 0,disabled:!1,conditions:[],if_dropdown_conditions:[],procedure_name:"",procedure_return_value:void 0,times_left:0}},t.prototype.release_block_param=function(t){void 0!=t&&this.u.block.is.compiled_block(t)&&this.release(t)},t.prototype.reset=function(t){this.release_block_param(t.next_block);for(var e=0;e<t.child_block.length;e++)this.release_block_param(t.child_block[e]);for(e=0;e<t.conditions.length;e++)this.release_block_param(t.conditions[e]);for(var i in t.params)this.release_block_param(t.params[i]);t.params={},t.kind="",t.type="",t.id="",t.parent_block=void 0,t.next_block=void 0,t.child_block=[],t.first_evaluation=!0,t.done_evaluating=!1,t.output_type="",t.last_call=void 0,t.waiting_for_procedure=void 0,t.disabled=!1,t.conditions=[],t.if_dropdown_conditions=[],t.procedure_name="",t.procedure_return_value=void 0,t.times_left=0},t.prototype.clone=function(t,e){var i=this.get();for(var r in t.params){var o=t.params[r];void 0===o?i.params[r]=void 0:this.u.block.is.compiled_block(o)?i.params[r]=this.clone(o,i):i.params[r]=n(o)}i.kind=t.kind,i.type=t.type,i.id=t.id,i.parent_block=e,void 0!=t.next_block&&(i.next_block=this.clone(t.next_block,e)),i.child_block=[];for(var a=0;a<t.child_block.length;a++){var s=t.child_block[a];void 0==s?i.child_block.push(void 0):i.child_block.push(this.clone(s,i))}if(i.first_evaluation=t.first_evaluation,i.done_evaluating=t.done_evaluating,i.output_type=t.output_type,i.last_call=t.last_call,i.waiting_for_procedure=t.waiting_for_procedure,i.disabled=t.disabled,this.block.is.cond_block(t))for(a=0;a<t.conditions.length;a++){var _=t.conditions[a];void 0==_?i.conditions.push(void 0):i.conditions.push(this.clone(_,i))}return this.block.is.controls_if_dropdown(t)&&(i.if_dropdown_conditions=t.if_dropdown_conditions.slice()),(this.block.is.procedures_defnoreturn(t)||this.block.is.procedures_callreturn(t)||this.block.is.procedures_callnoreturn(t))&&(i.procedure_name=t.procedure_name),this.block.is.procedures_callreturn(t)&&(i.procedure_return_value=t.procedure_return_value),this.block.is.repeat_n_times(t)&&(i.times_left=t.times_left),i},t.prototype.get=function(){var t=this.pool.pop();return void 0==t?this.create():t},t.prototype.release=function(t){this.reset(t),this.pool.push(t)},t=r.__decorate([o.injectable(),r.__param(0,o.inject(a.BINDING.Util)),r.__param(1,o.inject(a.BINDING.Config)),r.__param(2,o.inject(a.BINDING.BlockUtil)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}());e.BlockPoolImpl=s},83064:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=i(71962),a=i(79224),s={domain_block:!0},_=function(){function t(t,e,i){this.registry=t,this.ohno=e,this.log=i}return t.prototype.hat_block_type=function(t){return a.HAT_BLOCKS[t]||a.EVENT_BLOCKS[t]||this.responder_type(t)||this.lifetime_responder_type(t)||this.registry.block_restart_when_finished(t)},t.prototype.responder_block=function(t){return this.registry.has_responder_type(t.type)},t.prototype.responder_type=function(t){return this.registry.has_responder_type(t)},t.prototype.lifetime_responder_type=function(t){return this.registry.has_lifetime_responder_type(t)},t.prototype.if_dropdown_type=function(t){return this.registry.has_if_dropdown_type(t)},t.prototype.atomic_type=function(t){return void 0!==a.ATOMIC_BLOCKS[t]},t.prototype.special_block=function(t){return a.SPECIAL_BLOCKS[t.kind]},t.prototype.domain_block=function(t){return s[t.kind]},t.prototype.loop_block=function(t){return a.LOOP_BLOCKS[t.kind]},t.prototype.cond_block=function(t){return a.IF_BLOCKS[t.kind]||this.if_dropdown_type(t.type)},t.prototype.proc_block=function(t){return a.PROCEDURE_BLOCKS[t.kind]},t.prototype.event_block=function(t){return a.EVENT_BLOCKS[t.type]||this.registry.block_restart_when_finished(t.type)},t.prototype.when=function(t){return a.EVENT_BLOCKS.when==a.EVENT_BLOCKS[t.type]},t.prototype.controls_if=function(t){return a.IF_BLOCKS.controls_if==a.IF_BLOCKS[t.type]},t.prototype.controls_if_no_else=function(t){return a.IF_BLOCKS.controls_if_no_else==a.IF_BLOCKS[t.type]},t.prototype.controls_if_dropdown=function(t){return a.IF_BLOCKS.controls_if_dropdown==a.IF_BLOCKS[t.type]||this.if_dropdown_type(t.type)},t.prototype.repeat_n_times=function(t){return a.LOOP_BLOCKS.repeat_n_times==a.LOOP_BLOCKS[t.type]},t.prototype.traverse_number=function(t){return a.LOOP_BLOCKS.traverse_number==a.LOOP_BLOCKS[t.type]},t.prototype.traverse_number_value=function(t){return a.LOOP_BLOCKS.traverse_number_value==a.LOOP_BLOCKS[t.type]},t.prototype.repeat_forever=function(t){return a.LOOP_BLOCKS.repeat_forever==a.LOOP_BLOCKS[t.type]},t.prototype.repeat_forever_until=function(t){return a.LOOP_BLOCKS.repeat_forever_until==a.LOOP_BLOCKS[t.type]},t.prototype.wait_until=function(t){return a.LOOP_BLOCKS.wait_until==a.LOOP_BLOCKS[t.type]},t.prototype.break=function(t){return a.LOOP_BLOCKS.break==a.LOOP_BLOCKS[t.type]},t.prototype.procedures_defnoreturn=function(t){return a.PROCEDURE_BLOCKS.procedures_defnoreturn==a.PROCEDURE_BLOCKS[t.type]||a.PROCEDURE_BLOCKS.procedures_2_defnoreturn==a.PROCEDURE_BLOCKS[t.type]},t.prototype.procedures_callreturn=function(t){return a.PROCEDURE_BLOCKS.procedures_callreturn==a.PROCEDURE_BLOCKS[t.type]||a.PROCEDURE_BLOCKS.procedures_2_callreturn==a.PROCEDURE_BLOCKS[t.type]},t.prototype.procedures_callnoreturn=function(t){return a.PROCEDURE_BLOCKS.procedures_callnoreturn==a.PROCEDURE_BLOCKS[t.type]||a.PROCEDURE_BLOCKS.procedures_2_callnoreturn==a.PROCEDURE_BLOCKS[t.type]},t.prototype.procedures_return_value=function(t){return a.PROCEDURE_BLOCKS.procedures_return_value==a.PROCEDURE_BLOCKS[t.type]||a.PROCEDURE_BLOCKS.procedures_2_return_value==a.PROCEDURE_BLOCKS[t.type]},t.prototype.procedures_parameter=function(t){return a.PROCEDURE_BLOCKS.procedures_parameter==a.PROCEDURE_BLOCKS[t.type]||a.PROCEDURE_BLOCKS.procedures_2_parameter==a.PROCEDURE_BLOCKS[t.type]},t.prototype.async_tell=function(t){return a.SPECIAL_BLOCKS.tell==a.SPECIAL_BLOCKS[t.type]},t.prototype.sync_tell=function(t){return a.SPECIAL_BLOCKS.sync_tell==a.SPECIAL_BLOCKS[t.type]},t.prototype.warp=function(t){return a.SPECIAL_BLOCKS.warp==a.SPECIAL_BLOCKS[t.type]},t.prototype.mirror=function(t){return a.EVENT_BLOCKS[t.type]==a.EVENT_BLOCKS.start_as_a_mirror},t.prototype.start_on_click=function(t){return a.HAT_BLOCKS[t.type]===a.HAT_BLOCKS.start_on_click||a.HAT_BLOCKS[t.type]===a.HAT_BLOCKS.start_on_click_2},t.prototype.logic_empty=function(t){return a.SPECIAL_BLOCKS.logic_empty==a.SPECIAL_BLOCKS[t.type]},t.prototype.compiled_block=function(t){return void 0!==t&&void 0!=t.id},t.prototype.atomic=function(t){return void 0!==t&&!this.compiled_block(t)},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Registry)),r.__param(1,n.inject(o.BINDING.Ohno)),r.__param(2,n.inject(o.BINDING.Log)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}();e.BlockPredicatesImpl=_},84877:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(40806);!function(t){t.Action="action",t.State="state",t.Dynamic="dynamic"}(e.ResponderType||(e.ResponderType={})),e.parse_namespaced_id=function(t){if(!r(t,"__"))return{namespace:"",function_id:t};var e=t.indexOf("__");return{namespace:t.substring(0,e),function_id:t.substring(e+2)}},e.namespaced_id=function(t,e){return""==t?e:t+"__"+e}},79224:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.repeat_forever=1]="repeat_forever",t[t.repeat_n_times=2]="repeat_n_times",t[t.repeat_forever_until=3]="repeat_forever_until",t[t.wait_until=4]="wait_until",t[t.break=5]="break",t[t.traverse_number=6]="traverse_number",t[t.traverse_number_value=7]="traverse_number_value"}(e.LOOP_BLOCKS||(e.LOOP_BLOCKS={})),function(t){t[t.controls_if=1]="controls_if",t[t.controls_if_no_else=2]="controls_if_no_else",t[t.controls_if_dropdown=3]="controls_if_dropdown"}(e.IF_BLOCKS||(e.IF_BLOCKS={})),function(t){t[t.self_listen=1]="self_listen",t[t.start_as_a_mirror=2]="start_as_a_mirror",t[t.player_position_on_change=3]="player_position_on_change",t[t.mouse_on_emit=4]="mouse_on_emit",t[t.block_on_break=5]="block_on_break",t[t.when=6]="when",t[t.self_listen_with_param=7]="self_listen_with_param"}(e.EVENT_BLOCKS||(e.EVENT_BLOCKS={})),function(t){t[t.procedures_defnoreturn=1]="procedures_defnoreturn",t[t.procedures_callnoreturn=2]="procedures_callnoreturn",t[t.procedures_callreturn=3]="procedures_callreturn",t[t.procedures_return_value=4]="procedures_return_value",t[t.procedures_parameter=5]="procedures_parameter",t[t.procedures_2_defnoreturn=6]="procedures_2_defnoreturn",t[t.procedures_2_callnoreturn=7]="procedures_2_callnoreturn",t[t.procedures_2_callreturn=8]="procedures_2_callreturn",t[t.procedures_2_return_value=9]="procedures_2_return_value",t[t.procedures_2_parameter=10]="procedures_2_parameter"}(e.PROCEDURE_BLOCKS||(e.PROCEDURE_BLOCKS={})),function(t){t[t.midi_play_note=1]="midi_play_note",t[t.midi_wait=2]="midi_wait"}(e.MIDI_BLOCKS||(e.MIDI_BLOCKS={})),function(t){t[t.start_on_click=1]="start_on_click",t[t.start_on_click_2=2]="start_on_click_2",t[t.procedures_defnoreturn=3]="procedures_defnoreturn",t[t.procedures_2_defnoreturn=4]="procedures_2_defnoreturn"}(e.HAT_BLOCKS||(e.HAT_BLOCKS={})),function(t){t[t.math_number=1]="math_number",t[t.text=2]="text"}(e.ATOMIC_BLOCKS||(e.ATOMIC_BLOCKS={})),function(t){t[t.tell=1]="tell",t[t.logic_empty=2]="logic_empty",t[t.sync_tell=3]="sync_tell",t[t.warp=4]="warp"}(e.SPECIAL_BLOCKS||(e.SPECIAL_BLOCKS={})),function(t){t[t.none=0]="none",t[t.any=1]="any",t[t.number=2]="number",t[t.list=3]="list",t[t.string=4]="string"}(e.BlockOutputType||(e.BlockOutputType={}))},11506:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(40806),o=i(26769),a=i(14064),s=i(43180),_=i(71962),c=function(){function t(t,e,i){this.is=t,this.ohno=e,this.log=i}return t.prototype.get_first_ancestor_satisfying=function(t,e){if(void 0!=t&&t.parent_block)return e(t.parent_block)?t.parent_block:this.get_first_ancestor_satisfying(t.parent_block,e)},t.prototype.has_block_of_types=function(t,e){var i=this;if(o(e)&&(e=[e]),0==t.length)return!1;if(0==e.length)return!1;var r=function(t){var r=!1;return i.ast_for_each(t,(function(t){if(n(e,t.type))return r=!0,!1})),r};return a(t,(function(t){var e=a(t.procedures,r);return t.compiled_block_map?e||a(t.compiled_block_map,r):e}))},t.prototype.ast_for_each=function(t,e){var i=this,r=!1;!function t(n,o){if(!r&&n)if(!1!==e(n,o)){for(var a in n.params){var s=n.params[a];i.is.compiled_block(s)&&t(s,n)}if(i.is.cond_block(n))for(var _=0;_<n.conditions.length;_++){var c=n.conditions[_];void 0!=c&&t(c,n)}for(_=0;_<n.child_block.length;_++){var u=n.child_block[_];void 0!=u&&t(u,n)}n.next_block&&t(n.next_block,o)}else r=!0}(t)},t.prototype.ast_map=function(t,e){var i={};for(var r in t.params){var n=t.params[r];this.is.compiled_block(n)&&(i[r]=this.ast_map(n,e))}var o=[];if(this.is.cond_block(t))for(var a=0;a<t.conditions.length;a++){var s=t.conditions[a];void 0!=s&&o.push(this.ast_map(s,e))}var _,c=[];for(a=0;a<t.child_block.length;a++){var u=t.child_block[a];u&&c.push(this.ast_map(u,e))}return t.next_block&&(_=this.ast_map(t.next_block,e)),e(t,i,o,c,_)},t.prototype.ast_merkle_tree=function(t,e){var i=this;return this.ast_map(t,(function(t,r,n,o,a){var s=0==Object.keys(r).length&&0==n.length&&0==o.length&&void 0==a,_=[],c=[],u=[],p=n.map((function(t){return t.hash})),d=o.map((function(t){return t.hash})),l=[];a&&l.push(a.hash),_.push(s?"LEAF":"INNER");var h=Object.keys(t.params);h=h.sort();for(var f=0;f<h.length;f++){var g=h[f],y=r[g];if(void 0==y){var m=t.params[g];void 0!=m&&(c.push(typeof m),u.push(m.toString()))}else c.push("expr"),u.push(y.hash)}var v=[],b=[];(i.is.procedures_callnoreturn(t)||i.is.procedures_callreturn(t))&&(v.push("F1"),b.push(t.procedure_name)),0!=c.length&&(v.push("P"),v.push(c.length.toString())),0!=n.length&&(v.push("I"),v.push(n.length.toString())),0!=o.length&&(v.push("C"),v.push(o.length.toString())),a&&v.push("N1");var w=[];w.push(_),w.push(t.type),0!=v.length&&w.push(v.join(""));var x=["["+(w=w.concat(c)).join("::")+"]"].concat(b).concat(u).concat(p).concat(d).concat(l).join("__"),k=e("("+x+")");return{block_id:t.id,hash:k,params:r,conditions:n,children:o,next:a}}))},t.prototype.ast_flat_map=function(t,e){var i=[];return this.ast_for_each(t,(function(t,r){i.push(e(t,r))})),i},t.prototype.ast_block_ids=function(t){return this.ast_flat_map(t,(function(t){return t.id}))},t=r.__decorate([s.injectable(),r.__param(0,s.inject(_.BINDING.BlockPredicates)),r.__param(1,s.inject(_.BINDING.Ohno)),r.__param(2,s.inject(_.BINDING.Log)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}();e.BlockUtilImpl=c},86068:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(94379),o=i(22988),a=i(43180),s=i(71962),_=function(){function t(t,e,i,r){this.ohno=t,this.is=e,this.xml_compiler=i,this.json_compiler=r}return t.prototype.compile=function(t,e,i){var r=this;void 0===i&&(i=!1);try{return n.success(t.map((function(t){return r.compile_entity(t,e,i)})))}catch(s){var a="Heart could not compile one or more entities with DOM Compiler";return s instanceof o.Catastrophe?n.error(a,s):n.error(a,this.ohno.compiler.system.unknown_compiler_error(s))}},t.prototype.compile_entity=function(t,e,i){return void 0===i&&(i=!1),this.is.uncompiled_XML_entity(t)?this.xml_compiler.compile(t,e,i):this.json_compiler.compile(t,e,i)},t=r.__decorate([a.injectable(),r.__param(0,a.inject(s.BINDING.Ohno)),r.__param(1,a.inject(s.BINDING.Predicates)),r.__param(2,a.inject(s.BINDING.XMLEntityCompiler)),r.__param(3,a.inject(s.BINDING.JSONEntityCompiler)),r.__metadata("design:paramtypes",[Object,Object,Object,Object])],t)}();e.CompilerImpl=_},58708:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(26769),o=i(6822),a=i(43180),s=i(79224),_=i(71962),c=function(){function t(t,e,i,r){this.block_pool=t,this.ohno=e,this.block=i,this.event_bus=r}return t.prototype.compile=function(t,e,i){void 0===i&&(i=!1);var r=this.compile_from_workspace_json(t.blocksJSON,e,i);return{id:t.id,procedures:r.procedures,compiled_block_map:r.compiled_block_map}},t.prototype.compile_from_workspace_json=function(t,e,i){var r=this;void 0===i&&(i=!1);var n={procedures:{},compiled_block_map:{}};if(!t.blocks)return n;var o=new Set(Object.keys(t.blocks));return Object.keys(t.connections).forEach((function(e){Object.keys(t.connections[e]).forEach((function(t){o.delete(t)}))})),o.forEach((function(o){var a=r.ws_json_to_json(t,o);if(void 0!=a){if(0==i)if(e){if(!e[a.id])return}else if(!r.block.is.hat_block_type(a.type))return;r.block.is.procedures_defnoreturn(a)?n.procedures[a.procedure_name]=a:void 0!=a.id&&(n.compiled_block_map[a.id]=a)}})),n},t.prototype.ws_json_to_json=function(t,e,i){var r=this;if(e){var n=t.blocks[e];if(!n)throw this.ohno.compiler.user.json_compiler_invalid_block({block_id:e});var a=t.connections[e]||{},_={next:"",inputs:[]};for(var c in a)"next"===a[c].type?(_.next&&this.event_bus.warning.all.send({error:this.ohno.compiler.warning.json_compiler_multi_children_on_one_connection({parent_id:e,children_id:[_.next,c],type:"next"})}),_.next=c):_.inputs.push(c);var u=_.next?this.ws_json_to_json(t,_.next,i):void 0,p=this.block_pool.get();return p.type=n.type,p.disabled=!!n.disabled,p.id=n.id,p.parent_block=i,p.next_block=u,p.first_evaluation=!0,p.done_evaluating=!1,p.output_type=n.is_output&&n.parent_id?s.BlockOutputType.number:s.BlockOutputType.none,this.parse_kind(p),_.inputs.forEach((function(e){var i=a[e];if("next"!==i.type){var n=r.ws_json_to_json(t,e,p);"value"===i.input_type?(p.params[i.input_name]&&r.event_bus.warning.all.send({error:r.ohno.compiler.warning.json_compiler_multi_children_on_one_connection({parent_id:p.id,children:[p.params[i.input_name],e],type:"value"})}),p.params[i.input_name]=n):p.child_block.push(n)}})),Object.keys(n.fields).forEach((function(t){p.params[t]="NUM"===t?parseFloat(n.fields[t]):o(n.fields[t])})),this.block.is.cond_block(p)?this.conditional_json_to_json(p,t):this.block.is.proc_block(p)?this.procedure_json_to_json(p,t):"traverse_number_value"===p.type?this.json_traverse_number_value_to_json(p,t):("start_on_click_2"===p.type&&(p.next_block=p.child_block.shift()),p)}},t.prototype.parse_kind=function(t){t.kind=t.type,this.block.is.loop_block(t)||(this.block.is.cond_block(t)?this.block.is.controls_if_dropdown(t)&&(t.kind="controls_if_dropdown"):this.block.is.event_block(t)?t.kind="event_block":this.block.is.responder_block(t)||this.block.is.lifetime_responder_type(t.type)?t.kind="responder_block":this.block.is.proc_block(t)||this.block.is.async_tell(t)||this.block.is.sync_tell(t)||this.block.is.warp(t)||(t.kind="domain_block"))},t.prototype.conditional_json_to_json=function(t,e){var i=t;i.conditions=[],i.if_dropdown_conditions=[];var r=[],n=void 0;var o=function(){var i=0,o=0,a=e.connections[t.id];return Object.keys(a).forEach((function(e){var s=a[e];if("next"!==s.type)if(s.input_name.indexOf("IF")>=0)i=Math.max(i,parseInt(s.input_name.split("IF")[1]));else if(s.input_name.indexOf("DO")>=0){var _=parseInt(s.input_name.split("DO")[1]);o=Math.max(o,_),r[_]=t.child_block.find((function(t){var i;return(null===(i=t)||void 0===i?void 0:i.id)===e}))}else"ELSE"===s.input_name&&(n=t.child_block.find((function(t){var i;return(null===(i=t)||void 0===i?void 0:i.id)===e})))})),Math.max(i,o)+1}();i.child_block.length=0;for(var a=0;a<o;++a){var s=t.params["IF"+a];if(this.block.is.controls_if_dropdown(i)){if("string"!==typeof s)throw this.ohno.compiler.system.if_dropdown_condition_not_string({pre_block:t});i.if_dropdown_conditions.push(s)}else"boolean"!==typeof s&&"string"!==typeof s&&"number"!==typeof s?i.conditions.push(s):i.conditions.push(void 0);i.child_block.push(r[a])}return i.child_block.push(n),i.params={},i},t.prototype.procedure_json_to_json=function(t,e){switch(s.PROCEDURE_BLOCKS[t.type]){case s.PROCEDURE_BLOCKS.procedures_defnoreturn:return this.json_procedure_definition_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_2_defnoreturn:return this.json_procedure_2_definition_to_json(t);case s.PROCEDURE_BLOCKS.procedures_callreturn:case s.PROCEDURE_BLOCKS.procedures_2_callreturn:return this.json_procedure_call_return_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_callnoreturn:case s.PROCEDURE_BLOCKS.procedures_2_callnoreturn:return this.json_procedure_call_no_return_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_return_value:case s.PROCEDURE_BLOCKS.procedures_2_return_value:case s.PROCEDURE_BLOCKS.procedures_parameter:case s.PROCEDURE_BLOCKS.procedures_2_parameter:return t}throw this.ohno.compiler.system.unknown_procedure_block_type({pre_block:t})},t.prototype.json_procedure_definition_to_json=function(t,e){var i,r=t.params.NAME;if(!n(r))throw this.ohno.compiler.system.procedure_name_not_string({pre_block:t});var o=t;return o.procedure_name=r,o.params={},null===(i=e.blocks[t.id].mutation.match(/ name="[^"]+"/g))||void 0===i||i.forEach((function(t){var e=t.slice(7,t.length-1);o.params[e]=!0})),o},t.prototype.json_procedure_2_definition_to_json=function(t){var e=t.params.NAME;if(!n(e))throw this.ohno.compiler.system.procedure_name_not_string({pre_block:t});var i=t;return i.procedure_name=e,delete i.params.NAME,Object.keys(i.params).forEach((function(t){var e=i.params[t];i.params[e.params.param_name]=!0,delete i.params[t]})),i},t.prototype.json_procedure_call_return_to_json=function(t,e){var i,r=t,n=e.blocks[t.id].mutation.match(/ name="[^"]+"/g),o=' name="'.length,a='"'.length;return null===(i=n)||void 0===i||i.forEach((function(t,e){var i=t.slice(o,t.length-a);if(0===e)return r.procedure_name=i,void delete r.params.NAME;var n="ARG"+(e-1);r.params[i]=r.params[n],delete r.params[n]})),r},t.prototype.json_procedure_call_no_return_to_json=function(t,e){return this.json_procedure_call_return_to_json(t,e)},t.prototype.json_traverse_number_value_to_json=function(t,e){var i=t;if(t.parent_block){var r=function t(e,i){var r,n=i.parent_block;if(!n)return"";if("traverse_number"===n.type){var o=null===(r=n.params)||void 0===r?void 0:r.value;if(o&&o.params.TEXT===e)return n.id}return t(e,n)}(t.params.TEXT,t);r&&(t.params.owner_id=r)}return i},t=r.__decorate([a.injectable(),r.__param(0,a.inject(_.BINDING.BlockPool)),r.__param(1,a.inject(_.BINDING.Ohno)),r.__param(2,a.inject(_.BINDING.BlockUtil)),r.__param(3,a.inject(_.BINDING.EventBus)),r.__metadata("design:paramtypes",[Object,Object,Object,Object])],t)}();e.JSONEntityCompilerImpl=c},77004:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=i(71962),a=function(){function t(t){this.dom_parser=t}return t.prototype.parse=function(t,e){e(this.dom_parser.parseFromString("<kitten>"+t+"</kitten>","text/xml").firstChild.children)},t.prototype.for_each_child=function(t,e){for(var i=0;i<t.children.length;i++){e(t.children[i],i)}},t.prototype.first_child=function(t){return t.firstChild},t.prototype.last_child=function(t){return t.lastChild},t.prototype.children=function(t){return t.children},t.prototype.parent=function(t){return t.parentNode},t.prototype.attr=function(t,e){return t.getAttribute(e)},t.prototype.inner_html=function(t){return t.innerHTML},t.prototype.tag_name=function(t){return t.tagName},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.DOMParser)),r.__metadata("design:paramtypes",[Object])],t)}();e.DOMParserImpl=a},77460:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(94379),o=i(15727),a=i(43180),s=i(71962),_=function(){function t(t){this.html_parser=t}return t.prototype.parse=function(t,e){var i=new this.html_parser.DomHandler((function(t,i){if(t)return n.error("htmlparser2 compile error",t);e(i)})),r=new this.html_parser.Parser(i);r.write(t),r.end()},t.prototype.for_each_child=function(t,e){for(var i=0;i<t.children.length;i++){e(t.children[i],i)}},t.prototype.first_child=function(t){return t.children[0]},t.prototype.last_child=function(t){return o(t.children)||null},t.prototype.children=function(t){return t.children},t.prototype.parent=function(t){return t.parent},t.prototype.attr=function(t,e){return t.attribs[e]},t.prototype.inner_html=function(t){var e;return(null===(e=t.children[0])||void 0===e?void 0:e.data)||""},t.prototype.tag_name=function(t){return t.name},t=r.__decorate([a.injectable(),r.__param(0,a.inject(s.BINDING.HtmlParser)),r.__metadata("design:paramtypes",[Object])],t)}();e.HtmlParserImpl=_},61799:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(26769),o=i(6822),a=i(43180),s=i(79224),_=i(71962),c=function(){function t(t,e,i,r){this.block_pool=t,this.ohno=e,this.block=i,this.parser=r}return t.prototype.compile=function(t,e,i){void 0===i&&(i=!1);var r=this.compile_from_workspace_xml(t.blocksXML.trim(),e,i);return{id:t.id,procedures:r.procedures,compiled_block_map:r.compiled_block_map}},t.prototype.compile_from_workspace_xml=function(t,e,i){var r=this;void 0===i&&(i=!1);var n={procedures:{},compiled_block_map:{}};return t?(this.parser.parse(t,(function(t){for(var o=0;o<t.length;o++){var a=r.xml_to_json(t[o]);if(void 0!=a){if(0==i)if(e){if(!e[a.id])continue}else if(!r.block.is.hat_block_type(a.type))continue;r.block.is.procedures_defnoreturn(a)?n.procedures[a.procedure_name]=a:void 0!=a.id&&(n.compiled_block_map[a.id]=a)}}})),n):n},t.prototype.parse_xml_field=function(t){var e=this.parser.inner_html(t);return"NUM"==this.parser.attr(t,"name")?parseFloat(e):o(e)},t.prototype.xml_to_json=function(t,e){var i=this;if(t){var r={named:{},tagged:{}};this.parser.for_each_child(t,(function(t){var e=i.parser.tag_name(t);r.tagged[e]=t;var n=i.parser.attr(t,"name");n&&(r.named[n]=t)}));var n=r.tagged.next,o=n?this.xml_to_json(this.parser.first_child(n),e):void 0,a=this.block_pool.get();a.kind=this.parser.attr(t,"type"),a.type=this.parser.attr(t,"type"),a.disabled=!!this.parser.attr(t,"disabled"),a.id=this.parser.attr(t,"id"),a.parent_block=e,a.next_block=o,a.first_evaluation=!0,a.done_evaluating=!1;var _=this.parser.parent(t);if(a.output_type=_&&"value"==this.parser.tag_name(_)?s.BlockOutputType.number:s.BlockOutputType.none,this.parser.for_each_child(t,(function(t){var e=i.parser.attr(t,"name"),r=i.parser.tag_name(t);if("value"==r){var n=i.xml_to_json(i.parser.last_child(t),a);void 0!=n&&(a.params[e]=n)}else"field"==r&&(a.params[e]=i.parse_xml_field(t))})),this.block.is.loop_block(a))return this.loop_to_json(a,r);if(this.block.is.cond_block(a))return this.conditional_to_json(a,r);if(this.block.is.event_block(a))return this.event_to_json(a,r);if(this.block.is.responder_block(a))return this.responder_to_json(a,r);if(this.block.is.lifetime_responder_type(a.type))return this.responder_to_json(a,r);if(this.block.is.proc_block(a))return this.procedure_to_json(a,r);if(this.block.is.async_tell(a)||this.block.is.sync_tell(a))return this.tell_to_json(a,r);if(this.block.is.warp(a))return this.warp_to_json(a,r);if("start_on_click_2"===a.type){var c=r.tagged.statement,u=c?this.xml_to_json(this.parser.first_child(c),e):void 0;a.next_block=u}return a.kind="domain_block",a}},t.prototype.responder_to_json=function(t,e){t.kind="responder_block";var i=t;return e.tagged.statement&&i.child_block.push(this.xml_to_json(this.parser.last_child(e.tagged.statement),i)),i},t.prototype.event_to_json=function(t,e){t.kind="event_block";var i=t;return e.tagged.statement&&i.child_block.push(this.xml_to_json(this.parser.last_child(e.tagged.statement),i)),i},t.prototype.loop_to_json=function(t,e){var i=e.named,r=t;return(this.block.is.repeat_n_times(r)||this.block.is.traverse_number(r)||this.block.is.repeat_forever(r)||this.block.is.repeat_forever_until(r))&&r.child_block.push(i.DO?this.xml_to_json(this.parser.first_child(i.DO),r):void 0),r},t.prototype.tell_to_json=function(t,e){var i=e.named,r=t;return r.child_block.push(i.DO?this.xml_to_json(this.parser.first_child(i.DO),r):void 0),r},t.prototype.warp_to_json=function(t,e){var i=e.named,r=t;return r.child_block.push(i.DO?this.xml_to_json(this.parser.first_child(i.DO),r):void 0),r},t.prototype.conditional_to_json=function(t,e){var i=e.named,r=t;this.block.is.controls_if_dropdown(r)&&(r.kind="controls_if_dropdown"),r.conditions=[],r.if_dropdown_conditions=[];for(var n=function(){var t=Object.keys(i),e=0,r=0;return t.forEach((function(t){t.indexOf("IF")>=0?e=Math.max(e,parseInt(t.split("IF")[1])):t.indexOf("DO")>=0&&(r=Math.max(r,parseInt(t.split("DO")[1])))})),Math.max(e,r)+1}(),o=0;o<n;++o){var a=i["IF"+o];if(void 0===a)r.conditions.push(void 0);else if(this.block.is.controls_if_dropdown(r)){var s=t.params["IF"+o];if(!s||"string"!==typeof s)throw this.ohno.compiler.system.if_dropdown_condition_not_string({pre_block:t});r.if_dropdown_conditions.push(s)}else r.conditions.push(this.xml_to_json(this.parser.last_child(a),t));var _=i["DO"+o];_?r.child_block.push(this.xml_to_json(this.parser.last_child(_),t)):r.child_block.push(void 0)}var c=i.ELSE;return c?r.child_block.push(this.xml_to_json(this.parser.last_child(c),t)):r.child_block.push(void 0),r.params={},r},t.prototype.procedure_to_json=function(t,e){switch(s.PROCEDURE_BLOCKS[t.type]){case s.PROCEDURE_BLOCKS.procedures_defnoreturn:return this.procedure_definition_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_2_defnoreturn:return this.procedure_2_definition_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_callreturn:case s.PROCEDURE_BLOCKS.procedures_2_callreturn:return this.procedure_call_return_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_callnoreturn:case s.PROCEDURE_BLOCKS.procedures_2_callnoreturn:return this.procedure_call_no_return_to_json(t,e);case s.PROCEDURE_BLOCKS.procedures_return_value:case s.PROCEDURE_BLOCKS.procedures_2_return_value:case s.PROCEDURE_BLOCKS.procedures_parameter:case s.PROCEDURE_BLOCKS.procedures_2_parameter:return t}throw this.ohno.compiler.system.unknown_procedure_block_type({pre_block:t,child_nodes:e})},t.prototype.procedure_definition_to_json=function(t,e){var i=this,r=e.tagged,o=t.params.NAME;if(!n(o))throw this.ohno.compiler.system.procedure_name_not_string({pre_block:t});var a=t;a.procedure_name=o,a.params={};var s=r.mutation;return s&&this.parser.for_each_child(s,(function(t){a.params[i.parser.attr(t,"name")]=!0})),r.statement&&a.child_block.push(this.xml_to_json(this.parser.last_child(r.statement),a)),a},t.prototype.procedure_2_definition_to_json=function(t,e){var i=e.named,r=e.tagged,o=t.params.NAME;if(!n(o))throw this.ohno.compiler.system.procedure_name_not_string({pre_block:t});var a=t;for(var s in a.procedure_name=o,a.params={},i)if("value"==this.parser.tag_name(i[s])){var _=this.parser.children(i[s])[1],c=this.parser.children(_)[0],u=this.parser.inner_html(c);a.params[u]=!0}return r.statement&&a.child_block.push(this.xml_to_json(this.parser.last_child(r.statement),a)),a},t.prototype.procedure_call_return_to_json=function(t,e){var i=this,r=e.tagged.mutation,n=t;return r&&this.parser.for_each_child(r,(function(t,e){n.params[i.parser.attr(t,"name")]=n.params["ARG"+e],delete n.params["ARG"+e]})),n.procedure_name=this.parser.attr(r,"name"),delete n.params.NAME,n},t.prototype.procedure_call_no_return_to_json=function(t,e){var i=this,r=e.tagged.mutation,o=t.params.NAME;if(!n(o))throw this.ohno.compiler.system.procedure_call_name_not_string({pre_block:t});var a=t;return a.procedure_name=o,r&&this.parser.for_each_child(r,(function(t,e){a.params[i.parser.attr(t,"name")]=a.params["ARG"+e],delete a.params["ARG"+e],delete a.params["ARGNAME"+e]})),delete a.params.WITH,delete a.params.NAME,a},t=r.__decorate([a.injectable(),r.__param(0,a.inject(_.BINDING.BlockPool)),r.__param(1,a.inject(_.BINDING.Ohno)),r.__param(2,a.inject(_.BINDING.BlockUtil)),r.__param(3,a.inject(_.BINDING.XMLParser)),r.__metadata("design:paramtypes",[Object,Object,Object,Object])],t)}();e.XMLEntityCompilerImpl=c},85990:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(34521),o=i(43180),a=(i(76715),i(71962));var s=function(){function t(t){this.event_bus=t}return t.prototype.get=function(){return this.config},t.prototype.set=function(t){this.config=n({},t,this.config,{block_pool_preallocation_size:50,opti_frame_pool_preallocation_size:10,opti_frame_pool_size_limit:600,deterministic:void 0,legacy:{lists_get_value_allow_return_undefined:!1},max_procedure_calls_per_interpreter_step:5e4,max_warp_iterations_per_interpreter_step:3e4,warp_interpreter_millisecond_time_limit:4,max_call_stack_size:1e4,opti_compiler:{pretty_print:!1},per_entity_clone_limit:300,entity_max_clones_per_frame:300,reports_all_entities:!0,should_report_current_running_block:!1,user_debug_mode:!1,ignore_missing_domain_function:!1,nan_to_zero_conversion_blocks:[],loop_break_error_type:"error",clone_target_do_add_responder_interpreters:!1,replace_parameters_value:!1}),this.event_bus.system.config_updated.send()},t=r.__decorate([o.injectable(),r.__param(0,o.inject(a.BINDING.EventBus)),r.__metadata("design:paramtypes",[Object])],t)}();e.ConfigImpl=s},21590:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(34521),n=i(43180),o=i(71962),a=i(9425),s=i(54895),_=i(19406),c=i(83064),u=i(11506),p=i(40299),d=i(85990),l=i(61799),h=i(58708),f=i(86068),g=i(77004),y=i(77460),m=i(23094),v=i(9831),b=i(56612),w=i(32803),x=i(35765),k=i(59651),O=i(53972),E=i(4622),I=i(72130),T=i(36041),N=i(8541),S=i(36138),A=i(34139),C=i(97289),M=i(86596),P=i(13783),R=i(72495),B=i(26460),j={day_names:m.DEFAULT_DAY_NAMES};e.get_instance=function(t){t.basic_blocks_requirements=r(t.basic_blocks_requirements,j);var e=new n.Container;e.bind(o.BINDING.Log).toConstantValue(t.logger);var i=B.create_event_bus();e.bind(o.BINDING.EventBus).toConstantValue(i),e.bind(o.BINDING.Config).to(d.ConfigImpl).inSingletonScope(),e.get(o.BINDING.Config).set(t.configuration);var m=t.compiler_requirements&&t.compiler_requirements.dom_parser,D=t.compiler_requirements&&t.compiler_requirements.html_parser;return m?(e.bind(o.BINDING.DOMParser).toConstantValue(t.compiler_requirements.dom_parser),e.bind(o.BINDING.XMLParser).to(g.DOMParserImpl).inSingletonScope()):D&&(e.bind(o.BINDING.HtmlParser).toConstantValue(t.compiler_requirements.html_parser),e.bind(o.BINDING.XMLParser).to(y.HtmlParserImpl).inSingletonScope()),e.bind(o.BINDING.XMLEntityCompiler).to(l.XMLEntityCompilerImpl).inSingletonScope(),e.bind(o.BINDING.JSONEntityCompiler).to(h.JSONEntityCompilerImpl).inSingletonScope(),e.bind(o.BINDING.Compiler).to(f.CompilerImpl).inSingletonScope(),e.bind(o.BINDING.DayNames).toConstantValue(t.basic_blocks_requirements.day_names),e.bind(o.BINDING.Ohno).toConstantValue(R.ohno),e.bind(o.BINDING.ActionStateStore).to(a.ActionStateStoreImpl).inSingletonScope(),e.bind(o.BINDING.RuntimeData).to(I.RuntimeDataImpl).inSingletonScope(),e.bind(o.BINDING.Clock).to(p.ClockImpl).inSingletonScope(),e.bind(o.BINDING.OptiProgramCache).to(x.OptiProgramCacheImpl).inSingletonScope(),e.bind(o.BINDING.OptiRunnerFactory).to(k.OptiRunnerFactory).inSingletonScope(),e.bind(o.BINDING.DebugRunnerFactory).to(v.DebugRunnerFactory).inSingletonScope(),e.bind(o.BINDING.BasicBlockProviderFactory).to(s.BasicBlockProviderFactoryImpl).inSingletonScope(),e.bind(o.BINDING.PRNGFactory).to(O.PRNGFactoryImpl).inSingletonScope(),e.bind(o.BINDING.BlockPool).to(_.BlockPoolImpl).inSingletonScope(),e.bind(o.BINDING.OptiFramePool).to(w.OptiFramePoolImpl).inSingletonScope(),e.bind(o.BINDING.BlockPredicates).to(c.BlockPredicatesImpl).inSingletonScope(),e.bind(o.BINDING.OptiCompiler).to(b.OptiCompilerImpl).inSingletonScope(),e.bind(o.BINDING.Registry).to(E.RegistryImpl).inSingletonScope(),e.bind(o.BINDING.RuntimeManager).to(N.RuntimeManagerImpl).inSingletonScope(),e.bind(o.BINDING.RuntimeManagerFacade).to(T.RuntimeManagerFacade).inSingletonScope(),e.bind(o.BINDING.TaskManager).to(A.TaskManagerImpl).inSingletonScope(),e.bind(o.BINDING.ScriptStore).to(S.ScriptStoreImpl).inSingletonScope(),e.bind(o.BINDING.UserVariable).to(C.UserVariableImpl).inSingletonScope(),e.bind(o.BINDING.BlockUtil).to(u.BlockUtilImpl).inSingletonScope(),e.bind(o.BINDING.Util).to(M.UtilImpl).inSingletonScope(),e.bind(o.BINDING.Predicates).to(P.PredicatesImpl).inSingletonScope(),e}},9831:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=(i(76715),i(71962)),a=i(15220),s=function(){function t(t,e,i,r,n,o){var a=this;this.u=t,this.ohno=e,this.event_bus=i,this.registry=r,this.block_pool=n,this.runtime_data=o;var s=function(){var e=t.config.get();a.tell_should_ensure_entity_exists=e.reports_all_entities,a.should_report_current_running_block=e.should_report_current_running_block,a.max_procedure_calls_per_interpreter_step=e.max_procedure_calls_per_interpreter_step,a.max_warp_iterations_per_interpreter_step=e.max_warp_iterations_per_interpreter_step,a.warp_interpreter_millisecond_time_limit=e.warp_interpreter_millisecond_time_limit,a.max_call_stack_size=e.max_call_stack_size};s(),this.event_bus.system.config_updated.immediate.sub(s)}return t.prototype.create=function(t,e,i,r,n,o,s,_,c){return new a.DebugRunner(this.u,this.ohno,this.event_bus,t,this.runtime_data,this.block_pool,this.registry.get_domain_functions(),n,i,e,o,this.should_report_current_running_block,this.max_procedure_calls_per_interpreter_step,this.max_warp_iterations_per_interpreter_step,this.warp_interpreter_millisecond_time_limit,this.max_call_stack_size,this.tell_should_ensure_entity_exists,!!this.u.config.get().deterministic,s,_,c)},t.prototype.clear=function(){},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Util)),r.__param(1,n.inject(o.BINDING.Ohno)),r.__param(2,n.inject(o.BINDING.EventBus)),r.__param(3,n.inject(o.BINDING.Registry)),r.__param(4,n.inject(o.BINDING.BlockPool)),r.__param(5,n.inject(o.BINDING.RuntimeData)),r.__metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object])],t)}();e.DebugRunnerFactory=s},15220:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r,n=i(9108),o=i(58121),a=i(64286),s=i(2100),_=i(34521),c=i(66933),u=i(22988),p=i(40303),d=i(79224),l=i(88073),h="__main__";!function(t){t[t.Break=0]="Break",t[t.Done=1]="Done",t[t.Yield=2]="Yield",t[t.Finish=3]="Finish",t[t.EvalArg=4]="EvalArg",t[t.EvalChild=5]="EvalChild",t[t.EvalWarp=6]="EvalWarp",t[t.EvalTell=7]="EvalTell",t[t.ProcedureCall=8]="ProcedureCall",t[t.ProcedureReturn=9]="ProcedureReturn"}(r||(r={}));var f={kind:r.Done,has_value:!1,value:void 0,never_needs_to_yield:!1},g={kind:r.Done,has_value:!1,value:void 0,never_needs_to_yield:!0},y=function(){function t(t,e,i,r,n,o,a,s,_,c,u,p,d,l,h,g,y,m,v,w,x){var k=this;this.util=t,this.ohno=e,this.event_bus=i,this.run_mgr=r,this.runtime_data=n,this.block_pool=o,this.domain_functions=a,this.priorities=_,this.original_identities=c,this.max_procedure_calls_per_interpreter_step=d,this.max_warp_iterations_per_interpreter_step=l,this.warp_interpreter_millisecond_time_limit=h,this.max_call_stack_size=g,this.tell_should_ensure_entity_exists=y,this.deterministic=m,this.is_warped=v,this.action_parameters=w,this.on_finished=x,this.should_report_current_running_block=!1,this.n_warp_iterations=0,this.n_procedure_calls=0,this.warp_tick_start=0,this.current_frame=void 0,this.return_after_final_yield=!1,this.eval_repeat_forever=function(){},this.eval_repeat_n_times=function(t,e){if(0==b(e,"has_times",!1)&&k.needs_eval_params()){var i=k.eval_params();if(void 0!=i)return i}e.has_times=!0;var r=b(e,"n_times_done",0),n=k.util.config.get().nan_to_zero_conversion_blocks,o=e.param_meta.args.times;if(n&&n.includes(k.current_block.kind)&&(o="string"===typeof o||isNaN(o)?0:o),r>=o)return f;e.n_times_done+=1},this.eval_traverse_number=function(t,e){if(0==b(e,"has_times",!1)&&k.needs_eval_params()){var i=k.eval_params();if(void 0!=i)return i}e.has_times=!0;var r=b(e,"n_times_done",0),n=e.param_meta.args.from,o=e.param_meta.args.to;if(n<=o){if((n=Math.ceil(n))>o)return f}else if((n=Math.floor(n))<o)return f;var a=e.param_meta.args.by;void 0===a&&(a=1),a=isNaN(Number(a))||Number(a)<=0?0:Math.abs(Math.round(a));var s=b(e,"n_value",n);return k.runtime_data.set_arbitrary_data(t.id,s),r>=Math.floor(Math.abs((n-o)/a))+1?(k.runtime_data.set_arbitrary_data(t.id,void 0),f):(e.n_times_done+=1,isNaN(e.n_value)?(k.runtime_data.set_arbitrary_data(t.id,void 0),f):void(e.n_value+=n<o?a:-a))},this.eval_repeat_forever_until=function(t,e){if(k.needs_eval_params()){var i=k.eval_params();if(void 0!=i)return i}var r=e.param_meta.args.condition;if(e.param_meta=null,r)return f},this.root_block=s,this.metadata={priorities:_,original_identities:c,typeclass_id:c.typeclass_id,interpreter_id:c.interpreter_id,type:s.type,group_id:u},this.should_report_current_running_block=p,this.program_state=this.empty_state(c.target_entity,v)}return t.prototype.reset=function(){this.return_after_final_yield=!1,this.program_state=this.empty_state(this.original_identities.target_entity,this.is_warped)},t.prototype.dispose=function(){},t.prototype.is_inside_warp=function(){return this.is_warped||this.current_frame.is_warped||this.current_frame.n_warp_parents>0},t.prototype.step=function(){if(this.return_after_final_yield)return l.StepResult.finished;this.n_warp_iterations=0,this.n_procedure_calls=0,this.deterministic||(this.warp_tick_start=this.run_mgr.wall_clock_now()),this.run_mgr.set_current_interpreter_not_blocked();try{return this.do_step()}catch(e){var t={interpreter_id:this.original_identities.interpreter_id,interpreter_stack:this.get_current_stack()};if(e instanceof u.Catastrophe)throw e.annotation=e.annotation||{},e.annotation=_(e.annotation,t),e;throw this.ohno.system.unknown_system_error(e,t)}},t.prototype.get_stack_frame=function(){var t=m(this.program_state.proc_stack);if(void 0==t)throw this.ohno.system.procedure_popped_empty_call_stack({source_map_rbid:this.original_identities.source_map_rbid,source_entity_id:this.original_identities.source_map_entity,block:this.current_block,block_id:void 0==this.current_block?void 0:this.current_block.id,block_type:void 0==this.current_block?void 0:this.current_block.type});return t},t.prototype.do_step=function(){var t=this.get_stack_frame();for(this.current_frame=t,this.current_block=t.current_block,this.program_state.proc_stack_changed=!1;;){if(this.program_state.proc_stack_changed&&(this.program_state.proc_stack_changed=!1,t=this.get_stack_frame(),this.current_frame=t,this.current_block=t.current_block,this.n_procedure_calls>this.max_procedure_calls_per_interpreter_step))return l.StepResult.yielding;var e=this.step_eval_dispatch();if(e===r.Yield)return l.StepResult.yielding;if(e===r.Finish)return l.StepResult.finished;if(e!==r.Break)if(e.kind!=r.Done)if(e.kind!=r.EvalArg)if(e.kind!=r.EvalChild)if(e.kind!=r.EvalTell)if(e.kind!=r.EvalWarp)if(e.kind!=r.ProcedureCall){if(e.kind!=r.ProcedureReturn)throw v(e,this.ohno.system.unhandled_run_block_result(n.__assign(n.__assign({},this.get_catastrophe_dict()),{block_result:e})));if(this.program_state.proc_stack.length<2){if(void 0==this.current_frame)throw this.ohno.user.procedure_return_outside({source_map_rbid:this.original_identities.source_map_rbid,source_entity_id:this.original_identities.source_map_entity,block:this.current_block,block_id:void 0==this.current_block?void 0:this.current_block.id,block_type:void 0==this.current_block?void 0:this.current_block.type});throw this.ohno.user.procedure_return_outside(n.__assign({},this.get_catastrophe_dict()))}this.program_state.proc_stack.pop(),e.has_return_value?(this.program_state.proc_has_return_value=!0,this.program_state.proc_return_value=e.return_value):(this.program_state.proc_has_return_value=!1,this.program_state.proc_return_value=void 0),this.program_state.proc_stack_changed=!0}else this.push_onto_proc_stack(e.proc_id,e.parameters,this.current_frame.target_entity_id,this.current_block.id);else this.current_frame.current_block=e.block,this.current_block=e.block;else this.current_frame.current_block=e.block,this.current_block=e.block;else this.current_frame.current_block=e.block,this.current_block=e.block;else this.current_frame.current_block=e.block,this.current_block=e.block;else{var i=e.never_needs_to_yield,o=e.has_value,a=e.value,s=this.current_block;o&&(this.program_state.expression_return_value=a,this.program_state.has_expression_return_value=!0,void 0==a||s.parent_block||this.util.block.is.procedures_callnoreturn(s)||this.event_bus.runtime_data.block_run_result.send({root_block_id:this.original_identities.interpreter_id,block_id:s.id,result:a})),this.current_frame.dynamic_data[this.current_block.id]={};var _=!i&&this.must_yield();if(0==this.go_next_or_parent()){if(this.pop_stack_or_finish()){this.program_state.proc_stack_changed=!0;continue}return _?(this.return_after_final_yield=!0,l.StepResult.yielding):l.StepResult.finished}if(_)return l.StepResult.yielding}else{var c=this.util.block.get_first_ancestor_satisfying(this.current_block,this.util.block.is.loop_block),u=this.util.config.get().loop_break_error_type;if(void 0==c){if("warning"==u){if(this.event_bus.warning.runtime.send({error:this.ohno.warning.tried_to_break_outside_of_loop({block:this.get_catastrophe_dict().block})}),0==this.go_next_or_parent()){if(this.pop_stack_or_finish()){this.program_state.proc_stack_changed=!0;continue}return l.StepResult.finished}continue}throw this.ohno.user.break_with_bad_parent(n.__assign({},this.get_catastrophe_dict()))}var p=this.current_frame.dynamic_data[c.id].break_cache;if(this.current_frame.n_warp_parents=p.n_warp_parents,this.current_frame.target_entity_id=p.target_entity_id,this.reset_subtree_state(c),this.current_block=c,this.current_frame.current_block=c,0==this.go_next_or_parent()){if(this.pop_stack_or_finish()){this.program_state.proc_stack_changed=!0;continue}return l.StepResult.finished}}}},t.prototype.get_value=function(t,e){if(void 0==t||null==t)throw this.ohno.system.undefined_or_null_block(n.__assign({},this.get_catastrophe_dict(e)));try{if(this.util.block.is.compiled_block(t)&&d.ATOMIC_BLOCKS[t.type])return t.params[Object.keys(t.params)[0]];if(this.util.block.is.atomic(t))return t}catch(i){throw this.ohno.user.error_constructing_value_from_atomic_block(i,n.__assign(n.__assign({},this.get_catastrophe_dict()),{param:t}))}},t.prototype.step_eval_dispatch=function(){var t=this.current_block;if(t.disabled)return g;if((this.util.block.is.responder_block(t)||this.util.block.is.lifetime_responder_type(t.type))&&!this.util.block.is.when(t))return this.eval_child_or_done(t,r.EvalChild);if(this.util.block.is.event_block(t))return this.eval_event();if(this.util.block.is.cond_block(t))return this.eval_cond();if(this.util.block.is.logic_empty(t))return{kind:r.Done,has_value:!0,value:!1,never_needs_to_yield:!0};if(this.util.block.is.domain_block(t))return this.eval_domain();if(this.util.block.is.break(t))return r.Break;if(this.util.block.is.repeat_forever(t))return this.eval_repeat_template(this.eval_repeat_forever);if(this.util.block.is.repeat_n_times(t))return this.eval_repeat_template(this.eval_repeat_n_times);if(this.util.block.is.traverse_number(t))return this.eval_repeat_template(this.eval_traverse_number);if(this.util.block.is.traverse_number_value(t))return this.eval_traverse_number_value();if(this.util.block.is.repeat_forever_until(t))return this.eval_repeat_template(this.eval_repeat_forever_until);if(this.util.block.is.wait_until(t))return this.eval_wait_until();if(this.util.block.is.procedures_callreturn(t))return this.eval_procedures_callreturn();if(this.util.block.is.procedures_defnoreturn(t))return this.eval_procedures_defnoreturn();if(this.util.block.is.procedures_parameter(t))return this.eval_procedures_parameter();if(this.util.block.is.procedures_return_value(t))return this.eval_procedures_return_value();if(this.util.block.is.procedures_callnoreturn(t))return this.eval_procedures_callnoreturn();if(this.util.block.is.sync_tell(t))return this.eval_sync_tell();if(this.util.block.is.async_tell(t))return this.eval_async_tell();if(this.util.block.is.warp(t))return this.eval_warp();throw v(t,this.ohno.system.unknown_system_error(n.__assign(n.__assign({},this.get_catastrophe_dict()),{unhandled_block_type:t})))},t.prototype.eval_child_or_done=function(t,e){var i=t.child_block[0];if(void 0==i)return f;var r=this.get_block_state(t.id);return b(r,"has_run_child",!1)?f:(r.has_run_child=!0,{kind:e,block:i})},t.prototype.eval_cond=function(){var t,e=this.current_block,i=e.child_block;t=this.util.block.is.controls_if_dropdown(e)?e.if_dropdown_conditions:e.conditions;var o=i.length,a=t.length;if(0==o||0==a)return f;var s=this.get_block_state(e.id);if(b(s,"done",!1))return f;var _=b(s,"waiting",!1),c=b(s,"waiting_dropdown",!1),u=b(s,"branch_n",0);if(_){s.waiting=!1;var p=this.consume_previous_expression_value(),d=p.value;if(0==p.has_value)throw this.ohno.compiler.user.disabled_param(n.__assign({},this.get_catastrophe_dict()));if(d)return s.done=!0,void 0==(g=e.child_block[u])?f:{kind:r.EvalChild,block:g};u+=1,s.branch_n+=1}if(c){if(!(void 0!=(h=this.eval_domain()).kind&&h.kind==r.Done))return h;if(s.waiting_dropdown=!1,h.has_value&&h.value)return s.done=!0,void 0==(g=e.child_block[u])?f:{kind:r.EvalChild,block:g};u+=1,s.branch_n+=1}for(;u<o&&u<a;){var l=t[u];if(void 0!=i[u]&&void 0!=l){if("string"!==typeof l)return s.waiting=!0,{kind:r.EvalArg,block:l};var h,g;if(s.domain_function=l,!(void 0!=(h=this.eval_domain()).kind&&h.kind==r.Done))return s.waiting_dropdown=!0,h;if(h.has_value&&h.value)return s.done=!0,void 0==(g=e.child_block[u])?f:{kind:r.EvalChild,block:g};u+=1,s.branch_n+=1}else u+=1,s.branch_n+=1}if(o==a+1){s.done=!0;var y=e.child_block[o-1];return void 0==y?f:{kind:r.EvalChild,block:y}}return f},t.prototype.eval_event=function(){var t=this.current_block,e=this.get_block_state(t.id),i=t.child_block[0];if(void 0==i)return r.Finish;if(b(e,"should_reset",!1))return d.EVENT_BLOCKS[t.type]==d.EVENT_BLOCKS.start_as_a_mirror?r.Finish:(this.current_frame.dynamic_data[t.id]={},r.Yield);var n=this.eval_domain();return void 0!=n.kind&&n.kind==r.Done?n.has_value&&n.value?(e.should_reset=!0,{kind:r.EvalChild,block:i}):(this.current_frame.dynamic_data[t.id]={},r.Yield):n},t.prototype.eval_repeat_template=function(t){var e=this.current_block,i=this.get_block_state(e.id),n=e.child_block[0];if(void 0==n)return g;b(i,"first_entry",!0)&&(i.break_cache={n_warp_parents:this.current_frame.n_warp_parents,target_entity_id:this.current_frame.target_entity_id},i.first_entry=!1);var o=b(i,"should_yield",!1);if(o)return i.should_yield=!1,r.Yield;var a=t(e,i);if(void 0!=a)return a;if(i.should_yield=!0,this.is_inside_warp()&&(this.n_warp_iterations<this.max_warp_iterations_per_interpreter_step&&(this.n_warp_iterations+=1,i.should_yield=!1),!this.deterministic&&!o)){var s=this.warp_tick_start+this.warp_interpreter_millisecond_time_limit<this.run_mgr.wall_clock_now();i.should_yield=s}return{kind:r.EvalChild,block:n}},t.prototype.eval_traverse_number_value=function(){var t=this.current_block;if(this.needs_eval_params()){var e=this.eval_params();if(void 0!=e)return e}var i=this.runtime_data.get_arbitrary_data(t.params.owner_id);return{kind:r.Done,value:i,has_value:!0,never_needs_to_yield:!1}},t.prototype.eval_wait_until=function(){var t=this.current_block,e=this.get_block_state(t.id);if(this.needs_eval_params()){var i=this.eval_params();if(void 0!=i)return i}var n=e.param_meta.args.condition;return e.param_meta=null,n?f:r.Yield},t.prototype.eval_procedures_callreturn=function(){var t=this.current_block,e=this.get_block_state(t.id);if(b(e,"has_called",!1)){var i=this.program_state,n=i.proc_has_return_value,o=i.proc_return_value;return{kind:r.Done,has_value:n,value:o,never_needs_to_yield:!1}}if(this.needs_eval_params()){var a=this.eval_params();if(void 0!=a)return a}var s=e.param_meta.args;return e.has_called=!0,{kind:r.ProcedureCall,proc_id:t.procedure_name,parameters:s}},t.prototype.eval_procedures_callnoreturn=function(){return this.eval_procedures_callreturn()},t.prototype.push_onto_proc_stack=function(t,e,i,r){var o=this.program_state.proc_stack;if(o.length>this.max_call_stack_size)throw this.ohno.system.stack_overflow(n.__assign(n.__assign({},this.get_catastrophe_dict()),{procedure_id:t}));var a=this.run_mgr.get_procedure(t);if(void 0==a)throw this.ohno.user.call_undefined_procedure(n.__assign(n.__assign({},this.get_catastrophe_dict()),{procedure_id:t}));this.util.config.get()&&this.replaceParametersValue(e,t,i,r),o.push(this.empty_stack_frame(t,this.current_frame.target_entity_id,a.script,this.is_inside_warp(),e,a.source_entity_id,a.script.id,this.current_block.id)),this.n_procedure_calls+=1,this.program_state.proc_stack_changed=!0},t.prototype.getParameterFiledOrInput=function(t,e){return"Variable"===t?{field:e}:"Audio"===t?{input:e}:"Actor"===t?{field:e}:"Style"===t||"List"===t?{input:e}:{}},t.prototype.replaceParametersValue=function(t,e,i,r){var o=this.run_mgr.get_procedure_parameters_type(),a=["Variable","Audio","Actor","Style","List"];for(var s in t){var _=o[s];if("?"===t[s]&&_&&a.includes(_)&&(this.event_bus.warning.runtime.send({error:this.ohno.warning.procedure_parameter_illegal(n.__assign(n.__assign(n.__assign(n.__assign({},this.get_catastrophe_dict()),{procedure_id:e,source_entity_id:i}),this.getParameterFiledOrInput(_,s)),{current_frame:{proc_id:this.current_frame.proc_id,proc_call_bid:this.current_frame.proc_call_bid,proc_parameters:this.current_frame.proc_parameters}}))}),t[s]=NaN),p.validate(t[s])){var c=this.run_mgr.get_style(t[s]),u=this.run_mgr.get_audio(t[s]),d=this.run_mgr.get_variable(t[s],this.original_identities.interpreter_id,this.original_identities.target_entity,null);null!==d&&"Variable"===_&&(t[s]=d),void 0!==c&&"Style"===_&&(t[s]=c),void 0!==u&&"Audio"===_&&(t[s]=u)}}},t.prototype.eval_procedures_defnoreturn=function(){var t=this.current_block;return this.eval_child_or_done(t,r.EvalChild)},t.prototype.eval_procedures_parameter=function(){if(this.program_state.proc_stack.length<2)throw this.ohno.user.procedure_parameter_outside(n.__assign({},this.get_catastrophe_dict()));var t=this.current_block;if(this.needs_eval_params()){var e=this.eval_params();if(void 0!=e)return e}var i=this.get_block_state(t.id).param_meta,o=i.args.param_name||"",a=this.current_frame.proc_parameters;if(o in a==0)throw this.ohno.user.procedure_no_such_parameter(n.__assign(n.__assign({},this.get_catastrophe_dict()),{args:i.args,param_name:o}));var s=a[o];if(void 0==s)throw this.ohno.user.proc_parameter_without_value(n.__assign(n.__assign({},this.get_catastrophe_dict()),{args:i.args,param_name:o}));return{kind:r.Done,value:s,has_value:!0,never_needs_to_yield:!1}},t.prototype.eval_procedures_return_value=function(){var t=this.current_block;if(this.needs_eval_params()){var e=this.eval_params();if(void 0!=e)return e}var i=this.get_block_state(t.id).param_meta.args.VALUE;return{kind:r.ProcedureReturn,has_return_value:!0,return_value:i}},t.prototype.eval_sync_tell=function(){var t=this.current_block,e=this.get_block_state(t.id),i=t.child_block[0];if(void 0==i)return g;if(b(e,"has_told",!1))return this.current_frame.target_entity_id=e.previous_target,g;if(this.needs_eval_params()){var n=this.eval_params();if(void 0!=n)return n}var o=e.param_meta.args.sprite;return 0==this.ensure_tell_target_ok(this.current_block.id,o)?g:(e.previous_target=this.current_frame.target_entity_id,e.has_told=!0,this.current_frame.target_entity_id=o,{kind:r.EvalTell,async:!1,block:i})},t.prototype.eval_async_tell=function(){var t=this,e=this.current_block;if(e===this.root_block.parent_block)return r.Finish;var i=this.get_block_state(e.id),n=e.child_block[0];if(void 0==n)return g;if(this.needs_eval_params()){var o=this.eval_params();if(void 0!=o)return o}var a=i.param_meta.args.sprite;return 0==this.ensure_tell_target_ok(this.current_block.id,a)||(this.run_mgr.spawn_async_tell_interpreter({typeclass_id:this.original_identities.typeclass_id,interpreter_id:this.original_identities.interpreter_id,target_entity:this.current_frame.target_entity_id,source_map_entity:this.current_frame.source_map_entity,source_map_rbid:this.current_frame.source_map_rbid},a,n,this.metadata.group_id,this.is_inside_warp()),this.run_mgr.get_clones_of_entity(a).forEach((function(e){t.run_mgr.spawn_async_tell_interpreter({typeclass_id:t.original_identities.typeclass_id,interpreter_id:t.original_identities.interpreter_id,target_entity:t.current_frame.target_entity_id,source_map_entity:t.current_frame.source_map_entity,source_map_rbid:t.current_frame.source_map_rbid},e,n,t.metadata.group_id,t.is_inside_warp())}))),g},t.prototype.ensure_tell_target_ok=function(t,e){var i=this.run_mgr.get_entity_state(e);if(this.tell_should_ensure_entity_exists){if(i==l.EntityState.Destructing)return this.run_mgr.report_warning(this.ohno.warning.tell_with_destructing_entity({root_block_id:this.current_frame.source_map_rbid,entity_id:this.current_frame.source_map_entity,block_id:t,tell_entity:e})),!1;if(i==l.EntityState.Disposed)return this.run_mgr.report_warning(this.ohno.warning.tell_with_disposed_entity({root_block_id:this.current_frame.source_map_rbid,entity_id:this.current_frame.source_map_entity,block_id:t,tell_entity:e})),!1;if(i==l.EntityState.Unknown)throw this.ohno.user.tell_with_unknown_entity(n.__assign(n.__assign({},this.get_catastrophe_dict()),{tell_entity:e}))}return!0},t.prototype.eval_warp=function(){var t=this.current_block,e=t.child_block[0];if(void 0==e)return f;var i=this.get_block_state(t.id);return b(i,"has_run_child",!1)?(this.current_frame.n_warp_parents-=1,f):(i.has_run_child=!0,this.current_frame.n_warp_parents+=1,{kind:r.EvalWarp,block:e})},t.prototype.eval_domain=function(){var t=this,e=this.current_block,i=this.get_block_state(e.id),o=b(i,"domain_function",e.type);if(d.ATOMIC_BLOCKS[o])return{kind:r.Done,has_value:!0,value:e.params[Object.keys(e.params)[0]],never_needs_to_yield:!0};if(this.needs_eval_params()){var a=this.eval_params();if(void 0!=a)return a}var s,_=i.param_meta.args,c=b(i,"waiting_on_promise",!1),u=b(i,"promise_resolved",!1),p=b(i,"promise_result",void 0);if(c)return 0==u?r.Yield:{kind:r.Done,has_value:!0,value:p,never_needs_to_yield:!1};if(void 0==this.domain_functions[o])throw this.ohno.system.missing_domain_function(n.__assign({},this.get_catastrophe_dict()));try{if(w(e))this.run_mgr.get_clones_of_entity(this.current_frame.target_entity_id).forEach((function(e){t.domain_functions[o](_,t.original_identities.interpreter_id,e,{runtime_manager:t.run_mgr,add_user_procedure_call_to_stack:function(e,i,r){t.push_onto_proc_stack(e,r,i,t.current_block.id)},get_action_parameter:function(e){if(void 0==t.action_parameters)throw t.ohno.system.unknown_system_error({message:'Could not get parameter in test block "test action parameter"'});return t.action_parameters[e]},create_domain_function_error:function(e){var i={client_annotation:e};return void 0!=e.native_error?t.ohno.client.domain_function_error(e.native_error,i):t.ohno.client.domain_function_error(i)}},t.current_block.id,{proc_id:t.current_frame.proc_id||"",proc_call_bid:t.current_frame.proc_call_bid||"",proc_parameters:t.current_frame.proc_parameters})}));s=this.domain_functions[o](_,this.original_identities.interpreter_id,this.current_frame.target_entity_id,{runtime_manager:this.run_mgr,add_user_procedure_call_to_stack:function(e,i,r){t.push_onto_proc_stack(e,r,i,t.current_block.id)},get_action_parameter:function(e){if(void 0==t.action_parameters)throw t.ohno.system.unknown_system_error({message:'Could not get parameter in test block "test action parameter"'});return t.action_parameters[e]},create_domain_function_error:function(e){var i={client_annotation:e};return void 0!=e.native_error?t.ohno.client.domain_function_error(e.native_error,i):t.ohno.client.domain_function_error(i)}},this.current_block.id,{proc_id:this.current_frame.proc_id||"",proc_call_bid:this.current_frame.proc_call_bid||"",proc_parameters:this.current_frame.proc_parameters})}catch(g){throw this.extend_domain_function_call_error(g,e.id,e.type,this.current_frame.source_map_rbid,this.current_frame.source_map_entity)}if(void 0!=s&&Promise.resolve(s)===s){i.waiting_on_promise=!0;var l=this.current_frame.target_entity_id,h=this.run_mgr.get_thread_lock(l,this.original_identities.interpreter_id),f=this.run_mgr;return s.then(function(t){i.promise_resolved=!0,i.promise_result=t,h.stop()}.bind(this),function(i){var r=t.extend_domain_function_call_error(i,e.id,e.type,t.current_frame.source_map_rbid,t.current_frame.source_map_entity);f.report_error_and_stop(r,"OptiRunner domain function promise result handler")}.bind(this)),r.Yield}return void 0==s&&"lists_get_value"==e.type&&this.util.config.get().legacy.lists_get_value_allow_return_undefined?{kind:r.Done,value:void 0,has_value:!0,never_needs_to_yield:!1}:{kind:r.Done,value:s,has_value:void 0!=s,never_needs_to_yield:!1}},t.prototype.needs_eval_params=function(){var t=this.current_block,e=Object.keys(t.params);if(0==t.params.length)return!1;var i=this.get_block_state(t.id),r=i.param_meta;return null==r||void 0==r?(this.deterministic&&(e=a(e,s)),r={keys:e,n_keys:e.length,n_done:0,values:[],waiting_for_value:!1,args:{}},i.param_meta=r,!0):r.n_keys>=r.n_done},t.prototype.eval_params=function(){var t=this.current_block,e=this.get_block_state(t.id).param_meta;if(e.waiting_for_value){var i=this.consume_previous_expression_value(),o=i.value;if(0==i.has_value)throw this.ohno.user.procedure_used_return_undefined(n.__assign({},this.get_catastrophe_dict()));e.values.push(o),e.waiting_for_value=!1,e.n_done+=1}for(;;){if(e.n_keys<=e.n_done){for(var a=0;a<e.n_keys;a++){var s=e.keys[a],_=e.values[a];e.args[s]=_}return}var c=e.keys[e.n_done],u=t.params[c];if(this.util.block.is.compiled_block(u)&&u.disabled){var p={};if("traverse_number_value"===u.type&&this.current_frame.proc_call_bid&&(p.proc_id=this.current_frame.proc_id,p.proc_call_bid=this.current_frame.proc_call_bid),"get_answer"===u.type||"get_choice_and_index"===u.type)throw this.ohno.compiler.user.unsupported_in_scene(new Error,n.__assign({},this.get_catastrophe_dict(u)));throw this.ohno.compiler.user.disabled_param(new Error,n.__assign(n.__assign({},this.get_catastrophe_dict(u)),p))}var d=this.get_value(u,t);if(void 0==d)return e.waiting_for_value=!0,{kind:r.EvalArg,block:u};e.values.push(d),e.n_done+=1}},t.prototype.next_block=function(){var t=this.current_block;return void 0!=t.next_block?t.next_block:void 0!=t.parent_block?t.parent_block:void 0},t.prototype.must_yield=function(){return this.run_mgr.current_interpreter_must_yield(this.original_identities.interpreter_id,this.metadata.group_id)},t.prototype.go_next_or_parent=function(){var t=this.next_block();return void 0!=t&&(this.current_frame.current_block=t,this.current_block=t,!0)},t.prototype.pop_stack_or_finish=function(){return this.program_state.proc_stack.pop(),void 0!=m(this.program_state.proc_stack)},t.prototype.get_block_state=function(t){var e=this.current_frame.dynamic_data[t];return void 0==e&&(e={},this.current_frame.dynamic_data[t]=e),e},t.prototype.reset_subtree_state=function(t){for(var e=this.util.block.ast_block_ids(t),i=0;i<e.length;i++){var r=e[i];this.current_frame.dynamic_data[r]={}}},t.prototype.consume_previous_expression_value=function(){if(0==this.program_state.has_expression_return_value)return{has_value:!1,value:void 0};this.program_state.has_expression_return_value=!1;var t=this.program_state.expression_return_value;return this.program_state.expression_return_value=void 0,{has_value:!0,value:t}},t.prototype.get_current_stack=function(){for(var t=this.program_state.proc_stack,e=[],i=0;i<t.length;i++){var r=t[i];e.push({interpreter_id:this.original_identities.interpreter_id,source_entity_id:r.source_map_entity,source_map_rbid:r.source_map_rbid,block_id:r.current_block.id,proc_parameters:o(r.proc_parameters),proc_id:r.proc_id===h?void 0:r.proc_id})}return e},t.prototype.get_catastrophe_dict=function(t){var e=t||this.current_block;return{source_map_rbid:this.current_frame.source_map_rbid,source_entity_id:this.current_frame.source_map_entity,block:e,block_id:void 0==e?void 0:e.id,block_type:void 0==e?void 0:e.type}},t.prototype.empty_state=function(t,e){return{proc_stack:[this.empty_stack_frame(h,t,this.root_block,e)],proc_stack_changed:!1,has_expression_return_value:!1,expression_return_value:void 0,proc_has_return_value:!1,proc_return_value:void 0}},t.prototype.empty_stack_frame=function(t,e,i,r,n,o,a,s){for(var _=this.util.block.ast_block_ids(i),c={},u=0;u<_.length;u++){c[_[u]]={}}return{proc_id:t,proc_parameters:n||{},root_block:i,current_block:i,dynamic_data:{},target_entity_id:e,source_map_entity:o||this.original_identities.source_map_entity,source_map_rbid:a||this.original_identities.source_map_rbid,proc_call_bid:s,is_warped:r,n_warp_parents:0}},t.prototype.extend_domain_function_call_error=function(t,e,i,r,n){var o={block_id:e,block_type:i,source_map_rbid:r,source_entity_id:n,interpreter_id:this.original_identities.interpreter_id,interpreter_stack:this.get_current_stack()};return t instanceof u.Catastrophe?(t.annotation=t.annotation||{},c(t.annotation,o),t):this.ohno.system.unknown_error_in_domain_function_call(t,o)},t}();function m(t){if(0!=t.length)return t[t.length-1]}function v(t,e){return e}function b(t,e,i){var r=t[e];return void 0==r?(t[e]=i,i):r}function w(t){return"sync_tell"===t.type||!!t.parent_block&&w(t.parent_block)}e.DebugRunner=y},76715:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},71962:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.BINDING={BlockUtil:"BlockUtil",Config:"Config",Log:"Log",Ohno:"Ohno",Util:"Util",ActionStateStore:"ActionStateStore",BlockPool:"BlockPool",OptiFramePool:"OptiFramePool",BlockPredicates:"BlockPredicates",Broadcasts:"Broadcasts",Clock:"Clock",XMLParser:"XMLParser",XMLEntityCompiler:"XMLEntityCompiler",JSONEntityCompiler:"JSONEntityCompiler",Compiler:"Compiler",EventBus:"EventBus",OptiCompiler:"OptiCompiler",OptiProgramCache:"OptiProgramCache",Registry:"Registry",RuntimeData:"RuntimeData",RuntimeManager:"RuntimeManager",RuntimeManagerFacade:"RuntimeManagerFacade",TaskManager:"TaskManager",ScriptStore:"ScriptStore",UserVariable:"UserVariable",Predicates:"Predicates",BasicBlockProviderFactory:"BasicBlockProviderFactory",BlockInterpreterFactory:"BlockInterpreterFactory",BlockXmlBuilderFactory:"BlockXmlBuilderFactory",EventBufferFactory:"EventBufferFactory",OptiRunnerFactory:"OptiRunnerFactory",DebugRunnerFactory:"DebugRunnerFactory",PRNGFactory:"PRNGFactory",DOMParser:"DOMParser",HtmlParser:"HtmlParser",DayNames:"DayNames"}},72495:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=new(i(22988).Catastrophic)("HEART.CATASTROPHIC");e.ohno={system:r.new_category({unique_code:"HEART.SYSTEM",description:"Internal heart errors not caused by users",default_http_code:500},{unknown_system_error:{unique_number:0},missing_domain_function:{unique_number:1,description:"No domain function of this type exists"},procedure_missing_call_timestamps:{unique_number:2},procedure_popped_empty_call_stack:{unique_number:3},popped_empty_variable_stack:{unique_number:4},undefined_or_null_block:{unique_number:5,description:"Tried to run an undefined or null block"},procedure_can_not_find_yielding_ancestor:{unique_number:6},unhandled_run_block_result:{unique_number:7,description:"Called run_block but did not properly handle a possible result type."},action_received_without_spec:{unique_number:8,description:"Received an Action with namespace and id that have no associated registered ActionSpec."},state_query_received_without_spec:{unique_number:9,description:"Received a State Query with namespace and id that have no associated registered ActionSpec."},state_query_for_non_stateful_action:{unique_number:10,description:"Attempted to get State for an Action type that is not stateful."},unknown_error_in_domain_function_call:{unique_number:11},unknown_action_block_param_type:{unique_number:12},feature_not_available_in_debug_mode:{unique_number:13},called_set_variable_without_needed_parameters:{unique_number:14,description:"If your variable's scope is 'script', you must provide an interpreter_id. If scope is 'entity' then entity_id must be provided."},called_get_variable_without_needed_parameters:{unique_number:15,description:"If your variable's scope is 'script', you must provide an interpreter_id. If scope is 'entity' then entity_id must be provided."},stack_overflow:{unique_number:16,description:"Maximum call stack size exceeded"},called_opt_safe_static_with_strange_value:{unique_number:17,description:"Values passed to opt_safe_static must be a string, number or boolean."},looked_at_wall_clock_in_deterministic_mode:{unique_number:18,description:"This breaks determinism. Find another way."}}),user:r.new_category({unique_code:"HEART.USER",description:"Runtime errors caused by users",default_http_code:400},{unknown_user_error:{unique_number:0},procedure_no_such_parameter:{unique_number:1,description:"A procedure parameter not belonging to this procedure was used"},procedure_parameter_outside:{unique_number:2,description:"A procedure parameter block was used outside of a procedure"},procedure_return_outside:{unique_number:3,description:"The procedure return block was used outside of a procedure"},procedure_return_empty:{unique_number:4,description:"The procedure return block must not be empty"},error_constructing_value_from_atomic_block:{unique_number:5},unknown_run_block_error:{unique_number:6,description:"Unknown error when attempting to run a block"},block_bad_math_expression:{unique_number:7,description:"User used a bad expression in the calculate block"},break_with_bad_parent:{unique_number:8,description:"A break block was used outside of a looping block"},undefined_code_path_argument:{unique_number:9,description:"This execution path should be impossible, argument is calling a child"},lists_get_value_bad_index:{unique_number:10,description:"The user attempted to access a list index that either didn't exist or contained an undefined value"},tell_with_unknown_entity:{unique_number:11,description:"The user attempted to tell an entity to do something, but no such entity is known"},entity_variable_operation_out_of_scope:{unique_number:12,description:"The user attempted to get or set an entity variable with blocks of other entity"},clone_unknown_entity:{unique_number:13,description:"The user attempted to clone an entity, but no such entity is known"},proc_parameter_without_value:{unique_number:14,description:"The user attempted to use a procedure parameter that had no value."},call_undefined_procedure:{unique_number:15,description:"The user attempted to call a procedure that is not defined."},procedure_not_return_all_branches:{unique_number:16,description:"The user did not return in all branches"},procedure_used_return_undefined:{unique_number:17,description:"The user tried to use a return value from a procedure that didn't return any value."}}),warning:r.new_category({unique_code:"HEART.WARNING",description:"Warnings caused by user code",default_http_code:400},{tell_with_disposed_entity:{unique_number:0,description:"The user attempted to tell a disposed entity to do something"},clone_with_disposed_entity:{unique_number:1,description:"The user attempted to clone an entity after disposed it"},tell_with_destructing_entity:{unique_number:2,description:"The user attempted to tell a destructing entity to do something"},entity_has_no_known_typeclass:{unique_number:3,description:"The system tried to do something with an entity, but that entity had no associated typeclass"},broadcast_with_no_listener:{unique_number:4,description:"There's at least one broadcast with no listener"},tried_to_break_outside_of_loop:{unique_number:5,description:"Tried using the break (Quit loop) block outside a loop"},block_parameter_illegal:{unique_number:6,description:"A block parameter got an illegal value"},procedure_parameter_illegal:{unique_number:7,description:"A block parameter got an illegal value"},disabled_param:{unique_number:8,description:"There is a disabled expression in code"}}),compiler:{system:r.new_category({unique_code:"HEART.COMPILER.SYSTEM",description:"Compilation errors caused by Heart or Client setups",default_http_code:500},{unknown_procedure_block_type:{unique_number:0,description:"Entered procedure_to_json without matching data.type"},procedure_name_not_string:{unique_number:1,description:"Given procedure block's NAME param was not name"},procedure_call_name_not_string:{unique_number:2,description:"Given procedure call block's NAME param was not name"},unknown_compiler_error:{unique_number:3,description:"Unknown compiler error, sorry"},unknown_expression:{unique_number:4,description:"Optimizing compiler reached an unknown expression"},constructed_bad_javascript:{unique_number:5,description:"Optimizing compiler constructed invalid javascript"},popped_empty_yield_reset_stack:{unique_number:6,description:"Optimizing compiler popped empty yield reset stack"},popped_empty_yield_group_stack:{unique_number:7,description:"Optimizing compiler popped empty yield group stack"},could_not_find_root_block:{unique_number:8,description:"Optimizing compiler could not find root block of another block"},could_not_find_procedure_parameter_name:{unique_number:9,description:"Optimizing compiler could not find the name of a procedure parameter"},if_dropdown_condition_not_string:{unique_number:10,description:"Given IfDropdownBlock condition was malformed"}}),user:r.new_category({unique_code:"HEART.COMPILER.USER",description:"Compilation errors caused by Users",default_http_code:400},{tried_to_break_outside_of_loop:{unique_number:0,description:"Tried using the break (Quit loop) block outside a loop"},procedure_parameter_outside:{unique_number:1,description:"A procedure parameter block was used outside of a procedure"},procedure_return_empty:{unique_number:2,description:"The procedure return block must not be empty"},error_constructing_value_from_atomic_block:{unique_number:3},procedure_no_such_parameter:{unique_number:4,description:"A procedure parameter not belonging to this procedure was used"},procedure_return_outside:{unique_number:5,description:"The procedure return block was used outside of a procedure"},defined_multiple_constructors:{unique_number:6,description:"Multiple constructors were defined for a single entity typeclass. Only zero or one is allowed."},defined_multiple_destructors:{unique_number:7,description:"Multiple destructors were defined for a single entity typeclass. Only zero or one is allowed."},disabled_param:{unique_number:8,description:"There is a disabled expression in code"},json_compiler_invalid_block:{unique_number:9,description:"Trying to compile a block not in workspace_json.blocks"},unsupported_in_scene:{unique_number:10,description:"There is a unsupported block in scene"}}),warning:r.new_category({unique_code:"HEART.COMPILER.WARNING",description:"Compilation warnings caused by users or setup",default_http_code:400},{json_compiler_multi_children_on_one_connection:{unique_number:0,description:"There're more than one block on same connection. "}})},configuration:r.new_category({unique_code:"HEART.CONFIGURATION",description:"Configuration errors, caused by the Client's attempt to configure or set up Heart",default_http_code:500},{tried_to_change_user_debug_mode_while_running:{unique_number:0,description:"Tried to change user_debug_mode while running. Heart does not allow this."}}),client:r.new_category({unique_code:"HEART.CLIENT",description:"Errors created and thrown by the client environment",default_http_code:500},{domain_function_error:{unique_number:0,description:"Error which ocurred within a domain function"},ast_linter_error:{unique_number:1,description:"Error which ocurred within ast lint"},missing_block_xml_error:{unique_number:2,description:"Tried to add to a Toolbox a block without an XML definition"},duplicate_entity_id:{unique_number:3,description:"Tried to create two Entity instances with the same entity_id."},missing_typeclass:{unique_number:4,description:"Tried to create an Entity with an unregistered typeclass_id"},registry_misconfiguration:{unique_number:5,description:"Client registered a combination of things that will either break Heart or not work as they intend."},missing_domain_function:{unique_number:6,description:"No domain function of this type exists"},ast_linter_warning:{unique_number:7,description:"Warning which ocurred within ast lint"}})}},12786:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(69742);e.create_variable_neko=function(){var t=r.util.merge_event_buffers(r.builtin.event_ebs(),{merged:r.event_buffer.create({reducer:function(t,e){return t[e.var_id]=e.new_value,t},start_value:{}})});return r.neko.create_for_event(t)},e.create_list_neko=function(){var t=r.util.merge_event_buffers(r.builtin.event_ebs(),{merged:r.event_buffer.create({reducer:function(t,e){return t[e.list_id]=e.new_value,t},start_value:{}})});return r.neko.create_for_event(t)},e.create_entity_variable_neko=function(){var t=r.util.merge_event_buffers(r.builtin.event_ebs(),{merged:r.event_buffer.create({reducer:function(t,e){return void 0===t[e.entity_id]&&(t[e.entity_id]={}),t[e.entity_id][e.var_id]=e.new_value,t},start_value:{}})});return r.neko.create_for_event(t)},e.create_entity_list_neko=function(){var t=r.util.merge_event_buffers(r.builtin.event_ebs(),{merged:r.event_buffer.create({reducer:function(t,e){return void 0===t[e.entity_id]&&(t[e.entity_id]={}),t[e.entity_id][e.list_id]=e.new_value,t},start_value:{}})});return r.neko.create_for_event(t)}},26460:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(69742);function n(){var t,e=r.event_bus.categorized({error:r.event_bus.create({runtime:r.builtin.event(),all:r.builtin.event()}),warning:r.event_bus.create({runtime:r.builtin.event(),all:r.builtin.event()}),runtime_manager:r.event_bus.create({after_update:r.builtin.signal(),before_update:r.builtin.signal(),restart:r.builtin.signal(),stop:r.builtin.signal(),start:r.builtin.signal(),idle:r.builtin.signal(),disable_interpreters_restart:r.builtin.signal()}),runtime_data:r.event_bus.create({variable_update:a.create_variable_neko(),list_update:a.create_list_neko(),entity_variable_update:a.create_entity_variable_neko(),entity_list_update:a.create_entity_list_neko(),entity_dispose:r.builtin.event(),block_run_result:r.builtin.event(),block_running:r.builtin.event(),block_finished:r.builtin.event()}),system:r.event_bus.create({config_updated:r.builtin.signal()}),clones:r.event_bus.create({dispose_clone:r.builtin.event()})});return(t=e).runtime_manager.after_update.immediate.sub((function(){t.error._meta.flush(),t.warning._meta.flush(),t.runtime_manager._meta.flush(),t.runtime_data._meta.flush(),t.system._meta.flush(),t.clones._meta.flush()})),function(t){t.error.runtime.immediate.sub((function(e){t.error.all.send({error:e.error})})),t.warning.runtime.immediate.sub((function(e){t.warning.all.send({error:e.error})}))}(e),e}function o(t){var e=r.util.builtin_event_as_public,i=r.util.builtin_signal_as_public;return{error:{runtime:e(t.error.runtime),all:e(t.error.all)},warning:{runtime:e(t.warning.runtime),all:e(t.warning.all)},runtime_manager:{after_update:i(t.runtime_manager.after_update),before_update:i(t.runtime_manager.before_update),restart:i(t.runtime_manager.restart),stop:i(t.runtime_manager.stop),start:i(t.runtime_manager.start),idle:i(t.runtime_manager.idle),disable_interpreters_restart:i(t.runtime_manager.disable_interpreters_restart)},runtime_data:{variable_update:{merged:t.runtime_data.variable_update.merged,last:t.runtime_data.variable_update.last,list:t.runtime_data.variable_update.list,immediate:t.runtime_data.variable_update.immediate},list_update:{merged:t.runtime_data.list_update.merged,last:t.runtime_data.list_update.last,list:t.runtime_data.list_update.list,immediate:t.runtime_data.list_update.immediate},entity_variable_update:{merged:t.runtime_data.entity_variable_update.merged,last:t.runtime_data.entity_variable_update.last,list:t.runtime_data.entity_variable_update.list,immediate:t.runtime_data.entity_variable_update.immediate},entity_list_update:{merged:t.runtime_data.entity_list_update.merged,last:t.runtime_data.entity_list_update.last,list:t.runtime_data.entity_list_update.list,immediate:t.runtime_data.entity_list_update.immediate},entity_dispose:e(t.runtime_data.entity_dispose),block_running:e(t.runtime_data.block_running),block_finished:e(t.runtime_data.block_finished),block_run_result:e(t.runtime_data.block_run_result)}}}e.create_event_bus=n,e.as_public_event_bus=o;var a=i(12786);e.DO_NOT_USE__TYPE_INFERENCE_HACK__EB=n(),e.DO_NOT_USE__TYPE_INFERENCE_HACK__EB_PUB=o(n())},71841:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},75337:function(t,e,i){var r=i(94379);i(22988).Catastrophe;var n=i(26460),o=i(21590),a=i(71962);i(15637);var s=i(84877);e.Cv=s,i(71841),i(88073),i(79224);var _=function(){function t(t){var e=this;this.spec=t,this.create_ast_linter_error=function(t){var i=e.container.get(a.BINDING.Util),r={client_annotation:t};return void 0!=t.native_error?i.ohno.client.ast_linter_error(t.native_error,r):i.ohno.client.ast_linter_error(r)},this.create_ast_linter_warning=function(t){var i=e.container.get(a.BINDING.Util),r={client_annotation:t};return void 0!=t.native_error?i.ohno.client.ast_linter_warning(t.native_error,r):i.ohno.client.ast_linter_warning(r)};var i=t.basic_blocks_requirements,r=t.compiler_requirements,n=t.configuration,s=t.logger;if(void 0==s){var _=console.warn.bind(console),c=console.error.bind(console),u=console.log.bind(console);s={fatal:c,error:c,warn:_,info:u,debug:u,trace:u}}var p=n||{};if(p.deterministic&&void 0!==p.warp_interpreter_millisecond_time_limit)throw new Error("Configuration error! Can't use warp_interpreter_millisecond_time_limit in deterministic mode");this.container=o.get_instance({configuration:p,basic_blocks_requirements:i,compiler_requirements:r,logger:s})}return t.prototype.get_event_bus=function(){return void 0==this.event_bus&&(this.event_bus=n.as_public_event_bus(this.container.get(a.BINDING.EventBus))),this.event_bus},t.prototype.get_compiler=function(){if(void 0==this.compiler){if(void 0==this.spec.compiler_requirements)return r.fail("Heart compiler requirements unfulfilled, cannot get compiler");this.compiler=this.container.get(a.BINDING.Compiler)}return r.success(this.compiler)},t.prototype.get_util=function(){return void 0==this.util&&(this.util=this.container.get(a.BINDING.Util)),this.util},t.prototype.get_runtime_data=function(){return void 0==this.runtime_data&&(this.runtime_data=this.container.get(a.BINDING.RuntimeData)),this.runtime_data},t.prototype.get_registry=function(){return void 0==this.registry&&(this.registry=this.container.get(a.BINDING.Registry)),this.registry},t.prototype.get_runtime_manager=function(){return void 0==this.runtime_manager&&(this.runtime_manager=this.container.get(a.BINDING.RuntimeManagerFacade)),this.runtime_manager},t.prototype.basic_blocks=function(){void 0==this.basic_block_provider_factory&&(this.basic_block_provider_factory=this.container.get(a.BINDING.BasicBlockProviderFactory));var t=this.basic_block_provider_factory;return{load_domain_functions:function(){t.load_domain_functions()},load_linters:function(){t.load_linters()}}},t.prototype.create_domain_function_error=function(t){var e=this.container.get(a.BINDING.Util),i={client_annotation:t};return void 0!=t.native_error?e.ohno.client.domain_function_error(t.native_error,i):e.ohno.client.domain_function_error(i)},t.prototype.set_config=function(t){this.container.get(a.BINDING.Config).set(t)},t.prototype.lint=function(t,e){void 0===e&&(e=[]);for(var i=[],r=[],n=this.container.get(a.BINDING.BlockUtil),o=this.container.get(a.BINDING.Registry).get_ast_linters().concat(e),s=0;s<o.length;s++)for(var _=0,c=(0,o[s])(t,n,this.create_ast_linter_error,this.create_ast_linter_warning);_<c.length;_++){var u=c[_],p="HEART.WARNING"==u.category.unique_code,d="HEART.CLIENT"==u.category.unique_code&&7==u.error.unique_number;p||d?r.push(u):i.push(u)}return{warnings:r,errors:i}},t.prototype.get_statistics=function(){return void 0==this.real_runtime_manager&&(this.real_runtime_manager=this.container.get(a.BINDING.RuntimeManager)),{n_entities:this.real_runtime_manager.get_n_entities(),n_interpreters:this.real_runtime_manager.get_n_interpreters()}},t}();e.tm=function(t){return new _(t)}},56612:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(66933),o=i(93613),a=i(2100),s=i(65127),_=i(30298),c=i(26769),u=i(64286),p=i(22988),d=i(43180),l=(i(76715),i(71962));function h(t){if(0!=t.length)return t[t.length-1]}var f={ohno:"X.AA",call_domain_function:"X.AB",report_sync_telling:"X.AC",async_tell:"X.AD",event_bus:"X.AE",runtime_data:"X.AF",default_target_entity_id:"X.BA",identities:"X.BB",static_data:"X.BC",proc_parameters:"X.CA",proc_return_value:"X.CB",proc_has_return_value:"X.CC",proc_do_return_value:"X.CD",proc_yield_after_call:"X.CE",dynamic_data:"X.DA",program_counter:"X.DB",current_frame:"X.DC",proc_call:"X.EA",before_expression:"X.EB",after_potential_blocker:"X.EC",increment_program_counter:"X.ED",reset_program_counter:"X.EE",after_iteration:"X.EF",finished:"X.EG"},g={ohno:"X.ohno",call_domain_function:"X.call_domain_function",report_sync_telling:"X.report_sync_telling",async_tell:"X.async_tell",event_bus:"X.event_bus",runtime_data:"X.runtime_data",default_target_entity_id:"X.default_target_entity_id",identities:"X.identities",static_data:"X.static_data",proc_parameters:"X.proc_parameters",proc_return_value:"X.proc_return_value",proc_has_return_value:"X.proc_has_return_value",proc_do_return_value:"X.proc_do_return_value",proc_yield_after_call:"X.proc_yield_after_call",dynamic_data:"X.dynamic_data",program_counter:"X.program_counter",current_frame:"X.current_frame",proc_call:"X.proc_call",before_expression:"X.before_expression",after_potential_blocker:"X.after_potential_blocker",increment_program_counter:"X.increment_program_counter",reset_program_counter:"X.reset_program_counter",after_iteration:"X.after_iteration",finished:"X.finished"},y=function(){function t(t,e,i,r){this.ohno=t,this.source_map_entity=e,this.source_map_rbid=i,this.pretty_print_symbols=r,this.current_yield_group=0,this.top_yield_group_id=0,this.top_yield_ids={0:0},this.yield_group_stack=[],this.break_yield_reset_stack=[[]],this.tell_entity_target_stack=[],this.top_break_id=0,this.break_id_stack=[],this.n_warp_block_parents=0,this.top_parameter_id=0,this.top_static_data_id=0,this.async_tell_asts={},this.keyword=r?g:f,this.static_data=r?{}:[]}return t.prototype.gen_parameter_symbol=function(t){return this.top_parameter_id++,(this.pretty_print_symbols?t:"")+this.top_parameter_id},t.prototype.set_static=function(t,e){if(this.top_static_data_id++,this.pretty_print_symbols){var i=[t,this.top_static_data_id].join("");return this.static_data[i]=e,i}return this.static_data[this.top_static_data_id]=e,this.top_static_data_id.toString()},t.prototype.get_static_data=function(){return this.static_data},t.prototype.dynamic_data_size=function(){return this.top_parameter_id+1},t.prototype.push_yield_level=function(t){this.yield_group_stack.push(this.current_yield_group),this.top_yield_group_id++;var e=this.top_yield_group_id;this.current_yield_group=e,this.top_yield_ids[e]=0;var i=h(this.break_yield_reset_stack);if(void 0==i)throw this.ohno.compiler.system.popped_empty_yield_reset_stack({block:t});return i.push(e),["switch (",this.keyword.program_counter,"[",e.toString(),"]) {case 0:"]},t.prototype.pop_yield_level=function(t){var e=this.yield_group_stack.pop();if(void 0==e)throw this.ohno.compiler.system.popped_empty_yield_group_stack({block:t});this.current_yield_group=e;var i=h(this.break_yield_reset_stack);if(void 0==i)throw this.ohno.compiler.system.popped_empty_yield_group_stack({block:t});return i.pop(),"}"},t.prototype.push_breakable=function(){this.break_yield_reset_stack.push([]);var t="B"+this.top_break_id++;return this.break_id_stack.push(t),t},t.prototype.pop_breakable=function(){this.break_id_stack.pop(),this.break_yield_reset_stack.pop()},t.prototype.get_current_break_reset_statements=function(t){var e=h(this.break_yield_reset_stack);if(void 0==e)throw this.ohno.compiler.system.popped_empty_yield_reset_stack({block:t});for(var i=[],r=0;r<e.length;r++){var n=e[r];i.push(this.keyword.program_counter,"[",n.toString(),"] = 0;")}return i},t.prototype.push_target_entity=function(t){this.tell_entity_target_stack.push(t)},t.prototype.pop_target_entity=function(){this.tell_entity_target_stack.pop()},t.prototype.current_target_entity=function(){var t=h(this.tell_entity_target_stack);return void 0==t?this.keyword.default_target_entity_id:t},t.prototype.get_tell_entity_target_stack=function(){return this.tell_entity_target_stack},t.prototype.current_break_id=function(t){return h(this.break_id_stack)},t.prototype.create_yield_point=function(){this.top_yield_ids[this.current_yield_group]++;var t=this.top_yield_ids[this.current_yield_group];return[this.keyword.increment_program_counter,"('",this.source_map_entity,"', '",this.source_map_rbid,"', ",this.current_yield_group.toString(),", ",t.toString(),"); case ",t.toString(),": "]},t.prototype.create_before_expression_yield_point=function(t){this.top_yield_ids[this.current_yield_group]++;var e=this.top_yield_ids[this.current_yield_group];return["if (",this.keyword.before_expression,"('",t.id,"', '",this.source_map_entity,"', '",this.source_map_rbid,"', ",this.current_yield_group.toString(),", ",e.toString(),")) { return; }","case ",e.toString(),": "]},t.prototype.create_after_potential_blocker_yield_point=function(t){this.top_yield_ids[this.current_yield_group]++;var e=this.top_yield_ids[this.current_yield_group];return["if (",this.keyword.after_potential_blocker,"('",t.id,"', '",this.source_map_entity,"', '",this.source_map_rbid,"', ",this.current_yield_group.toString(),", ",e.toString(),")) { return; }","case ",e.toString(),": "]},t.prototype.create_iteration_yield_point=function(){return["if (",this.keyword.after_iteration,"(",this.is_inside_warp().toString(),")) { return; }"]},t.prototype.create_yield_reset_point=function(){return[this.keyword.reset_program_counter,"('",this.source_map_entity,"', '",this.source_map_rbid,"', ",this.current_yield_group.toString(),");"]},t.prototype.create_procedure_yield_point=function(){this.top_yield_ids[this.current_yield_group]++;var t=this.top_yield_ids[this.current_yield_group];return[this.keyword.proc_yield_after_call,"(",this.current_yield_group.toString(),", ",t.toString(),"); return;","case ",t.toString(),": "]},t.prototype.get_n_yield_groups=function(){return 1+this.top_yield_group_id},t.prototype.add_async_tell_ast=function(t){this.async_tell_asts[t.id]=t},t.prototype.get_async_tell_asts=function(){return this.async_tell_asts},t.prototype.is_inside_warp=function(){return this.n_warp_block_parents>=1},t.prototype.enter_warp_block=function(){this.n_warp_block_parents++},t.prototype.exit_warp_block=function(){this.n_warp_block_parents--},t}(),m=function(){function t(t,e,i,r,n,o,a,s,_){var c=this;this.block_pool=t,this.event_bus=e,this.log=i,this.ohno=r,this.prng_factory=n,this.u=o,this.block=a,this.config=s,this.registry=_,this.params_block_dict={},this.deterministic=void 0!=o.config.get().deterministic;var u=function(){c.should_pretty_print=!1;var t=c.config.get().opti_compiler;void 0!=t&&(c.should_pretty_print=t.pretty_print),c.keyword=c.should_pretty_print?g:f};u(),this.event_bus.system.config_updated.immediate.sub(u)}return t.prototype.comment=function(t,e){if(void 0===e&&(e=!0),!this.should_pretty_print)return"";var i=e?"\n":"",r=JSON.stringify(t);return r=r.substring(1,r.length-2),i+"/* "+(r=t.replace(/\*\//,"{{{*./}}}"))+" */"+i},t.prototype.create_catch_all_error=function(t,e,i){var r={caught_at:t};return void 0!=i&&(r.block=i),e instanceof p.Catastrophe?(e.annotation=e.annotation||{},n(e.annotation,r),e):this.ohno.compiler.system.unknown_compiler_error(e,r)},t.prototype.compile=function(t,e,i,r){var a,s,_,c,u,d;try{this.state=new y(this.ohno,t,e,this.should_pretty_print);var l=this.compile_statement(r),h=this.wrap_with_top_level(l);a=o(h.statements).join(""),s=this.state.get_static_data(),_=this.state.dynamic_data_size(),c=this.state.get_n_yield_groups(),u=this.state.get_async_tell_asts()}catch(m){var f={block:r,interpreter_id:i,source_map_rbid:e,source_entity_id:t,proc_id:this.block.is.procedures_defnoreturn(r)?r.procedure_name:void 0};if(m instanceof p.Catastrophe){var g=m.annotation||{};throw n(g,f),void 0==g.block_id&&void 0!=g.block&&(g.block_id=g.block.id),void 0==g.block_type&&void 0!=g.block&&(g.block_type=g.block.type),m.annotation=g,m}throw this.ohno.compiler.system.unknown_compiler_error(m,f)}try{d=new Function("X",a)()}catch(m){throw this.ohno.compiler.system.constructed_bad_javascript(m,{root_block_id:e,entity_id:t,invalid_script:a})}return{script:d,static_data:s,dynamic_data_size:_,n_yield_groups:c,async_tell_asts:u,params_block_dict:this.params_block_dict}},t.prototype.wrap_with_top_level=function(t){var e=this.state.create_yield_point();return{statements:["return function optifun(X) {","switch (",this.keyword.program_counter,"[0]) {","case 0: ",t.statements,e,this.keyword.finished,"();","}}"]}},t.prototype.compile_statement=function(t){try{if(void 0==t)return{statements:""};var e=[];e.push(this.state.create_before_expression_yield_point(t));var i=!1,r=!1;if(t.disabled){if(void 0!=t.next_block&&0==r){var n=this.compile_statement(t.next_block);e.push(n.statements)}return{statements:e}}if(this.block.is.repeat_forever(t)){i=!0;n=this.compile_repeat_forever(t);e.push(n.statements)}else if(this.block.is.repeat_forever_until(t)){i=!0;n=this.compile_repeat_forever_until(t);e.push(n.statements)}else if(this.block.is.wait_until(t)){i=!0;n=this.compile_wait_until(t);e.push(n.statements)}else if(this.block.is.repeat_n_times(t)){i=!0;n=this.compile_repeat_n_times(t);e.push(n.statements)}else if(this.block.is.traverse_number(t)){i=!0;n=this.compile_traverse_number(t);e.push(n.statements)}else if(this.block.is.break(t)){n=this.compile_break(t);e.push(n.statements)}else if(this.block.is.procedures_defnoreturn(t)){var o=t.child_block[0];if(void 0==o)i=!0;else{n=this.compile_statement(o);e.push(n.statements)}}else if(this.block.is.procedures_callnoreturn(t)){n=this.compile_procedure_call(t);e.push(n.pre)}else if(this.block.is.cond_block(t)){i=!0;n=this.compile_conditional(t);e.push(n.statements)}else if(this.block.is.async_tell(t)){i=!0;n=this.compile_async_tell(t);e.push(n.statements)}else if(this.block.is.sync_tell(t)){i=!0;n=this.compile_sync_tell(t);e.push(n.statements)}else if(this.block.is.warp(t)){i=!0;n=this.compile_warp(t);e.push(n.statements)}else if(this.block.is.event_block(t)){i=!0;n=this.compile_event(t);e.push(n.statements)}else if(this.block.is.responder_block(t)){i=!0;n=this.compile_responder(t);e.push(n.statements)}else if(this.block.is.lifetime_responder_type(t.type)){i=!0;n=this.compile_responder(t);e.push(n.statements)}else if(this.block.is.procedures_return_value(t)){i=!0,r=!0;n=this.compile_procedure_return_value(t);e.push(n.statements)}else{n=this.compile_expression(t);e.push(n.pre),e.push(n.expr)}if(0!=e.length&&0==i&&e.push(";"),void 0!=t.next_block&&0==r){n=this.compile_statement(t.next_block);e.push(n.statements)}return{statements:e}}catch(a){throw this.create_catch_all_error("compile_statement",a,t)}},t.prototype.opt_safe_static=function(t){if(_(t)||c(t)||s(t))return JSON.stringify(t);throw this.ohno.system.called_opt_safe_static_with_strange_value({value:t})},t.prototype.static_is_safe=function(t){return void 0!=t&&null!=t&&(!!s(t)||(_(t)?t!=1/0&&!isNaN(t)&&t!=-1/0:!!c(t)&&this.u.misc.is_safe_string(t)))},t.prototype.compile_expression=function(t){if(t.disabled&&"traverse_number_value"!==t.type)throw"get_answer"===t.type||"get_choice_and_index"===t.type?this.ohno.compiler.user.unsupported_in_scene(new Error,{block:t}):this.ohno.compiler.user.disabled_param(new Error,{block:t});try{if(this.block.is.atomic_type(t.type)){var e=t.params[Object.keys(t.params)[0]];if(this.static_is_safe(e))return{pre:"",expr:this.opt_safe_static(e)};var i=this.state.set_static(t.type+"__"+t.id,e);return{pre:"",expr:this.opt_static(i)}}}catch(a){throw this.ohno.compiler.user.error_constructing_value_from_atomic_block(a,{block:t})}try{if(this.block.is.logic_empty(t))return this.compile_logic_empty(t);var r=this.state.create_before_expression_yield_point(t),n=void 0;if(this.block.is.procedures_callreturn(t))n=this.compile_procedure_call(t);else if(this.block.is.procedures_parameter(t))n=this.compile_procedure_parameter(t);else if(this.block.is.traverse_number_value(t))n=this.compile_domain_functions(t);else{if(!this.block.is.domain_block(t)){var o=t;throw this.ohno.compiler.system.unknown_expression({unknown_expression_type:o.type,block:o})}n=this.compile_domain_functions(t)}return{pre:[r,n.pre],expr:n.expr}}catch(a){throw this.create_catch_all_error("compile_expression",a,t)}},t.prototype.compile_conditional=function(t){var e=this;try{var i=[],r=void 0;if(this.block.is.controls_if_dropdown(t)?(i.push(this.comment("CONDITIONAL_DROPDOWN")),r=t.if_dropdown_conditions):(i.push(this.comment("CONDITIONAL")),r=t.conditions),0==t.child_block.length||0==r.length)return{statements:""};var n=this.state.gen_parameter_symbol("if_matched"),o=this.opt_params(n);i.push(this.state.create_yield_point()),i.push(o," = false;");for(var a=function(i,r){if(void 0==i)return[];var n=[e.comment("COND_BRANCH "+(void 0!==r?r:"ELSE"))];n.push(e.state.push_yield_level(t));var o=e.compile_statement(i);return n.push(o.statements),n.push(e.state.create_yield_reset_point()),n.push(e.state.pop_yield_level(t)),n},s=0;s<r.length;s++){var _=r[s],c=t.child_block[s];if(void 0!=_){var u=this.state.gen_parameter_symbol("if_cond"+s+"_"),p=this.opt_params(u),d=this.state.push_yield_level(t),l=void 0;if("string"!==typeof _)l=this.compile_expression(_);else{var h=this.block_pool.clone(t);h.type=_,h.kind="domain_block",l=this.compile_expression(h),this.block_pool.release(h)}var f=this.state.create_yield_reset_point(),g=this.state.pop_yield_level(t),y=this.state.create_yield_point(),m=a(c,s),v=this.state.create_yield_point();i.push(this.comment("COND_CHECK "+s),"if (!",o,") {",d,l.pre,f,g,"}"),i.push(p," = !",o," && ",l.expr,";"),i.push(o," = ",o," || ",p,";"),i.push(y),i.push("if (",p,") {",m,"}"),i.push(v)}}var b=t.child_block[r.length];if(void 0!=b){m=a(b);i.push("if (!",o,") {",m,"}")}return{statements:i}}catch(w){throw this.create_catch_all_error("compile_conditional",w,t)}},t.prototype.compile_sync_tell=function(t){try{if(void 0==t.child_block[0])return{statements:""};var e=this.compile_params("__sync_tell_"+t.id+"__",t.params),i=[this.opt_params(e.dynamic_data_id),"['sprite']"];this.state.push_target_entity(i);var r=this.state.push_yield_level(t),n=this.compile_statement(t.child_block[0]),o=this.state.create_yield_reset_point(),a=this.state.pop_yield_level(t);return this.state.pop_target_entity(),{statements:[this.comment("SYNC_TELL"),e.statements,"if (",this.keyword.report_sync_telling,"('",t.id,"', ",i,")) {",r,n.statements,o,a,"}"]}}catch(s){throw this.create_catch_all_error("compile_sync_tell",s,t)}},t.prototype.compile_warp=function(t){try{if(void 0==t.child_block[0])return{statements:""};this.state.enter_warp_block();var e=this.compile_statement(t.child_block[0]);return this.state.exit_warp_block(),{statements:[this.comment("WARP"),e.statements]}}catch(i){throw this.create_catch_all_error("compile_warp",i,t)}},t.prototype.compile_async_tell=function(t){try{var e=t.child_block[0];if(void 0==e)return{statements:""};this.state.add_async_tell_ast(e);var i=this.compile_params("__async_tell_"+t.id+"__",t.params),r=[this.opt_params(i.dynamic_data_id),"['sprite']"];return{statements:[this.comment("ASYNC_TELL"),i.statements,this.keyword.async_tell,"('",e.id,"', ",this.state.current_target_entity(),", ",r,", ",this.state.is_inside_warp().toString(),");"]}}catch(n){throw this.create_catch_all_error("compile_async_tell",n,t)}},t.prototype.compile_repeat_forever=function(t){try{if(void 0==t.child_block[0])return{statements:""};var e=this.state.push_breakable(),i=this.state.push_yield_level(t),r=this.compile_statement(t.child_block[0]),n=this.state.create_yield_reset_point(),o=this.state.create_iteration_yield_point(),a=this.state.pop_yield_level(t);return this.state.pop_breakable(),{statements:[this.comment("REPEAT_FOREVER"),e,": while (true) {",i,r.statements,n,o,a,"}"]}}catch(s){throw this.create_catch_all_error("compile_repeat_forever",s,t)}},t.prototype.compile_repeat_forever_until=function(t){try{if(void 0==t.child_block[0])return{statements:""};var e=this.state.push_breakable(),i=this.state.push_yield_level(t),r=this.compile_params("__repeat_forever_until_"+t.id+"__",t.params),n=[this.opt_params(r.dynamic_data_id),"['condition']"],o=this.state.create_yield_reset_point(),a=this.compile_statement(t.child_block[0]),s=this.state.create_yield_reset_point(),_=this.state.create_iteration_yield_point(),c=this.state.pop_yield_level(t);return this.state.pop_breakable(),{statements:[this.comment("REPEAT_FOREVER_UNTIL"),e,": while (true) {",i,r.statements,"if (",n,") {",o,"break ",e,";}",a.statements,s,_,c,"}"]}}catch(u){throw this.create_catch_all_error("compile_repeat_forever_until",u,t)}},t.prototype.compile_repeat_n_times=function(t){try{if(void 0==t.child_block[0])return{statements:""};var e=this.compile_params("__repeat_n_times_"+t.id+"__",t.params),i=this.state.push_breakable(),r=this.state.push_yield_level(t),n=[this.opt_params(e.dynamic_data_id),"['times']"],o=this.state.create_yield_reset_point(),a=this.compile_statement(t.child_block[0]),s=this.state.create_yield_reset_point(),_=this.state.create_iteration_yield_point(),c=this.state.pop_yield_level(t);return this.state.pop_breakable(),{statements:[this.comment("REPEAT_N_TIMES"),e.statements,i,": while (true) {",r,"if (",n," <= 0) {",o,"break ",i,";}",n,"--;",a.statements,s,_,c,"}"]}}catch(u){throw this.create_catch_all_error("compile_repeat_n_times",u,t)}},t.prototype.compile_traverse_number=function(t){try{if(void 0==t.child_block[0])return{statements:""};var e=this.compile_params("__traverse_number_"+t.id+"__",t.params),i=this.state.push_breakable(),r=this.state.push_yield_level(t),n=[this.opt_params(e.dynamic_data_id),"['from']"],o=[this.opt_params(e.dynamic_data_id),"['to']"],a=[this.opt_params(e.dynamic_data_id),"['by']"],s=[this.opt_params(e.dynamic_data_id),"['value']"],_=this.state.create_yield_reset_point(),c=this.compile_statement(t.child_block[0]),u=this.state.create_yield_reset_point(),p=this.state.create_iteration_yield_point(),d=this.state.pop_yield_level(t);return this.state.pop_breakable(),{statements:[this.comment("TRAVERSE_NUMBER"),e.statements,i,": while (true) {",r,"var warn_iters = [];","if (isNaN(",n,")) {warn_iters.push('from')};","if (isNaN(",o,")) {warn_iters.push('to')};","if (isNaN(",a,") &&",a,"!== undefined) {warn_iters.push('by')};","if (warn_iters.length) {",this.keyword.event_bus,".warning.runtime.send({error: ",this.keyword.ohno,".warning.block_parameter_illegal({block_id: '",t.id,"', source_entity_id: '",this.state.source_map_entity,"', current_frame: ",this.keyword.current_frame,", input: warn_iters.join()})});",_,"break ",i,";","}","if (",n,"<=",o,") {",n,"= Math.ceil(",n,");","if (",n,">",o,") {",_,"break ",i,";","}","} else {",n,"= Math.floor(",n,");","if (",n,"<",o,") {",_,"break ",i,";","}","}","if (",a," === undefined)",a," = 1;","if (isNaN(Number(",a,")) || Number(",a,") <= 0) {",a," = 0;","} else {",a," = Math.abs(Math.round(",a,"));","}","if (",s," === 'INIT') {",s," =",n,";}","else if (isNaN(",s,")) {",_,"break ",i,";}","if (",n," <= ",o,") {","if (",s," > ",o,") {",this.keyword.runtime_data,".set_arbitrary_data('",t.id,"', undefined);",_,"break ",i,";}",this.keyword.runtime_data,".set_arbitrary_data('",t.id,"', ",s,");",s," += ",a,";","} else {","if (",s," < ",o,") {",this.keyword.runtime_data,".set_arbitrary_data('",t.id,"', undefined);",_,"break ",i,";}",this.keyword.runtime_data,".set_arbitrary_data('",t.id,"', ",s,");",s," -= ",a,";","}",c.statements,u,p,d,"}"]}}catch(l){throw this.create_catch_all_error("compile_traverse_number",l,t)}},t.prototype.compile_wait_until=function(t){try{var e=this.state.push_breakable(),i=this.state.push_yield_level(t),r=this.compile_params("__wait_until_"+t.id+"__",t.params),n=[this.opt_params(r.dynamic_data_id),"['condition']"],o=this.state.create_yield_reset_point(),a=this.state.create_yield_reset_point(),s=this.state.create_iteration_yield_point(),_=this.state.pop_yield_level(t);return this.state.pop_breakable(),{statements:[this.comment("WAIT_UNTIL"),e,": while (true) {",i,r.statements,"if (",n,") {",o,"break ",e,";}",a,s,_,"}"]}}catch(c){throw this.create_catch_all_error("compile_wait_until",c,t)}},t.prototype.compile_break=function(t){try{var e=this.state.current_break_id(t),i=this.config.get().loop_break_error_type,r=[];if(e)r=[this.comment("BREAK"),this.state.get_current_break_reset_statements(t),this.state.create_yield_reset_point(),"break ",e,";"];else{if("warning"!==i)throw this.ohno.compiler.user.tried_to_break_outside_of_loop({block:t});this.event_bus.warning.runtime.send({error:this.ohno.warning.tried_to_break_outside_of_loop({block:t})})}return{statements:r}}catch(n){throw this.create_catch_all_error("compile_break",n,t)}},t.prototype.compile_logic_empty=function(t){try{return{pre:[],expr:["false"]}}catch(e){throw this.create_catch_all_error("compile_logic_empty",e,t)}},t.prototype.compile_domain_functions=function(t){try{var e=this.registry.get_domain_function_index(t.type);if(void 0==e){if(!this.config.get().ignore_missing_domain_function)throw this.ohno.client.missing_domain_function({ns_id:t.type});e=-1}var i=this.compile_params("__domain_block_"+t.type+"_"+t.id+"__",t.params),r=[];r.push(i.statements);var n=this.state.gen_parameter_symbol("domain_wrap"),o=this.opt_params(n),a=0!==this.state.get_tell_entity_target_stack().length,s=[[this.keyword.call_domain_function,"('",n,"', ",e.toString(),", '",t.id,"', ",this.opt_params(i.dynamic_data_id),", ",this.state.current_target_entity(),", ",a.toString(),");"],this.state.create_after_potential_blocker_yield_point(t)];return{pre:[this.comment('DOMAIN_FUNCTION PRE "'+t.type+'"'),r,s],expr:[o,this.comment('DOMAIN_FUNCTION EXPR "'+t.type+'"',!1)]}}catch(_){throw this.create_catch_all_error("compile_domain_functions",_,t)}},t.prototype.compile_event=function(t){try{var e=this.state.gen_parameter_symbol("if_triggered"),i=this.opt_params(e),r=this.compile_domain_functions(t),n=this.state.create_yield_point(),o=this.state.create_yield_point(),a=this.state.push_yield_level(t),s=this.compile_statement(t.child_block[0]),_=this.state.create_yield_reset_point(),c=this.state.pop_yield_level(t);return{statements:[this.comment('EVENT "'+t.type+'"'),r.pre,n,i," = ",r.expr,";",o,"if (",i,") {",a,s.statements,_,c,"}"]}}catch(u){throw this.create_catch_all_error("compile_event",u,t)}},t.prototype.compile_responder=function(t){try{var e=this.compile_statement(t.child_block[0]);return{statements:[this.comment("RESPONDER"),e.statements]}}catch(i){throw this.create_catch_all_error("compile_responder",i,t)}},t.prototype.compile_procedure_call=function(t){try{var e=this.compile_params("__"+t.type+"_"+t.id+"__",t.params),i=[];return i.push(this.comment('PROCEDURE_CALL PRE "'+t.procedure_name+'"')),i.push(e.statements),i.push(this.state.create_yield_point()),i.push([this.keyword.proc_call,"('",t.procedure_name,"', ",this.state.current_target_entity(),", ",this.opt_params(e.dynamic_data_id),", '",t.id,"', ",this.state.is_inside_warp().toString(),");"]),i.push(this.state.create_procedure_yield_point()),{pre:i,expr:[this.keyword.proc_return_value,this.comment('PROCEDURE_CALL EXPR "'+t.procedure_name+'"',!1)]}}catch(r){throw this.create_catch_all_error("compile_procedure_call",r,t)}},t.prototype.compile_procedure_parameter=function(t){var e,i=this.u.block.get_first_ancestor_satisfying(t,(function(t){return void 0==t.parent_block}));if(void 0==i)throw this.ohno.compiler.system.could_not_find_root_block({block:t});if(!this.u.block.is.procedures_defnoreturn(i))throw this.ohno.compiler.user.procedure_parameter_outside({block:t});if(void 0==t.params||void 0==t.params.param_name||!c(t.params.param_name))throw this.ohno.compiler.system.could_not_find_procedure_parameter_name({block:t});if(e=t.params.param_name,!i.params[e])throw this.ohno.compiler.user.procedure_no_such_parameter({param_name:e,block:t});try{var r=this.compile_params("__"+t.type+"_"+t.id+"__",t.params),n=[this.opt_params(r.dynamic_data_id),"['param_name']"],o=[this.keyword.proc_parameters,"[",n,"]",this.comment('PROCEDURE_PARAMETER EXPR "'+e+'"',!1)];return{pre:[this.comment('PROCEDURE_PARAMETER PRE "'+e+'"'),r.statements,"if (",o," == undefined) {throw ",this.keyword.ohno,".user.proc_parameter_without_value({",'"block_id": \'',t.id,"'});}"],expr:o}}catch(a){throw this.create_catch_all_error("compile_procedure_parameter",a,t)}},t.prototype.compile_procedure_return_value=function(t){var e=this.u.block.get_first_ancestor_satisfying(t,(function(t){return void 0==t.parent_block}));if(void 0===e||!this.u.block.is.procedures_defnoreturn(e))throw this.ohno.compiler.user.procedure_return_outside({block:t});var i=this.comment("PROCEDURE_RETURN_VALUE");try{if(void 0===t.params.VALUE)return{statements:[i,this.keyword.proc_do_return_value,"('",t.id,"', ","undefined","); return;"]};var r=this.compile_params("__"+t.type+"_"+t.id+"__",t.params),n=[this.opt_params(r.dynamic_data_id),"['VALUE']"];return{statements:[i,r.statements,this.keyword.proc_do_return_value,"('",t.id,"', ",n,"); return;"]}}catch(o){throw this.create_catch_all_error("compile_procedure_return_value",o,t)}},t.prototype.compile_params=function(t,e){var i;try{var r=this.config.get().nan_to_zero_conversion_blocks,n=[this.comment('PARAMS "'+t+'"'),this.state.create_yield_point()],o=this.state.gen_parameter_symbol(t+"_params");n.push(this.opt_create_params(o));var s=null===(i=e)||void 0===i?void 0:i.times,_=Object.keys(e);if(0==_.length)return{dynamic_data_id:o,statements:n};s&&r&&r.some((function(e){return t.includes(e)}))&&(this.params_block_dict[s.id]=s),this.deterministic&&(_=u(_,a));for(var c=0;c<_.length;c++){var p=_[c],d=e[p];if(this.block.is.compiled_block(d)){var l=this.compile_expression(d);n.push(l.pre),n.push(this.state.create_yield_point()),n.push(this.opt_set_param(o,p,l.expr))}else{n.push(this.state.create_yield_point());var h=void 0;if(this.static_is_safe(d))h=this.opt_safe_static(d);else{var f=this.state.set_static(t+"_"+p,d);h=this.opt_static(f)}n.push(this.opt_set_param(o,p,h))}}return n.push(this.state.create_yield_point()),{dynamic_data_id:o,statements:n}}catch(g){throw this.create_catch_all_error("compile_params",g)}},t.prototype.opt_static=function(t){return this.should_pretty_print?[this.keyword.static_data,"['",t,"']"]:[this.keyword.static_data,"[",t,"]"]},t.prototype.opt_params=function(t){return this.should_pretty_print?[this.keyword.dynamic_data,"['",t,"']"]:[this.keyword.dynamic_data,"[",t,"]"]},t.prototype.opt_create_params=function(t){return[this.opt_params(t)," = {};"]},t.prototype.opt_set_param=function(t,e,i){return[this.opt_params(t),"['",e,"'] = ",i,";"]},t=r.__decorate([d.injectable(),r.__param(0,d.inject(l.BINDING.BlockPool)),r.__param(1,d.inject(l.BINDING.EventBus)),r.__param(2,d.inject(l.BINDING.Log)),r.__param(3,d.inject(l.BINDING.Ohno)),r.__param(4,d.inject(l.BINDING.PRNGFactory)),r.__param(5,d.inject(l.BINDING.Util)),r.__param(6,d.inject(l.BINDING.BlockUtil)),r.__param(7,d.inject(l.BINDING.Config)),r.__param(8,d.inject(l.BINDING.Registry)),r.__metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object,Object,Object])],t)}();e.OptiCompilerImpl=m},59651:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=(i(76715),i(71962)),a=i(83084),s=function(){function t(t,e,i,r,n,o,a,s){var _=this;this.u=t,this.ohno=e,this.event_bus=i,this.registry=r,this.program_cache=n,this.block_pool=o,this.frame_pool=a,this.runtime_data=s;var c=function(){var e=t.config.get(),i=e.opti_compiler;_.should_pretty_print=void 0!=i&&i.pretty_print,_.tell_should_ensure_entity_exists=e.reports_all_entities,_.should_report_current_running_block=e.should_report_current_running_block,_.max_procedure_calls_per_interpreter_step=e.max_procedure_calls_per_interpreter_step,_.max_warp_iterations_per_interpreter_step=e.max_warp_iterations_per_interpreter_step,_.warp_interpreter_millisecond_time_limit=e.warp_interpreter_millisecond_time_limit,_.max_call_stack_size=e.max_call_stack_size};c(),this.event_bus.system.config_updated.immediate.sub(c)}return t.prototype.create=function(t,e,i,r,n,o,s,_,c){return new a.OptiRunner(this.u,this.ohno,this.event_bus,this.should_pretty_print,this.tell_should_ensure_entity_exists,this.should_report_current_running_block,this.max_procedure_calls_per_interpreter_step,this.max_warp_iterations_per_interpreter_step,this.warp_interpreter_millisecond_time_limit,this.max_call_stack_size,t,this.runtime_data,this.block_pool,this.frame_pool,this.program_cache,this.registry.get_domain_function_list(),this.registry.get_domain_function_types(),e,i,this.program_cache.get_program(r,e.source_map_entity,e.source_map_rbid,e.interpreter_id,n),o,n,s,_,c)},t.prototype.clear=function(){this.program_cache.clear()},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Util)),r.__param(1,n.inject(o.BINDING.Ohno)),r.__param(2,n.inject(o.BINDING.EventBus)),r.__param(3,n.inject(o.BINDING.Registry)),r.__param(4,n.inject(o.BINDING.OptiProgramCache)),r.__param(5,n.inject(o.BINDING.BlockPool)),r.__param(6,n.inject(o.BINDING.OptiFramePool)),r.__param(7,n.inject(o.BINDING.RuntimeData)),r.__metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object,Object])],t)}();e.OptiRunnerFactory=s},32803:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=(i(76715),i(71962)),a=function(){function t(t,e){var i=this;this.u=t,this.event_bus=e;var r=function(){var e=t.config.get(),r=e.opti_compiler;i.should_pretty_print=void 0!=r&&r.pretty_print,i.pool_limit=e.opti_frame_pool_size_limit};r(),this.event_bus.system.config_updated.immediate.sub(r);var n=t.config.get().opti_frame_pool_preallocation_size;this.pool=new Array(n);for(var o=0;o<n;o++)this.pool[o]=this.create()}return t.prototype.create=function(){return{proc_id:"",proc_parameters:{},program_counter:[],dynamic_data:this.should_pretty_print?{}:[],target_entity_id:"",source_map_entity:"",source_map_rbid:"",proc_call_bid:"",async_tell_asts:{},is_warped:!1}},t.prototype.reset=function(t){t.proc_id="",t.proc_parameters={},t.program_counter=[],t.dynamic_data=this.should_pretty_print?{}:[],t.target_entity_id="",t.source_map_entity="",t.source_map_rbid="",t.proc_call_bid="",t.async_tell_asts={},t.is_warped=!1},t.prototype.get=function(){var t=this.pool.pop();return void 0!=t?t:this.create()},t.prototype.release=function(t){},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Util)),r.__param(1,n.inject(o.BINDING.EventBus)),r.__metadata("design:paramtypes",[Object,Object])],t)}();e.OptiFramePoolImpl=a},35765:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=(i(76715),i(71962)),a=function(){function t(t,e,i,r,n){this.u=t,this.ohno=e,this.event_bus=i,this.opti_compiler=r,this.block_pool=n,this.programs={}}return t.prototype.get_program=function(t,e,i,r,n){var o=t,a=this.programs[o];if(void 0!=a)return a;var s=this.opti_compiler.compile(e,i,r,n);return this.programs[o]=s,s},t.prototype.clear=function(){this.programs={}},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Util)),r.__param(1,n.inject(o.BINDING.Ohno)),r.__param(2,n.inject(o.BINDING.EventBus)),r.__param(3,n.inject(o.BINDING.OptiCompiler)),r.__param(4,n.inject(o.BINDING.BlockPool)),r.__metadata("design:paramtypes",[Object,Object,Object,Object,Object])],t)}();e.OptiProgramCacheImpl=a},83084:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(58121),o=i(66933),a=i(22988),s=i(40303),_=i(88073);var c="__main__",u=function(){function t(t,e,i,r,n,o,a,s,_,u,p,d,l,h,f,g,y,m,v,b,w,x,k,O,E){var I=this;this.u=t,this.ohno=e,this.event_bus=i,this.should_pretty_print=r,this.tell_should_ensure_entity_exists=n,this.should_report_current_running_block=o,this.max_procedure_calls_per_interpreter_step=a,this.max_warp_iterations_per_interpreter_step=s,this.warp_interpreter_millisecond_time_limit=_,this.max_call_stack_size=u,this.run_mgr=p,this.runtime_data=d,this.block_pool=l,this.frame_pool=h,this.program_cache=f,this.domain_functions=g,this.domain_function_types=y,this.original_identities=m,this.priorities=v,this.program=b,this.action_parameters=O,this.on_finished=E,this.programs={},this.current_frame=void 0,this.n_warp_iterations=0,this.warp_tick_start=0,this.deterministic_mode=!!t.config.get().deterministic,this.replace_parameters_value=!!t.config.get().replace_parameters_value,this.metadata={priorities:v,original_identities:m,typeclass_id:m.typeclass_id,interpreter_id:m.interpreter_id,type:x.type,group_id:w},this.root_block_type=x.type,this.root_block_id=m.interpreter_id,this.step_input_outputs={ohno:this.ohno,event_bus:this.event_bus,runtime_data:this.runtime_data,call_domain_function:this.step_call_domain_function.bind(this),report_sync_telling:this.step_report_sync_telling.bind(this),async_tell:this.step_async_tell.bind(this)},this.step_outputs={proc_call:this.step_call_procedure.bind(this),before_expression:this.step_before_expression.bind(this),after_potential_blocker:this.step_after_potential_blocker.bind(this),increment_program_counter:this.step_increment_program_counter.bind(this),reset_program_counter:this.step_reset_program_counter.bind(this),after_iteration:this.step_iteration_yield.bind(this),finished:this.step_finished.bind(this),proc_do_return_value:this.step_return_value.bind(this),proc_yield_after_call:this.step_yield_to_procedure.bind(this)},this.domain_function_util={runtime_manager:this.run_mgr,add_user_procedure_call_to_stack:function(t,e,i){I.step_call_procedure(t,e,i,"__user_defined_procedure__"+t,!1)},get_action_parameter:this.get_action_parameter.bind(this),create_domain_function_error:this.create_domain_function_error.bind(this)},this.programs[c]=b,this.reset(k)}return t.prototype.reset=function(t){this.program_state=this.empty_state(this.original_identities.target_entity,t||!1)},t.prototype.get_action_parameter=function(t){if(void 0==this.action_parameters)throw this.ohno.system.unknown_system_error({message:'Could not get parameter in test block "test action parameter"'});return this.action_parameters[t]},t.prototype.step_call_procedure=function(t,e,i,n,o){var a=this.run_mgr.get_procedure(t,!1);if(void 0==a)throw this.u.ohno.user.call_undefined_procedure(r.__assign({},this.get_catastrophe_dict(n)));var s=this.program_state.proc_stack;if(s.length>this.max_call_stack_size)throw this.ohno.system.stack_overflow(r.__assign(r.__assign({},this.get_catastrophe_dict(n)),{procedure_id:t}));var _=this.programs[t];void 0==_&&(_=this.program_cache.get_program(a.script.id,a.source_entity_id,a.script.id,this.original_identities.interpreter_id,a.script),this.programs[t]=_),this.replace_parameters_value&&this.replaceParametersValue(i,t,e,n);var c=this.empty_stack_frame(t,e,_,o||this.current_frame.is_warped,i,a.source_entity_id,a.script.id,n);s.push(c),this.program_state.did_proc_yield=!0},t.prototype.getParameterFiledOrInput=function(t,e){return"Variable"===t?{field:e}:"Audio"===t?{input:e}:"Actor"===t?{field:e}:"Style"===t||"List"===t?{input:e}:{}},t.prototype.replaceParametersValue=function(t,e,i,n){var o=this.run_mgr.get_procedure_parameters_type(),a=["Variable","Audio","Actor","Style","List"];for(var _ in t){var c=o[_];if("?"===t[_]&&c&&a.includes(c)&&(this.event_bus.warning.runtime.send({error:this.ohno.warning.procedure_parameter_illegal(r.__assign(r.__assign(r.__assign(r.__assign({},this.get_catastrophe_dict(n)),{procedure_id:e,source_entity_id:i}),this.getParameterFiledOrInput(c,_)),{current_frame:{proc_id:this.current_frame.proc_id,proc_call_bid:this.current_frame.proc_call_bid,proc_parameters:this.current_frame.proc_parameters}}))}),t[_]=NaN),s.validate(t[_])){var u=this.run_mgr.get_style(t[_]),p=this.run_mgr.get_audio(t[_]),d=this.run_mgr.get_variable(t[_],this.original_identities.interpreter_id,this.original_identities.target_entity,null);null!==d&&"Variable"===c&&(t[_]=d),void 0!==u&&"Style"===c&&(t[_]=u),void 0!==p&&"Audio"===c&&(t[_]=p)}}},t.prototype.step_yield_to_procedure=function(t,e){var i=this.program_state.proc_stack,r=i[i.length-2];void 0!=r&&(r.program_counter[t]=e)},t.prototype.step_iteration_yield=function(t){if(!(this.current_frame.is_warped||t))return!0;var e=this.n_warp_iterations>this.max_warp_iterations_per_interpreter_step;this.deterministic_mode||e||(e=this.warp_tick_start+this.warp_interpreter_millisecond_time_limit<this.run_mgr.wall_clock_now());return this.n_warp_iterations++,e},t.prototype.step_before_expression=function(t,e,i,r,n){return this.should_report_current_running_block&&this.run_mgr.set_running_block(i,t),this.current_frame.program_counter[r]=n,!1},t.prototype.step_after_potential_blocker=function(t,e,i,r,n){return this.current_frame.program_counter[r]=n,this.run_mgr.current_interpreter_must_yield(this.root_block_id,this.metadata.group_id)||this.program_state.did_proc_yield},t.prototype.step_increment_program_counter=function(t,e,i,r){this.current_frame.program_counter[i]=r},t.prototype.step_reset_program_counter=function(t,e,i){this.current_frame.program_counter[i]=0},t.prototype.step_finished=function(){if(this.pop_proc_stack(),this.current_frame=void 0,this.program_state.proc_has_return_value=!1,this.program_state.proc_return_value=void 0,this.program_state.did_proc_yield=!0,0==this.program_state.proc_stack.length)return this.program_state.did_proc_yield=!1,void(this.program_state.finished=!0)},t.prototype.step_return_value=function(t,e){this.pop_proc_stack(),this.current_frame=void 0,this.program_state.did_proc_yield=!0,this.program_state.proc_has_return_value=void 0!=e,this.program_state.proc_return_value=e},t.prototype.step_call_domain_function=function(t,e,i,r,n,o){var a,s=this;!n.startsWith("_clone")&&o&&this.run_mgr.get_clones_of_entity(n).forEach((function(n){s.step_call_domain_function(t,e,i,r,n,!1)}));try{a=-1!=e&&this.domain_functions[e](r,this.original_identities.interpreter_id,n,this.domain_function_util,i,{proc_id:this.current_frame.proc_id,proc_call_bid:this.current_frame.proc_call_bid,proc_parameters:this.current_frame.proc_parameters})}catch(p){throw this.extend_domain_function_call_error(p,i,e,this.current_frame.source_map_rbid,this.current_frame.source_map_entity)}if(void 0!=a){if(Promise.resolve(a)===a){var _=this.run_mgr.get_thread_lock(n,this.original_identities.interpreter_id),c=this.current_frame,u=this.run_mgr;a.then((function(e){c.dynamic_data[t]=e,_.stop()}),(function(t){var r=s.extend_domain_function_call_error(t,i,e,c.source_map_rbid,c.source_map_entity);u.report_error_and_stop(r,"OptiRunner domain function promise result handler")}))}this.program.params_block_dict[i]&&(a="string"===typeof a||isNaN(a)?0:a),this.current_frame.dynamic_data[t]=a}},t.prototype.extend_domain_function_call_error=function(t,e,i,r,n){var s={block_id:e,block_type:this.domain_function_types[i],root_block_id:r,entity_id:n,interpreter_id:this.original_identities.interpreter_id,interpreter_stack:this.get_current_stack()};return t instanceof a.Catastrophe?(t.annotation=t.annotation||{},o(t.annotation,s),t):this.ohno.system.unknown_error_in_domain_function_call(t,s)},t.prototype.get_catastrophe_dict=function(t){return{source_map_rbid:this.current_frame.source_map_rbid,source_entity_id:this.current_frame.source_map_entity,block_id:t}},t.prototype.ensure_tell_target_ok=function(t,e){var i=this.run_mgr.get_entity_state(e);if(this.tell_should_ensure_entity_exists){if(i==_.EntityState.Destructing)return this.run_mgr.report_warning(this.ohno.warning.tell_with_destructing_entity({root_block_id:this.current_frame.source_map_rbid,entity_id:this.current_frame.source_map_entity,block_id:t,tell_entity:e})),!1;if(i==_.EntityState.Disposed)return this.run_mgr.report_warning(this.ohno.warning.tell_with_disposed_entity({root_block_id:this.current_frame.source_map_rbid,entity_id:this.current_frame.source_map_entity,block_id:t,tell_entity:e})),!1;if(i==_.EntityState.Unknown)throw this.ohno.user.tell_with_unknown_entity(r.__assign(r.__assign({},this.get_catastrophe_dict(t)),{tell_entity:e}))}return!0},t.prototype.step_async_tell=function(t,e,i,r){var n=this;this.ensure_tell_target_ok(t,i)&&(this.run_mgr.spawn_async_tell_interpreter({typeclass_id:this.original_identities.typeclass_id,interpreter_id:this.original_identities.interpreter_id,target_entity:e,source_map_entity:this.current_frame.source_map_entity,source_map_rbid:this.current_frame.source_map_rbid},i,this.current_frame.async_tell_asts[t],this.metadata.group_id,r),this.run_mgr.get_clones_of_entity(i).forEach((function(i){n.run_mgr.spawn_async_tell_interpreter({typeclass_id:n.original_identities.typeclass_id,interpreter_id:n.original_identities.interpreter_id,target_entity:e,source_map_entity:n.current_frame.source_map_entity,source_map_rbid:n.current_frame.source_map_rbid},i,n.current_frame.async_tell_asts[t],n.metadata.group_id,r)})))},t.prototype.step_report_sync_telling=function(t,e){return this.ensure_tell_target_ok(t,e)},t.prototype.pop_proc_stack=function(){var t=this.program_state.proc_stack.pop();void 0!=t&&this.frame_pool.release(t)},t.prototype.empty_stack_frame=function(t,e,i,r,n,o,a,s){void 0===s&&(s="");for(var _=i.n_yield_groups,c=[],u=0;u<_;u++)c.push(0);return{proc_id:t,proc_parameters:n||{},program_counter:c,dynamic_data:this.should_pretty_print?{}:new Array(i.dynamic_data_size),target_entity_id:e,source_map_entity:o||this.original_identities.source_map_entity,source_map_rbid:a||this.original_identities.source_map_rbid,async_tell_asts:i.async_tell_asts,proc_call_bid:s,is_warped:r}},t.prototype.empty_state=function(t,e){return{finished:!1,proc_stack:[this.empty_stack_frame(c,t,this.program,e)],proc_has_return_value:!1,proc_return_value:void 0,did_proc_yield:!1}},t.prototype.get_step_args=function(t,e){var i={identities:this.original_identities,default_target_entity_id:t.target_entity_id,static_data:e,proc_parameters:t.proc_parameters,proc_return_value:this.program_state.proc_return_value,proc_has_return_value:this.program_state.proc_has_return_value};i.identities.source_map_entity=t.source_map_entity,i.identities.source_map_rbid=t.source_map_rbid;var r={dynamic_data:t.dynamic_data,program_counter:t.program_counter,current_frame:{proc_id:t.proc_id,proc_call_bid:t.proc_call_bid,proc_parameters:t.proc_parameters}},n=this.step_outputs;return this.should_pretty_print?{ohno:this.step_input_outputs.ohno,call_domain_function:this.step_input_outputs.call_domain_function,report_sync_telling:this.step_input_outputs.report_sync_telling,async_tell:this.step_input_outputs.async_tell,event_bus:this.step_input_outputs.event_bus,runtime_data:this.step_input_outputs.runtime_data,default_target_entity_id:i.default_target_entity_id,identities:i.identities,static_data:i.static_data,proc_parameters:i.proc_parameters,proc_return_value:i.proc_return_value,proc_has_return_value:i.proc_has_return_value,proc_do_return_value:n.proc_do_return_value,proc_yield_after_call:n.proc_yield_after_call,dynamic_data:r.dynamic_data,program_counter:r.program_counter,current_frame:r.current_frame,proc_call:n.proc_call,before_expression:n.before_expression,after_potential_blocker:n.after_potential_blocker,increment_program_counter:n.increment_program_counter,reset_program_counter:n.reset_program_counter,after_iteration:n.after_iteration,finished:n.finished}:{AA:this.step_input_outputs.ohno,AB:this.step_input_outputs.call_domain_function,AC:this.step_input_outputs.report_sync_telling,AD:this.step_input_outputs.async_tell,AE:this.step_input_outputs.event_bus,AF:this.step_input_outputs.runtime_data,BA:i.default_target_entity_id,BB:i.identities,BC:i.static_data,CA:i.proc_parameters,CB:i.proc_return_value,CC:i.proc_has_return_value,CD:n.proc_do_return_value,CE:n.proc_yield_after_call,DA:r.dynamic_data,DB:r.program_counter,DC:r.current_frame,EA:n.proc_call,EB:n.before_expression,EC:n.after_potential_blocker,ED:n.increment_program_counter,EE:n.reset_program_counter,EF:n.after_iteration,EG:n.finished}},t.prototype.step=function(){this.n_warp_iterations=0,this.deterministic_mode||(this.warp_tick_start=this.run_mgr.wall_clock_now());for(var t=0;;){var e=this.do_step();if(void 0!=e)return e;if(++t>=this.max_procedure_calls_per_interpreter_step)return _.StepResult.yielding}},t.prototype.do_step=function(){var t=function(t){if(0!=t.length)return t[t.length-1]}(this.program_state.proc_stack);if(void 0==t)throw this.ohno.system.procedure_popped_empty_call_stack({root_block_id:this.original_identities.source_map_rbid,entity_id:this.original_identities.source_map_entity});this.current_frame=t,this.program_state.did_proc_yield=!1;var e=this.programs[t.proc_id],i=this.get_step_args(t,e.static_data);this.run_mgr.set_current_interpreter_not_blocked();try{e.script(i)}catch(s){var n=r.__assign(r.__assign({},this.get_catastrophe_dict()),{interpreter_id:this.original_identities.interpreter_id,interpreter_stack:this.get_current_stack()});if(s instanceof a.Catastrophe)throw s.annotation=s.annotation||{},o(s.annotation,n),s;throw this.ohno.system.unknown_system_error(s,n)}return this.program_state.finished?(void 0!==this.on_finished&&this.on_finished(this.original_identities.source_map_rbid),_.StepResult.finished):0==this.program_state.did_proc_yield?_.StepResult.yielding:void 0},t.prototype.get_current_stack=function(){for(var t=this.program_state.proc_stack,e=[],i=0;i<t.length;i++){var r=t[i],o=i===t.length-1?void 0:t[i+1].proc_call_bid;""==o&&(o=void 0),e.push({interpreter_id:this.original_identities.interpreter_id,source_entity_id:r.source_map_entity,source_map_rbid:r.source_map_rbid,block_id:o,proc_parameters:n(r.proc_parameters),proc_id:r.proc_id===c?void 0:r.proc_id})}return e},t.prototype.dispose=function(){},t.prototype.create_domain_function_error=function(t){var e={client_annotation:t};return void 0!=t.native_error?this.ohno.client.domain_function_error(t.native_error,e):this.ohno.client.domain_function_error(e)},t}();e.OptiRunner=u},13783:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=function(){function t(){}return t.prototype.uncompiled_XML_entity=function(t){return!!t.blocksXML},t.prototype.uncompiled_JSON_entity=function(t){return!!t.blocksJSON},t=r.__decorate([n.injectable()],t)}();e.PredicatesImpl=o},53972:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=i(16392),a=function(){function t(){}return t.prototype.create=function(t){return void 0==t?new s:"number"===typeof t?new s(t):new s(t.seed_high,t.seed_low,t.inc_high,t.inc_low)},t=r.__decorate([n.injectable()],t)}();e.PRNGFactoryImpl=a;var s=function(){function t(t,e,i,r){this.pcg_random=new o(t,e,i,r)}return t.prototype.set_state=function(t){this.pcg_random.setState(t)},t.prototype.get_state=function(){return this.pcg_random.getState()},t.prototype.set_seed=function(t,e,i,r){this.pcg_random.setSeed(t,e,i,r)},t.prototype.random_int=function(t){return this.pcg_random.integer(t)},t.prototype.random=function(){return this.pcg_random.number()},t}()},15637:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.Constructor=0]="Constructor",t[t.Destructor=1]="Destructor"}(e.RegLifetimeType||(e.RegLifetimeType={}))},4622:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=i(84877),a=i(71962),s=function(){function t(t){this.ohno=t,this.domain_function={},this.domain_function_index={},this.domain_function_list=[],this.domain_function_types=[],this.respond={},this.lifetime_respond={},this.linter=[],this.action_types={},this.meta_finish_out_of_run_group={},this.meta_is_if_dropdown={},this.meta_never_causes_yield={},this.meta_pure={},this.meta_restart_when_finished={}}return t.prototype.has_responder_type=function(t){return void 0!=this.respond[t]},t.prototype.has_lifetime_responder_type=function(t){return void 0!=this.lifetime_respond[t]},t.prototype.has_if_dropdown_type=function(t){return void 0!==this.meta_is_if_dropdown[t]},t.prototype.get_responder_info=function(t){var e=this.respond[t];if(void 0==e)return this.lifetime_respond[t];var i=e.to_action,r=o.namespaced_id(i.namespace,i.id),n=this.action_types[r];return void 0!=n?{responder_spec:e,action_spec:n}:void 0},t.prototype.get_domain_functions=function(){return this.domain_function},t.prototype.get_domain_function_index=function(t){return this.domain_function_index[t]},t.prototype.get_domain_function_list=function(){return this.domain_function_list},t.prototype.get_domain_function_types=function(){return this.domain_function_types},t.prototype.block_restart_when_finished=function(t){return void 0!=this.meta_restart_when_finished[t]},t.prototype.block_finish_out_of_run_group=function(t){return void 0!=this.meta_finish_out_of_run_group[t]},t.prototype.block_pure=function(t){return void 0!=this.meta_pure[t]},t.prototype.block_never_causes_yield=function(t){return void 0!=this.meta_never_causes_yield[t]},t.prototype.register=function(t){var e=t.id,i=t.namespace,r=t.domain_function,n=t.respond,a=t.lifetime_respond,s=t.metadata,_=o.namespaced_id(i,e);if(void 0!=r){void 0==this.domain_function_index[_]&&(this.domain_function_index[_]=this.domain_function_list.length);var c=this.domain_function_index[_],u=r.bind(this.domain_function);this.domain_function_list[c]=u,this.domain_function_types[c]=_,this.domain_function[_]=u}void 0!=n&&(this.respond[_]=n),void 0!=a&&(this.lifetime_respond[_]=a),void 0!=s&&(s.restart_when_finished&&(this.meta_restart_when_finished[_]=!0),s.finish_out_of_run_group&&(this.meta_finish_out_of_run_group[_]=!0),s.pure&&(this.meta_pure[_]=!0),s.never_causes_yield&&(this.meta_never_causes_yield[_]=!0),s.is_if_dropdown&&(this.meta_is_if_dropdown[_]=!0))},t.prototype.register_linter=function(t){this.linter.push(t)},t.prototype.register_action_type=function(t){var e=t.namespace,i=t.id,r=o.namespaced_id(e,i);this.action_types[r]=t},t.prototype.misconfigurations=function(){var t=[];for(var e in this.respond){var i=this.respond[e].type!=o.ResponderType.Dynamic,r=void 0!=this.domain_function[e];i&&r&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered a non-Dynamic responder with a domain function. Only Dynamic Responders use domain functions.",ns_id:e}))}for(var e in this.lifetime_respond){void 0!=this.domain_function[e]&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered a Lifetime Responder with a domain function. The domain function will never be used.",ns_id:e})),void 0!=this.respond[e]&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered both a Lifetime Responder and a Responder with the same nsid.",ns_id:e}));var n=void 0!=this.meta_finish_out_of_run_group[e],a=void 0!=this.meta_never_causes_yield[e],s=void 0!=this.meta_pure[e],_=void 0!=this.meta_restart_when_finished[e],c=void 0!=this.meta_is_if_dropdown[e];(n||a||s||_||c)&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered metadata for a Lifetime Responder. This metadata will never be used.",ns_id:e}))}for(var e in this.meta_is_if_dropdown){this.domain_function[e]&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered a domain function for an if_dropdown. Will not be used.",ns_id:e})),this.respond[e]&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered a responder as an if_dropdown.",ns_id:e}));n=void 0!=this.meta_finish_out_of_run_group[e],a=void 0!=this.meta_never_causes_yield[e],s=void 0!=this.meta_pure[e],_=void 0!=this.meta_restart_when_finished[e];(n||a||s||_)&&t.push(this.ohno.client.registry_misconfiguration({misconfiguration:"Registered other metadata for an if_dropdown. Does not make sense.",ns_id:e}))}return t},t.prototype.get_ast_linters=function(){return this.linter},t.prototype.get_action_type=function(t){return this.action_types[t]},t=r.__decorate([n.injectable(),r.__param(0,n.inject(a.BINDING.Ohno)),r.__metadata("design:paramtypes",[Object])],t)}();e.RegistryImpl=s},40299:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=i(71962),a=(i(76715),function(){function t(t){this.u=t;var e=this.u.config.get().deterministic;void 0!==e&&(this.ms_per_update=1e3*e.seconds_per_update)}return t.prototype._wall_clock_now=function(){return"undefined"!==typeof performance&&void 0!==performance.now?performance.now():(new Date).getTime()},t.prototype.wall_clock_now=function(){if(void 0!==this.ms_per_update)throw this.u.ohno.system.looked_at_wall_clock_in_deterministic_mode();return this._wall_clock_now()},t.prototype.clear=function(){this.current_time=void 0},t.prototype.update=function(){void 0!==this.current_time&&void 0!==this.ms_per_update?this.current_time+=this.ms_per_update:this.current_time=this._wall_clock_now()},t.prototype.now=function(){return void 0===this.current_time&&(this.current_time=this._wall_clock_now()),this.current_time},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.Util)),r.__metadata("design:paramtypes",[Object])],t)}());e.ClockImpl=a},72130:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r,n=i(9108),o=i(85004),a=i(43180),s=(i(76715),i(71962));!function(t){t[t.Running=0]="Running",t[t.Stopped=1]="Stopped"}(r||(r={}));var _=function(){function t(t,e,i,n){var o=this;this.state_store=t,this.event_bus=e,this.u=i,this.config=n,this._clone_id_2_original_id={},this.original_id_2_clone_id_list={},this.run_status=r.Stopped,this.arbitrary_data={},this.interpreter_data={},this.running_blocks_map={},this.per_entity_clone_limit=this.config.get().per_entity_clone_limit,this.should_report_current_running_block=this.config.get().should_report_current_running_block,this.event_bus.system.config_updated.immediate.sub((function(){o.per_entity_clone_limit=o.config.get().per_entity_clone_limit,o.should_report_current_running_block=o.config.get().should_report_current_running_block}))}return t.prototype.clear=function(t){void 0===t&&(t=!0),t&&(this.run_status=r.Stopped),this._clone_id_2_original_id={},this.arbitrary_data={},this.interpreter_data={},this.original_id_2_clone_id_list={},this.should_report_current_running_block&&this.clear_running_blocks_map()},t.prototype.is_mirror=function(t){return!0},t.prototype.set_arbitrary_data=function(t,e){this.arbitrary_data[t]=e},t.prototype.get_arbitrary_data=function(t){return this.arbitrary_data[t]},t.prototype.set_interpreter_data=function(t,e,i){void 0==this.interpreter_data[t]&&(this.interpreter_data[t]={}),this.interpreter_data[t][e]=i},t.prototype.get_interpreter_data=function(t,e){return void 0==this.interpreter_data[t]&&(this.interpreter_data[t]={}),this.interpreter_data[t][e]},t.prototype.dispose_interpreter_data=function(t){delete this.interpreter_data[t],this.should_report_current_running_block&&void 0!==this.running_blocks_map[t]&&(this.set_finished_block(this.running_blocks_map[t]),delete this.running_blocks_map[t])},t.prototype.report_variable_updated=function(t,e){this.event_bus.runtime_data.variable_update.send({var_id:t,new_value:e})},t.prototype.report_list_updated=function(t,e){this.event_bus.runtime_data.list_update.send({list_id:t,new_value:e})},t.prototype.report_entity_variable_updated=function(t,e,i){this.event_bus.runtime_data.entity_variable_update.send({var_id:t,new_value:e,entity_id:i})},t.prototype.report_entity_list_updated=function(t,e,i){this.event_bus.runtime_data.entity_list_update.send({list_id:t,new_value:e,entity_id:i})},t.prototype.is_running=function(){return this.run_status===r.Running},t.prototype.is_stopped=function(){return this.run_status===r.Stopped},t.prototype.set_running=function(){this.run_status=r.Running},t.prototype.set_stopped=function(){this.run_status=r.Stopped},t.prototype.clone_id_2_original_id=function(t){return this._clone_id_2_original_id[t]},t.prototype.get_sprite_clones=function(t){return this.original_id_2_clone_id_list[t]},t.prototype.clone_created=function(t,e){if(this._clone_id_2_original_id[e]=t,this.original_id_2_clone_id_list[t]||(this.original_id_2_clone_id_list[t]=[]),this.original_id_2_clone_id_list[t].push(e),void 0!=this.per_entity_clone_limit)for(var i=this.original_id_2_clone_id_list[t],r=i.length-this.per_entity_clone_limit,n=0;n<r;n++)this.event_bus.clones.dispose_clone.send(i[n])},t.prototype.remove_clone_lookups=function(t){var e=this._clone_id_2_original_id[t];if(void 0!=e){delete this._clone_id_2_original_id[t];var i=this.original_id_2_clone_id_list[e];o(i,(function(e){return e===t})),0===i.length&&delete this.original_id_2_clone_id_list[e]}},t.prototype.entity_disposed=function(t){this.remove_clone_lookups(t),this.event_bus.runtime_data.entity_dispose.send({entity_id:t})},t.prototype.get_action_state_value=function(t){return this.state_store.get_action_state_value(t)},t.prototype.set_running_block=function(t,e){this.running_blocks_map[t]!==e&&(void 0!==this.running_blocks_map[t]&&this.event_bus.runtime_data.block_finished.send(this.running_blocks_map[t]),this.running_blocks_map[t]=e,this.event_bus.runtime_data.block_running.send(e))},t.prototype.set_finished_block=function(t){this.event_bus.runtime_data.block_finished.send(t)},t.prototype.clear_running_blocks_map=function(){for(var t=Object.keys(this.running_blocks_map),e=0;e<t.length;e++){var i=t[e];this.set_finished_block(this.running_blocks_map[i])}this.running_blocks_map={}},t=n.__decorate([a.injectable(),n.__param(0,a.inject(s.BINDING.ActionStateStore)),n.__param(1,a.inject(s.BINDING.EventBus)),n.__param(2,a.inject(s.BINDING.Util)),n.__param(3,a.inject(s.BINDING.Config)),n.__metadata("design:paramtypes",[Object,Object,Object,Object])],t)}();e.RuntimeDataImpl=_},8541:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r,n=i(9108),o=i(94379),a=i(58121),s=i(66933),_=i(80086),c=i(2100),u=i(85004),p=i(14064),d=i(64286),l=i(21139),h=i(63518),f=i(72064),g=i(22988),y=i(43180),m=i(71962),v=i(88073),b=i(79224),w=(i(76715),i(84877));function x(t,e,i,r,n,o,a,s,_){void 0===n&&(n=50),void 0===o&&(o={}),void 0===a&&(a=!1);var c={};return c.static=t,c.interpreter_id=e,c.target_entity_id=i,c.compile_cache_id=void 0!=r?r:t.source_map_rbid,c.responder_priority=n,c.action_parameters=o,c.is_warped=a,c.on_finished=s,c.on_dispose=_,c}!function(t){t[t.Pending=1]="Pending",t[t.Sending=2]="Sending",t[t.Idle=3]="Idle",t[t.Waiting=4]="Waiting"}(r||(r={}));var k=function(){function t(t,e,i,r,n,o,s,_,u,p,h,g,y,m,v,b){var w=this;this.state_store=t,this.orf=e,this.drf=i,this.block_pool=r,this.event_bus=n,this.log=o,this.ohno=s,this.prng_factory=_,this.registry=u,this.clock=p,this.runtime_data=h,this.task_manager=g,this.u=y,this.config=m,this.script_store=v,this.user_variable=b,this.frames=0,this.interpreters_spawned=0,this.timer_block_date=0,this.entity_states={},this.entities={},this.interpreters={},this.runnings={},this.sorted_interpreters=[],this.running_interpreter_was_blocked=!1,this.action_responders={},this.state_responders={},this.dynamic_responders={},this.action_queue=[],this.action_parameters={},this.tell_source_map={},this.broadcast_interpreter_n_listeners={},this.broadcast_responder_to_awaiting_interpreter_id={},this.broadcasting_interpreter_status_map={},this.broadcast_message_to_broadcasting_interpreter_id={},this.broadcast_message_should_wait={},this.responder_id_to_instance_interpreter_id={},this.instance_interpreter_id_to_responder_id={},this.just_restart=!1,this.just_stopped=!1,this.interpreters_needing_dispose={},this.interpreters_needing_dispose_force={},this.entities_needing_add=[],this.interpreters_needing_spawn=[],this.entities_needing_destruct={},this.entities_needing_dispose=[],this.disable_automatic_interpreter_restarts=!1,this.entities_cloned_times={},this.running_group=void 0,this.running_group_changed=!1,this.get_frame_error_metadata=function(t){var e=(t=a(t)).interpreter_id,i=t.source_map_rbid,r=t.source_entity_id,n=t.block_id;if(void 0!==e){var o=w.tell_source_map[e];void 0!==o&&(n=o.block_id,r=o.source_entity_id,i=o.source_map_rbid)}if(void 0!=t.block_id&&t.block_id==e&&void 0!=n&&(t.block_id=n),i=w.instance_interpreter_id_to_responder_id[i]||i,void 0!==t.proc_id){var s=w.get_procedure(t.proc_id);void 0!==s&&(i=s.script.id,r=s.source_entity_id)}return t.source_map_rbid=i,void 0!=r&&(t.source_entity_id=r),t},this.event_bus.clones.dispose_clone.immediate.sub((function(t){w.destruct_entity(t)}));var x=function(){var t=m.get();w.deterministic=t.deterministic,w.entity_max_clones_per_frame=t.entity_max_clones_per_frame,w.clone_target_do_add_responder_interpreters=t.clone_target_do_add_responder_interpreters,void 0==w.deterministic?(w.prng=_.create(),w.interpreter_sorters=w.get_interpreter_sorters(!1),w.get_sorted_ids=function(t){return f(t)}):(w.prng=_.create(w.deterministic.prng_seed),w.interpreter_sorters=w.get_interpreter_sorters(!0),w.get_sorted_ids=function(t){return t=d(t,c),l(t)}),w.user_debug_mode!=t.user_debug_mode&&w.runtime_data.is_running()?(w.event_bus.warning.all.send({error:w.ohno.configuration.tried_to_change_user_debug_mode_while_running()}),w.stop()):(w.user_debug_mode=t.user_debug_mode,w.interpreter_factory=w.user_debug_mode?w.drf:w.orf)};x(),this.event_bus.system.config_updated.immediate.sub(x)}return t.prototype.get_entities_ids=function(){return Object.keys(this.entities)},t.prototype.get_clones_of_entity=function(t){var e=this.get_entities_ids().concat(this.entities_needing_add.map((function(t){return t.id}))).filter((function(e){return e.startsWith("_clone_")&&e.includes(t)}));return f(e)},t.prototype.set_variable_specs=function(t){this.user_variable.set_variable_specs(t)},t.prototype.change_running_group=function(t){t!==this.running_group&&(this.running_group=t,this.running_group_changed=!0)},t.prototype.interpreter_out_of_running_group=function(t){return void 0!==t&&void 0!==this.running_group&&t!==this.running_group},t.prototype.is_interpreter_blocking_broadcaster=function(t){return void 0!==this.broadcast_responder_to_awaiting_interpreter_id[t]},t.prototype.block_finish_out_of_run_group=function(t){return this.registry.block_finish_out_of_run_group(t)},t.prototype.soft_clear=function(t){function e(e){var i={};for(var r in e){for(var n=e[r],o=[],a=0;a<n.length;a++){var s=n[a];s.runnable.typeclass_id!=t&&o.push(s)}i[r]=o}return e}this.action_responders=e(this.action_responders),this.state_responders=e(this.state_responders),this.dynamic_responders=e(this.dynamic_responders),this.interpreter_factory.clear()},t.prototype.clear_state=function(){this.frames=0,this.interpreters_spawned=0,this.timer_block_date=0,this.interpreters={},this.interpreters_needing_spawn=[],this.sorted_interpreters=[],this.action_responders={},this.state_responders={},this.dynamic_responders={},this.action_queue=[],this.tell_source_map={},this.responder_id_to_instance_interpreter_id={},this.instance_interpreter_id_to_responder_id={},this.broadcast_interpreter_n_listeners={},this.broadcast_responder_to_awaiting_interpreter_id={},this.broadcasting_interpreter_status_map={},this.broadcast_message_to_broadcasting_interpreter_id={},this.broadcast_message_should_wait={},this.just_restart=!1,this.just_stopped=!1,this.disable_automatic_interpreter_restarts=!1,this.interpreters_needing_dispose={},this.interpreters_needing_dispose_force={},this.entities_needing_add=[],this.entities_needing_destruct={},this.entities_needing_dispose=[],this.runtime_data.clear(!1),this.state_store.clear(),this.task_manager.clear(),this.user_variable.clear_state(),this.clock.clear(),this.clone_target_do_add_responder_interpreters&&this.script_store.clearClone(),this.running_group=void 0,this.entities={},this.runnings={}},t.prototype.clear=function(){this.clear_state(),this.entity_states={},this.script_store.clear(),this.user_variable.clear(),this.drf.clear(),this.orf.clear()},t.prototype.do_spawn_interpreter=function(t){var e=t.static,i={typeclass_id:e.typeclass_id,source_map_entity:e.source_map_entity,source_map_rbid:e.source_map_rbid,target_entity:t.target_entity_id,interpreter_id:t.interpreter_id},r=this.interpreter_factory.create(this,i,{creation_counter:this.interpreters_spawned,frame_created:this.frames,responder_priority:void 0!=t.responder_priority?t.responder_priority:50},t.compile_cache_id,e.script,e.group_id,t.is_warped||!1,t.action_parameters,t.on_finished),n=t.interpreter_id,o=t.target_entity_id;this.interpreters_spawned+=1,this.interpreters[n]=r,this.runnings[n]=t;var a=this.entities[o];void 0==a&&(a=this.create_entity(o)),a.add_interpreter(n)},t.prototype.spawn_interpreter=function(t){this.runtime_data.is_running()?this.interpreters_needing_spawn.push(t):this.do_spawn_interpreter(t)},t.prototype.get_responder_filter_value=function(t){if(void 0==t)return t;if(this.u.block.is.compiled_block(t)){if(this.u.block.is.atomic_type(t.type))return h(t.params[Object.keys(t.params)[0]]);throw this.ohno.system.unknown_action_block_param_type({caught_at:"RuntimeManager::get_param_value, unknown action block param type"})}return h(t)},t.prototype.load=function(t){var e=this;t.forEach((function(t){return e.script_store.load_compiled_entity_procedures(t)}));var i=t.map((function(t){var i=e.script_store.load_typeclass(t);return o.is_fail(i)&&("Typeclass had multiple constructors"==i.message?e.report_error_and_stop(e.ohno.compiler.user.defined_multiple_constructors({typeclass_id:t.id,compiled_entity:t}),"RuntimeManager::load_typeclass"):e.report_error_and_stop(e.ohno.compiler.user.defined_multiple_destructors({compiled_entity:t}),"RuntimeManager::load_typeclass")),i}));return t.forEach((function(t){void 0!=t.variables&&e.user_variable.set_entity_variable_specs(t.id,t.variables)})),i},t.prototype.create_singleton_entity_instances=function(){var t=this,e=[];return this.script_store.get_loaded_typeclass_ids().forEach((function(i){var r=t.create_entity_instance(i,i,void 0);e=e.concat(r)})),e},t.prototype.create_entity_instance=function(t,e,i,r){var n={typeclass_id:t,entity_id:e},a=this.script_store.get_typeclass(t);if(void 0==a){var s=this.ohno.client.missing_typeclass(n);return this.report_error_and_stop(s,"create_entity_instance"),[o.error('No typeclass with id "'+t+'"',s)]}var _=r||this.create_entity(e);if(_.alread_initialized){s=this.ohno.client.duplicate_entity_id(n);return this.report_error_and_stop(s,"create_entity_instance"),[o.error('An entity with id "${entity_id}" already exists',s)]}return _.set_typeclass(a),void 0!=i&&_.set_constructor_params(i),this.add_entity(_)},t.prototype.initialize_runnable=function(t){try{this.spawn_interpreter(t)}catch(e){return this.report_error_and_stop(e,"RuntimeManager::initialize_runnable, spawning interpreter"),o.error("Error while spawning interpreter",e)}return o.success(t.interpreter_id)},t.prototype.initialize_responder=function(t){var e=t.runnable,i=t.responder_spec,r="filter_value",n="filter_sub_type";void 0!=i.filter_arg_names&&(r=i.filter_arg_names.value,void 0!=i.filter_arg_names.sub_type&&(n=i.filter_arg_names.sub_type));var a=e.script.params,s=this.get_responder_filter_value(a[r]);s&&(t.value_filter=s);var _=this.get_responder_filter_value(a[n]);_&&(t.sub_type_filter=_);var c=this.action_responders;t.responder_spec.type==w.ResponderType.State&&(c=this.state_responders),t.responder_spec.type==w.ResponderType.Dynamic&&(c=this.dynamic_responders);var u=w.namespaced_id(t.action_spec.namespace,t.action_spec.id);return void 0==c[u]&&(c[u]=[]),c[u].push(t),o.success("responder")},t.prototype.send_action=function(t){this.runtime_data.is_stopped()||this.action_queue.push(t)},t.prototype.runnable_should_respond_to_action=function(t,e){if(t.responder_spec.entity_specific&&(void 0==e.entity_id||t.target_entity_id!=e.entity_id))return!1;if(void 0!=t.sub_type_filter&&t.sub_type_filter!=e.sub_type)return!1;if(void 0!=t.value_filter){var i=e.value;if(void 0==i&&void 0!=t.action_spec.statefulness&&(i=t.action_spec.statefulness.default_value),t.value_filter!=i)return!1}return!0},t.prototype.create_action_responder_interpreters=function(t){for(var e=0;e<t.length;e++){var i=t[e],r=w.namespaced_id(i.namespace,i.id);if(void 0!=this.action_responders[r])for(var n=0;n<this.action_responders[r].length;n++){var o=this.action_responders[r][n];0==o.responder_spec.async&&void 0!=this.responder_id_to_instance_interpreter_id[o.responder_id]||this.runnable_should_respond_to_action(o,i)&&this.do_add_responder_interpreters(o,"action",i.parameters)}}},t.prototype.create_state_responder_interpreters=function(){for(var t in this.state_responders)for(var e=this.state_responders[t],i=0;i<e.length;i++){var r=e[i];if(0!=r.responder_spec.async||void 0==this.responder_id_to_instance_interpreter_id[r.responder_id]){var n={action_namespace:r.action_spec.namespace,action_id:r.action_spec.id,sub_type:r.sub_type_filter};r.responder_spec.entity_specific&&(n.entity_id=r.target_entity_id);var o=this.state_store.get_action_state_value(n);void 0!=r.value_filter&&o!=r.value_filter||this.do_add_responder_interpreters(r,"state")}}},t.prototype.is_stateful_action=function(t){var e=this.registry.get_action_type(t);return void 0!=e&&void 0!=e.statefulness},t.prototype.create_dynamic_responder_interpreters=function(t){for(var e=this,i=_(Object.keys(this.dynamic_responders),(function(i){return p(t,{id:i})||e.is_stateful_action(i)})),r=0;r<i.length;r++)for(var n=this.dynamic_responders[i[r]],o=0;o<n.length;o++){var a=n[o];if(void 0!=a.responder_spec.trigger_function)if(0!=a.responder_spec.async||void 0==this.responder_id_to_instance_interpreter_id[a.responder_id])a.responder_spec.trigger_function(t,a.value_filter,a.sub_type_filter,a.target_entity_id,a.runnable.source_map_rbid,a.responder_id)&&this.do_add_responder_interpreters(a,"dynamic")}},t.prototype.do_add_responder_interpreters=function(t,e,i){var r=t.runnable;if(!this.interpreter_out_of_running_group(r.group_id)){var n=this.generate_random_id("__"+e+"_responder_interpreter__"),o=t.responder_id;this.instance_interpreter_id_to_responder_id[n]=o,void 0==this.responder_id_to_instance_interpreter_id[o]?this.responder_id_to_instance_interpreter_id[o]=[n]:this.responder_id_to_instance_interpreter_id[o].push(n);var a=x(r,n,t.target_entity_id,void 0,t.responder_priority,i);this.initialize_runnable(a)}},t.prototype.update_actions=function(){this.create_action_responder_interpreters(this.action_queue),this.state_store.update(this.action_queue),this.create_state_responder_interpreters(),this.create_dynamic_responder_interpreters(this.action_queue),this.action_queue=[]},t.prototype.create_entity=function(t){var e=new O(t,this);return this.entities[t]=e,e},t.prototype.do_add_entity=function(t){return this.entities[t.id]=t,void 0===this.runtime_data.clone_id_2_original_id(t.id)&&this.set_entity_known(t.id),t.init()},t.prototype.add_entity=function(t){return this.runtime_data.is_running()?(this.entities_needing_add.push(t),[]):this.do_add_entity(t)},t.prototype.clone_entity=function(t,e,i){if(this.get_entity_state(t)===v.EntityState.Unknown)throw this.ohno.user.clone_unknown_entity({entity_id:t});if(void 0==this.entities_cloned_times[t]&&(this.entities_cloned_times[t]=0),!(this.entities_cloned_times[t]>this.entity_max_clones_per_frame)){this.entities_cloned_times[t]++;var r=this.entities[t],n=this.generate_random_id("_clone_"+t+"_random_id");if(void 0==r)return n;var o=r.get_clone(n,e,i);return this.user_variable.clone_entity_variables(t,n),this.runtime_data.clone_created(t,n),this.clone_target_do_add_responder_interpreters?(this.script_store.load_clone_typeclass(t,n),this.create_entity_instance(n,n,void 0,o)):this.add_entity(o),n}},t.prototype.run=function(){this.timer_block_date=(new Date).valueOf(),this.runtime_data.set_running(),this.event_bus.runtime_manager.start.send()},t.prototype.delete_other_interpreters=function(t){for(var e=Object.keys(this.interpreters).filter((function(e){return e!=t})),i=0;i<e.length;i++)this.dispose_block_group(e[i])},t.prototype.stop=function(){this.runtime_data.is_stopped()||(this.runtime_data.set_stopped(),this.just_stopped=!0)},t.prototype.restart=function(){this.just_restart=!0},t.prototype.update=function(){var t=this;this.event_bus.runtime_manager.before_update.send();var e=!1,i=Object.keys(this.interpreters).length;try{this.update_dispose(),i!=Object.keys(this.interpreters).length&&(e=!0)}catch(s){return void this.report_error_and_stop(s,"RuntimeManager::update, update_dispose")}if(this.just_stopped||this.just_restart){var r=this.just_stopped;return this.just_stopped?this.clear():this.just_restart&&this.clear_state(),this.event_bus.runtime_data._meta.clear(),this.event_bus.runtime_manager._meta.clear(),void(r?this.event_bus.runtime_manager.stop.send():this.event_bus.runtime_manager.restart.send())}if(!this.disable_automatic_interpreter_restarts&&this.runtime_data.is_running()){try{i=Object.keys(this.interpreters).length;for(var n=0;n<this.entities_needing_add.length;n++){var o=this.entities_needing_add[n];this.entities_needing_destruct[o.id]||this.do_add_entity(o)}this.entities_needing_add=[],this.clock.update(),this.update_actions(),this.update_broadcaster_await();for(n=0;n<this.interpreters_needing_spawn.length;n++)this.do_spawn_interpreter(this.interpreters_needing_spawn[n]);this.interpreters_needing_spawn=[];var a=Object.keys(this.interpreters).map((function(e){return t.interpreters[e]}));i!=a.length&&(e=!0),(e||a.length!=this.sorted_interpreters.length)&&(this.sorted_interpreters=d(a,this.interpreter_sorters))}catch(s){return void this.report_error_and_stop(s,"RuntimeManager::update, adding and sorting interpreters")}try{this.step_code()}catch(s){return void this.report_error_and_stop(s,"RuntimeManager::update, stepping code")}this.task_manager.update(),this.frames++,this.event_bus.runtime_manager.after_update.send()}},t.prototype.broadcaster_is_blocking_on_await=function(t){return this.broadcasting_interpreter_status_map[t]&&this.broadcasting_interpreter_status_map[t]!==r.Idle},t.prototype.update_broadcaster_await=function(){for(var t in this.broadcasting_interpreter_status_map)this.broadcasting_interpreter_status_map[t]==r.Sending&&(this.broadcasting_interpreter_status_map[t]=r.Idle),this.broadcasting_interpreter_status_map[t]==r.Pending&&(this.broadcasting_interpreter_status_map[t]=r.Sending)},t.prototype.dispose_idle_broadcaster=function(){for(var t in this.broadcasting_interpreter_status_map)this.broadcasting_interpreter_status_map[t]==r.Idle&&(delete this.broadcasting_interpreter_status_map[t],delete this.broadcast_interpreter_n_listeners[t],delete this.broadcast_message_should_wait[t])},t.prototype.broadcaster_sending_message=function(t,e,i){this.send_action({id:"broadcast",namespace:"",parameters:void 0,sub_type:e,value:"on"});var n=this.broadcast_message_to_broadcasting_interpreter_id[e];n&&this.broadcasting_interpreter_status_map[n]==r.Pending||(this.broadcast_message_to_broadcasting_interpreter_id[e]=t,i&&(this.broadcast_message_should_wait[e]=i,this.broadcasting_interpreter_status_map[t]=r.Pending,this.running_interpreter_was_blocked=i))},t.prototype.broadcast_responder_bind_broadcaster=function(t,e,i){var n,o=this.broadcast_message_to_broadcasting_interpreter_id[e];this.broadcast_message_should_wait[e]&&(this.broadcast_responder_to_awaiting_interpreter_id[t]=o,this.broadcasting_interpreter_status_map[o]=r.Waiting,this.broadcast_interpreter_n_listeners[o]||(this.broadcast_interpreter_n_listeners[o]=0),(null===(n=i)||void 0===n?void 0:n.includes("clone"))||this.broadcast_interpreter_n_listeners[o]++)},t.prototype.broadcast_responder_unbind_broadcaster=function(t){var e=this.broadcast_responder_to_awaiting_interpreter_id[t];delete this.broadcast_responder_to_awaiting_interpreter_id[t],this.broadcast_interpreter_n_listeners[e]&&(this.broadcast_interpreter_n_listeners[e]--,this.broadcasting_interpreter_status_map[e]&&this.broadcast_interpreter_n_listeners[e]<1&&(this.broadcasting_interpreter_status_map[e]=r.Idle))},t.prototype.set_current_interpreter_not_blocked=function(){this.running_interpreter_was_blocked=!1},t.prototype.current_interpreter_must_yield=function(t,e){var i=void 0!=this.interpreters_needing_dispose[t]&&this.interpreters_needing_dispose[t];i=i||!0===this.interpreters_needing_dispose_force[t];var r=this.running_group_changed&&this.interpreter_out_of_running_group(e);return this.running_interpreter_was_blocked||i||r},t.prototype.add_task=function(t){return t.blocking&&(this.running_interpreter_was_blocked=!0),this.task_manager.add_task(this.generate_random_id("runtime_task"),t)},t.prototype.get_thread_lock=function(t,e){return this.add_task({entity_id:t,interpreter_id:e,blocking:!0})},t.prototype.thread_wait=function(t,e,i){this.add_task({entity_id:t,interpreter_id:e,lifetime:i,blocking:!0})},t.prototype.procedure_load=function(t,e,i){this.script_store.procedure_load(t,e,i)},t.prototype.get_procedure=function(t,e){void 0===e&&(e=!0);var i=this.script_store.get_procedure(t);if(void 0!=i)return e&&(i.script=this.block_pool.clone(i.script),i.script.id=this.generate_random_id("procedure_id")),i},t.prototype.get_elapsed_frames=function(){return this.frames},t.prototype.reset_timer=function(){this.timer_block_date=(new Date).valueOf()},t.prototype.get_timer_elapsed_s=function(){return((new Date).valueOf()-this.timer_block_date)/1e3},t.prototype.do_dispose_of_interpreter=function(t,e){if(void 0===e&&(e=!1),void 0!=this.interpreters[t]){var i=this.interpreters[t],r=this.runnings[t],n=r.target_entity_id,o=r.on_dispose,a=r.static.restart_when_finished;if(!e&&a)return i.reset(),this.runtime_data.dispose_interpreter_data(t),void this.task_manager.dispose_tasks_given({interpreter_id:t});var s=this.instance_interpreter_id_to_responder_id[t];if(void 0!=s){var _=this.responder_id_to_instance_interpreter_id[s];1==_.length?delete this.responder_id_to_instance_interpreter_id[s]:u(_,(function(e){return e==t})),delete this.instance_interpreter_id_to_responder_id[t]}i.dispose(),delete this.interpreters[t],delete this.runnings[t];var c=this.entities[n];void 0!=c&&c.remove_interpreter(t),this.runtime_data.dispose_interpreter_data(t),this.task_manager.dispose_tasks_given({interpreter_id:t}),o&&o()}else this.u.log.warn("Attempted to dispose non-existing interpreter.")},t.prototype.do_dispose_of_entity=function(t){void 0!==this.entity_states[t]&&(this.entity_states[t]=v.EntityState.Disposed),this.runtime_data.entity_disposed(t),this.user_variable.entity_disposed(t),delete this.entities[t],this.task_manager.dispose_tasks_given({entity_id:t})},t.prototype.do_destruct_entity=function(t){var e=this;if(this.entity_states[t]!=v.EntityState.Destructing){void 0!==this.entity_states[t]&&(this.entity_states[t]=v.EntityState.Destructing);var i=this.entities[t];if(void 0!=i){var r=function(e){return e.target_entity_id==t};for(var n in this.action_responders)u(this.action_responders[n],r);for(var n in this.state_responders)u(this.state_responders[n],r);for(var n in this.dynamic_responders)u(this.dynamic_responders[n],r);var a=i.destruct((function(){e.entities_needing_dispose.push(t)}));o.is_fail(a)&&this.report_warning(this.ohno.warning.entity_has_no_known_typeclass({typeclass_id:void 0,entity_id:t,caught_at:"RuntimeManager::do_destruct_entity"}))}}},t.prototype.update_dispose=function(){for(var t in this.interpreters_needing_dispose)this.do_dispose_of_interpreter(t);for(var t in this.interpreters_needing_dispose={},this.interpreters_needing_dispose_force)this.do_dispose_of_interpreter(t,!0);this.interpreters_needing_dispose_force={};for(var e=this.get_sorted_ids(Object.keys(this.entities_needing_destruct)),i=0;i<e.length;i++)this.do_destruct_entity(e[i]);this.entities_needing_destruct={};var r=this.get_sorted_ids(this.entities_needing_dispose);for(i=0;i<r.length;i++)this.do_dispose_of_entity(r[i]);this.entities_needing_dispose=[],this.dispose_idle_broadcaster(),this.task_manager.update_dispose()},t.prototype.get_interpreter_sorters=function(t){var e=function(t){return"self_listen"==t.metadata.type||"self_listen_with_param"==t.metadata.type||b.EVENT_BLOCKS[t.metadata.type]==b.EVENT_BLOCKS.mouse_on_emit},i=function(t){return t.metadata.priorities.frame_created},r=function(t){return t.metadata.priorities.responder_priority},n=function(t){return 0-t.metadata.priorities.creation_counter};return[e,i,r,n]},t.prototype.step_code=function(){this.running_group_changed=!1,this.entities_cloned_times={};var t=this.sorted_interpreters;if(0!==t.length)for(var e=t.length-1;e>=0;e--){var i=t[e];if(void 0==i)break;var r=i.metadata.interpreter_id;this.interpreters_needing_dispose[r]||this.interpreters_needing_dispose_force[r]||(this.interpreter_out_of_running_group(i.metadata.group_id)?this.block_finish_out_of_run_group(i.metadata.type)&&this.dispose_block_group(r):this.is_blocking(r)||this._step(r,i))}else this.event_bus.runtime_manager.idle.send()},t.prototype.is_blocking=function(t){return this.task_manager.is_blocking(t)||this.broadcaster_is_blocking_on_await(t)},t.prototype._step=function(t,e){var i;try{i=e.step()}catch(o){var r={root_block_id:t};throw o instanceof g.Catastrophe?o.annotation=s(o.annotation,r):o=this.ohno.system.unknown_system_error(o,n.__assign({caught_at:"RuntimeManager::_step"},r)),o}i==v.StepResult.finished&&(this.is_interpreter_blocking_broadcaster(t)&&this.broadcast_responder_unbind_broadcaster(t),this.dispose_block_group(t)),this.interpreter_out_of_running_group(e.metadata.group_id)&&this.block_finish_out_of_run_group(e.metadata.type)&&this.dispose_block_group(t)},t.prototype.destruct_entity=function(t){var e=this.entities[t];if(void 0!=e){this.entities_needing_destruct[t]=!0;for(var i=e.get_interpreter_ids(),r=0;r<i.length;r++)this.dispose_block_group(i[r],!0)}},t.prototype.dispose_block_group=function(t,e){void 0===e&&(e=!1),this.interpreters[t]?e?this.interpreters_needing_dispose_force[t]=!0:this.interpreters_needing_dispose[t]=!0:this.u.log.warn("Can't dispose block group (rbid: "+t+") without associated interpreter")},t.prototype.dispose_all=function(){for(var t in this.interpreters)this.dispose_block_group(t);this.entities_needing_add=[],this.interpreters_needing_spawn=[]},t.prototype.disable_interpreter_restarts_automatically=function(){this.disable_automatic_interpreter_restarts=!0,this.event_bus.runtime_manager.disable_interpreters_restart.send()},t.prototype.dispose_other_block_groups_of_entity=function(t,e){var i=this.entities[t];if(void 0!=i)for(var r=i.get_interpreter_ids(),n=0;n<r.length;n++){var o=r[n];o!==e&&this.dispose_block_group(o)}},t.prototype.dispose_block_groups_of_other_entities=function(t){for(var e in this.entities)if(e!==t)for(var i=this.entities[e].get_interpreter_ids(),r=0;r<i.length;r++)this.dispose_block_group(i[r])},t.prototype.get_list_id=function(t,e){return this.user_variable.get_list_id(t,e)},t.prototype.set_variable=function(t,e,i,r){this.user_variable.set_variable(t,e,i,r)},t.prototype.get_variable=function(t,e,i,r){return void 0===r&&(r=0),this.user_variable.get_variable(t,e,i,r)},t.prototype.set_style=function(t){this.user_variable.set_style(t)},t.prototype.get_style=function(t){return this.user_variable.get_style(t)},t.prototype.set_audio=function(t){this.user_variable.set_audio(t)},t.prototype.get_audio=function(t){return this.user_variable.get_audio(t)},t.prototype.lists_get=function(t,e,i){return this.user_variable.lists_get(t,e,i)},t.prototype.get_global_variable=function(t){return this.user_variable.get_global_variable(t)},t.prototype.set_procedure_parameters_type=function(t){return this.user_variable.set_procedure_parameters_type(t)},t.prototype.get_procedure_parameters_type=function(){return this.user_variable.get_procedure_parameters_type()},t.prototype.is_entity_variable=function(t){return this.user_variable.is_entity_variable(t)},t.prototype.get_entity_id_from_root_block_id=function(t){return this.runnings[t].target_entity_id},t.prototype.spawn_async_tell_interpreter=function(t,e,i,r,n){this.do_spawn_tell_interpreter(t,e,i,r,void 0,n)},t.prototype.do_spawn_tell_interpreter=function(t,e,i,r,n,o){var a=this.interpreters[t.interpreter_id];void 0==o&&void 0!=a.is_inside_warp&&(o=a.is_inside_warp());var s=t.typeclass_id,_=t.source_map_entity,c=t.source_map_rbid,u={block_id:i.id,source_entity_id:_,source_map_rbid:c,parent_stack:a.get_current_stack()},p=this.generate_random_id("__tell_root_block__");this.tell_source_map[p]=u;var d=i.type,l=x({typeclass_id:s,source_map_entity:_,source_map_rbid:c,script:i,group_id:r,restart_when_finished:this.registry.block_restart_when_finished(d),finish_out_of_group:this.registry.block_finish_out_of_run_group(d)},p,e,i.id,void 0,void 0,o,n);this.initialize_runnable(l)},t.prototype.get_error_stack=function(t){if("HEART.COMPILER.SYSTEM"===t.category.unique_code||"HEART.COMPILER.USER"===t.category.unique_code||void 0===t.annotation.interpreter_id||void 0==t.annotation.interpreter_stack)return[{block_id:t.annotation.block_id,source_entity_id:t.annotation.source_entity_id,source_map_rbid:t.annotation.source_map_rbid,interpreter_id:t.annotation.interpreter_id,proc_id:t.annotation.proc_id}];for(var e=a(t.annotation.interpreter_stack),i=t.annotation.interpreter_id;;){var r=this.tell_source_map[i];if(void 0===r)break;i=r.source_map_rbid;var n=r.parent_stack,o=e.shift();n[n.length-1].block_id=o.block_id,n[n.length-1].interpreter_id=o.interpreter_id,e=n.concat(e)}return e[e.length-1].block_id=t.annotation.block_id,e},t.prototype.error_to_error_event=function(t){var e=this.get_error_stack(t).map(this.get_frame_error_metadata);return t.annotation.stack=e,t.annotation.root_block_id=t.annotation.source_map_rbid,t.annotation.entity_id=t.annotation.source_entity_id,{error:t,error_stack:e}},t.prototype.report_error_and_stop=function(t,e){var i;i=t instanceof g.Catastrophe?t:this.ohno.system.unknown_system_error(t,{caught_at:e});var r=this.error_to_error_event(i);this.event_bus.error.runtime.send(r),this.stop()},t.prototype.report_warning=function(t){var e=this.error_to_error_event(t);this.event_bus.warning.runtime.send(e)},t.prototype.set_entity_known=function(t){this.entity_states[t]=v.EntityState.Known},t.prototype.get_entity_state=function(t){var e=this.entity_states[t];return void 0==e?v.EntityState.Unknown:e},t.prototype.get_random_number=function(){return this.prng.random()},t.prototype.generate_random_id=function(t,e){void 0===t&&(t=""),void 0===e&&(e=9);for(var i=[t],r=0;r<e;r++)i.push(Math.round(10*this.prng.random()));return i.join("")},t.prototype.get_compiled_block_by_interpreter_id=function(t){return this.runnings[t].static.script},t.prototype.set_running_block=function(t,e){this.runtime_data.set_running_block(t,e)},t.prototype.get_n_entities=function(){return Object.keys(this.entities).length},t.prototype.get_n_interpreters=function(){return Object.keys(this.interpreters).length},t.prototype.clock_now=function(){return this.clock.now()},t.prototype.wall_clock_now=function(){return this.clock.wall_clock_now()},t=n.__decorate([y.injectable(),n.__param(0,y.inject(m.BINDING.ActionStateStore)),n.__param(1,y.inject(m.BINDING.OptiRunnerFactory)),n.__param(2,y.inject(m.BINDING.DebugRunnerFactory)),n.__param(3,y.inject(m.BINDING.BlockPool)),n.__param(4,y.inject(m.BINDING.EventBus)),n.__param(5,y.inject(m.BINDING.Log)),n.__param(6,y.inject(m.BINDING.Ohno)),n.__param(7,y.inject(m.BINDING.PRNGFactory)),n.__param(8,y.inject(m.BINDING.Registry)),n.__param(9,y.inject(m.BINDING.Clock)),n.__param(10,y.inject(m.BINDING.RuntimeData)),n.__param(11,y.inject(m.BINDING.TaskManager)),n.__param(12,y.inject(m.BINDING.Util)),n.__param(13,y.inject(m.BINDING.Config)),n.__param(14,y.inject(m.BINDING.ScriptStore)),n.__param(15,y.inject(m.BINDING.UserVariable)),n.__metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object,Object])],t)}();e.RuntimeManagerImpl=k;var O=function(){function t(t,e,i,r){void 0===i&&(i=!1),void 0===r&&(r=void 0),this.id=t,this.run_mgr=e,this.is_mirror=i,this.is_mirror_responding_others=r,this.alread_initialized=!1,this.interpreters={}}return t.prototype.set_constructor_params=function(t){this.constructor_params=t},t.prototype.get_verbose_id=function(t){var e=this.id,i="__typeclass-"+t.typeclass_id+"__instance-"+e+"__srbid-"+t.source_map_rbid+"__";return this.run_mgr.generate_random_id(i)},t.prototype.get_runnable=function(t,e,i){return x(t,this.get_verbose_id(t),this.id,void 0,void 0,i,void 0,void 0,e)},t.prototype.get_responder=function(t){return{runnable:t.runnable,action_spec:t.action_spec,responder_spec:t.responder_spec,event_id:t.event_id,responder_id:this.get_verbose_id(t.runnable),target_entity_id:this.id}},t.prototype.init=function(){var t=this;if(void 0==this.typeclass)return[];var e,i=this,r=i.run_mgr,o=i.is_mirror,a=i.is_mirror_responding_others,s=this.typeclass,_=s.construct,c=s.runnables,u=s.responders,p=s.mirrors,d=s.mirror_runnables,l=function(e){var i=t.get_runnable(e);return r.initialize_runnable(i)},h=function(e){var i=t.get_responder(e);return r.initialize_responder(i)};if(e=o?a?function(){var t=d.map(l),e=u.map(h);return n.__spreadArrays(t,e)}:function(){var t=p.map(l),e=[];return r.clone_target_do_add_responder_interpreters&&(e=u.filter((function(t){return"running_group_activated"!==t.event_id})).map(h)),n.__spreadArrays(t,e)}:function(){var t=c.map(l),e=u.map(h);return n.__spreadArrays(t,e)},this.alread_initialized=!0,void 0==_)return e();var f=this.get_runnable(_,e,this.constructor_params);return[r.initialize_runnable(f)]},t.prototype.destruct=function(t){if(void 0==this.typeclass)return o.fail("entity has no typeclass");var e=this.run_mgr,i=this.typeclass.destruct;if(void 0==i)t();else{var r=this.get_runnable(i,t);e.initialize_runnable(r)}return o.ok()},t.prototype.get_clone=function(e,i,r){var n=this.typeclass,o=new t(e,this.run_mgr,i,r);return o.set_typeclass(n),o},t.prototype.add_interpreter=function(t){this.interpreters[t]=!0},t.prototype.remove_interpreter=function(t){delete this.interpreters[t]},t.prototype.get_interpreter_ids=function(){return Object.keys(this.interpreters)},t.prototype.set_typeclass=function(t){this.typeclass=t},t}()},36041:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(43180),o=i(71962),a=(i(76715),function(){function t(t){this.run_mgr=t}return t.prototype.restart=function(){this.run_mgr.restart()},t.prototype.run=function(){this.run_mgr.run()},t.prototype.stop=function(){this.run_mgr.stop()},t.prototype.update=function(){this.run_mgr.update()},t.prototype.clone_entity=function(t,e,i){return this.run_mgr.clone_entity(t,e,i)},t.prototype.set_entity_known=function(t){this.run_mgr.set_entity_known(t)},t.prototype.soft_clear=function(t){this.run_mgr.soft_clear(t)},t.prototype.clear=function(){this.run_mgr.clear()},t.prototype.disable_interpreter_restarts_automatically=function(){this.run_mgr.disable_interpreter_restarts_automatically()},t.prototype.change_running_group=function(t){this.run_mgr.change_running_group(t)},t.prototype.load=function(t){return this.run_mgr.load(t)},t.prototype.create_singleton_entity_instances=function(){return this.run_mgr.create_singleton_entity_instances()},t.prototype.create_entity_instance=function(t,e,i){return this.run_mgr.create_entity_instance(t,e,i)},t.prototype.procedure_load=function(t,e,i){this.run_mgr.procedure_load(t,e,i)},t.prototype.set_variable_specs=function(t){this.run_mgr.set_variable_specs(t)},t.prototype.add_task=function(t){return this.run_mgr.add_task(t)},t.prototype.get_thread_lock=function(t,e){return this.run_mgr.get_thread_lock(t,e)},t.prototype.send_action=function(t){this.run_mgr.send_action(t)},t.prototype.thread_wait=function(t,e,i){this.run_mgr.thread_wait(t,e,i)},t.prototype.get_elapsed_frames=function(){return this.run_mgr.get_elapsed_frames()},t.prototype.get_timer_elapsed_s=function(){return this.run_mgr.get_timer_elapsed_s()},t.prototype.reset_timer=function(){this.run_mgr.reset_timer()},t.prototype.get_entity_id_from_root_block_id=function(t){return this.run_mgr.get_entity_id_from_root_block_id(t)},t.prototype.delete_other_interpreters=function(t){this.run_mgr.delete_other_interpreters(t)},t.prototype.dispose_all=function(){this.run_mgr.dispose_all()},t.prototype.dispose_block_group=function(t){this.run_mgr.dispose_block_group(t)},t.prototype.dispose_block_groups_of_other_entities=function(t){this.run_mgr.dispose_block_groups_of_other_entities(t)},t.prototype.dispose_other_block_groups_of_entity=function(t,e){this.run_mgr.dispose_other_block_groups_of_entity(t,e)},t.prototype.destruct_entity=function(t){this.run_mgr.destruct_entity(t)},t.prototype.get_global_variable=function(t){return this.run_mgr.get_global_variable(t)},t.prototype.get_variable=function(t,e,i){return this.run_mgr.get_variable(t,e,i)},t.prototype.lists_get=function(t,e,i){return this.run_mgr.lists_get(t,e,i)},t.prototype.set_variable=function(t,e,i,r){this.run_mgr.set_variable(t,e,i,r)},t.prototype.set_style=function(t){this.run_mgr.set_style(t)},t.prototype.get_style=function(t){return this.run_mgr.get_style(t)},t.prototype.set_audio=function(t){this.run_mgr.set_audio(t)},t.prototype.get_audio=function(t){return this.run_mgr.get_audio(t)},t.prototype.is_entity_variable=function(t){return this.run_mgr.is_entity_variable(t)},t.prototype.set_procedure_parameters_type=function(t){return this.run_mgr.set_procedure_parameters_type(t)},t.prototype.get_procedure_parameters_type=function(){return this.run_mgr.get_procedure_parameters_type()},t.prototype.get_random_number=function(){return this.run_mgr.get_random_number()},t.prototype.get_list_id=function(t,e){return this.run_mgr.get_list_id(t,e)},t.prototype.broadcaster_sending_message=function(t,e,i){this.run_mgr.broadcaster_sending_message(t,e,i)},t.prototype.broadcast_responder_bind_broadcaster=function(t,e,i){this.run_mgr.broadcast_responder_bind_broadcaster(t,e,i)},t.prototype.get_entities_ids=function(){return this.run_mgr.get_entities_ids()},t=r.__decorate([n.injectable(),r.__param(0,n.inject(o.BINDING.RuntimeManager)),r.__metadata("design:paramtypes",[Object])],t)}());e.RuntimeManagerFacade=a},36138:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(94379),o=i(43180),a=i(71962),s=i(15637),_=function(){function t(t,e,i){this.registry=t,this.block_pool=e,this.block_is=i,this.typeclasses={},this.procedure_compiled_block_map={},this.entity_id_to_compiled_blocks={}}return t.prototype.clear=function(){for(var t in this.typeclasses={},this.procedure_compiled_block_map)this.block_pool.release(this.procedure_compiled_block_map[t].script);for(var e in this.procedure_compiled_block_map={},this.entity_id_to_compiled_blocks){var i=this.entity_id_to_compiled_blocks[e];for(var r in i)this.block_pool.release(i[r])}this.entity_id_to_compiled_blocks={}},t.prototype.clearClone=function(){for(var t in this.typeclasses)t.includes("clone")&&delete this.typeclasses[t]},t.prototype.load_compiled_entity_procedures=function(t){var e=this;Object.keys(t.procedures).forEach((function(i){var r=t.procedures[i],n=t.id;e.procedure_load(n,i,r)}))},t.prototype.procedure_load=function(t,e,i){this.procedure_compiled_block_map[e]={name:e,script:i,source_entity_id:t}},t.prototype.load_typeclass=function(t){var e,i,r=t.id,o=[],a=[],_=[],c=[],u=0,p=0,d=t.running_group_id||{};for(var l in this.entity_id_to_compiled_blocks[t.id]={},t.compiled_block_map){var h=this.block_pool.clone(t.compiled_block_map[l]);this.entity_id_to_compiled_blocks[t.id][l]=h;var f=d[l],g=h.type,y=this.registry.block_restart_when_finished(g),m=this.registry.block_finish_out_of_run_group(g),v={typeclass_id:r,source_map_entity:t.id,source_map_rbid:l,script:h,group_id:f,restart_when_finished:y,finish_out_of_group:m},b=this.registry.get_responder_info(h.type);if(b!=s.RegLifetimeType.Constructor)if(b!=s.RegLifetimeType.Destructor)if(void 0!=b){var w=b.action_spec,x={runnable:v,action_spec:w,responder_spec:b.responder_spec,event_id:w.id};c.push(x)}else this.block_is.mirror(v.script)?a.push(v):o.push(v),this.block_is.start_on_click(v.script)||_.push(v);else i=v,p+=1;else e=v,u+=1}return u>1?n.fail("Typeclass had multiple constructors"):p>1?n.fail("Typeclass had multiple destructors"):(this.typeclasses[r]={id:r,construct:e,destruct:i,runnables:o,mirrors:a,mirror_runnables:_,responders:c},n.ok())},t.prototype.load_clone_typeclass=function(t,e){var i=this.typeclasses[t],n=i.responders,o=[];n.forEach((function(t){o.push(r.__assign(r.__assign({},t),{runnable:r.__assign(r.__assign({},t.runnable),{typeclass_id:e,source_map_entity:e})}))})),this.typeclasses[e]=r.__assign(r.__assign({},i),{id:e,responders:o})},t.prototype.get_procedure=function(t){return this.procedure_compiled_block_map[t]},t.prototype.get_typeclass=function(t){return this.typeclasses[t]},t.prototype.get_loaded_typeclass_ids=function(){return Object.keys(this.typeclasses)},t=r.__decorate([o.injectable(),r.__param(0,o.inject(a.BINDING.Registry)),r.__param(1,o.inject(a.BINDING.BlockPool)),r.__param(2,o.inject(a.BINDING.BlockPredicates)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}();e.ScriptStoreImpl=_},34139:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(80086),o=i(40806),a=i(85004),s=i(43180),_=i(71962),c=(i(76715),function(){function t(t,e,i){this.runtime_data=t,this.clock=e,this.u=i,this.tasks=[],this.tasks_needing_dispose=[],this.interpreter_n_blockers_lookup={}}return t.prototype.clear=function(){this.tasks=[],this.tasks_needing_dispose=[],this.interpreter_n_blockers_lookup={}},t.prototype.update_dispose=function(){for(var t=this,e=a(this.tasks,(function(e){return o(t.tasks_needing_dispose,e.id)})),i=0;i<e.length;i++){var r=e[i],n=r.interpreter_id;r.blocking&&void 0!=this.interpreter_n_blockers_lookup[n]&&(this.interpreter_n_blockers_lookup[n]--,this.interpreter_n_blockers_lookup[n]<1&&delete this.interpreter_n_blockers_lookup[n])}this.tasks_needing_dispose=[]},t.prototype.update=function(){if(this.runtime_data.is_stopped())this.clear();else for(var t=0;t<this.tasks.length;t++)this.task_update(this.tasks[t])},t.prototype.add_task=function(t,e){var i=this,r=e;if(r.id=t,this.tasks.push(r),r.blocking){var n=e.interpreter_id;this.interpreter_n_blockers_lookup[n]=this.interpreter_n_blockers_lookup[n]||0,this.interpreter_n_blockers_lookup[n]++}return{stop:function(){return i.dispose_task(r.id)}}},t.prototype.is_blocking=function(t){return void 0!=this.interpreter_n_blockers_lookup[t]},t.prototype.dispose_task=function(t){this.tasks_needing_dispose.push(t)},t.prototype.dispose_tasks_given=function(t){for(var e=n(this.tasks,t),i=[],r=0;r<e.length;r++)i.push(e[r].id);this.tasks_needing_dispose=this.tasks_needing_dispose.concat(i)},t.prototype.task_update=function(t){var e=this.clock.now();if(void 0==t.start_tick||void 0==t.previous_tick)return t.start_tick=e,t.previous_tick=e,void(t.on_start&&t.on_start());var i=e-t.previous_tick;if(void 0==t.lifetime)return t.on_tick&&t.on_tick(i),void(t.previous_tick=e);var r=(e-t.start_tick)/t.lifetime;if(t.lifetime<=e-t.start_tick)return t.on_end&&t.on_end(i),void this.dispose_task(t.id);t.on_tick&&t.on_tick(i,r),t.previous_tick=e},t=r.__decorate([s.injectable(),r.__param(0,s.inject(_.BINDING.RuntimeData)),r.__param(1,s.inject(_.BINDING.Clock)),r.__param(2,s.inject(_.BINDING.Util)),r.__metadata("design:paramtypes",[Object,Object,Object])],t)}());e.TaskManagerImpl=c},97289:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(58121),o=i(43180),a=i(71962),s=i(88073),_=(i(76715),function(){function t(t,e){this.ohno=t,this.runtime_data=e,this.variable_specs={},this.variables={},this.entity_variables={},this.is_script_var={},this.is_entity_var={},this.style_list=[],this.audio_list={},this.paramter_map={}}return t.prototype.clear_state=function(){this.variables={},this.entity_variables={}},t.prototype.clear=function(){this.clear_state(),this.variable_specs={},this.is_script_var={},this.is_entity_var={},this.style_list=[],this.audio_list={}},t.prototype.set_variable_specs=function(t){for(var e=0;e<t.length;e++){var i=t[e];this.variable_specs[i.id]=i,i.scope!==s.VariableScope.entity?this.variables[i.id]=i.value:(this.is_entity_var[i.id]=!0,this.entity_variables[i.entity_id]||(this.entity_variables[i.entity_id]={}),this.entity_variables[i.entity_id][i.id]=i.value)}},t.prototype.set_style=function(t){this.style_list=t},t.prototype.get_style=function(t){if(-1!==this.style_list.findIndex((function(e){return e===t})))return this.style_list.findIndex((function(e){return e===t}))+1},t.prototype.set_audio=function(t){this.audio_list=t},t.prototype.get_audio=function(t){var e=this.audio_list[t];return e?e.name:void 0},t.prototype.set_procedure_parameters_type=function(t){this.paramter_map=t},t.prototype.get_procedure_parameters_type=function(){return this.paramter_map},t.prototype.set_entity_variable_specs=function(t,e){var i=e.map((function(e){return{type:"any",id:e,value:0,scope:s.VariableScope.entity,entity_id:t}}));this.set_variable_specs(i)},t.prototype.get_var_or_list=function(t,e,i,r){if(this.is_entity_var[t]){if(void 0==r)throw this.ohno.system.called_get_variable_without_needed_parameters({var_id:t});if(this.entity_variables[r]&&void 0!==this.entity_variables[r][t])return this.entity_variables[r][t];var n=this.variable_specs[t];throw this.ohno.user.entity_variable_operation_out_of_scope({target_entity_id:r,entity_variable_spec:n})}return void 0==this.variables[t]&&(this.variables[t]=e),this.variables[t]},t.prototype.get_list_id=function(t,e){var i=this.variables;for(var r in i){if(i[r]===t&&void 0!==this.variable_specs[r]&&void 0!==this.variable_specs[r].type&&"list"==this.variable_specs[r].type)return r}var n=this.entity_variables[e];for(var r in n){if(n[r]===t&&void 0!==this.variable_specs[r]&&void 0!==this.variable_specs[r].type&&"list"==this.variable_specs[r].type)return r}},t.prototype.set_variable=function(t,e,i,r){if(this.is_entity_var[t]){if(void 0==r)throw this.ohno.system.called_set_variable_without_needed_parameters({var_id:t,val:e});if(this.entity_variables[r]&&void 0!==this.entity_variables[r][t])return this.entity_variables[r][t]=e,void this.runtime_data.report_entity_variable_updated(t,e,r);throw this.ohno.user.entity_variable_operation_out_of_scope({target_entity_id:r,entity_variable_spec:this.variable_specs[t]})}this.variables[t]=e,this.runtime_data.report_variable_updated(t,e)},t.prototype.get_variable=function(t,e,i,r){return void 0===r&&(r=0),this.get_var_or_list(t,r,e,i)},t.prototype.lists_get=function(t,e,i){return this.get_var_or_list(t,[],e,i)},t.prototype.get_global_variable=function(t){return this.variables[t]},t.prototype.is_entity_variable=function(t){var e=this.variable_specs[t];return!!e&&e.scope===s.VariableScope.entity},t.prototype.clone_entity_variables=function(t,e){var i=n(this.entity_variables[t]);this.entity_variables[e]=i},t.prototype.entity_disposed=function(t){delete this.entity_variables[t]},t=r.__decorate([o.injectable(),r.__param(0,o.inject(a.BINDING.Ohno)),r.__param(1,o.inject(a.BINDING.RuntimeData)),r.__metadata("design:paramtypes",[Object,Object])],t)}());e.UserVariableImpl=_},86596:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(9108),n=i(58121),o=i(43180),a=i(71962),s=i(84877),_=["A-Za-z0-9"," \t",[",","?","!"],"\u4e00-\u9fff\u3400-\u4dff\uf900-\ufaff",["\uff0c","\uff01","\uff1f","\uff1b","\uff1a","\uff08","\uff09","\uff3b","\uff3d","\u3010","\u3011","\u3002","\ufe12","\u300e","\u300f","\u300c","\u300d","\ufe41","\ufe42","\u3001","\xb7","\u300a","\u300b","\u3008","\u3009","\ufe4f","\u22ef","\u2026","\u2010-\u2015","\uff5e","~","\u3000","\ufe4f"].join("")].join(""),c=new RegExp("^["+_+"]*$"),u=function(){function t(t,e,i,r){this.config=t,this.ohno=e,this.log=i,this.block=r,this.misc={ce_restore_cyclical_references:this.ce_restore_cyclical_references.bind(this),ce_without_cyclical_references:this.ce_without_cyclical_references.bind(this),is_safe_string:function(t){return c.test(t)},get_called_procedures:this.get_called_procedures.bind(this),namespaced_id:s.namespaced_id}}return t.prototype.ce_without_cyclical_references=function(t){var e=n(t);for(var i in e.compiled_block_map){var r=e.compiled_block_map[i];this.remove_parent_references(r)}for(var o in e.procedures){var a=e.procedures[o];this.remove_parent_references(a)}return e},t.prototype.ce_restore_cyclical_references=function(t){for(var e in t.compiled_block_map){var i=t.compiled_block_map[e];this.restore_parents(i)}for(var e in t.procedures){i=t.procedures[e];this.restore_parents(i)}},t.prototype.remove_parent_references=function(t){this.block.ast_for_each(t,(function(t){t.parent_block=void 0}))},t.prototype.restore_parents=function(t){this.block.ast_for_each(t,(function(t,e){void 0!=e&&(t.parent_block=e)}))},t.prototype.get_called_procedures=function(t){for(var e=this,i={},r=0;r<t.length;r++){var n=t[r];for(var o in n.procedures){var a=n.procedures[o];i[o]=a}}var s=function(t,i){e.block.ast_for_each(t,(function(t){e.block.is.procedures_callnoreturn(t)&&i(t.procedure_name),e.block.is.procedures_callreturn(t)&&i(t.procedure_name)}))},_=new Set;for(r=0;r<t.length;r++){n=t[r];for(var c in n.compiled_block_map){var u=n.compiled_block_map[c];s(u,(function(t){_.add(t)}))}}for(var p=new Set,d=_,l=function(){var t=new Set;d.forEach((function(e){p.add(e);var r=i[e];void 0!=r&&s(r,(function(e){p.has(e)||d.has(e)||t.add(e)}))})),d=t};0!=d.size;)l();return Array.from(p)},t=r.__decorate([o.injectable(),r.__param(0,o.inject(a.BINDING.Config)),r.__param(1,o.inject(a.BINDING.Ohno)),r.__param(2,o.inject(a.BINDING.Log)),r.__param(3,o.inject(a.BINDING.BlockUtil)),r.__metadata("design:paramtypes",[Object,Object,Object,Object])],t)}();e.UtilImpl=u},47905:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(55496);function o(t,e,i,n,o){var a={},s="number"===typeof o,_=void 0!==o&&s?o.toString():i;if(s&&void 0!==i)throw new Error(r.INVALID_DECORATOR_OPERATION);Reflect.hasOwnMetadata(t,e)&&(a=Reflect.getMetadata(t,e));var c=a[_];if(Array.isArray(c))for(var u=0,p=c;u<p.length;u++){var d=p[u];if(d.key===n.key)throw new Error(r.DUPLICATED_METADATA+" "+d.key.toString())}else c=[];c.push(n),a[_]=c,Reflect.defineMetadata(t,a,e)}function a(t,e){Reflect.decorate(t,e)}function s(t,e){return function(i,r){e(i,r,t)}}e.tagParameter=function(t,e,i,r){o(n.TAGGED,t,e,r,i)},e.tagProperty=function(t,e,i){o(n.TAGGED_PROP,t.constructor,e,i)},e.decorate=function(t,e,i){"number"===typeof i?a([s(i,t)],e):"string"===typeof i?Reflect.decorate([t],e,i):a([t],e)}},79966:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(55496),o=i(46373),a=i(47905),s=function(){function t(t){this._cb=t}return t.prototype.unwrap=function(){return this._cb()},t}();e.LazyServiceIdentifer=s,e.inject=function(t){return function(e,i,s){if(void 0===t)throw new Error(r.UNDEFINED_INJECT_ANNOTATION(e.name));var _=new o.Metadata(n.INJECT_TAG,t);"number"===typeof s?a.tagParameter(e,i,s,_):a.tagProperty(e,i,_)}}},88901:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(55496);e.injectable=function(){return function(t){if(Reflect.hasOwnMetadata(n.PARAM_TYPES,t))throw new Error(r.DUPLICATED_INJECTABLE_DECORATOR);var e=Reflect.getMetadata(n.DESIGN_PARAM_TYPES,t)||[];return Reflect.defineMetadata(n.PARAM_TYPES,e,t),t}}},8432:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(46373),o=i(47905);e.multiInject=function(t){return function(e,i,a){var s=new n.Metadata(r.MULTI_INJECT_TAG,t);"number"===typeof a?o.tagParameter(e,i,a,s):o.tagProperty(e,i,s)}}},10748:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(46373),o=i(47905);e.named=function(t){return function(e,i,a){var s=new n.Metadata(r.NAMED_TAG,t);"number"===typeof a?o.tagParameter(e,i,a,s):o.tagProperty(e,i,s)}}},28765:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(46373),o=i(47905);e.optional=function(){return function(t,e,i){var a=new n.Metadata(r.OPTIONAL_TAG,!0);"number"===typeof i?o.tagParameter(t,e,i,a):o.tagProperty(t,e,a)}}},35593:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(55496),o=i(46373);e.postConstruct=function(){return function(t,e,i){var a=new o.Metadata(n.POST_CONSTRUCT,e);if(Reflect.hasOwnMetadata(n.POST_CONSTRUCT,t.constructor))throw new Error(r.MULTIPLE_POST_CONSTRUCT_METHODS);Reflect.defineMetadata(n.POST_CONSTRUCT,a,t.constructor)}}},4481:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(46373),n=i(47905);e.tagged=function(t,e){return function(i,o,a){var s=new r.Metadata(t,e);"number"===typeof a?n.tagParameter(i,o,a,s):n.tagProperty(i,o,s)}}},90334:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(46373),o=i(47905);e.targetName=function(t){return function(e,i,a){var s=new n.Metadata(r.NAME_TAG,t);o.tagParameter(e,i,a,s)}}},18696:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(46373),o=i(47905);e.unmanaged=function(){return function(t,e,i){var a=new n.Metadata(r.UNMANAGED_TAG,!0);o.tagParameter(t,e,i,a)}}},8293:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(88142),n=i(15416),o=function(){function t(t,e){this.id=n.id(),this.activated=!1,this.serviceIdentifier=t,this.scope=e,this.type=r.BindingTypeEnum.Invalid,this.constraint=function(t){return!0},this.implementationType=null,this.cache=null,this.factory=null,this.provider=null,this.onActivation=null,this.dynamicValue=null}return t.prototype.clone=function(){var e=new t(this.serviceIdentifier,this.scope);return e.activated=!1,e.implementationType=this.implementationType,e.dynamicValue=this.dynamicValue,e.scope=this.scope,e.type=this.type,e.factory=this.factory,e.provider=this.provider,e.constraint=this.constraint,e.onActivation=this.onActivation,e.cache=this.cache,e},t}();e.Binding=o},26087:function(t,e){Object.defineProperty(e,"__esModule",{value:!0});e.BindingCount={MultipleBindingsAvailable:2,NoBindingsAvailable:0,OnlyOneBindingAvailable:1}},75659:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DUPLICATED_INJECTABLE_DECORATOR="Cannot apply @injectable decorator multiple times.",e.DUPLICATED_METADATA="Metadata key was used more than once in a parameter:",e.NULL_ARGUMENT="NULL argument",e.KEY_NOT_FOUND="Key Not Found",e.AMBIGUOUS_MATCH="Ambiguous match found for serviceIdentifier:",e.CANNOT_UNBIND="Could not unbind serviceIdentifier:",e.NOT_REGISTERED="No matching bindings found for serviceIdentifier:",e.MISSING_INJECTABLE_ANNOTATION="Missing required @injectable annotation in:",e.MISSING_INJECT_ANNOTATION="Missing required @inject or @multiInject annotation in:",e.UNDEFINED_INJECT_ANNOTATION=function(t){return"@inject called with undefined this could mean that the class "+t+" has a circular dependency problem. You can use a LazyServiceIdentifer to  overcome this limitation."},e.CIRCULAR_DEPENDENCY="Circular dependency found:",e.NOT_IMPLEMENTED="Sorry, this feature is not fully implemented yet.",e.INVALID_BINDING_TYPE="Invalid binding type:",e.NO_MORE_SNAPSHOTS_AVAILABLE="No snapshot available to restore.",e.INVALID_MIDDLEWARE_RETURN="Invalid return type in middleware. Middleware must return!",e.INVALID_FUNCTION_BINDING="Value provided to function binding must be a function!",e.INVALID_TO_SELF_VALUE="The toSelf function can only be applied when a constructor is used as service identifier",e.INVALID_DECORATOR_OPERATION="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",e.ARGUMENTS_LENGTH_MISMATCH=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return"The number of constructor arguments in the derived class "+t[0]+" must be >= than the number of constructor arguments of its base class."},e.CONTAINER_OPTIONS_MUST_BE_AN_OBJECT="Invalid Container constructor argument. Container options must be an object.",e.CONTAINER_OPTIONS_INVALID_DEFAULT_SCOPE="Invalid Container option. Default scope must be a string ('singleton' or 'transient').",e.CONTAINER_OPTIONS_INVALID_AUTO_BIND_INJECTABLE="Invalid Container option. Auto bind injectable must be a boolean",e.CONTAINER_OPTIONS_INVALID_SKIP_BASE_CHECK="Invalid Container option. Skip base check must be a boolean",e.MULTIPLE_POST_CONSTRUCT_METHODS="Cannot apply @postConstruct decorator multiple times in the same class",e.POST_CONSTRUCT_ERROR=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return"@postConstruct error in class "+t[0]+": "+t[1]},e.CIRCULAR_DEPENDENCY_IN_FACTORY=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return"It looks like there is a circular dependency in one of the '"+t[0]+"' bindings. Please investigate bindings withservice identifier '"+t[1]+"'."},e.STACK_OVERFLOW="Maximum call stack size exceeded"},88142:function(t,e){Object.defineProperty(e,"__esModule",{value:!0});e.BindingScopeEnum={Request:"Request",Singleton:"Singleton",Transient:"Transient"};e.BindingTypeEnum={ConstantValue:"ConstantValue",Constructor:"Constructor",DynamicValue:"DynamicValue",Factory:"Factory",Function:"Function",Instance:"Instance",Invalid:"Invalid",Provider:"Provider"};e.TargetTypeEnum={ClassProperty:"ClassProperty",ConstructorArgument:"ConstructorArgument",Variable:"Variable"}},55496:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NAMED_TAG="named",e.NAME_TAG="name",e.UNMANAGED_TAG="unmanaged",e.OPTIONAL_TAG="optional",e.INJECT_TAG="inject",e.MULTI_INJECT_TAG="multi_inject",e.TAGGED="inversify:tagged",e.TAGGED_PROP="inversify:tagged_props",e.PARAM_TYPES="inversify:paramtypes",e.DESIGN_PARAM_TYPES="design:paramtypes",e.POST_CONSTRUCT="post_construct"},22054:function(t,e,i){var r=this&&this.__awaiter||function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){t.done?n(t.value):new i((function(e){e(t.value)})).then(a,s)}_((r=r.apply(t,e||[])).next())}))},n=this&&this.__generator||function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=r[2&o[0]?"return":o[0]?"throw":"next"])&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[0,n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}};Object.defineProperty(e,"__esModule",{value:!0});var o=i(8293),a=i(75659),s=i(88142),_=i(55496),c=i(74700),u=i(23480),p=i(79949),d=i(61227),l=i(15416),h=i(64809),f=i(10436),g=i(85339),y=function(){function t(t){var e=t||{};if("object"!==typeof e)throw new Error(""+a.CONTAINER_OPTIONS_MUST_BE_AN_OBJECT);if(void 0===e.defaultScope)e.defaultScope=s.BindingScopeEnum.Transient;else if(e.defaultScope!==s.BindingScopeEnum.Singleton&&e.defaultScope!==s.BindingScopeEnum.Transient&&e.defaultScope!==s.BindingScopeEnum.Request)throw new Error(""+a.CONTAINER_OPTIONS_INVALID_DEFAULT_SCOPE);if(void 0===e.autoBindInjectable)e.autoBindInjectable=!1;else if("boolean"!==typeof e.autoBindInjectable)throw new Error(""+a.CONTAINER_OPTIONS_INVALID_AUTO_BIND_INJECTABLE);if(void 0===e.skipBaseClassChecks)e.skipBaseClassChecks=!1;else if("boolean"!==typeof e.skipBaseClassChecks)throw new Error(""+a.CONTAINER_OPTIONS_INVALID_SKIP_BASE_CHECK);this.options={autoBindInjectable:e.autoBindInjectable,defaultScope:e.defaultScope,skipBaseClassChecks:e.skipBaseClassChecks},this.id=l.id(),this._bindingDictionary=new g.Lookup,this._snapshots=[],this._middleware=null,this.parent=null,this._metadataReader=new c.MetadataReader}return t.merge=function(e,i){var r=new t,n=u.getBindingDictionary(r),o=u.getBindingDictionary(e),a=u.getBindingDictionary(i);function s(t,e){t.traverse((function(t,i){i.forEach((function(t){e.add(t.serviceIdentifier,t.clone())}))}))}return s(o,n),s(a,n),r},t.prototype.load=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=this._getContainerModuleHelpersFactory(),r=0,n=t;r<n.length;r++){var o=n[r],a=i(o.id);o.registry(a.bindFunction,a.unbindFunction,a.isboundFunction,a.rebindFunction)}},t.prototype.loadAsync=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r(this,void 0,void 0,(function(){var e,i,r,o,a;return n(this,(function(n){switch(n.label){case 0:e=this._getContainerModuleHelpersFactory(),i=0,r=t,n.label=1;case 1:return i<r.length?(o=r[i],a=e(o.id),[4,o.registry(a.bindFunction,a.unbindFunction,a.isboundFunction,a.rebindFunction)]):[3,4];case 2:n.sent(),n.label=3;case 3:return i++,[3,1];case 4:return[2]}}))}))},t.prototype.unload=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach((function(e){var i,r=(i=e.id,function(t){return t.moduleId===i});t._bindingDictionary.removeByCondition(r)}))},t.prototype.bind=function(t){var e=this.options.defaultScope||s.BindingScopeEnum.Transient,i=new o.Binding(t,e);return this._bindingDictionary.add(t,i),new d.BindingToSyntax(i)},t.prototype.rebind=function(t){return this.unbind(t),this.bind(t)},t.prototype.unbind=function(t){try{this._bindingDictionary.remove(t)}catch(e){throw new Error(a.CANNOT_UNBIND+" "+h.getServiceIdentifierAsString(t))}},t.prototype.unbindAll=function(){this._bindingDictionary=new g.Lookup},t.prototype.isBound=function(t){var e=this._bindingDictionary.hasKey(t);return!e&&this.parent&&(e=this.parent.isBound(t)),e},t.prototype.isBoundNamed=function(t,e){return this.isBoundTagged(t,_.NAMED_TAG,e)},t.prototype.isBoundTagged=function(t,e,i){var r=!1;if(this._bindingDictionary.hasKey(t)){var n=this._bindingDictionary.get(t),o=u.createMockRequest(this,t,e,i);r=n.some((function(t){return t.constraint(o)}))}return!r&&this.parent&&(r=this.parent.isBoundTagged(t,e,i)),r},t.prototype.snapshot=function(){this._snapshots.push(f.ContainerSnapshot.of(this._bindingDictionary.clone(),this._middleware))},t.prototype.restore=function(){var t=this._snapshots.pop();if(void 0===t)throw new Error(a.NO_MORE_SNAPSHOTS_AVAILABLE);this._bindingDictionary=t.bindings,this._middleware=t.middleware},t.prototype.createChild=function(e){var i=new t(e||this.options);return i.parent=this,i},t.prototype.applyMiddleware=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this._middleware?this._middleware:this._planAndResolve();this._middleware=t.reduce((function(t,e){return e(t)}),i)},t.prototype.applyCustomMetadataReader=function(t){this._metadataReader=t},t.prototype.get=function(t){return this._get(!1,!1,s.TargetTypeEnum.Variable,t)},t.prototype.getTagged=function(t,e,i){return this._get(!1,!1,s.TargetTypeEnum.Variable,t,e,i)},t.prototype.getNamed=function(t,e){return this.getTagged(t,_.NAMED_TAG,e)},t.prototype.getAll=function(t){return this._get(!0,!0,s.TargetTypeEnum.Variable,t)},t.prototype.getAllTagged=function(t,e,i){return this._get(!1,!0,s.TargetTypeEnum.Variable,t,e,i)},t.prototype.getAllNamed=function(t,e){return this.getAllTagged(t,_.NAMED_TAG,e)},t.prototype.resolve=function(t){var e=this.createChild();return e.bind(t).toSelf(),e.get(t)},t.prototype._getContainerModuleHelpersFactory=function(){var t=this,e=function(t,e){t._binding.moduleId=e},i=function(i){return function(r){var n=t.rebind.bind(t)(r);return e(n,i),n}};return function(r){return{bindFunction:(n=r,function(i){var r=t.bind.bind(t)(i);return e(r,n),r}),isboundFunction:function(e){return t.isBound.bind(t)(e)},rebindFunction:i(r),unbindFunction:function(e){t.unbind.bind(t)(e)}};var n}},t.prototype._get=function(t,e,i,r,n,o){var s=null,_={avoidConstraints:t,contextInterceptor:function(t){return t},isMultiInject:e,key:n,serviceIdentifier:r,targetType:i,value:o};if(this._middleware){if(void 0===(s=this._middleware(_))||null===s)throw new Error(a.INVALID_MIDDLEWARE_RETURN)}else s=this._planAndResolve()(_);return s},t.prototype._planAndResolve=function(){var t=this;return function(e){var i=u.plan(t._metadataReader,t,e.isMultiInject,e.targetType,e.serviceIdentifier,e.key,e.value,e.avoidConstraints);return i=e.contextInterceptor(i),p.resolve(i)}},t}();e.Container=y},8063:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(15416),n=function(t){this.id=r.id(),this.registry=t};e.ContainerModule=n;var o=function(t){this.id=r.id(),this.registry=t};e.AsyncContainerModule=o},10436:function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){}return t.of=function(e,i){var r=new t;return r.bindings=e,r.middleware=i,r},t}();e.ContainerSnapshot=i},85339:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=function(){function t(){this._map=new Map}return t.prototype.getMap=function(){return this._map},t.prototype.add=function(t,e){if(null===t||void 0===t)throw new Error(r.NULL_ARGUMENT);if(null===e||void 0===e)throw new Error(r.NULL_ARGUMENT);var i=this._map.get(t);void 0!==i?(i.push(e),this._map.set(t,i)):this._map.set(t,[e])},t.prototype.get=function(t){if(null===t||void 0===t)throw new Error(r.NULL_ARGUMENT);var e=this._map.get(t);if(void 0!==e)return e;throw new Error(r.KEY_NOT_FOUND)},t.prototype.remove=function(t){if(null===t||void 0===t)throw new Error(r.NULL_ARGUMENT);if(!this._map.delete(t))throw new Error(r.KEY_NOT_FOUND)},t.prototype.removeByCondition=function(t){var e=this;this._map.forEach((function(i,r){var n=i.filter((function(e){return!t(e)}));n.length>0?e._map.set(r,n):e._map.delete(r)}))},t.prototype.hasKey=function(t){if(null===t||void 0===t)throw new Error(r.NULL_ARGUMENT);return this._map.has(t)},t.prototype.clone=function(){var e=new t;return this._map.forEach((function(t,i){t.forEach((function(t){return e.add(i,t.clone())}))})),e},t.prototype.traverse=function(t){this._map.forEach((function(e,i){t(i,e)}))},t}();e.Lookup=n},43180:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496);e.METADATA_KEY=r;var n=i(22054);e.Container=n.Container;var o=i(88142);e.BindingScopeEnum=o.BindingScopeEnum,e.BindingTypeEnum=o.BindingTypeEnum,e.TargetTypeEnum=o.TargetTypeEnum;var a=i(8063);e.AsyncContainerModule=a.AsyncContainerModule,e.ContainerModule=a.ContainerModule;var s=i(88901);e.injectable=s.injectable;var _=i(4481);e.tagged=_.tagged;var c=i(10748);e.named=c.named;var u=i(79966);e.inject=u.inject,e.LazyServiceIdentifer=u.LazyServiceIdentifer;var p=i(28765);e.optional=p.optional;var d=i(18696);e.unmanaged=d.unmanaged;var l=i(8432);e.multiInject=l.multiInject;var h=i(90334);e.targetName=h.targetName;var f=i(35593);e.postConstruct=f.postConstruct;var g=i(74700);e.MetadataReader=g.MetadataReader;var y=i(15416);e.id=y.id;var m=i(47905);e.decorate=m.decorate;var v=i(63465);e.traverseAncerstors=v.traverseAncerstors,e.taggedConstraint=v.taggedConstraint,e.namedConstraint=v.namedConstraint,e.typeConstraint=v.typeConstraint;var b=i(64809);e.getServiceIdentifierAsString=b.getServiceIdentifierAsString;var w=i(71771);e.multiBindToService=w.multiBindToService},90501:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(15416),n=function(){function t(t){this.id=r.id(),this.container=t}return t.prototype.addPlan=function(t){this.plan=t},t.prototype.setCurrentRequest=function(t){this.currentRequest=t},t}();e.Context=n},46373:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=function(){function t(t,e){this.key=t,this.value=e}return t.prototype.toString=function(){return this.key===r.NAMED_TAG?"named: "+this.value.toString()+" ":"tagged: { key:"+this.key.toString()+", value: "+this.value+" }"},t}();e.Metadata=n},74700:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=function(){function t(){}return t.prototype.getConstructorMetadata=function(t){return{compilerGeneratedMetadata:Reflect.getMetadata(r.PARAM_TYPES,t),userGeneratedMetadata:Reflect.getMetadata(r.TAGGED,t)||{}}},t.prototype.getPropertiesMetadata=function(t){return Reflect.getMetadata(r.TAGGED_PROP,t)||[]},t}();e.MetadataReader=n},38034:function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=function(t,e){this.parentContext=t,this.rootRequest=e};e.Plan=i},23480:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(26087),n=i(75659),o=i(88142),a=i(55496),s=i(84271),_=i(64809),c=i(90501),u=i(46373),p=i(38034),d=i(39261),l=i(69387),h=i(49387);function f(t){return t._bindingDictionary}function g(t,e,i,o,a){var s=m(i.container,a.serviceIdentifier),c=[];return s.length===r.BindingCount.NoBindingsAvailable&&i.container.options.autoBindInjectable&&"function"===typeof a.serviceIdentifier&&t.getConstructorMetadata(a.serviceIdentifier).compilerGeneratedMetadata&&(i.container.bind(a.serviceIdentifier).toSelf(),s=m(i.container,a.serviceIdentifier)),c=e?s:s.filter((function(t){var e=new l.Request(t.serviceIdentifier,i,o,t,a);return t.constraint(e)})),function(t,e,i,o){switch(e.length){case r.BindingCount.NoBindingsAvailable:if(i.isOptional())return e;var a=_.getServiceIdentifierAsString(t),s=n.NOT_REGISTERED;throw s+=_.listMetadataForTarget(a,i),s+=_.listRegisteredBindingsForServiceIdentifier(o,a,m),new Error(s);case r.BindingCount.OnlyOneBindingAvailable:if(!i.isArray())return e;case r.BindingCount.MultipleBindingsAvailable:default:if(i.isArray())return e;a=_.getServiceIdentifierAsString(t),s=n.AMBIGUOUS_MATCH+" "+a;throw s+=_.listRegisteredBindingsForServiceIdentifier(o,a,m),new Error(s)}}(a.serviceIdentifier,c,a,i.container),c}function y(t,e,i,r,a,s){var _,c;if(null===a){_=g(t,e,r,null,s),c=new l.Request(i,r,null,_,s);var u=new p.Plan(r,c);r.addPlan(u)}else _=g(t,e,r,a,s),c=a.addChildRequest(s.serviceIdentifier,_,s);_.forEach((function(e){var i=null;if(s.isArray())i=c.addChildRequest(e.serviceIdentifier,e,s);else{if(e.cache)return;i=c}if(e.type===o.BindingTypeEnum.Instance&&null!==e.implementationType){var a=d.getDependencies(t,e.implementationType);if(!r.container.options.skipBaseClassChecks){var _=d.getBaseClassDependencyCount(t,e.implementationType);if(a.length<_){var u=n.ARGUMENTS_LENGTH_MISMATCH(d.getFunctionName(e.implementationType));throw new Error(u)}}a.forEach((function(e){y(t,!1,e.serviceIdentifier,r,i,e)}))}}))}function m(t,e){var i=[],r=f(t);return r.hasKey(e)?i=r.get(e):null!==t.parent&&(i=m(t.parent,e)),i}e.getBindingDictionary=f,e.plan=function(t,e,i,r,n,o,p,d){void 0===d&&(d=!1);var l=new c.Context(e),f=function(t,e,i,r,n,o){var s=t?a.MULTI_INJECT_TAG:a.INJECT_TAG,_=new u.Metadata(s,i),c=new h.Target(e,r,i,_);if(void 0!==n){var p=new u.Metadata(n,o);c.metadata.push(p)}return c}(i,r,n,"",o,p);try{return y(t,d,n,l,null,f),l}catch(g){throw s.isStackOverflowExeption(g)&&l.plan&&_.circularDependencyToException(l.plan.rootRequest),g}},e.createMockRequest=function(t,e,i,r){var n=new h.Target(o.TargetTypeEnum.Variable,"",e,new u.Metadata(i,r)),a=new c.Context(t);return new l.Request(e,a,null,[],n)}},51337:function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t){this.str=t}return t.prototype.startsWith=function(t){return 0===this.str.indexOf(t)},t.prototype.endsWith=function(t){var e,i=t.split("").reverse().join("");return e=this.str.split("").reverse().join(""),this.startsWith.call({str:e},i)},t.prototype.contains=function(t){return-1!==this.str.indexOf(t)},t.prototype.equals=function(t){return this.str===t},t.prototype.value=function(){return this.str},t}();e.QueryableString=i},39261:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(79966),n=i(75659),o=i(88142),a=i(55496),s=i(64809);e.getFunctionName=s.getFunctionName;var _=i(49387);function c(t,e,i,r){var o=t.getConstructorMetadata(i),a=o.compilerGeneratedMetadata;if(void 0===a){var s=n.MISSING_INJECTABLE_ANNOTATION+" "+e+".";throw new Error(s)}var _=o.userGeneratedMetadata,c=Object.keys(_),d=function(t,e,i,r,n){for(var o=[],a=0;a<n;a++){var s=u(a,t,e,i,r);null!==s&&o.push(s)}return o}(r,e,a,_,0===i.length&&c.length>0?c.length:i.length),l=p(t,i);return d.concat(l)}function u(t,e,i,a,s){var c=s[t.toString()]||[],u=d(c),p=!0!==u.unmanaged,l=a[t],h=u.inject||u.multiInject;if((l=h||l)instanceof r.LazyServiceIdentifer&&(l=l.unwrap()),p){if(!e&&(l===Object||l===Function||void 0===l)){var f=n.MISSING_INJECT_ANNOTATION+" argument "+t+" in class "+i+".";throw new Error(f)}var g=new _.Target(o.TargetTypeEnum.ConstructorArgument,u.targetName,l);return g.metadata=c,g}return null}function p(t,e){for(var i=t.getPropertiesMetadata(e),r=[],n=0,a=Object.keys(i);n<a.length;n++){var s=a[n],c=i[s],u=d(i[s]),l=u.targetName||s,h=u.inject||u.multiInject,f=new _.Target(o.TargetTypeEnum.ClassProperty,l,h);f.metadata=c,r.push(f)}var g=Object.getPrototypeOf(e.prototype).constructor;if(g!==Object){var y=p(t,g);r=r.concat(y)}return r}function d(t){var e={};return t.forEach((function(t){e[t.key.toString()]=t.value})),{inject:e[a.INJECT_TAG],multiInject:e[a.MULTI_INJECT_TAG],targetName:e[a.NAME_TAG],unmanaged:e[a.UNMANAGED_TAG]}}e.getDependencies=function(t,e){return c(t,s.getFunctionName(e),e,!1)},e.getBaseClassDependencyCount=function t(e,i){var r=Object.getPrototypeOf(i.prototype).constructor;if(r!==Object){var n=c(e,s.getFunctionName(r),r,!0),o=n.map((function(t){return t.metadata.filter((function(t){return t.key===a.UNMANAGED_TAG}))})),_=[].concat.apply([],o).length,u=n.length-_;return u>0?u:t(e,r)}return 0}},69387:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(15416),n=function(){function t(t,e,i,n,o){this.id=r.id(),this.serviceIdentifier=t,this.parentContext=e,this.parentRequest=i,this.target=o,this.childRequests=[],this.bindings=Array.isArray(n)?n:[n],this.requestScope=null===i?new Map:null}return t.prototype.addChildRequest=function(e,i,r){var n=new t(e,this.parentContext,this,i,r);return this.childRequests.push(n),n},t}();e.Request=n},49387:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(15416),o=i(46373),a=i(51337),s=function(){function t(t,e,i,s){this.id=n.id(),this.type=t,this.serviceIdentifier=i,this.name=new a.QueryableString(e||""),this.metadata=new Array;var _=null;"string"===typeof s?_=new o.Metadata(r.NAMED_TAG,s):s instanceof o.Metadata&&(_=s),null!==_&&this.metadata.push(_)}return t.prototype.hasTag=function(t){for(var e=0,i=this.metadata;e<i.length;e++){if(i[e].key===t)return!0}return!1},t.prototype.isArray=function(){return this.hasTag(r.MULTI_INJECT_TAG)},t.prototype.matchesArray=function(t){return this.matchesTag(r.MULTI_INJECT_TAG)(t)},t.prototype.isNamed=function(){return this.hasTag(r.NAMED_TAG)},t.prototype.isTagged=function(){return this.metadata.some((function(t){return t.key!==r.INJECT_TAG&&t.key!==r.MULTI_INJECT_TAG&&t.key!==r.NAME_TAG&&t.key!==r.UNMANAGED_TAG&&t.key!==r.NAMED_TAG}))},t.prototype.isOptional=function(){return this.matchesTag(r.OPTIONAL_TAG)(!0)},t.prototype.getNamedTag=function(){return this.isNamed()?this.metadata.filter((function(t){return t.key===r.NAMED_TAG}))[0]:null},t.prototype.getCustomTags=function(){return this.isTagged()?this.metadata.filter((function(t){return t.key!==r.INJECT_TAG&&t.key!==r.MULTI_INJECT_TAG&&t.key!==r.NAME_TAG&&t.key!==r.UNMANAGED_TAG&&t.key!==r.NAMED_TAG})):null},t.prototype.matchesNamedTag=function(t){return this.matchesTag(r.NAMED_TAG)(t)},t.prototype.matchesTag=function(t){var e=this;return function(i){for(var r=0,n=e.metadata;r<n.length;r++){var o=n[r];if(o.key===t&&o.value===i)return!0}return!1}},t}();e.Target=s},70317:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(88142),o=i(55496);e.resolveInstance=function(t,e,i){var a,s,_=null;if(e.length>0){var c=e.filter((function(t){return null!==t.target&&t.target.type===n.TargetTypeEnum.ConstructorArgument})).map(i);s=c,_=function(t,e,i){var r=e.filter((function(t){return null!==t.target&&t.target.type===n.TargetTypeEnum.ClassProperty})),o=r.map(i);return r.forEach((function(e,i){var r;r=e.target.name.value();var n=o[i];t[r]=n})),t}(_=new((a=t).bind.apply(a,[void 0].concat(s))),e,i)}else _=new t;return function(t,e){if(Reflect.hasMetadata(o.POST_CONSTRUCT,t)){var i=Reflect.getMetadata(o.POST_CONSTRUCT,t);try{e[i.value]()}catch(n){throw new Error(r.POST_CONSTRUCT_ERROR(t.name,n.message))}}}(t,_),_}},79949:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(88142),o=i(84271),a=i(64809),s=i(70317),_=function(t,e,i){try{return i()}catch(n){throw o.isStackOverflowExeption(n)?new Error(r.CIRCULAR_DEPENDENCY_IN_FACTORY(t,e.toString())):n}},c=function t(e){return function(i){i.parentContext.setCurrentRequest(i);var o=i.bindings,c=i.childRequests,u=i.target&&i.target.isArray(),p=!i.parentRequest||!i.parentRequest.target||!i.target||!i.parentRequest.target.matchesArray(i.target.serviceIdentifier);if(u&&p)return c.map((function(i){return t(e)(i)}));var d=null;if(!i.target.isOptional()||0!==o.length){var l=o[0],h=l.scope===n.BindingScopeEnum.Singleton,f=l.scope===n.BindingScopeEnum.Request;if(h&&l.activated)return l.cache;if(f&&null!==e&&e.has(l.id))return e.get(l.id);if(l.type===n.BindingTypeEnum.ConstantValue)d=l.cache;else if(l.type===n.BindingTypeEnum.Function)d=l.cache;else if(l.type===n.BindingTypeEnum.Constructor)d=l.implementationType;else if(l.type===n.BindingTypeEnum.DynamicValue&&null!==l.dynamicValue)d=_("toDynamicValue",l.serviceIdentifier,(function(){return l.dynamicValue(i.parentContext)}));else if(l.type===n.BindingTypeEnum.Factory&&null!==l.factory)d=_("toFactory",l.serviceIdentifier,(function(){return l.factory(i.parentContext)}));else if(l.type===n.BindingTypeEnum.Provider&&null!==l.provider)d=_("toProvider",l.serviceIdentifier,(function(){return l.provider(i.parentContext)}));else{if(l.type!==n.BindingTypeEnum.Instance||null===l.implementationType){var g=a.getServiceIdentifierAsString(i.serviceIdentifier);throw new Error(r.INVALID_BINDING_TYPE+" "+g)}d=s.resolveInstance(l.implementationType,c,t(e))}return"function"===typeof l.onActivation&&(d=l.onActivation(i.parentContext,d)),h&&(l.cache=d,l.activated=!0),f&&null!==e&&!e.has(l.id)&&e.set(l.id,d),d}}};e.resolve=function(t){return c(t.plan.rootRequest.requestScope)(t.plan.rootRequest)}},11472:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(88142),n=i(33540),o=function(){function t(t){this._binding=t}return t.prototype.inRequestScope=function(){return this._binding.scope=r.BindingScopeEnum.Request,new n.BindingWhenOnSyntax(this._binding)},t.prototype.inSingletonScope=function(){return this._binding.scope=r.BindingScopeEnum.Singleton,new n.BindingWhenOnSyntax(this._binding)},t.prototype.inTransientScope=function(){return this._binding.scope=r.BindingScopeEnum.Transient,new n.BindingWhenOnSyntax(this._binding)},t}();e.BindingInSyntax=o},44390:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(11472),n=i(39462),o=i(21970),a=function(){function t(t){this._binding=t,this._bindingWhenSyntax=new o.BindingWhenSyntax(this._binding),this._bindingOnSyntax=new n.BindingOnSyntax(this._binding),this._bindingInSyntax=new r.BindingInSyntax(t)}return t.prototype.inRequestScope=function(){return this._bindingInSyntax.inRequestScope()},t.prototype.inSingletonScope=function(){return this._bindingInSyntax.inSingletonScope()},t.prototype.inTransientScope=function(){return this._bindingInSyntax.inTransientScope()},t.prototype.when=function(t){return this._bindingWhenSyntax.when(t)},t.prototype.whenTargetNamed=function(t){return this._bindingWhenSyntax.whenTargetNamed(t)},t.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},t.prototype.whenTargetTagged=function(t,e){return this._bindingWhenSyntax.whenTargetTagged(t,e)},t.prototype.whenInjectedInto=function(t){return this._bindingWhenSyntax.whenInjectedInto(t)},t.prototype.whenParentNamed=function(t){return this._bindingWhenSyntax.whenParentNamed(t)},t.prototype.whenParentTagged=function(t,e){return this._bindingWhenSyntax.whenParentTagged(t,e)},t.prototype.whenAnyAncestorIs=function(t){return this._bindingWhenSyntax.whenAnyAncestorIs(t)},t.prototype.whenNoAncestorIs=function(t){return this._bindingWhenSyntax.whenNoAncestorIs(t)},t.prototype.whenAnyAncestorNamed=function(t){return this._bindingWhenSyntax.whenAnyAncestorNamed(t)},t.prototype.whenAnyAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenAnyAncestorTagged(t,e)},t.prototype.whenNoAncestorNamed=function(t){return this._bindingWhenSyntax.whenNoAncestorNamed(t)},t.prototype.whenNoAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenNoAncestorTagged(t,e)},t.prototype.whenAnyAncestorMatches=function(t){return this._bindingWhenSyntax.whenAnyAncestorMatches(t)},t.prototype.whenNoAncestorMatches=function(t){return this._bindingWhenSyntax.whenNoAncestorMatches(t)},t.prototype.onActivation=function(t){return this._bindingOnSyntax.onActivation(t)},t}();e.BindingInWhenOnSyntax=a},39462:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(21970),n=function(){function t(t){this._binding=t}return t.prototype.onActivation=function(t){return this._binding.onActivation=t,new r.BindingWhenSyntax(this._binding)},t}();e.BindingOnSyntax=n},61227:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659),n=i(88142),o=i(44390),a=i(33540),s=function(){function t(t){this._binding=t}return t.prototype.to=function(t){return this._binding.type=n.BindingTypeEnum.Instance,this._binding.implementationType=t,new o.BindingInWhenOnSyntax(this._binding)},t.prototype.toSelf=function(){if("function"!==typeof this._binding.serviceIdentifier)throw new Error(""+r.INVALID_TO_SELF_VALUE);var t=this._binding.serviceIdentifier;return this.to(t)},t.prototype.toConstantValue=function(t){return this._binding.type=n.BindingTypeEnum.ConstantValue,this._binding.cache=t,this._binding.dynamicValue=null,this._binding.implementationType=null,new a.BindingWhenOnSyntax(this._binding)},t.prototype.toDynamicValue=function(t){return this._binding.type=n.BindingTypeEnum.DynamicValue,this._binding.cache=null,this._binding.dynamicValue=t,this._binding.implementationType=null,new o.BindingInWhenOnSyntax(this._binding)},t.prototype.toConstructor=function(t){return this._binding.type=n.BindingTypeEnum.Constructor,this._binding.implementationType=t,new a.BindingWhenOnSyntax(this._binding)},t.prototype.toFactory=function(t){return this._binding.type=n.BindingTypeEnum.Factory,this._binding.factory=t,new a.BindingWhenOnSyntax(this._binding)},t.prototype.toFunction=function(t){if("function"!==typeof t)throw new Error(r.INVALID_FUNCTION_BINDING);var e=this.toConstantValue(t);return this._binding.type=n.BindingTypeEnum.Function,e},t.prototype.toAutoFactory=function(t){return this._binding.type=n.BindingTypeEnum.Factory,this._binding.factory=function(e){return function(){return e.container.get(t)}},new a.BindingWhenOnSyntax(this._binding)},t.prototype.toProvider=function(t){return this._binding.type=n.BindingTypeEnum.Provider,this._binding.provider=t,new a.BindingWhenOnSyntax(this._binding)},t.prototype.toService=function(t){this.toDynamicValue((function(e){return e.container.get(t)}))},t}();e.BindingToSyntax=s},33540:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(39462),n=i(21970),o=function(){function t(t){this._binding=t,this._bindingWhenSyntax=new n.BindingWhenSyntax(this._binding),this._bindingOnSyntax=new r.BindingOnSyntax(this._binding)}return t.prototype.when=function(t){return this._bindingWhenSyntax.when(t)},t.prototype.whenTargetNamed=function(t){return this._bindingWhenSyntax.whenTargetNamed(t)},t.prototype.whenTargetIsDefault=function(){return this._bindingWhenSyntax.whenTargetIsDefault()},t.prototype.whenTargetTagged=function(t,e){return this._bindingWhenSyntax.whenTargetTagged(t,e)},t.prototype.whenInjectedInto=function(t){return this._bindingWhenSyntax.whenInjectedInto(t)},t.prototype.whenParentNamed=function(t){return this._bindingWhenSyntax.whenParentNamed(t)},t.prototype.whenParentTagged=function(t,e){return this._bindingWhenSyntax.whenParentTagged(t,e)},t.prototype.whenAnyAncestorIs=function(t){return this._bindingWhenSyntax.whenAnyAncestorIs(t)},t.prototype.whenNoAncestorIs=function(t){return this._bindingWhenSyntax.whenNoAncestorIs(t)},t.prototype.whenAnyAncestorNamed=function(t){return this._bindingWhenSyntax.whenAnyAncestorNamed(t)},t.prototype.whenAnyAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenAnyAncestorTagged(t,e)},t.prototype.whenNoAncestorNamed=function(t){return this._bindingWhenSyntax.whenNoAncestorNamed(t)},t.prototype.whenNoAncestorTagged=function(t,e){return this._bindingWhenSyntax.whenNoAncestorTagged(t,e)},t.prototype.whenAnyAncestorMatches=function(t){return this._bindingWhenSyntax.whenAnyAncestorMatches(t)},t.prototype.whenNoAncestorMatches=function(t){return this._bindingWhenSyntax.whenNoAncestorMatches(t)},t.prototype.onActivation=function(t){return this._bindingOnSyntax.onActivation(t)},t}();e.BindingWhenOnSyntax=o},21970:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(39462),n=i(63465),o=function(){function t(t){this._binding=t}return t.prototype.when=function(t){return this._binding.constraint=t,new r.BindingOnSyntax(this._binding)},t.prototype.whenTargetNamed=function(t){return this._binding.constraint=n.namedConstraint(t),new r.BindingOnSyntax(this._binding)},t.prototype.whenTargetIsDefault=function(){return this._binding.constraint=function(t){return null!==t.target&&!t.target.isNamed()&&!t.target.isTagged()},new r.BindingOnSyntax(this._binding)},t.prototype.whenTargetTagged=function(t,e){return this._binding.constraint=n.taggedConstraint(t)(e),new r.BindingOnSyntax(this._binding)},t.prototype.whenInjectedInto=function(t){return this._binding.constraint=function(e){return n.typeConstraint(t)(e.parentRequest)},new r.BindingOnSyntax(this._binding)},t.prototype.whenParentNamed=function(t){return this._binding.constraint=function(e){return n.namedConstraint(t)(e.parentRequest)},new r.BindingOnSyntax(this._binding)},t.prototype.whenParentTagged=function(t,e){return this._binding.constraint=function(i){return n.taggedConstraint(t)(e)(i.parentRequest)},new r.BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorIs=function(t){return this._binding.constraint=function(e){return n.traverseAncerstors(e,n.typeConstraint(t))},new r.BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorIs=function(t){return this._binding.constraint=function(e){return!n.traverseAncerstors(e,n.typeConstraint(t))},new r.BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorNamed=function(t){return this._binding.constraint=function(e){return n.traverseAncerstors(e,n.namedConstraint(t))},new r.BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorNamed=function(t){return this._binding.constraint=function(e){return!n.traverseAncerstors(e,n.namedConstraint(t))},new r.BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorTagged=function(t,e){return this._binding.constraint=function(i){return n.traverseAncerstors(i,n.taggedConstraint(t)(e))},new r.BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorTagged=function(t,e){return this._binding.constraint=function(i){return!n.traverseAncerstors(i,n.taggedConstraint(t)(e))},new r.BindingOnSyntax(this._binding)},t.prototype.whenAnyAncestorMatches=function(t){return this._binding.constraint=function(e){return n.traverseAncerstors(e,t)},new r.BindingOnSyntax(this._binding)},t.prototype.whenNoAncestorMatches=function(t){return this._binding.constraint=function(e){return!n.traverseAncerstors(e,t)},new r.BindingOnSyntax(this._binding)},t}();e.BindingWhenSyntax=o},63465:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(55496),n=i(46373);e.traverseAncerstors=function t(e,i){var r=e.parentRequest;return null!==r&&(!!i(r)||t(r,i))};var o=function(t){return function(e){var i=function(i){return null!==i&&null!==i.target&&i.target.matchesTag(t)(e)};return i.metaData=new n.Metadata(t,e),i}};e.taggedConstraint=o;var a=o(r.NAMED_TAG);e.namedConstraint=a;e.typeConstraint=function(t){return function(e){var i=null;if(null!==e){if(i=e.bindings[0],"string"===typeof t)return i.serviceIdentifier===t;var r=e.bindings[0].implementationType;return t===r}return!1}}},71771:function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.multiBindToService=function(t){return function(e){return function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];return i.forEach((function(i){return t.bind(i).toService(e)}))}}}},84271:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659);e.isStackOverflowExeption=function(t){return t instanceof RangeError||t.message===r.STACK_OVERFLOW}},15416:function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=0;e.id=function(){return i++}},64809:function(t,e,i){Object.defineProperty(e,"__esModule",{value:!0});var r=i(75659);function n(t){return"function"===typeof t?t.name:"symbol"===typeof t?t.toString():t}function o(t,e){return null!==t.parentRequest&&(t.parentRequest.serviceIdentifier===e||o(t.parentRequest,e))}function a(t){if(t.name)return t.name;var e=t.toString(),i=e.match(/^function\s*([^\s(]+)/);return i?i[1]:"Anonymous function: "+e}e.getServiceIdentifierAsString=n,e.listRegisteredBindingsForServiceIdentifier=function(t,e,i){var r="",n=i(t,e);return 0!==n.length&&(r="\nRegistered bindings:",n.forEach((function(t){var e="Object";null!==t.implementationType&&(e=a(t.implementationType)),r=r+"\n "+e,t.constraint.metaData&&(r=r+" - "+t.constraint.metaData)}))),r},e.circularDependencyToException=function t(e){e.childRequests.forEach((function(e){if(o(e,e.serviceIdentifier)){var i=function(t){var e=function t(e,i){void 0===i&&(i=[]);var r=n(e.serviceIdentifier);return i.push(r),null!==e.parentRequest?t(e.parentRequest,i):i}(t);return e.reverse().join(" --\x3e ")}(e);throw new Error(r.CIRCULAR_DEPENDENCY+" "+i)}t(e)}))},e.listMetadataForTarget=function(t,e){if(e.isTagged()||e.isNamed()){var i="",r=e.getNamedTag(),n=e.getCustomTags();return null!==r&&(i+=r.toString()+"\n"),null!==n&&n.forEach((function(t){i+=t.toString()+"\n"}))," "+t+"\n "+t+" - "+i}return" "+t},e.getFunctionName=a},9108:function(t,e,i){i.r(e),i.d(e,{__assign:function(){return o},__asyncDelegator:function(){return b},__asyncGenerator:function(){return v},__asyncValues:function(){return w},__await:function(){return m},__awaiter:function(){return u},__classPrivateFieldGet:function(){return E},__classPrivateFieldSet:function(){return I},__createBinding:function(){return d},__decorate:function(){return s},__exportStar:function(){return l},__extends:function(){return n},__generator:function(){return p},__importDefault:function(){return O},__importStar:function(){return k},__makeTemplateObject:function(){return x},__metadata:function(){return c},__param:function(){return _},__read:function(){return f},__rest:function(){return a},__spread:function(){return g},__spreadArrays:function(){return y},__values:function(){return h}});var r=function(t,e){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])},r(t,e)};function n(t,e){function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var o=function(){return o=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},o.apply(this,arguments)};function a(t,e){var i={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(i[r]=t[r]);if(null!=t&&"function"===typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(t);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(t,r[n])&&(i[r[n]]=t[r[n]])}return i}function s(t,e,i,r){var n,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a}function _(t,e){return function(i,r){e(i,r,t)}}function c(t,e){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(t,e)}function u(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))}function p(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function d(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}function l(t,e){for(var i in t)"default"===i||e.hasOwnProperty(i)||(e[i]=t[i])}function h(t){var e="function"===typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"===typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function f(t,e){var i="function"===typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a}function g(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t}function y(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var r=Array(t),n=0;for(e=0;e<i;e++)for(var o=arguments[e],a=0,s=o.length;a<s;a++,n++)r[n]=o[a];return r}function m(t){return this instanceof m?(this.v=t,this):new m(t)}function v(t,e,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,n=i.apply(t,e||[]),o=[];return r={},a("next"),a("throw"),a("return"),r[Symbol.asyncIterator]=function(){return this},r;function a(t){n[t]&&(r[t]=function(e){return new Promise((function(i,r){o.push([t,e,i,r])>1||s(t,e)}))})}function s(t,e){try{(i=n[t](e)).value instanceof m?Promise.resolve(i.value.v).then(_,c):u(o[0][2],i)}catch(r){u(o[0][3],r)}var i}function _(t){s("next",t)}function c(t){s("throw",t)}function u(t,e){t(e),o.shift(),o.length&&s(o[0][0],o[0][1])}}function b(t){var e,i;return e={},r("next"),r("throw",(function(t){throw t})),r("return"),e[Symbol.iterator]=function(){return this},e;function r(r,n){e[r]=t[r]?function(e){return(i=!i)?{value:m(t[r](e)),done:"return"===r}:n?n(e):e}:n}}function w(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t=h(t),e={},r("next"),r("throw"),r("return"),e[Symbol.asyncIterator]=function(){return this},e);function r(i){e[i]=t[i]&&function(e){return new Promise((function(r,n){(function(t,e,i,r){Promise.resolve(r).then((function(e){t({value:e,done:i})}),e)})(r,n,(e=t[i](e)).done,e.value)}))}}}function x(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}function k(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e}function O(t){return t&&t.__esModule?t:{default:t}}function E(t,e){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return e.get(t)}function I(t,e,i){if(!e.has(t))throw new TypeError("attempted to set private field on non-instance");return e.set(t,i),i}},40465:function(t,e,i){i.d(e,{LP:function(){return r},M5:function(){return s},MO:function(){return o},bJ:function(){return n},i$:function(){return c},su:function(){return _}});var r,n,o,a,s,_,c,u=i(4097);!function(t){t.Actor="actor",t.Scene="scene",t.Background="background",t.ActorDialog="actor_dialog"}(r||(r={})),function(t){t.ActorWrapper="actor_wrapper"}(n||(n={})),function(t){t[t.ALL=0]="ALL",t[t.LEFT_RIGHT=1]="LEFT_RIGHT",t[t.NONE=2]="NONE"}(o||(o={})),function(t){t[t.UP=u.DIRECTION_UP]="UP",t[t.DOWN=u.DIRECTION_DOWN]="DOWN",t[t.LEFT=u.DIRECTION_LEFT]="LEFT",t[t.RIGHT=u.DIRECTION_RIGHT]="RIGHT"}(a||(a={})),function(t){t.TO="to",t.FROM="from",t.FROM_TO="from_to"}(s||(s={})),function(t){t[t.RIGHT=8]="RIGHT",t[t.LEFT=4]="LEFT",t[t.TOP=2]="TOP",t[t.BOTTOM=1]="BOTTOM"}(_||(_={})),function(t){t.CONTAIN="contain",t.COVER="cover",t.STRETCH="stretch",t.NONE="none"}(c||(c={}))},4001:function(t,e,i){var r;i.d(e,{O:function(){return r}}),function(t){t[t.NORMAL=0]="NORMAL",t[t.ELASTIC=1]="ELASTIC"}(r||(r={}))},53273:function(t,e,i){i.d(e,{S:function(){return c}});var r=i(12745),n="attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform mat3 projectionMatrix;varying vec2 vTextureCoord;void main(void) { gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0); vTextureCoord = aTextureCoord;}",o="varying vec2 vTextureCoord;uniform sampler2D uSampler;uniform vec4 inputSize;uniform vec4 outputFrame; const int NUM_TRIADS = number_triangles_to_be_replaced; uniform vec3 transform_matrixes[NUM_TRIADS * 2]; uniform vec2 triangles[NUM_TRIADS * 3];vec2 map_coord(vec2 coord) { coord *= inputSize.xy; coord += outputFrame.xy; return coord;}vec2 unmap_coord(vec2 coord) { coord -= outputFrame.xy; coord /= inputSize.xy; return coord;}float product(vec2 a, vec2 b, vec2 p) { return (b.x - a.x) * (p.y - a.y) - (b.y - a.y) * (p.x - a.x);}bool inside_triangle(vec2 a, vec2 b, vec2 c, vec2 p) { float min_x = min(a.x, b.x); min_x = min(min_x, c.x); float max_x = max(a.x, b.x); max_x = max(max_x, c.x); float min_y = min(a.y, b.y); min_y = min(min_y, c.y); float max_y = max(a.y, b.y); max_y = max(max_y, c.y); if(p.x < min_x || p.x > max_x || p.y < min_y || p.y > max_y) { return false; } float cross_ab = product(a, b, p); float cross_bc = product(b, c, p); float cross_ca = product(c, a, p); if(cross_ab < 0.0 && cross_bc < 0.0 && cross_ca < 0.0) return true; if(cross_ab > 0.0 && cross_bc > 0.0 && cross_ca > 0.0) return true; if(cross_ab == 0.0 || cross_bc == 0.0 || cross_ca == 0.0) return true; return false;}vec2 transform_by_matrix(vec3 first_line, vec3 second_line, vec2 coord) { float a = first_line.x; float b = first_line.y; float c = first_line.z; float d = second_line.x; float e = second_line.y; float f = second_line.z; return vec2(floor(a * coord.x + b * coord.y + c), floor(d * coord.x + e * coord.y + f));}vec4 get_color(vec2 coord) { return texture2D(uSampler, unmap_coord(coord));}vec4 blend(vec4 base, vec4 color) { float target_a = 1.0 - (1.0 - base.a) * (1.0 - color.a); base.r = (color.r * color.a / target_a) + (base.r * base.a * (1.0 - color.a) / target_a); base.g = (color.g * color.a / target_a) + (base.g * base.a * (1.0 - color.a) / target_a); base.b = (color.b * color.a / target_a) + (base.b * base.a * (1.0 - color.a) / target_a); base.a = target_a; return base;}vec4 map_triangle(vec2 coord) { coord = map_coord(coord); vec4 color = vec4(0.0, 0.0, 0.0, 0.0); for(int i = 0; i < NUM_TRIADS; i++) { vec2 p0 = triangles[i * 3]; vec2 p1 = triangles[i * 3 + 1]; vec2 p2 = triangles[i * 3 + 2]; if(inside_triangle(p0, p1, p2, coord)) { vec2 source_coord = transform_by_matrix(transform_matrixes[i * 2], transform_matrixes[i * 2 + 1], coord); vec4 source_color = get_color(source_coord); if(source_color.a > 0.9) return source_color; color = blend(color, source_color); } } return color;}void main(void) { gl_FragColor = map_triangle(vTextureCoord);}",a=function(){function t(t){this.a=this.solve_a(t[0][0].x,t[0][0].y,t[0][1].x,t[1][0].x,t[1][0].y,t[1][1].x,t[2][0].x,t[2][0].y,t[2][1].x),this.b=this.solve_b(t[0][0].x,t[0][0].y,t[0][1].x,t[1][0].x,t[1][0].y,t[1][1].x,t[2][0].x,t[2][0].y,t[2][1].x),this.c=this.solve_c(t[0][0].x,t[0][0].y,t[0][1].x,t[1][0].x,t[1][0].y,t[1][1].x,this.a,this.b),this.d=this.solve_a(t[0][0].x,t[0][0].y,t[0][1].y,t[1][0].x,t[1][0].y,t[1][1].y,t[2][0].x,t[2][0].y,t[2][1].y),this.e=this.solve_b(t[0][0].x,t[0][0].y,t[0][1].y,t[1][0].x,t[1][0].y,t[1][1].y,t[2][0].x,t[2][0].y,t[2][1].y),this.f=this.solve_c(t[0][0].x,t[0][0].y,t[0][1].y,t[1][0].x,t[1][0].y,t[1][1].y,this.d,this.e)}return t.prototype.solve_a=function(t,e,i,r,n,o,a,s,_){return((i-o)*(n-s)-(o-_)*(e-n))/((t-r)*(n-s)-(r-a)*(e-n))},t.prototype.solve_b=function(t,e,i,r,n,o,a,s,_){return((i-o)*(r-a)-(o-_)*(t-r))/((e-n)*(r-a)-(n-s)*(t-r))},t.prototype.solve_c=function(t,e,i,r,n,o,a,s){return(i+o-a*(t+r)-s*(e+n))/2},t.prototype.transform=function(t){return{x:Math.round(this.a*t.x+this.b*t.y+this.c),y:Math.round(this.d*t.x+this.e*t.y+this.f)}},t}(),s=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),_=function(t,e){var i="function"===typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a},c=function(t){function e(e){var i=t.call(this,String(n),String(o).replace(/number_triangles_to_be_replaced/g,e.triangles.length.toFixed(0)))||this;return i.max_num_anchors=e.max_num_anchors,i.triangle_top_points=e.triangles,i.uniforms.transform_matrixes=[],i.uniforms.triangles=[],e.anchors&&i.set_anchors(e.anchors),i}return s(e,t),e.prototype.compute_target_rect=function(t,e,i){for(var r=1/0,n=-1/0,o=-1/0,a=1/0,s=0;s<this.max_num_anchors;s++){var _=t[s][1];r=Math.min(r,_.x),n=Math.max(n,_.x),a=Math.min(a,_.y),o=Math.max(o,_.y)}return r=Math.max(0,r),n=Math.min(e,n),{top:a=Math.max(0,a),right:n,bottom:o=Math.min(i,o),left:r}},e.prototype.set_anchors=function(t,e,i){var r,n,o,s=t.length;s>this.max_num_anchors&&(console.error("Length of anchors ("+s+") exceeds the maximum anchors length ("+this.max_num_anchors+") which decided when the filter was constructed. "),t.slice(0,this.max_num_anchors));var c=null===(o=null===(n=null===(r=this.uniforms.filterGlobals)||void 0===r?void 0:r.uniforms)||void 0===n?void 0:n.outputFrame)||void 0===o?void 0:o.clone();if(c&&e&&i&&(c.pad(-this.padding),c.width>0&&c.height>0)){var u=this.compute_target_rect(t,e,i);this.padding=Math.max(0,c.left-u.left,c.top-u.top,u.right-(c.left+c.width),u.bottom-(c.top+c.height))+5}this.uniforms.triangles.length=0,this.uniforms.transform_matrixes.length=0;for(var p=0;p<this.triangle_top_points.length;p++){var d=_(this.triangle_top_points[p],3),l=d[0],h=d[1],f=d[2];this.uniforms.triangles[6*p]=Math.floor(t[l][1].x),this.uniforms.triangles[6*p+1]=Math.floor(t[l][1].y),this.uniforms.triangles[6*p+2]=Math.floor(t[h][1].x),this.uniforms.triangles[6*p+3]=Math.floor(t[h][1].y),this.uniforms.triangles[6*p+4]=Math.floor(t[f][1].x),this.uniforms.triangles[6*p+5]=Math.floor(t[f][1].y);var g=new a([[t[l][1],t[l][0]],[t[h][1],t[h][0]],[t[f][1],t[f][0]]]);this.uniforms.transform_matrixes[6*p]=g.a,this.uniforms.transform_matrixes[6*p+1]=g.b,this.uniforms.transform_matrixes[6*p+2]=g.c,this.uniforms.transform_matrixes[6*p+3]=g.d,this.uniforms.transform_matrixes[6*p+4]=g.e,this.uniforms.transform_matrixes[6*p+5]=g.f}},e}(r.wn)},21392:function(t,e,i){i.d(e,{BK:function(){return d},Gl:function(){return n},I1:function(){return g},K9:function(){return p},Ly:function(){return u},QB:function(){return m},RA:function(){return c},RQ:function(){return o},TN:function(){return f},V9:function(){return y},Xg:function(){return s},bB:function(){return a},iu:function(){return _},pg:function(){return l},yC:function(){return h}});var r=10;function n(t){return t/r}function o(t){return t*r}function a(t,e){return t+"---"+e}var s=6e3,_=5,c=1,u=1e3,p=0,d=1/60,l=8,h=3,f=10,g=1,y=.1,m=0},12745:function(t,e,i){i.d(e,{Ae:function(){return d.Ae},Ag:function(){return S.A},E9:function(){return d.E9},FP:function(){return u.o},GW:function(){return I.G},Mx:function(){return o.M},N3:function(){return y.N3},P6:function(){return r},TC:function(){return v.TC},TI:function(){return a.TI},W2:function(){return m.W2},_:function(){return T._},aH:function(){return y.aH},aN:function(){return _.aN},c2:function(){return c.c},jd:function(){return a.jd},jy:function(){return b.j},mJ:function(){return k.m},o0:function(){return C},pt:function(){return E.p},pz:function(){return O.p},tq:function(){return x.t},wn:function(){return a.wn},x1:function(){return N.x},xE:function(){return a.xE},xv:function(){return w.xv},y3:function(){return d.y3}});i(35441);var r=i(83588),n=i(18701),o=i(14360),a=i(18924),s=i(4164),_=i(70530),c=i(36149),u=i(3539),p=i(24039),d=i(42997),l=(i(95267),i(77046),i(41446),i(76217)),h=i(84666),f=i(12547),g=i(25259),y=(i(95591),i(46747),i(94556),i(25501)),m=i(40536),v=i(35155),b=i(46649),w=(i(25008),i(50798)),x=(i(69951),i(48102)),k=i(14663),O=i(61601),E=i(58976),I=i(28746),T=i(18819),N=i(34456),S=i(4208),A=(i(53273),function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}()),C=function(t){function e(e,i){return t.call(this,e?Math.floor(e):e,i?Math.floor(i):i)||this}return A(e,t),e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.set=function(e,i){return t.prototype.set.call(this,e?Math.floor(e):e,i?Math.floor(i):i)},e}(d.E9);l.uK.registerPlugin("extract",g.z),l.uK.registerPlugin("graphics",h.c),l.uK.registerPlugin("interaction",n.bx),l.uK.registerPlugin("sprite",f.O),a.Th.registerPlugin("extract",s.Q),a.Th.registerPlugin("interaction",n.bx),a.Th.registerPlugin("tilingSprite",u.S),a.Th.registerPlugin("batch",a.Bv),_.aN.registerPlugin(c.o),o.M.registerPlugin(p.Sb),o.M.registerPlugin(_.LP);var M=new d.y3;a.kV.prototype.push=function(t,e){for(var i=this.renderer,r=this.defaultFilterStack,n=this.statePool.pop()||new a.jV,o=this.renderer.renderTexture,s=e[0].resolution,_=e[0].padding,c=e[0].autoFit,u=e[0].legacy,p=1;p<e.length;p++){var l=e[p];s=Math.min(s,l.resolution),_=Math.max(_,l.padding),c=c&&l.autoFit,u=u||l.legacy}if(1===r.length&&(this.defaultFilterStack[0].renderTexture=o.current),r.push(n),n.resolution=s,n.legacy=u,n.target=t,n.sourceFrame.copyFrom(t.filterArea||t.getBounds(!0)),n.sourceFrame.pad(_),c){var h=new d.Ae(o.sourceFrame.x-o.sourceFrame.width/2,o.sourceFrame.y-o.sourceFrame.height/2,2*o.sourceFrame.width,2*o.sourceFrame.height);i.projection.transform&&this.transformAABB(M.copyFrom(i.projection.transform).invert(),h),n.sourceFrame.fit(h)}this.roundFrame(n.sourceFrame,o.current?o.current.resolution:i.resolution,o.sourceFrame,o.destinationFrame,i.projection.transform),n.renderTexture=this.getOptimalFilterTexture(n.sourceFrame.width,n.sourceFrame.height,s),n.filters=e,n.destinationFrame.width=n.renderTexture.width,n.destinationFrame.height=n.renderTexture.height;var f=new d.Ae(0,0,n.sourceFrame.width,n.sourceFrame.height);n.renderTexture.filterFrame=n.sourceFrame,n.bindingSourceFrame.copyFrom(o.sourceFrame),n.bindingDestinationFrame.copyFrom(o.destinationFrame),n.transform=i.projection.transform,i.projection.transform=null,o.bind(n.renderTexture,n.sourceFrame,f),i.framebuffer.clear(0,0,0,0)}},1753:function(t,e,i){i.d(e,{$1:function(){return a},JI:function(){return k},Jf:function(){return w},OI:function(){return f},OX:function(){return s},P2:function(){return I},Ri:function(){return d},UQ:function(){return y},VS:function(){return E},W4:function(){return m},Wz:function(){return v},YH:function(){return b},ck:function(){return _},g3:function(){return h},k4:function(){return O},kF:function(){return u},ph:function(){return g},pj:function(){return x},r6:function(){return p},se:function(){return l},uD:function(){return c},yZ:function(){return T}});var r=i(12745),n=i(40465),o=.7;function a(t){return{width:Math.floor(t.width*o),height:Math.floor(t.height*o)}}function s(t){return new r.E9(Math.floor(t.x*o),Math.floor(t.y*o))}function _(t){return new r.E9(Math.floor(t.x/o),Math.floor(t.y/o))}function c(t,e){var i=new r.y3;return i.tx=-Math.floor((t.x+e.width/2)*o),i.ty=-Math.floor((t.y+e.height/2)*o),i.a=i.d=o,i}function u(t,e){return p(new r.E9(e.x-t.pivot.x*t.scale.x,e.y-t.pivot.y*t.scale.y),e,t.rotation)}function p(t,e,i){var n=t.x-e.x,o=t.y-e.y,a=Math.cos(i),s=Math.sin(i),_=a*n-o*s+e.x,c=a*o+n*s+e.y;return new r.E9(_,c)}function d(t,e){var i=p(u(e,e.position),e.position,-e.rotation),n=p(t,e.position,-e.rotation),o=e.scale.x>0?n.x-i.x+e.width/2:n.x-i.x-e.width/2,a=e.scale.y>0?n.y-i.y+e.height/2:n.y-i.y-e.height/2;return new r.E9(Math.round(o/e.scale.x),Math.round(a/e.scale.y))}function l(t,e){var i=new r.E9(e.position.x-e.pivot.x*e.scale.x,e.position.y-e.pivot.y*e.scale.y),n=t.x*e.scale.x,o=t.y*e.scale.y,a=e.scale.x>0?n+i.x-e.width/2:n+i.x+e.width/2,s=e.scale.y>0?o+i.y-e.height/2:o+i.y+e.height/2,_=p(new r.E9(a,s),e.position,e.rotation);return new r.E9(_.x,_.y)}function h(t,e){if(0===t&&0===e)return 0;var i=Math.pow(t*t+e*e,.5),r=Math.asin(e/i);return t<0&&(r=r>0?Math.PI-r:-Math.PI-r),r<0?r+2*Math.PI:r}function f(t){return 180*t/Math.PI}function g(t){return t*Math.PI/180}function y(t){var e=parseInt(t,16);return[e>>16&255,e>>8&255,255&e]}function m(t){var e=y(t);return function(t,e,i){t/=255,e/=255,i/=255;var r,n,o=Math.max(t,e,i),a=Math.min(t,e,i),s=(o+a)/2;if(o===a)r=n=0;else{var _=o-a;switch(n=s>.5?_/(2-o-a):_/(o+a),o){case t:r=(e-i)/_+(e<i?6:0);break;case e:r=(i-t)/_+2;break;case i:r=(t-e)/_+4;break;default:r=0}r/=6}return[r*=360,n,s]}(e[0],e[1],e[2])}function v(t,e,i){var r,n,o,a=function(t,e,i){var r,n,o;if(t/=360,0===e)r=n=o=i;else{var a=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},s=i<.5?i*(1+e):i+e-i*e,_=2*i-s,c=t,u=t-1/3;r=a(_,s,t+1/3),n=a(_,s,c),o=a(_,s,u)}return[Math.round(255*r),Math.round(255*n),Math.round(255*o)]}(t,e,i);return r=a[0],n=a[1],o=a[2],("00000"+(r<<16|n<<8|o).toString(16)).slice(-6)}function b(t){return!(!t||!t.type)&&t.type===n.LP.Actor}function w(t){return!(!t||!t.type)&&t.type===n.LP.Scene}function x(t){return!(!t||!t.type)&&t.type===n.bJ.ActorWrapper}function k(t){return t.type.startsWith("touch")}function O(t){var e=2*Math.PI,i=Math.abs(t);return i=i>e?i%e:i,i=(i=(t<0?-1:1)<0?e-i:i)>Math.PI?i-e:i}var E=16;function I(t,e){var i=Date.now();return function(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var o=Date.now();o-i>=e&&(t.apply(void 0,r),i=o)}}function T(t,e){var i=e.width/2,r=e.height/2;return!(t.x<-i||t.x>i||t.y<-r||t.y>r)}},2173:function(t,e,i){var r,n,o,a;i.d(e,{dL:function(){return r},jX:function(){return a},mG:function(){return o},s8:function(){return n}}),function(t){t.SCALE_BTN="scale_btn",t.ROTATE_BTN="rotate_btn",t.REMOVE_BTN="remove_btn",t.EDITOR_BOX="editor_box",t.ROTATION_CENTRE="rotation_centre",t.HIDE_TEXT="hide_text"}(r||(r={})),function(t){t.THINKING="thinking",t.SAYING="saying"}(n||(n={})),function(t){t[t.TURNING_ON=0]="TURNING_ON",t[t.IS_TURNED_ON=1]="IS_TURNED_ON",t[t.TURN_OFF=2]="TURN_OFF",t[t.PAUSED=3]="PAUSED"}(o||(o={})),function(t){t.FORMAT_IMAGE_DATA="image-data",t.FORMAT_CANVAS="canvas"}(a||(a={}))},61248:function(t,e,i){i.d(e,{s8:function(){return Jt.s8},su:function(){return nt.su},LP:function(){return nt.LP},M5:function(){return nt.M5},Xg:function(){return He}});var r,n=i(1753),o=i(66543),a=i(4097),s=i(12745),_={App:Symbol("App"),Data:Symbol("Data"),Events:Symbol("Events"),Textures:Symbol("Textures"),Scenes:Symbol("Scenes"),Scene:Symbol("Scene"),Transition:Symbol("Transition"),Actors:Symbol("Actors"),Actor:Symbol("Actor"),Stage:Symbol("Stage"),StageAnimation:Symbol("StageAnimation"),Physics:Symbol("Physics")},c=function(){function t(t){this.value=t}return t.prototype.is_error=function(t){return t&&"error_msg"===t.type},t.error=function(e){return new t(new u(e))},t.success=function(e){return new t(e)},t}(),u=function(){function t(e){this.error={message:""},this.type="error_msg",this.error.message=e,t.log_enabled&&console.error(e)}return t.set_log_enabled=function(t){this.log_enabled=t},t.log_enabled=!1,t}(),p=function(t,e,i,r){var n,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},d=function(t,e){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(t,e)},l=function(t,e){return function(i,r){e(i,r,t)}},h=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},f=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},g=function(){function t(t){var e=this;this.mouse_down_time=0,this.cancel_multi_touch=!1,this.on_stage_swipe=function(t){var i=e.get_app().stage;i.name&&e.events.fire("stage:swipe",{target_id:i.name,data:t})},this.events=t}return t.prototype.init=function(t){var e=this;this.app?console.warn("Application cannot be reinitialized."):(this.app=new s.Mx(t.renderer),this.app.stage.name=t.id?t.id:"stage",this.cancel_multi_touch=void 0!==t.cancel_multi_touch&&t.cancel_multi_touch,this.app.stage.pivot.set(-this.app.renderer.width/2,-this.app.renderer.height/2),this.app.stage.interactive=!0,this.app.stage.hitArea=new s.Ae(-this.app.renderer.width/2,-this.app.renderer.height/2,this.app.renderer.width,this.app.renderer.height),this.app.ticker.autoStart=!1,this.app.ticker.stop(),this.scene_container=new s.W2,this.scene_container.name="scenes",this.scene_container.interactive=!0,this.app.stage.addChild(this.scene_container),new a.Manager(this.app.view,{recognizers:[[a.Swipe,{direction:a.DIRECTION_ALL}]]}).on("swipe",this.on_stage_swipe),this.app.stage.addListener("mousedown",(function(t){return e.emit_mouse_event(t,"stage:mousedown")})),this.app.stage.addListener("mousemove",(function(t){return e.emit_mouse_event(t,"stage:mousemove")})),this.app.stage.addListener("mouseup",(function(t){return e.emit_mouse_event(t,"stage:mouseup")})),this.app.stage.addListener("mouseupoutside",(function(t){return e.emit_mouse_event(t,"stage:mouseupoutside")})),this.app.stage.addListener("touchstart",(function(t){return e.emit_mouse_event(t,"stage:touchstart")})),this.app.stage.addListener("touchmove",(function(t){return e.emit_mouse_event(t,"stage:touchmove")})),this.app.stage.addListener("touchend",(function(t){return e.emit_mouse_event(t,"stage:touchend")})),this.app.stage.addListener("touchendoutside",(function(t){return e.emit_mouse_event(t,"stage:touchendoutside")})),this.app.stage.addListener("rightclick",(function(t){return e.emit_mouse_event(t,"stage:rightclick")})),t.development&&u.set_log_enabled(!0))},t.prototype.get_app=function(){if(!this.app)throw new Error("Application needs init before using.");return this.app},t.prototype.get_scene_container=function(){if(!this.scene_container)throw new Error("Scene container needs init before using.");return this.scene_container},t.prototype.render=function(){!this.get_app().ticker.started&&this.get_app().render()},t.prototype.get_renderer_type=function(){return this.get_app().renderer.type},t.prototype.get_interaction_manager=function(){return this.get_app().renderer.plugins.interaction},t.prototype.get_extract_module=function(){return this.get_app().renderer.plugins.extract},t.prototype.screenshot=function(t){return h(this,void 0,void 0,(function(){var e,i,r,n,o,a,s,_,c,u,p;return f(this,(function(d){return e=t&&void 0!==t.scale?t.scale:.5,i=t&&t.type,r=t&&void 0!==t.quality?t.quality:1,n=this.get_app().view,o=n.width,a=n.height,s=document.createElement("canvas"),_=s.getContext("2d"),c=o*e,u=a*e,s.width=c,s.height=u,(p=new Image).src=this.get_app().view.toDataURL(i,r),[2,new Promise((function(e,n){p.onload=function(){if(_){_.drawImage(p,0,0,c,u),t&&t.handstand&&(_.clearRect(0,0,c,u),_.translate(c/2,u/2),_.rotate(Math.PI),_.translate(-c/2,-u/2),_.scale(-1,1),_.drawImage(p,0,0,-c,u));var n=s.toDataURL(i,r);e(n)}},p.onerror=function(t){n(t)}}))]}))}))},t.prototype.get_screenshot=function(t){return h(this,void 0,void 0,(function(){var e,i=this;return f(this,(function(r){return e=this.get_app().renderer,[2,new Promise((function(r,n){e.once("postrender",(function(){i.screenshot(t).then((function(t){return r(t)})).catch((function(t){return n(t)}))})),e.render(i.get_app().stage)}))]}))}))},t.prototype.resize=function(t,e){var i=this.get_app(),r=i.stage,n=i.renderer;r.pivot.set(-t/2,-e/2),r.hitArea=new s.Ae(-t/2,-e/2,t,e),n.resize(t,e),r.name&&this.events.fire("stage:resize",{target_id:r.name,data:{width:t,height:e}})},t.prototype.destroy=function(){this.get_app().destroy(!0,!0),this.app=void 0},t.prototype.emit_mouse_event=function(t,e){var i=this.get_app().stage,r=t.data.getLocalPosition(i),o=r.x,a=r.y;switch(e){case"stage:mousedown":case"stage:touchstart":this.mouse_down_time=(new Date).getTime();break;case"stage:mouseup":case"stage:touchend":(new Date).getTime()-this.mouse_down_time<1e3&&i.name&&this.events.fire("stage:click",{target_id:i.name,data:{position:{x:o,y:-a}}})}if(i.name&&this.events.fire(e,{target_id:i.name,data:{position:{x:o,y:-a}}}),this.cancel_multi_touch){var s=t.data.originalEvent;(0,n.JI)(s)&&s.touches.length>1&&this.events.emit_break_event()}},t=p([(0,o.b2)(),l(0,(0,o.f3)(_.Events)),d("design:paramtypes",[Object])],t)}(),y=i(65341),m=function(t,e){var i="function"===typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a},v=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(m(arguments[e]));return t};function b(t,e,i,n){n=n||{mode:"vertex"};for(var o,a,_,c,u,p=0,d=[],l=-1,h=r.SKIP,f=0,g=t.length,y=3;y<g;y++)if(t[y]>>>24>p){l=y;break}if(l>=0){o=_=l%e|0,a=c=l/e|0;do{switch((u=v(o,a))===r.MOVE_UP?a--:u===r.MOVE_DOWN?a++:u===r.MOVE_LEFT?o--:u===r.MOVE_RIGHT&&o++,n.mode){case"vertex":u!==h&&d.push(new s.o0(o,a));break;case"step":f%n.step===0&&d.push(new s.o0(o,a));break;case"mixed":u!==h?(d.push(new s.o0(o,a)),f=0):f%n.step===0&&d.push(new s.o0(o,a))}h=u,f++}while(o!==_||a!==c);n.tolerance&&(d=w(d,n.tolerance,n.step))}function m(r,n){return r>=0&&n>=0&&r<e&&n<i&&t[n*e+r]>>>24>p}function v(t,e){var i,n=0;return m(t-1,e-1)&&(n|=1),m(t,e-1)&&(n|=2),m(t-1,e)&&(n|=4),m(t,e)&&(n|=8),6===n?h===r.MOVE_UP?r.MOVE_LEFT:r.MOVE_RIGHT:9===n?h===r.MOVE_RIGHT?r.MOVE_UP:r.MOVE_DOWN:1===(i=n)||5===i||13===i?r.MOVE_UP:8===i||10===i||11===i?r.MOVE_DOWN:4===i||12===i||14===i?r.MOVE_LEFT:2===i||3===i||7===i?r.MOVE_RIGHT:r.SKIP}return d}function w(t,e,i){var r=t.length-1;if(r<2)return t;for(var n=t[0],o=t[r],a=e*e,_=-1,c=0,u=1;u<r;u++){var p=x(t[u],n,o);p>c&&(c=p,_=u)}if(c<=a){if(!i)return[n,o];var d=Math.floor(Math.sqrt(k(n,o))/i),l=[];for(u=1;u<d;u++)l.push(new s.o0(n.x+(o.x-n.x)*u/d,n.y+(o.y-n.y)*u/d));return v([n],l,[o])}var h=t.slice(0,_+1),f=t.slice(_),g=w(h,e,i),y=w(f,e,i);return g.slice(0,g.length-1).concat(y)}function x(t,e,i){var r=k(e,i);if(!r)return 0;var n=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/r;return k(t,n<0?e:n>1?i:new s.o0(e.x+n*(i.x-e.x),e.y+n*(i.y-e.y)))}function k(t,e){var i=t.x-e.x,r=t.y-e.y;return i*i+r*r}!function(t){t[t.MOVE_UP=0]="MOVE_UP",t[t.MOVE_DOWN=1]="MOVE_DOWN",t[t.MOVE_LEFT=2]="MOVE_LEFT",t[t.MOVE_RIGHT=3]="MOVE_RIGHT",t[t.SKIP=4]="SKIP"}(r||(r={}));var O=i(94586);function E(t,e){var i=function(t){for(var e=[],i=0,r=0,n=0,o=0;o<t.length;o++)if(0===o){var a=t[t.length-1];r=i=a.x===t[0].x?1/0:(a.y-t[0].y)/(a.x-t[0].x),e.push(a)}else{var s=void 0;if(i===(s=t[o-1].x===t[o].x?1/0:(t[o-1].y-t[o].y)/(t[o-1].x-t[o].x))||Math.abs(i-s)<.001)continue;i=s,o===t.length-1&&(n=s),e.push(t[o-1])}(r===n||Math.abs(r-n)<.001)&&e.shift();return e}(t);if(i.length){for(var r=i.length,n=N(i),o=void 0,a=-1,s=0;s<r;s++){var _=i[s],c=T(s+1,r),u=T(s+2,r),p=B(_,i[c],i[u]);if(n&&p===C){o=i[c],a=c;break}if(!n&&p===M){o=i[c],a=c;break}}if(o){var d=a,l=T(d+1,r),h=T(d-1,r),f=A(i[h],i[d],i[l]),g=(2*Math.PI-f)/2,y=100,m=0;for(s=0;s<r;s++)if(s!==d&&s!==h&&s!==l){var v=B(i[h],i[d],i[s]);if((n&&v===M||!n&&v===C||v===R)&&!I(i,h,d,l,s)){var b=A(i[h],i[d],i[s]),w=Math.abs(b-g);w<y&&(y=w,m=s)}}var x=function(t,e,i){var r=Math.min(e,i),n=Math.max(e,i),o=t[r],a=t[n],s=r+1,_=Math.abs(e-i)-1,c=[],u=s+_-t.length;if(u>0)for(var p=0;p<u;p++){var d=t.shift();t.push(d),s--}return c=t.splice(s,_),c.push(a,o),[c,t]}(i,d,m);E(x[0],e),E(x[1],e)}else e.push(i)}}function I(t,e,i,r,n){for(var o=[e,i,r],a=[T(n-1,t.length),n,T(n+1,t.length)],s=0;s<t.length;s++){var _=(s+1)%t.length;if(!(o.indexOf(s)>=0&&o.indexOf(_)>=0)&&(!(a.indexOf(s)>=0&&a.indexOf(_)>=0)&&D(t[s],t[_],t[i],t[n])))return!0}return!1}function T(t,e){return t>=e?t%e:t<0?e+t%e:t}function N(t){for(var e=0,i=0,r=0;r<t.length;r++){var n=T(r+1,t.length),o=T(r+2,t.length);B(t[r],t[n],t[o])===C?e++:i++}if(i===e){var a=(0,O.Z)(t);return a.pop(),N(a)}return i>e}function S(t,e){var i=function(t,e){return Math.hypot(e.x-t.x,e.y-t.y)}(t,e),r=(e.x-t.x)/i;return e.y>=t.y?Math.acos(r):2*Math.PI-Math.acos(r)}function A(t,e,i){var r=S(e,t),n=S(e,i),o=Math.abs(r-n);return o>Math.PI?2*Math.PI-o:o}var C=1,M=2,P=3,R=4;function B(t,e,i){var r=S(t,e),n=S(t,i);return Math.abs(r-n)<.001||Math.abs(r-n-Math.PI)<.001?j(i.x,t.x,e.x)&&j(i.y,t.y,e.y)?P:R:r<=Math.PI?n<r||n-r>Math.PI?C:M:n>r||r-n>Math.PI?M:C}function j(t,e,i){return t>=e&&t<=i||t>=i&&t<=e}function D(t,e,i,r){if(L(t,i)||L(t,r)||L(e,i)||L(e,r))return!0;var n=function(t,e,i,r){var n=e.y-t.y,o=t.x-e.x,a=e.x*t.y-t.x*e.y,_=r.y-i.y,c=i.x-r.x,u=r.x*i.y-i.x*r.y,p=_*o-n*c;if(0!==p){var d=(c*a-o*u)/p,l=(n*u-_*a)/p;return new s.E9(d,l)}}(t,e,i,r);return n?j(n.x,t.x,e.x)&&j(n.x,i.x,r.x)&&j(n.y,t.y,e.y)&&j(n.y,i.y,r.y):B(t,e,i)===P||B(t,e,r)===P}function L(t,e){return t.x===e.x&&t.y===e.y}var G,F=function(t){var e="function"===typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"===typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},U=function(){function t(t){this.scenes_cache=new Map,this.actors_cache=new Map,this.textures_points_color_data=new Map,this.textures_bounds_points=new Map,this.textures_internal_points=new Map,this.textures_convex_groups=new Map,this.sprite_sheets=new Map,this.app=t}return t.prototype.get_texture=function(t){var e=s.P6.TextureCache[t];if(e instanceof s.xE)return e},t.prototype.get_texture_points_color_data=function(t){var e=this.textures_points_color_data.get(t);if(e)return e;var i=this.get_texture(t);return i?this.set_points_data(t,i):void 0},t.prototype.get_texture_points_position=function(t){var e=this.get_texture_internal_points(t),i=this.get_texture_bounds_points(t);if(e&&i)return e.concat(i)},t.prototype.get_texture_internal_points=function(t){var e=this.textures_internal_points.get(t);if(e)return e;var i=this.get_texture(t),r=this.get_texture_points_color_data(t);if(i&&r){var o=(0,n.$1)({width:i.width,height:i.height}),a=function(t,e,i,r,n){var o,a;void 0===r&&(r=2),void 0===n&&(n=0);var _,c,u=[],p=function(r,n){return r>=0&&n>=0&&r<e&&n<i&&t[n*e+r]>>>24>0};for(o=0,a=0;a<i;o+=r)if(o>e&&(o=0,a+=r),!(a>i)){var d=n?(Math.random()-.5)*n+o:o,l=n?(Math.random()-.5)*n+a:a;p((_=d)-1,(c=l)-1)&&p(_,c-1)&&p(_-1,c)&&p(_,c)&&u.push(new s.o0(d,l))}return u}(r,o.width,o.height);if(a)return this.textures_internal_points.set(t,a),a}},t.prototype.get_texture_bounds_points=function(t){var e=this.textures_bounds_points.get(t);if(e)return e;var i=this.get_texture(t),r=this.get_texture_points_color_data(t);if(i&&r){var o=(0,n.$1)({width:i.width,height:i.height}),a=b(r,o.width,o.height,{mode:"step",step:5});if(a)return this.textures_bounds_points.set(t,a),a}},t.prototype.get_texture_convex_groups=function(t){var e=this.textures_convex_groups.get(t);if(e)return e;var i=this.collect_texture_convex_groups(t);return i?(this.textures_convex_groups.set(t,i),i):void 0},t.prototype.collect_texture_convex_groups=function(t){var e=this.get_texture(t),i=this.get_texture_points_color_data(t);if(e&&i){var r=(0,n.$1)({width:e.width,height:e.height}),o=b(i,r.width,r.height,{mode:"vertex",tolerance:5});if(o){var a=[];return E(o,a),a}}},t.prototype.set_points_data=function(t,e){var i=e.baseTexture.getDrawableSource&&e.baseTexture.getDrawableSource(),r=document.createElement("canvas"),o=r.getContext("2d");if(o&&i){var a=(0,n.$1)({width:e.width,height:e.height});r.width=a.width||1,r.height=a.height||1,o.drawImage(i,0,0,r.width,r.height);var s=new Uint32Array(o.getImageData(0,0,r.width,r.height).data.buffer);return this.textures_points_color_data.set(t,s),s}},t.prototype.get_internal_scene=function(t){var e=this.scenes_cache.get(t);if(e)return e;for(var i=this.app.get_scene_container().children,r=0;r<i.length;r++){var o=i[r];if((0,n.Jf)(o)&&o.id===t)return this.scenes_cache.set(t,o),o}},t.prototype.get_internal_actor=function(t,e){var i,r,o,a,s=this.actors_cache.get(t),_=function(t){return!e||(0,y.Z)(t.get_id(),e)};if(s)return!e||_(s.get_parent_scene())?s:void 0;var c=this.app.get_scene_container().children;try{for(var u=F(c),p=u.next();!p.done;p=u.next()){var d=p.value;if((0,n.Jf)(d)&&_(d)){var l=d.get_actor_container().children;try{for(var h=(o=void 0,F(l)),f=h.next();!f.done;f=h.next()){var g=f.value;if((0,n.pj)(g)&&g.id===t){var m=g.get_actor();return this.actors_cache.set(t,m),m}}}catch(v){o={error:v}}finally{try{f&&!f.done&&(a=h.return)&&a.call(h)}finally{if(o)throw o.error}}}}}catch(b){i={error:b}}finally{try{p&&!p.done&&(r=u.return)&&r.call(u)}finally{if(i)throw i.error}}},t.prototype.get_target=function(t){var e=this.get_internal_scene(t);return e||this.get_internal_actor(t)},t.prototype.clear_scene_cache=function(t){this.scenes_cache.get(t)&&this.scenes_cache.delete(t)},t.prototype.clear_actor_cache=function(t){this.actors_cache.get(t)&&this.actors_cache.delete(t)},t.prototype.clear_texture_points_cache=function(t){this.textures_points_color_data.get(t)&&this.textures_points_color_data.delete(t),this.textures_bounds_points.get(t)&&this.textures_bounds_points.delete(t),this.textures_internal_points.get(t)&&this.textures_internal_points.delete(t),this.textures_convex_groups.get(t)&&this.textures_convex_groups.delete(t)},t.prototype.clear_all_scenes_cache=function(){this.scenes_cache.clear()},t.prototype.clear_all_actors_cache=function(){this.actors_cache.clear()},t.prototype.clear_all_textures_points_cache=function(){this.textures_points_color_data.clear(),this.textures_bounds_points.clear(),this.textures_internal_points.clear(),this.textures_convex_groups.clear()},t.prototype.get_sprite_sheet_data=function(t){return this.sprite_sheets.get(t)},t.prototype.parse_and_cache_sprite_sheet_data=function(t,e,i){var r=this;return new Promise((function(n,o){var a=r.sprite_sheets.get(t);a&&n(a);var _=r.get_texture(e);if(_){var c=new s.c2(_,i);c.parse((function(){if(c.textures){var i={origin_texture_id:e,texture_ids:Object.keys(c.textures)};r.sprite_sheets.set(t,i),n(i)}else n(void 0)}))}else n(void 0)}))},t.prototype.clear_sprite_sheet_cache=function(t){return this.sprite_sheets.delete(t)},t.prototype.clear_all_sprite_sheet_cache=function(){this.sprite_sheets.clear()},t.prototype.is_texture_in_sprite_sheet=function(t){var e,i,r=this.sprite_sheets.values();try{for(var n=F(r),o=n.next();!o.done;o=n.next()){var a=o.value;if((0,y.Z)(t,a.texture_ids))return!0}}catch(s){e={error:s}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}return!1},t}(),V=function(t,e,i,r){var n,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},z=function(){function t(){this.event_emitter=new s.P6.EventEmitter,this.disabled=0,this.fire_queue=[]}return t.prototype.disable=function(){this.disabled++},t.prototype.enable=function(){if(this.disabled<=0)return this.disabled=0,new u("Do not use enable more than once");this.disabled--},t.prototype.is_enabled=function(){return 0===this.disabled},t.prototype.add_listener=function(t,e){this.event_emitter.addListener(t,e)},t.prototype.remove_listener=function(t,e){this.event_emitter.removeListener(t,e)},t.prototype.fire=function(t,e){this.is_enabled()&&(this.fire_queue.push([t,e]),this.release())},t.prototype.emit_break_event=function(t){this.event_emitter.emit("break",t)},t.prototype.release=function(){var t=this.fire_queue.shift();t&&(this.emit(t[0],t[1]),this.release())},t.prototype.emit=function(t,e){this.event_emitter.emit(t,e)},t=V([(0,o.b2)()],t)}(),H=i(14710),q=i.n(H),W=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},K=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},X="Sprite sheet is being loaded.",Y="Sprite sheet already exists.",J="Cannot load the image of sprite sheet",Z="Cannot parse sprite sheet textures.",Q=function(){function t(t){this.data=t,this.loading_urls=new Set}return t.prototype.load_texture=function(t,e){return W(this,void 0,void 0,(function(){var i;return K(this,(function(r){return this.data.get_texture(t)?[2,new u("Texture "+t+" already exists. Please use new texture id")]:(i=s.xE.from(e),s.xE.addToCache(i,t),i.valid?[2,new u("This texture "+t+" is already available in pixi")]:[2,new Promise((function(t,e){i.baseTexture.on("loaded",(function(){t()})),i.baseTexture.on("update",(function(){t()})),i.baseTexture.on("error",(function(t){i.destroy(!0),e(t)}))}))])}))}))},t.prototype.get_texture_img_url=function(t){var e=this.data.get_texture(t);if(!e)return c.error("Cannot find texture "+t);var i=e.baseTexture.getDrawableSource&&e.baseTexture.getDrawableSource();return i&&i instanceof HTMLImageElement?c.success(i.src):c.error("Cannot get url because source is not ImageElement")},t.prototype.destroy_texture=function(t){var e=this.data.get_texture(t);return e?this.data.is_texture_in_sprite_sheet(t)?new u("Texture "+t+" is part of sprite sheet. Cannot destroy it alone"):(e.destroy(!0),void this.data.clear_texture_points_cache(t)):new u("Cannot find texture "+t)},t.prototype.clear_texture_cache=function(t){if(!this.data.get_texture(t))return new u("Cannot find texture "+t);delete s.P6.TextureCache[t],this.data.clear_texture_points_cache(t)},t.prototype.clear_all_textures_cache=function(){this.data.clear_all_textures_points_cache()},t.prototype.destroy_all_textures=function(){s.P6.destroyTextureCache(),s.P6.clearTextureCache(),this.data.clear_all_textures_points_cache(),this.data.clear_all_sprite_sheet_cache()},t.prototype.load_sprite_sheet=function(t){return W(this,void 0,void 0,(function(){var e,i,r,n,o,a,_,c,p=this;return K(this,(function(d){switch(d.label){case 0:if(e=this.data.get_sprite_sheet_data(t))return new u(Y),[2,e.texture_ids];if(this.loading_urls.has(t))return[2,new u(X)];this.loading_urls.add(t),i=function(){return p.loading_urls.delete(t)},d.label=1;case 1:return d.trys.push([1,3,,4]),[4,q().get(t)];case 2:return n=d.sent(),r=n.data,[3,4];case 3:return o=d.sent(),i(),[2,new u(o)];case 4:a=s.P6.url.resolve(t,r.meta.image),_="SPRITE_SHEET_"+t,d.label=5;case 5:return d.trys.push([5,7,,8]),[4,this.load_texture(_,a)];case 6:return d.sent(),c=this.data.get_texture(_),[3,8];case 7:return d.sent(),i(),[2,new u(J)];case 8:return c?[4,this.data.parse_and_cache_sprite_sheet_data(t,_,r)]:(i(),[2,new u(J)]);case 9:return(e=d.sent())?(i(),[2,e.texture_ids]):(i(),[2,new u(Z)])}}))}))},t.prototype.destroy_sprite_sheet=function(t){var e=this,i=this.data.get_sprite_sheet_data(t);if(!i)return new u("Cannot find sprite sheet "+t);i.texture_ids.forEach((function(t){var i=e.data.get_texture(t);i&&i.destroy()}));var r=this.data.get_texture(i.origin_texture_id);r&&r.destroy(!0),this.data.clear_sprite_sheet_cache(t)},t.prototype.get_sprite_sheet_texture_ids=function(t){var e=this.data.get_sprite_sheet_data(t);if(e)return e.texture_ids},t}();!function(t){t[t.QUAD=0]="QUAD",t[t.BOUNCE=1]="BOUNCE"}(G||(G={}));var $,tt=function(t){return 1-(1-t)*(1-t)},et=function(t){var e=7.5625,i=2.75;return t<1/i?e*t*t:t<2/i?e*(t-=1.5/i)*t+.75:t<2.5/i?e*(t-=2.25/i)*t+.9375:e*(t-=2.625/i)*t+.984375};!function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.ALPHA=2]="ALPHA",t[t.ANGLE=3]="ANGLE"}($||($={}));var it=function(){function t(t){this.handler_cache=new Set,this.app=t}return t.prototype.update_attributes=function(t,e,i){var r,n;if(!(t instanceof s._))switch(i){case $.X:return n=e-t.x,r=t.x,function(e){t.position.set(r+n*e,t.position.y)};case $.Y:return n=e-t.y,r=t.y,function(e){t.position.set(t.position.x,r+n*e)};case $.ALPHA:return n=e-t.alpha,r=t.alpha,function(e){t.alpha=r+n*e}}if(i===$.ANGLE)return n=e-t.angle,r=t.angle,function(e){t.angle=r+n*e}},t.prototype.create_tween=function(t){var e,i,r=this,n=t.target,o=1e3*t.duration,a=performance.now(),_=(null===(e=t.to_options)||void 0===e?void 0:e.ease)||G.QUAD,c=t.to_options,u=t.delay?1e3*t.delay:0;switch(_){case G.QUAD:i=tt;break;case G.BOUNCE:i=et}var p={};n instanceof s._||(void 0!==c.x&&c.x-n.position.x!==0&&(p.update_x=this.update_attributes(n,c.x,$.X)),void 0!==c.y&&c.y-n.position.y!==0&&(p.update_y=this.update_attributes(n,c.y,$.Y)),void 0!==c.visible&&(n.visible=c.visible),void 0!==c.alpha&&(p.update_alpha=this.update_attributes(n,c.alpha,$.ALPHA))),void 0!==c.angle&&(p.update_angle=this.update_attributes(n,c.angle,$.ANGLE));var d=function t(){var e=performance.now();if(!(u>0&&a+u>e)){var n=(e-a-u)/o,s=i(n);if(n>1)return r.update_target(p,s),void r.remove_ticker(t);r.update_target(p,s)}};this.handler_cache.add(d),this.app.get_app().ticker.add(d)},t.prototype.update_target=function(t,e){t.update_x&&t.update_x(e),t.update_y&&t.update_y(e),t.update_alpha&&t.update_alpha(e),t.update_angle&&t.update_angle(e)},t.prototype.to=function(t,e,i,r){return this.create_tween({target:t,duration:e,to_options:i,delay:r}),this},t.prototype.from=function(t,e,i,r){var n={angle:t.angle};return t instanceof s._||(n.x=t.position.x,n.y=t.position.x,n.visible=t.visible,n.alpha=t.alpha),this.set_target_initial_state(t,i),this.create_tween({target:t,duration:e,to_options:n,delay:r}),this},t.prototype.from_to=function(t,e,i,r,n){return this.set_target_initial_state(t,i),this.create_tween({target:t,duration:e,to_options:r,delay:n}),this},t.prototype.set_target_initial_state=function(t,e){t instanceof s._||(void 0!==e.x&&(t.position.x=e.x),void 0!==e.y&&(t.position.y=e.y),void 0!==e.alpha&&(t.alpha=e.alpha),void 0!==e.visible&&(t.visible=e.visible)),void 0!==e.angle&&(t.angle=e.angle)},t.prototype.set_complete_handler=function(t){this.on_complete=t},t.prototype.get_cache_size=function(){return this.handler_cache.size},t.prototype.clear=function(){var t=this;this.handler_cache.forEach((function(e){t.app.get_app().ticker.remove(e)})),this.handler_cache.clear(),this.on_complete=void 0},t.prototype.remove_ticker=function(t){this.app.get_app().ticker.remove(t),this.handler_cache.delete(t),0===this.handler_cache.size&&(this.on_complete&&this.on_complete(),this.on_complete=void 0)},t}(),rt=function(){function t(t){this.app=t,this.tl=new it(this.app)}return t.prototype.on_complete=function(){},t.prototype.set_transition=function(t,e,i,r){var n=this;if(this.clear_tl(e,i),this.on_complete=function(){n.reset_scenes(e,i),r&&r()},"none"!==t)switch(this.tl.set_complete_handler(this.on_complete),this.scene_destroy_handler=function(){n.clear_tl(e,i),n.scene_destroy_handler=void 0},e.add_listener("destroy",this.scene_destroy_handler),i.add_listener("destroy",this.scene_destroy_handler),t){case"slide_up":case"slide_left":case"slide_down":case"slide_right":return void this.set_slide_transition(e,i,t);case"bounce_up":case"bounce_down":case"bounce_left":case"bounce_right":return void this.set_bounce_transition(i,t);case"fade_in_out":return void this.set_fade_transition(e,i);case"distort":return void this.set_distort_transition(e,i)}else r&&r()},t.prototype.set_slide_transition=function(t,e,i){var r=this.app.get_app().view,n=r.width,o=r.height;e.visible=!0;var a=0,s=0;switch(i){case"slide_down":e.position.y=-o,s=o;break;case"slide_up":e.position.y=o,s=-o;break;case"slide_left":e.position.x=n,a=-n;break;case"slide_right":e.position.x=-n,a=n}this.tl.to(t,.5,{x:a,y:s,ease:G.QUAD}).to(e,.5,{x:0,y:0,ease:G.QUAD})},t.prototype.set_bounce_transition=function(t,e){var i=this.app.get_app(),r=this.app.get_scene_container(),n=i.view,o=n.width,a=n.height;this.in_scene_origin_z_index=r.getChildIndex(t),r.setChildIndex(t,r.children.length-1),t.visible=!0;switch(e){case"bounce_down":t.position.y=-a;break;case"bounce_up":t.position.y=a;break;case"bounce_left":t.position.x=o;break;case"bounce_right":t.position.x=-o}this.tl.to(t,1,{x:0,y:0,ease:G.BOUNCE})},t.prototype.set_fade_transition=function(t,e){e.visible=!0;e.alpha=0,this.tl.to(t,.5,{alpha:0,ease:G.QUAD}).from_to(e,.5,{alpha:0},{alpha:1,ease:G.QUAD})},t.prototype.set_distort_transition=function(t,e){var i=this.app.get_app(),r=.5,o=i.view,a=o.width,_=o.height,c=new s.TI(new s.jd({width:a,height:_})),u=new s.TI(new s.jd({width:a,height:_}));t.visible=!0,e.visible=!1,i.renderer.render(i.stage,{renderTexture:c}),t.visible=!1,e.visible=!0,i.renderer.render(i.stage,{renderTexture:u}),this.out_sprite=s.jy.from(c),this.out_sprite.anchor.set(.5),this.in_sprite=s.jy.from(u),this.in_sprite.anchor.set(.5);var p=Math.min(a,_),d=new s.E9(a/2,_/2),l=new s._({radius:p,angle:0,padding:10});l.offset=d;var h=new s._({radius:p,angle:(0,n.ph)(189),padding:10});h.offset=d,this.out_sprite.filters=[l],this.in_sprite.filters=[h],i.stage.addChild(this.out_sprite,this.in_sprite),this.tl.from_to(this.out_sprite,r,{alpha:1},{alpha:0}).from_to(l,r,{angle:0},{angle:(0,n.ph)(-227.8)}).from_to(this.in_sprite,r,{visible:!0,alpha:0},{visible:!0,alpha:1},.1).to(h,r,{angle:0},.1)},t.prototype.clear_tl=function(t,e){this.tl.get_cache_size()&&(this.reset_scenes(t,e),this.tl.clear())},t.prototype.reset_scenes=function(t,e){t.x=0,t.y=0,t.alpha=1,e.x=0,e.y=0,e.alpha=1,this.scene_destroy_handler&&(t.remove_listener("destroy",this.scene_destroy_handler),e.remove_listener("destroy",this.scene_destroy_handler),this.scene_destroy_handler=void 0),void 0!==this.in_scene_origin_z_index&&(this.app.get_scene_container().setChildIndex(e,this.in_scene_origin_z_index),this.in_scene_origin_z_index=void 0),this.out_sprite&&(this.out_sprite.destroy({children:!0,texture:!0,baseTexture:!0}),this.out_sprite=void 0),this.in_sprite&&(this.in_sprite.destroy({children:!0,texture:!0,baseTexture:!0}),this.in_sprite=void 0)},t}(),nt=i(40465),ot=i(58580),at=function(){function t(t,e){var i=this;this.hue_degree=0,this.brightness=100,this.saturation=0,this.pixelate_size=0,this.twist_angle=0,this.ascii_size=0,this.displacement_img="",this.displacement_speed=0,this.update_twist_offset=function(){var t=i.effect_filter_list[4];if(i.is_twist_filter(t)&&t.enabled){var e=i.app.get_app().view,r=e.width,n=e.height,o=i.get_target_position();t.offset=new s.E9(o.x+r/2,-o.y+n/2)}},this.update_displacement_position=function(){var t=i.effect_filter_list[3];if(t&&t.enabled&&i.is_displacement_filter(t)&&i.displacement_sprite){var e=i.app.get_app().view.width/2,r=i.displacement_sprite.width/2;i.displacement_sprite.position.x-r>-e&&(i.displacement_sprite.position.x-=i.displacement_sprite.width/2),i.displacement_sprite.position.x+=i.displacement_speed}},this.app=t,this.effect_filter_list=[],this.target=e;var r=function(){i.remove_effects()};(0,n.Jf)(e)?(this.target_sprite=e.background,e.add_listener("destroy",r),this.get_target_position=function(){return e.background.get_position()}):(this.target_sprite=e,e.add_listener("destroy",r),this.get_target_position=function(){return e.get_position()})}return t.prototype.get_effect_filter=function(t){var e=this,i=this.effect_filter_list[t];if(!i){var r=function(t){t.position&&e.update_twist_offset()};switch(t){case 0:case 1:case 5:i=new s.mJ;break;case 2:i=new s.GW;break;case 3:if(!this.displacement_sprite)throw new Error("Displacement sprite should be init first.");i=new s.pz(this.displacement_sprite),this.app.get_app().ticker.add(this.update_displacement_position);break;case 4:i=new s._,(0,n.Jf)(this.target),this.target.add_listener("change",r);break;case 6:i=new s.x1}this.effect_filter_list[t]=i,this.update_target_filter()}return i.enabled=!0,i},t.prototype.update_target_filter=function(){this.target_sprite.filters=this.effect_filter_list.filter((function(t){return!!t}))},t.prototype.is_color_matrix_filter=function(t){return t instanceof s.mJ},t.prototype.is_pixelate_filter=function(t){return t instanceof s.GW},t.prototype.is_displacement_filter=function(t){return t instanceof s.pz},t.prototype.is_twist_filter=function(t){return t instanceof s._},t.prototype.is_ascii_filter=function(t){return t instanceof s.x1},t.prototype.update_displacement_sprite=function(t){if(!t||this.displacement_img!==t||!this.displacement_sprite){this.displacement_sprite&&this.displacement_sprite.destroy(),this.displacement_img=t,this.displacement_sprite=s.jy.from(t),this.displacement_sprite.anchor.set(.5,.5);var e=this.app.get_app().view,i=e.width,r=e.height;this.displacement_sprite.width=2*i,this.displacement_sprite.height=2*r,this.target_sprite.parent.addChild(this.displacement_sprite)}},t.prototype.set_hue=function(t){var e=this.get_effect_filter(0);this.is_color_matrix_filter(e)&&(this.hue_degree=t,e.hue(this.hue_degree,!1))},t.prototype.get_hue=function(){return this.hue_degree},t.prototype.set_brightness=function(t){var e=this.get_effect_filter(1);if(this.is_color_matrix_filter(e)){this.brightness=t;var i=(0,ot.Z)(-1,1,t/100-1);e.matrix=[1,0,0,0,i,0,1,0,0,i,0,0,1,0,i,0,0,0,1,0]}},t.prototype.get_brightness=function(){return this.brightness},t.prototype.set_saturate=function(t){var e=this.get_effect_filter(5);this.is_color_matrix_filter(e)&&(this.saturation=(0,ot.Z)(-100,100,t),e.saturate(this.saturation/100,!1))},t.prototype.get_saturate=function(){return this.saturation},t.prototype.set_pixelate=function(t){var e=this.get_effect_filter(2);if(this.is_pixelate_filter(e)){var i=Math.max(Math.min(this.target_sprite.width,this.target_sprite.height),1);this.pixelate_size=(0,ot.Z)(1,i,t),e.size=this.pixelate_size}},t.prototype.get_pixelate=function(){return this.pixelate_size},t.prototype.set_displacement=function(t,e){try{this.update_displacement_sprite(e);var i=this.get_effect_filter(3);if(!this.is_displacement_filter(i))return;return void(this.displacement_speed=(0,ot.Z)(0,100,t))}catch(r){return new u("Init displacement filter failed.")}},t.prototype.get_displacement=function(){return this.displacement_speed},t.prototype.set_twist=function(t){var e=this.get_effect_filter(4);this.is_twist_filter(e)&&(this.twist_angle=(0,ot.Z)(0,100,t),e.angle=(0,n.ph)(10*this.twist_angle),e.radius=Math.sqrt(Math.pow(this.target_sprite.width/2,2)+Math.pow(this.target_sprite.height/2,2)),this.update_twist_offset())},t.prototype.get_twist=function(){return this.twist_angle},t.prototype.set_ascii=function(t){var e=this.get_effect_filter(6);if(this.is_ascii_filter(e)){var i=Math.min(this.target_sprite.width,this.target_sprite.height);this.ascii_size=(0,ot.Z)(1,i,t),e.size=this.ascii_size}},t.prototype.get_ascii=function(){return this.ascii_size},t.prototype.reset_default_value=function(t){switch(t){case 0:this.hue_degree=0;break;case 1:this.brightness=100;break;case 5:this.saturation=0;break;case 2:this.pixelate_size=0;break;case 3:this.displacement_speed=0;break;case 4:this.twist_angle=0;break;case 6:this.ascii_size=0}},t.prototype.disable_effects=function(){var t=this;this.effect_filter_list.forEach((function(e,i){e&&(e.enabled=!1,t.reset_default_value(i))}))},t.prototype.remove_effects=function(){var t=this;this.effect_filter_list.forEach((function(e,i){t.reset_default_value(i),3===i&&t.app.get_app().ticker.remove(t.update_displacement_position)})),this.effect_filter_list=[],this.update_target_filter()},t.prototype.clone_to=function(t){var e=this,i=t.get_effects(),r=i.value;i.is_error(r)||this.effect_filter_list.forEach((function(t,i){if(t&&t.enabled)switch(i){case 0:r.set_hue(e.hue_degree);break;case 1:r.set_brightness(e.brightness);break;case 5:r.set_saturate(e.saturation);break;case 2:r.set_pixelate(e.pixelate_size);break;case 3:r.set_displacement(e.displacement_speed,e.displacement_img);break;case 4:r.set_twist(e.twist_angle);break;case 6:r.set_ascii(e.ascii_size)}}))},t}(),st=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),_t=function(t){function e(e,i,r,n,o,a,s,_,c){var u=t.call(this,e,r,n)||this;return u.type=nt.LP.Background,u.rotation_type=nt.MO.ALL,u.rotation_value=0,u.is_horizontal_flipped=!1,u.is_vertical_flipped=!1,u.is_rotation_flipped=!1,u.transform_offset={pivot:{x:0,y:0},position:{x:0,y:0}},u.custom_pivot={x:0,y:0},u.adaptive_scale={x:1,y:1},u.transform_position={x:0,y:0},u.on_resize=function(t){t.target_id===u.app.get_app().stage.name&&(u.width=t.data.width,u.height=t.data.height)},u.id=c,u.name=c,u.texture_id=i,u.anchor.set(.5),u.interactive=!0,u.emit_scene_event=o,u.app=a,u.data=s,u.events=_,u.events.add_listener("stage:resize",u.on_resize),u}return st(e,t),e.prototype.set_position=function(t,e){this.update_pixi_position(t,e),this.emit_scene_event("change",{position:this.transform_position})},e.prototype.set_position_x=function(t){var e=this.get_position().y;this.set_position(t,e)},e.prototype.set_position_y=function(t){var e=this.get_position().x;this.set_position(e,t)},e.prototype.move_forward=function(t){var e=this.get_position(),i=this.get_rotation(),r=e.x+Math.cos(i)*t,n=e.y+Math.sin(i)*t;this.set_position(r,n)},e.prototype.get_position=function(){var t=this.transform_offset.position;return{x:this.transform_position.x-t.x,y:-this.transform_position.y+t.y}},e.prototype.set_scale=function(t,e){var i=t;void 0!==i&&(i=Math.max(0,i),i=this.is_rotation_flipped!==this.is_vertical_flipped?-1*i:i);var r=void 0===e?t:e;void 0!==r&&(r=Math.max(0,r),r=this.is_horizontal_flipped?-1*r:r),this.set_pixi_scale(i,r)},e.prototype.get_scale=function(){var t=this.get_pixi_scale(),e=t.x,i=t.y;return{x:Math.abs(e),y:Math.abs(i)}},e.prototype.set_rotation=function(t){var e=(0,n.k4)(t);this.rotation_value=e;var i=!1;switch(this.rotation_type){case nt.MO.ALL:this.set_pixi_rotation(-this.rotation_value),i=this.is_rotation_flipped;break;case nt.MO.LEFT_RIGHT:this.set_pixi_rotation(0),i=(this.rotation_value>=Math.PI/2||this.rotation_value<-Math.PI/2)!==this.is_rotation_flipped;break;case nt.MO.NONE:this.set_pixi_rotation(0),i=this.is_rotation_flipped}if(i){var r=this.get_pixi_scale(),o=r.x,a=r.y;this.is_rotation_flipped=!this.is_rotation_flipped,this.set_pixi_scale(-1*o,a)}},e.prototype.set_flipped=function(t){var e=this.get_pixi_scale(),i=e.x,r=e.y;switch(t){case"vertical":return this.set_pixi_scale(-1*i,r),void(this.is_vertical_flipped=!this.is_vertical_flipped);case"horizontal":return this.set_pixi_scale(i,-1*r),void(this.is_horizontal_flipped=!this.is_horizontal_flipped)}},e.prototype.set_rotation_type=function(t){this.rotation_type=t,this.set_rotation(this.rotation_value)},e.prototype.set_visible=function(t){this.visible=t,this.emit_scene_event("change",{visible:this.visible})},e.prototype.set_alpha=function(t){this.alpha=t,this.emit_scene_event("change",{alpha:this.alpha})},e.prototype.get_rotation=function(){return this.rotation_value},e.prototype.get_rotation_type=function(){return this.rotation_type},e.prototype.get_visible=function(){return this.visible},e.prototype.get_alpha=function(){return this.alpha},e.prototype.get_texture_id=function(){return this.texture_id},e.prototype.get_vertical_flipped=function(){return this.is_vertical_flipped},e.prototype.get_horizontal_flipped=function(){return this.is_horizontal_flipped},e.prototype.set_texture=function(t,e){var i=this.data.get_texture(t);if(!i)return new u("Cannot find texture "+t+". Please load texture first");this.texture=i,this.texture_id=t,e&&(e.pivot&&(this.custom_pivot=e.pivot),void 0!==e.adaption&&(this.adaption=e.adaption)),this.on_texture_updated()},e.prototype.update_adaptive_scale=function(){if(this.adaption){var t=this.app.get_app().view,e=t.width,i=t.height,r=e/this.texture.width,n=i/this.texture.height,o=void 0;switch(this.adaption){case nt.i$.CONTAIN:o=Math.min(r,n),this.adaptive_scale={x:o,y:o},this.width=this.texture.width*this.adaptive_scale.x,this.height=this.texture.height*this.adaptive_scale.y,this.transform_offset.position={x:this.width/2,y:this.height/2};break;case nt.i$.COVER:o=Math.max(r,n),this.adaptive_scale={x:o,y:o},this.width=e,this.height=i,this.transform_offset.position={x:e/2,y:i/2};break;case nt.i$.STRETCH:this.adaptive_scale={x:r,y:n},this.width=e,this.height=i,this.transform_offset.position={x:e/2,y:i/2};break;case nt.i$.NONE:this.texture.width<e&&this.texture.height<i?(o=Math.max(r,n),this.adaptive_scale={x:o,y:o},this.width=e,this.height=i,this.transform_offset.position={x:e/2,y:i/2}):this.adaptive_scale={x:1,y:1};break;default:return}}else this.adaptive_scale={x:1,y:1};this.update_pixi_position(),this.tileTransform.scale.set(this.adaptive_scale.x,this.adaptive_scale.y)},e.prototype.set_adaption_mode=function(t){this.adaption!==t&&this.data.get_texture(this.texture_id)&&(this.adaption=t,this.on_texture_updated())},e.prototype.update_pixi_position=function(t,e){var i=this.transform_offset.position;this.transform_position={x:t?t+i.x:i.x,y:e?-e+i.y:i.y},this.tileTransform.position.set(this.transform_position.x%(this.texture.width*this.adaptive_scale.x),this.transform_position.y%(this.texture.height*this.adaptive_scale.y))},e.prototype.destroy=function(){this.events.remove_listener("stage:resize",this.on_resize),t.prototype.destroy.call(this)},e}(s.FP),ct=function(t){function e(e,i,r,n,o,a,s,_,c){var u=t.call(this,e,i,r,n,o,a,s,_,c)||this;u.update_transform=function(t){u.transform_offset.position={x:t.width/2,y:t.height/2},u.update_pixi_position(),u.update_transform_pivot(),u.update_adaptive_scale()},u.on_stage_resize=function(t){t.target_id===u.app.get_app().stage.name&&u.update_transform(t.data)};var p=a.get_app().view,d=p.width,l=p.height;return u.update_transform({width:d,height:l}),u.events.add_listener("stage:resize",u.on_stage_resize),u}return st(e,t),e.prototype.set_pixi_rotation=function(t){this.tileTransform.rotation=t,this.emit_scene_event("change",{rotation:this.get_pixi_rotation()})},e.prototype.get_pixi_rotation=function(){return this.tileTransform.rotation},e.prototype.set_pixi_scale=function(t,e){this.tileTransform.scale.set(void 0===t?void 0:t*this.adaptive_scale.x,void 0===e?void 0:e*this.adaptive_scale.y),this.emit_scene_event("change",{scale:this.tileTransform.scale})},e.prototype.get_pixi_scale=function(){var t=this.tileTransform.scale,e=t.x,i=t.y;return{x:e/this.adaptive_scale.x,y:i/this.adaptive_scale.y}},e.prototype.on_texture_updated=function(){this.update_transform_pivot(),this.update_adaptive_scale()},e.prototype.update_transform_pivot=function(){var t=this.texture,e=t.width,i=t.height;this.transform_offset.pivot={x:e/2+this.custom_pivot.x,y:i/2+this.custom_pivot.y},this.tileTransform.pivot.set(this.transform_offset.pivot.x,this.transform_offset.pivot.y)},e.prototype.destroy=function(){this.events.remove_listener("stage:resize",this.on_stage_resize),t.prototype.destroy.call(this)},e}(_t),ut=(function(t){function e(e,i,r,n,o,a,s,_,c){var u=t.call(this,e,i,r,n,o,a,s,_,c)||this;return u.update_transform=function(t){t.target_id===u.app.get_app().stage.name&&u.on_texture_updated()},u.update_transform_position(0,0),u.events.add_listener("stage:resize",u.update_transform),u}st(e,t),e.prototype.set_pixi_rotation=function(t){this.rotation=t,this.emit_scene_event("change",{rotation:this.get_pixi_rotation()})},e.prototype.get_pixi_rotation=function(){return this.rotation},e.prototype.set_pixi_scale=function(t,e){this.scale.set(t,e),this.emit_scene_event("change",{scale:this.get_pixi_scale()})},e.prototype.get_pixi_scale=function(){var t=this.scale;return{x:t.x,y:t.y}},e.prototype.on_texture_updated=function(){this.update_adaptive_scale();var t=this.tileTransform.position,e=t.x,i=t.y,r=e-this.transform_offset.position.x,n=i-this.transform_offset.position.y;this.update_transform_position(r,n)},e.prototype.update_transform_position=function(t,e){var i=this.app.get_app().view,r=i.width,n=i.height,o=this.texture,a=o.width,s=o.height,_=(a*this.adaptive_scale.x-r)/-2-this.custom_pivot.x,c=(s*this.adaptive_scale.y-n)/-2-this.custom_pivot.y;this.transform_offset.position={x:_,y:c},this.tileTransform.position.set(this.transform_offset.position.x+t,this.transform_offset.position.y+e)},e.prototype.destroy=function(){this.events.remove_listener("stage:resize",this.update_transform),t.prototype.destroy.call(this)}}(_t),function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}()),pt=function(t){function e(e,i,r,n,o,a){var _=t.call(this)||this;_.type=nt.LP.Scene,_.brush_canvas=document.createElement("canvas"),_.brush_ctx=_.brush_canvas.getContext("2d"),_.should_update_brush_texture=!1,_.mouse_down_time=0,_.on_resize=function(t){t.target_id===_.app.get_app().stage.name&&(_.brush_canvas.width=t.data.width,_.brush_canvas.height=t.data.height)},_.on_tick=function(){_.should_update_brush_texture&&(_.should_update_brush_texture=!1,_.update_brush())},_.data=n,_.app=o,_.events=a,_.id=e,_.name=e;var c=_.app.get_app().view,u=c.width,p=c.height;_.visible=!1,_.interactive=!0;var d=_.app.get_renderer_type()===s.N3.WEBGL,l=_.emit_event.bind(_);return _.background=new ct(i,r,u,p,l,o,n,a,e),_.addChildAt(_.background,0),_.brush_canvas.width=u,_.brush_canvas.height=p,_.brush_sprite=s.jy.from(_.brush_canvas),_.brush_sprite.anchor.set(.5),_.addChildAt(_.brush_sprite,1),_.actor_container=new s.W2,_.actor_container.name="actor_container",_.addChildAt(_.actor_container,2),_.background.addListener("mousedown",(function(){return _.emit_mouse_event("scene:mousedown")})),_.background.addListener("mousemove",(function(){return _.emit_mouse_event("scene:mousemove")})),_.background.addListener("mouseup",(function(){return _.emit_mouse_event("scene:mouseup")})),_.background.addListener("mouseupoutside",(function(){return _.emit_mouse_event("scene:mouseupoutside")})),_.background.addListener("touchstart",(function(){return _.emit_mouse_event("scene:touchstart")})),_.background.addListener("touchmove",(function(){return _.emit_mouse_event("scene:touchmove")})),_.background.addListener("touchend",(function(){return _.emit_mouse_event("scene:touchend")})),_.background.addListener("touchendoutside",(function(){return _.emit_mouse_event("scene:touchendoutside")})),_.events.add_listener("stage:resize",_.on_resize),_.app.get_app().ticker.add(_.on_tick),d&&(_.effects=new at(_.app,_)),_}return ut(e,t),e.prototype.emit_event=function(t,e){this.emit(t,e)},e.prototype.add_listener=function(t,e){this.on(t,e)},e.prototype.remove_listener=function(t,e){this.off(t,e)},e.prototype.destroy=function(){this.emit_event("destroy",void 0),this.app.get_app().ticker.remove(this.on_tick),this.events.remove_listener("stage:resize",this.on_resize),this.brush_sprite.destroy({children:!0,texture:!0,baseTexture:!0}),t.prototype.destroy.call(this,{children:!0}),this.data.clear_scene_cache(this.id)},e.prototype.get_background=function(){return this.background},e.prototype.get_id=function(){return this.id},e.prototype.get_actor_ids=function(t){var e=[],i=t?function(i){return i.group===t&&e.push(i.id)}:function(t){return e.push(t.id)};return this.actor_container.children.forEach((function(t){(0,n.pj)(t)&&i(t.get_actor())})),e},e.prototype.get_brush_ctx=function(){return this.brush_ctx},e.prototype.should_update_brush=function(){this.should_update_brush_texture=!0},e.prototype.update_brush=function(){this.brush_sprite.texture.update()},e.prototype.get_actor_container=function(){return this.actor_container},e.prototype.emit_mouse_event=function(t){switch(t){case"scene:mousedown":case"scene:touchstart":this.mouse_down_time=(new Date).getTime(),this.events.fire("scene:selected",{target_id:this.id});break;case"scene:mouseup":case"scene:touchend":(new Date).getTime()-this.mouse_down_time<1e3&&this.events.fire("scene:click",{target_id:this.id})}this.events.fire(t,{target_id:this.id})},e.prototype.get_effects=function(){return this.effects?c.success(this.effects):c.error("Effect not available. It needs support of WebGL.")},e.prototype.set_brush_target=function(t){var e=this,i=this.data.get_internal_actor(t,[this.get_id()]);if(!i)return new u("Cannot find actor "+t+" in scene "+this.id);i.wrapper.addChild(this.brush_sprite),this.brush_unset_listener=function(){e.unset_brush_target()},i.add_listener("destroy",this.brush_unset_listener)},e.prototype.get_brush_target=function(){if((0,n.pj)(this.brush_sprite.parent))return this.brush_sprite.parent.get_actor()},e.prototype.unset_brush_target=function(){var t=this.brush_sprite.parent;(0,n.pj)(t)&&(this.addChildAt(this.brush_sprite,1),this.brush_unset_listener&&(t.get_actor().remove_listener("destroy",this.brush_unset_listener),this.brush_unset_listener=void 0))},e}(s.W2),dt=function(){function t(t,e,i,r,n){this.transition_type="none",this.app=t,this.data=e,this.transition=i(t),this.scene=r,this.events=n}return t.prototype.load_scene=function(t,e){if(this.data.get_internal_scene(t))return c.error("Scene "+t+" already exists. Please use new scene id");var i=e?this.data.get_texture(e):s.xE.EMPTY;if(!i)return c.error("Cannot find texture "+e+". Please load texture first");var r=this.scene(t,i,e||"",this.data,this.app);return this.app.get_scene_container().addChild(r),c.success(r)},t.prototype.set_current_scene=function(t,e){var i=this,r=this.data.get_internal_scene(t);if(!r)return new u("Cannot find scene "+t);if(this.current_scene!==t){if(!this.current_scene)return this.current_scene=t,this.set_one_scene_visible(t),void(e&&e());var n=this.data.get_internal_scene(this.current_scene);if(!n)return new u("Cannot find out scene "+this.current_scene);this.current_scene=t,this.transition.set_transition(this.transition_type,n,r,(function(){i.set_one_scene_visible(r.id),e&&e()}))}},t.prototype.get_current_scene=function(){return this.current_scene},t.prototype.destroy_scene=function(t){var e=this.data.get_internal_scene(t);if(!e)return c.error("Cannot find scene "+t);e.destroy(),this.current_scene===t&&(this.current_scene=void 0);var i=this.app.get_scene_container().children,r=[];return i.forEach((function(t){(0,n.Jf)(t)&&r.push(t.id)})),c.success({scene_ids:r})},t.prototype.dispose_actors_by_scene=function(t){var e=this,i=this.data.get_internal_scene(t);if(!i)return new u("Cannot find scene "+t);i.get_actor_container().removeChildren().forEach((function(t){if((0,n.pj)(t)){var i=t.get_actor();i.destroy(),e.data.clear_actor_cache(i.get_id())}}))},t.prototype.destroy_all_scenes=function(){var t=this;this.get_scene_ids().forEach((function(e){var i=t.data.get_internal_scene(e);i&&i.destroy()})),this.current_scene=void 0,this.data.clear_all_scenes_cache()},t.prototype.get_scene_ids=function(){var t=[];return this.app.get_scene_container().children.forEach((function(e){(0,n.Jf)(e)&&t.push(e.id)})),t},t.prototype.set_one_scene_visible=function(t){this.app.get_scene_container().children.forEach((function(e){(0,n.Jf)(e)&&(e.id===t?e.visible=!0:e.visible=!1)})),this.events.fire("scene:current_scene_changed",t)},t.prototype.set_transition_type=function(t){if("distort"===t&&this.app.get_renderer_type()!==s.N3.WEBGL)return new u("Only WEBGL support distort transition");this.transition_type=t},t.prototype.get_scene=function(t){var e=this.data.get_internal_scene(t);return e?c.success(e):c.error("Cannot find scene "+t)},t}(),lt=function(){function t(t,e){this.actor=t,this.fn=e}return t.prototype.contains=function(t,e){var i=this.actor.toGlobal(new s.E9(t,e));return!!this.actor.containsPoint(new s.E9(i.x,i.y))&&this.fn(i)},t}(),ht=function(){function t(t,e){var i=this;this.ctx=null,this.update_pen_on_change=function(t){t.position&&i.draw_line(t.position.x,t.position.y)},this.update_fill_point_on_change=function(t){t.position&&i.update_fill_point(t.position.x,t.position.y)},this.app=t,this.actor=e,this.size=1,this.stroke_color="000000",this.alpha=1,this.hsl=[0,0,0],this.ctx=this.actor.parent_scene.get_brush_ctx(),this.fill_path=[],this.is_recording_fill_path=!1}return t.prototype.set_pen_down=function(){if(!this.origin_x||!this.origin_y){var t=this.actor,e=t.x,i=t.y;this.origin_x=e,this.origin_y=i,this.draw_line(e,i),this.actor.add_listener("change",this.update_pen_on_change)}},t.prototype.set_pen_up=function(){this.origin_x=void 0,this.origin_y=void 0,this.actor.remove_listener("change",this.update_pen_on_change)},t.prototype.draw_line=function(t,e){if(void 0!==this.origin_x&&void 0!==this.origin_y){var i=this.ctx;i&&(i.save(),i.lineWidth=this.size,i.globalAlpha=this.alpha,i.strokeStyle="#"+this.stroke_color,i.fillStyle="#"+this.stroke_color,this.canvas_draw_circle(i,this.origin_x,this.origin_y),this.canvas_draw_line(i,this.origin_x,this.origin_y,t,e),i.restore(),this.actor.parent_scene.should_update_brush(),this.origin_x=t,this.origin_y=e)}},t.prototype.canvas_draw_line=function(t,e,i,r,n){var o=this.app.get_app().view,a=o.width/2,s=o.height/2;t.lineJoin="round",t.beginPath(),t.moveTo(a+e,s+i),t.lineTo(a+r,s+n),t.closePath(),t.stroke()},t.prototype.canvas_draw_circle=function(t,e,i){var r=this.app.get_app().view,n=r.width/2,o=r.height/2,a=this.size/2;t.beginPath(),t.arc(n+e,o+i,a,0,2*Math.PI),t.fill()},t.prototype.render=function(){this.actor.parent_scene.update_brush(),this.app.render()},t.prototype.set_size=function(t){this.size=(0,ot.Z)(1,1e4,t)},t.prototype.set_color=function(t){this.stroke_color=t,this.hsl=(0,n.W4)(t)},t.prototype.set_alpha=function(t){this.alpha=(0,ot.Z)(0,1,t)},t.prototype.set_hue=function(t){(t%=360)<0&&(t+=360),this.hsl[0]=t,this.stroke_color=(0,n.Wz)(this.hsl[0],this.hsl[1],this.hsl[2])},t.prototype.set_saturation=function(t){this.hsl[1]=(0,ot.Z)(0,1,t),this.stroke_color=(0,n.Wz)(this.hsl[0],this.hsl[1],this.hsl[2])},t.prototype.set_brightness=function(t){this.hsl[2]=(0,ot.Z)(0,1,t),this.stroke_color=(0,n.Wz)(this.hsl[0],this.hsl[1],this.hsl[2])},t.prototype.get_size=function(){return this.size},t.prototype.get_color=function(){return this.stroke_color},t.prototype.get_alpha=function(){return this.alpha},t.prototype.get_hue=function(){return this.hsl[0]},t.prototype.get_saturation=function(){return this.hsl[1]},t.prototype.get_brightness=function(){return this.hsl[2]},t.prototype.clear=function(){if(this.ctx){var t=this.app.get_app().view,e=t.width,i=t.height;this.ctx.clearRect(0,0,e,i),this.actor.parent_scene.should_update_brush()}},t.prototype.set_fill_color=function(t){this.fill_color=t},t.prototype.set_fill_start=function(){this.is_recording_fill_path||(this.is_recording_fill_path=!0,this.actor.add_listener("change",this.update_fill_point_on_change)),this.fill_path=[],this.update_fill_point(this.actor.position.x,this.actor.position.y)},t.prototype.update_fill_point=function(t,e){if(this.is_recording_fill_path){var i=new s.E9(t,e);this.fill_path.push(this.app.get_app().stage.toGlobal(i))}},t.prototype.draw_fill_pattern=function(){if(this.is_recording_fill_path){var t=this.ctx;if(t){var e=this.fill_path.shift();e&&(t.save(),t.fillStyle=this.fill_color?"#"+this.fill_color:"#"+this.stroke_color,t.lineJoin="round",t.beginPath(),t.moveTo(e.x,e.y),this.fill_path.forEach((function(e){t.lineTo(e.x,e.y)})),t.closePath(),t.fill(),t.restore(),this.actor.parent_scene.should_update_brush(),this.fill_path=[],this.is_recording_fill_path=!1,this.actor.remove_listener("change",this.update_fill_point_on_change))}}},t.prototype.draw_text_stamp=function(t,e,i,r){var n=this.ctx;if(n){var o=this.app.get_app().stage.toGlobal(this.actor.position),a=o.x,s=o.y,_=void 0!==r?r:this.actor.rotation;n.save(),n.font="bold "+e+"px Arial , Microsoft YaHei",n.fillStyle="#"+this.stroke_color,n.globalAlpha=this.alpha,n.textBaseline="middle",n.textAlign=i,n.translate(a,s),n.rotate(_),n.fillText(t,0,0),n.restore(),this.actor.parent_scene.should_update_brush()}},t.prototype.draw_image_stamp=function(){var t=this.ctx;if(t){var e=this.actor,i=(0,n.kF)(e,e.position),r=this.actor.rotation,o=this.app.get_app().view,a=o.height,s=o.width;t.save(),t.translate(i.x+s/2,i.y+a/2),t.rotate(r),t.scale(e.scale.x<0?-1:1,e.scale.y<0?-1:1);var _=e.texture.baseTexture.getDrawableSource&&e.texture.baseTexture.getDrawableSource();_&&(t.drawImage(_,Math.floor(-e.width/2),Math.floor(-e.height/2),Math.floor(e.width),Math.floor(e.height)),t.restore(),e.parent_scene.should_update_brush())}},t.prototype.is_empty_brush=function(){var t=this.ctx,e=!0;if(!t)return e;for(var i=this.app.get_app().view,r=i.width,n=i.height,o=t.getImageData(0,0,r,n).data,a=3;a<o.length;a+=4)if(0!==o[a]){e=!1;break}return e},t}(),ft=i(69538),gt=function(){function t(t,e,i){this.cached_bounds_points_vertices={value:void 0,dependencies:[]},this.cached_internal_points_vertices={value:void 0,dependencies:[]},this.actor=t,this.app=e,this.data=i}return t.prototype.get_state_dependencies=function(){return[this.actor.texture,this.actor.position.x,this.actor.position.y,this.actor.scale.x,this.actor.scale.y,this.actor.rotation]},t.prototype.get_cached_bounds_points_vertices=function(){var t;if(this.cached_bounds_points_vertices.value){var e=this.get_state_dependencies();return(0,ft.Z)(e,this.cached_bounds_points_vertices.dependencies)?t=this.cached_bounds_points_vertices.value:this.cached_bounds_points_vertices.value=void 0,t}},t.prototype.get_cached_internal_points_vertices=function(){var t;if(this.cached_internal_points_vertices.value){var e=this.get_state_dependencies();return(0,ft.Z)(e,this.cached_internal_points_vertices.dependencies)?t=this.cached_internal_points_vertices.value:this.cached_internal_points_vertices.value=void 0,t}},t.prototype.set_cached_bounds_points_vertices=function(t){var e=this.get_state_dependencies();this.cached_bounds_points_vertices={value:t,dependencies:e}},t.prototype.set_cached_internal_points_vertices=function(t){var e=this.get_state_dependencies();this.cached_internal_points_vertices={value:t,dependencies:e}},t.prototype.get_vertices=function(t){var e,i=this;return t.forEach((function(t){var r=(0,n.ck)(t),o=(0,n.se)(r,i.actor);e?(e.max_x=Math.max(e.max_x,o.x),e.min_x=Math.min(e.min_x,o.x),e.max_y=Math.max(e.max_y,o.y),e.min_y=Math.min(e.min_y,o.y)):e={max_x:o.x,min_x:o.x,max_y:o.y,min_y:o.y}})),e},t.prototype.check_relation_by_vertices=function(t,e){var i=t.max_x,r=t.min_x,n=t.max_y,o=t.min_y,a=this.app.get_app().renderer,s=a.width/2,_=a.height/2,c=0,u=0,p=0,d=0;switch(e){case"collision":c=i,u=r,p=o,d=n;break;case"overstep":c=r,u=i,p=n,d=o}var l=0;return c>=s&&(l+=nt.su.RIGHT),u<=-s&&(l+=nt.su.LEFT),p<=-_&&(l+=nt.su.TOP),d>=_&&(l+=nt.su.BOTTOM),l},t.prototype.get_texture_bounds_points_vertices=function(){var t=this.get_cached_bounds_points_vertices();if(t)return t;if(this.actor.current_style){var e=this.data.get_texture_bounds_points(this.actor.current_style.texture_id);if(e&&e[0]){var i=this.get_vertices(e);return i&&this.set_cached_bounds_points_vertices(i),i}}},t.prototype.get_texture_internal_points_vertices=function(){var t=this.get_cached_internal_points_vertices();if(t)return t;if(this.actor.current_style){var e=this.data.get_texture_internal_points(this.actor.current_style.texture_id);if(e&&e[0]){var i=this.get_vertices(e);return i&&this.set_cached_internal_points_vertices(i),i}}},t.prototype.contains_edge=function(t,e){return!!((e||15)&t)},t}(),yt=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),mt=function(t){function e(e,i){var r=t.call(this)||this;return r.type=nt.bJ.ActorWrapper,r.actor=e,r.scene=i,r.id=e.get_id(),r.name=e.get_id(),r.addChild(r.actor),r.setParent(r.scene.get_actor_container()),r}return yt(e,t),e.prototype.get_actor=function(){return this.actor},e}(s.W2),vt=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),bt=function(t){function e(e){var i=t.call(this)||this;i.type=nt.LP.Actor,i.rotation_type=nt.MO.ALL,i.rotation_value=0,i.is_vertical_flipped=!1,i.is_horizontal_flipped=!1,i.is_rotation_flipped=!1,i.styles={},i.is_clone=!1,i.min_points_for_collision=5,i.mouse_down_time=0,i.is_draggable=!0,i.has_drag_protection=!1,i.on_resize=function(t){t.target_id===i.app.get_app().stage.name&&(i.hitArea=new lt(i,(function(e){return i.is_touching(new s.E9(e.x-t.data.width/2,e.y-t.data.height/2))})))},i.drag_start=function(t){i.mouse_down_time=(new Date).getTime(),i.events.fire("actor:selected",{target_id:i.id}),i.is_draggable&&(i.drag_data={event_data:t.data,old_pos:t.data.getLocalPosition(i.parent)},i.events.fire("actor:drag_start",{target_id:i.id,data:{position:{x:i.position.x,y:-i.position.y}}}))},i.drag_move=function(){if(i.is_draggable&&i.drag_data){var t=i.drag_data.event_data.getLocalPosition(i.parent),e=i.app.get_app().view,r=e.width,o=e.height;if(t.x<-r/2||t.x>r/2||t.y<-o/2||t.y>o/2)return;var a=new s.E9(i.position.x+t.x-i.drag_data.old_pos.x,i.position.y+t.y-i.drag_data.old_pos.y);if(i.drag_data.old_pos=t,i.has_drag_protection){var _=(0,n.kF)(i,a);a.set((0,ot.Z)(-r/2,r/2,_.x),(0,ot.Z)(-o/2,o/2,_.y))}i.set_pixi_position(a.x,a.y),i.app.render(),i.events.fire("actor:drag_move",{target_id:i.id,data:{position:{x:i.position.x,y:-i.position.y}}}),i.events.fire("actor:update",{target_id:i.id,data:{position:{x:i.position.x,y:-i.position.y}}})}},i.drag_end=function(t){var e=(new Date).getTime();!(t&&(0,y.Z)(t.type,["touchendoutside","mouseupoutside"]))&&e-i.mouse_down_time<1e3&&i.events.fire("actor:click",{target_id:i.id}),i.drag_data&&(i.drag_data=void 0,i.is_draggable&&(i.events.fire("actor:drag_end",{target_id:i.id,data:{position:{x:i.position.x,y:-i.position.y}}}),i.emit_event("change",{position:i.position}),i.app.render()))},i.on_break=function(t){t&&t!==i.id||(i.drag_data=void 0)},i.events=e.events,i.app=e.app,i.data=e.data,i.parent_scene=e.parent_scene,i.id=e.actor_id,i.name=e.actor_id,i.anchor.set(.5,.5),i.interactive=!0,i.wrapper=new mt(i,i.parent_scene);var r=i.app.get_app().view,o=r.width,a=r.height;return i.hitArea=new lt(i,(function(t){return i.is_touching(new s.E9(t.x-o/2,t.y-a/2))})),i.render_texture=new s.TI(new s.jd),i.brush=new ht(i.app,i),i.pixel_detector=new gt(i,i.app,i.data),i.app.get_renderer_type()===s.N3.WEBGL&&(i.effects=new at(i.app,i)),i.addListener("mousedown",i.drag_start),i.addListener("mousemove",(0,n.P2)(i.drag_move,n.VS)),i.addListener("mouseup",i.drag_end),i.addListener("mouseupoutside",i.drag_end),i.addListener("touchstart",i.drag_start),i.addListener("touchmove",(0,n.P2)(i.drag_move,n.VS)),i.addListener("touchend",i.drag_end),i.addListener("touchendoutside",i.drag_end),i.addListener("mousedown",(function(){return i.emit_mouse_event("actor:mousedown")})),i.addListener("mouseup",(function(){return i.emit_mouse_event("actor:mouseup")})),i.addListener("mouseupoutside",(function(){return i.emit_mouse_event("actor:mouseupoutside")})),i.addListener("mouseover",(function(){return i.emit_mouse_event("actor:mouseover")})),i.addListener("mouseout",(function(){return i.emit_mouse_event("actor:mouseout")})),i.addListener("rightclick",(function(){return i.emit_mouse_event("actor:rightclick")})),i.addListener("touchstart",(function(){return i.emit_mouse_event("actor:touchstart")})),i.addListener("touchend",(function(){return i.emit_mouse_event("actor:touchend")})),i.addListener("touchendoutside",(function(){return i.emit_mouse_event("actor:touchendoutside")})),i.add_listener("change",(function(t){t.position&&i.current_rotate_around_actor&&!i.current_rotate_around_actor.is_rotating&&(i.current_rotate_around_actor=void 0)})),i.events.event_emitter.addListener("break",i.on_break),i.events.add_listener("stage:resize",i.on_resize),i}return vt(e,t),e.prototype.emit_event=function(t,e){this.emit(t,e)},e.prototype.add_listener=function(t,e){this.on(t,e)},e.prototype.remove_listener=function(t,e){this.off(t,e)},e.prototype.destroy=function(){this.emit_event("destroy",void 0),this.wrapper.destroy(),t.prototype.destroy.call(this,{children:!0}),this.data.clear_actor_cache(this.id),this.events.event_emitter.removeListener("break",this.on_break),this.events.remove_listener("stage:resize",this.on_resize)},e.prototype.clone=function(t){var i=new e({actor_id:t||"cloned_"+s.P6.uid(),parent_scene:this.parent_scene,app:this.app,data:this.data,events:this.events});return i.styles=(0,O.Z)(this.styles),i.current_style=(0,O.Z)(this.current_style),i.texture=this.texture,i.position.set(this.position.x,this.position.y),i.scale.set(this.scale.x,this.scale.y),i.pivot.set(this.pivot.x,this.pivot.y),i.alpha=this.alpha,i.visible=this.visible,i.rotation=this.rotation,i.rotation_type=this.rotation_type,i.rotation_value=this.rotation_value,i.is_draggable=this.is_draggable,i.has_drag_protection=this.has_drag_protection,i.is_vertical_flipped=this.is_vertical_flipped,i.is_horizontal_flipped=this.is_horizontal_flipped,i.group=this.group,i.is_clone=!0,i.prototype_actor_id=this.id,this.effects&&this.effects.clone_to(i),i},e.prototype.set_pixi_texture=function(t){this.texture=t,this.emit_event("change",{texture:this.texture,width:this.width,height:this.height})},e.prototype.add_style=function(t){this.styles[t.style_id]=(0,O.Z)(t)},e.prototype.get_style=function(t){return(0,O.Z)(this.styles[t])},e.prototype.set_current_style=function(t){var e=this.styles[t];if(!e)return new u("Cannot find style "+t+", You should add style first");var i=this.data.get_texture(e.texture_id);if(!i)return new u("Cannot find texture "+e.texture_id);this.current_style=e,this.set_pixi_texture(i),this.set_pixi_pivot(e.pivot.x,e.pivot.y)},e.prototype.update_texture_of_style=function(t,e){var i=this.styles[t];if(!i)return new u("Cannot find style "+t+", You should add style first");var r=this.data.get_texture(e);if(!r)return new u("Cannot find texture "+e);i.texture_id=e,this.current_style&&t===this.current_style.style_id&&this.set_pixi_texture(r)},e.prototype.update_pivot_of_style=function(t,e){var i=this.styles[t];if(!i)return new u("Cannot find style "+t+", You should add style first");i.pivot=(0,O.Z)(e),this.current_style&&t===this.current_style.style_id&&this.set_pixi_pivot(i.pivot.x,i.pivot.y)},e.prototype.get_current_style=function(){return(0,O.Z)(this.current_style)},e.prototype.get_style_ids=function(){return Object.keys(this.styles)},e.prototype.remove_style=function(t){this.current_style&&t===this.current_style.style_id&&(this.current_style=void 0,this.set_pixi_texture(s.xE.EMPTY),this.set_pixi_pivot(0,0)),delete this.styles[t]},e.prototype.set_z_index=function(t){var e=this.parent_scene.get_actor_container(),i=(0,ot.Z)(0,e.children.length-1,t);e.setChildIndex(this.wrapper,i)},e.prototype.set_position_x=function(t){this.set_pixi_position(t,this.position.y)},e.prototype.set_position_y=function(t){this.set_pixi_position(this.position.x,-t)},e.prototype.set_position=function(t,e){this.set_pixi_position(t,e?-e:e)},e.prototype.set_pixi_position=function(t,e){this.position.set(t,e),this.emit_event("change",{position:this.position})},e.prototype.move_forward=function(t){var e=this.position.x+Math.cos(this.rotation_value)*t,i=-this.position.y+Math.sin(this.rotation_value)*t;this.set_pixi_position(e,-i)},e.prototype.set_pixi_scale=function(t,e){this.scale.set(t,e),this.emit_event("change",{width:this.width,height:this.height,scale:this.scale})},e.prototype.set_scale=function(t,e){var i=t;void 0!==i&&(i=Math.max(0,i),i=this.is_rotation_flipped!==this.is_vertical_flipped?-1*i:i);var r=void 0===e?t:e;void 0!==r&&(r=Math.max(0,r),r=this.is_horizontal_flipped?-1*r:r),this.set_pixi_scale(i,r)},e.prototype.set_alpha=function(t){this.alpha=t,this.emit_event("change",{alpha:this.alpha})},e.prototype.set_visible=function(t){this.visible=t,this.emit_event("change",{visible:this.visible})},e.prototype.set_pixi_rotation=function(t){this.rotation=t,this.emit_event("change",{rotation:this.rotation})},e.prototype.set_rotation_value=function(t){this.rotation_value=t},e.prototype.set_rotation=function(t){var e=(0,n.k4)(t);this.set_rotation_value(e);var i=0,r=!1;switch(this.rotation_type){case nt.MO.ALL:i=-e,r=this.is_rotation_flipped;break;case nt.MO.LEFT_RIGHT:i=0,r=(this.rotation_value>=Math.PI/2||this.rotation_value<-Math.PI/2)!==this.is_rotation_flipped;break;case nt.MO.NONE:i=0,r=this.is_rotation_flipped}this.set_pixi_rotation(i),r&&(this.is_rotation_flipped=!this.is_rotation_flipped,this.set_pixi_scale(-1*this.scale.x,this.scale.y))},e.prototype.set_rotation_type=function(t){this.rotation_type=t,this.set_rotation(this.rotation_value)},e.prototype.set_flipped=function(t){switch(t){case"vertical":return this.set_pixi_scale(-1*this.scale.x,this.scale.y),void(this.is_vertical_flipped=!this.is_vertical_flipped);case"horizontal":return this.set_pixi_scale(this.scale.x,-1*this.scale.y),void(this.is_horizontal_flipped=!this.is_horizontal_flipped)}},e.prototype.set_cursor=function(t){this.cursor=t},e.prototype.set_group=function(t){this.group=t},e.prototype.clear_group=function(){this.group=void 0},e.prototype.set_pivot_by_stage_point=function(t,e){var i=this,r=new s.E9(t,-e);Object.keys(this.styles).forEach((function(t){var e=i.styles[t],n=i.map_local_point_to_pivot(r,new s.E9(e.pivot.x,e.pivot.y));e.pivot.x=n.x,e.pivot.y=n.y}));var n=this.current_style?this.current_style.pivot:this.map_local_point_to_pivot(r,this.pivot);this.set_pixi_position(t,-e),this.set_pixi_pivot(n.x,n.y)},e.prototype.reset_pivot=function(){var t=this;Object.keys(this.styles).forEach((function(e){var i=t.styles[e];i.pivot.x=0,i.pivot.y=0}));var e=(0,n.kF)(this,this.position);this.set_pixi_position(e.x,e.y),this.set_pixi_pivot(0)},e.prototype.map_local_point_to_pivot=function(t,e){var i=new s.E9(this.position.x-e.x*this.scale.x,this.position.y-e.y*this.scale.y),r=(0,n.r6)(t,this.position,-this.rotation),o=r.x-i.x,a=r.y-i.y;return new s.E9(o/this.scale.x,a/this.scale.y)},e.prototype.set_pixi_pivot=function(t,e){this.pivot.set(t,e),this.emit_event("change",{pivot:this.pivot})},e.prototype.get_position=function(){return{x:this.position.x,y:-this.position.y}},e.prototype.get_center_position=function(){var t=(0,n.kF)(this,this.position);return{x:t.x,y:-t.y}},e.prototype.get_width=function(){return this.width},e.prototype.get_height=function(){return this.height},e.prototype.get_scale=function(){return{x:Math.abs(this.scale.x),y:Math.abs(this.scale.y)}},e.prototype.get_alpha=function(){return this.alpha},e.prototype.get_visible=function(){return this.visible},e.prototype.get_rotation=function(){return this.rotation_value},e.prototype.get_rotation_type=function(){return this.rotation_type},e.prototype.get_pixi_rotation=function(){return this.rotation},e.prototype.get_vertical_flipped=function(){return this.is_vertical_flipped},e.prototype.get_horizontal_flipped=function(){return this.is_horizontal_flipped},e.prototype.get_pivot=function(){return{x:this.pivot.x,y:this.pivot.y}},e.prototype.get_group=function(){return this.group},e.prototype.get_z_index=function(){return this.parent_scene.get_actor_container().getChildIndex(this.wrapper)},e.prototype.get_parent_scene=function(){return this.parent_scene},e.prototype.get_brush=function(){return this.brush},e.prototype.get_is_clone=function(){return this.is_clone},e.prototype.get_prototype_actor_id=function(){return this.prototype_actor_id},e.prototype.get_effects=function(){return this.effects?c.success(this.effects):c.error("Effect not available. It needs support of WebGL.")},e.prototype.set_draggable=function(t){this.is_draggable=t},e.prototype.get_draggable=function(){return this.is_draggable},e.prototype.is_dragging=function(){return!!this.drag_data},e.prototype.set_drag_protection=function(t){this.has_drag_protection=t},e.prototype.check_bumped=function(t){var e=this.data.get_internal_actor(t);return e?c.success(this.check_bumped_other(e)):c.error("Cannot find actor "+t)},e.prototype.hit_test=function(t,e){return this.is_touching(new s.E9(t,-e))},e.prototype.get_bounds_LTRB=function(){var t=this.get_vertices();return{left:t.min_x,top:-t.min_y,right:t.max_x,bottom:-t.max_y}},e.prototype.check_bumped_other=function(t){if(!this.visible||!t.get_visible())return!1;if(this.has_left_stage()||t.has_left_stage())return!1;if(this.parent_scene.id!==t.parent_scene.id)return!1;var e=this.get_vertices(),i=t.get_vertices();if(!(e.min_x<i.max_x&&e.max_x>i.min_x&&e.min_y<i.max_y&&e.max_y>i.min_y))return!1;for(var r={left:Math.round(Math.max(e.min_x,i.min_x)),right:Math.round(Math.min(e.max_x,i.max_x)),top:Math.round(Math.min(e.max_y,i.max_y)),bottom:Math.round(Math.max(e.min_y,i.min_y))},n=new s.E9(0,0),o=0,a=r.left;a<r.right;a+=2){n.x=a;for(var _=r.top;_>r.bottom;_-=2){if(n.y=_,this.is_touching(n)&&t.is_touching(n)&&(o++,this.is_tiny_sprite(this)||this.is_tiny_sprite(t)))return!0;if(o===this.min_points_for_collision)return!0}}return!1},e.prototype.check_bumped_color=function(t){return c.success(this.bumped_color(t))},e.prototype.bumped_color=function(t){if(this.has_left_stage()||!this.current_style)return!1;var e=this.get_bounds_in_stage();if(0===e.width||0===e.height)return!1;var i=this.data.get_texture_points_position(this.current_style.texture_id);return!(!i||0===i.length)&&this.color_match_texture_points(e,i,t)},e.prototype.color_match_texture_points=function(t,e,i){var r=this.app.get_app().view,o=r.width,a=r.height,_=(0,n.$1)({width:t.width,height:t.height}),c=this.get_visible();this.visible=!1;var u=(0,n.uD)(t,{width:o,height:a});this.render_texture.resize(_.width,_.height,!0),this.app.get_app().renderer.render(this.app.get_app().stage,{renderTexture:this.render_texture,transform:u});var p=this.app.get_extract_module().pixels(this.render_texture);this.visible=c;for(var d=(0,n.UQ)(i),l=void 0,h=0;h<e.length;h++){var f=(0,n.ck)(e[h]),g=(0,n.se)(f,this),y=(0,n.OX)(new s.E9(g.x-t.x,g.y-t.y)),m=Math.floor(y.x),v=Math.floor(y.y);if(!(m>=_.width||v>=_.height)&&(l=4*m+v*_.width*4,this.color_match(d,p,l)))return!0}return!1},e.prototype.color_match=function(t,e,i){return void 0!==e[i]&&void 0!==e[i+1]&&void 0!==e[i+2]&&((248&t[0])===(248&e[i])&&(248&t[1])===(248&e[i+1])&&(240&t[2])===(240&e[i+2]))},e.prototype.get_bounds_in_stage=function(){var t=this.get_vertices(),e=this.app.get_app().view,i=e.width,r=e.height,n={left:(0,ot.Z)(-i/2,i/2,t.min_x-5),right:(0,ot.Z)(-i/2,i/2,t.max_x+5),top:(0,ot.Z)(-r/2,r/2,t.min_y-5),bottom:(0,ot.Z)(-r/2,r/2,t.max_y+5)};return{x:Math.round(n.left),y:Math.round(n.top),width:Math.abs(Math.floor(n.right-n.left)),height:Math.abs(Math.floor(n.bottom-n.top))}},e.prototype.check_relation_with_edge=function(t,e){var i=this.get_vertices(),r=this.pixel_detector.check_relation_by_vertices(i,t),n=this.pixel_detector.contains_edge(r,e);switch(t){case"collision":if(!n)return!1;break;case"overstep":if(n)return!0}var o=this.pixel_detector.get_texture_bounds_points_vertices();if(!o)return!1;var a=this.pixel_detector.check_relation_by_vertices(o,t),s=this.pixel_detector.contains_edge(a,e);switch(t){case"collision":if(s)return!0;break;case"overstep":if(!s)return!1}var _=this.pixel_detector.get_texture_internal_points_vertices();if(!_)return!1;var c=this.pixel_detector.check_relation_by_vertices(_,t);return this.pixel_detector.contains_edge(c,e)},e.prototype.bounce_if_collision_with_edge=function(){var t=this.get_vertices();if(this.pixel_detector.check_relation_by_vertices(t,"collision")){var e=this.pixel_detector.get_texture_internal_points_vertices();if(e){var i=this.pixel_detector.check_relation_by_vertices(e,"collision");if(i){var r=this.app.get_app().renderer,o=r.width,a=r.height,s=o/2,_=a/2,c=Math.cos(this.rotation_value),u=Math.sin(this.rotation_value),p=[];this.pixel_detector.contains_edge(i,nt.su.RIGHT)&&(c=-Math.abs(c),p.push(nt.su.RIGHT)),this.pixel_detector.contains_edge(i,nt.su.LEFT)&&(c=Math.abs(c),p.push(nt.su.LEFT)),this.pixel_detector.contains_edge(i,nt.su.TOP)&&(u=-Math.abs(u),p.push(nt.su.TOP)),this.pixel_detector.contains_edge(i,nt.su.BOTTOM)&&(u=Math.abs(u),p.push(nt.su.BOTTOM));var d=Math.atan2(u,c),l=this.rotation_value-d,h=0,f=0,g=e;if(l%(2*Math.PI)!==0){if(0!==this.pivot.x&&0!==this.pivot.y){var y=(0,n.kF)(this,this.position),m=(0,n.r6)(this.position,y,l);this.set_pixi_position(m.x,m.y)}this.set_rotation(d);var v=this.pixel_detector.get_texture_internal_points_vertices();g=v||g}p.forEach((function(t){switch(t){case nt.su.RIGHT:h=s-(g.max_x+10);break;case nt.su.LEFT:h=-s-(g.min_x-10);break;case nt.su.TOP:f=-_-(g.min_y-10);break;case nt.su.BOTTOM:f=_-(g.max_y+10)}})),this.set_pixi_position(this.position.x+h,this.position.y+f)}}}},e.prototype.get_id=function(){return this.id},e.prototype.emit_mouse_event=function(t){this.events.fire(t,{target_id:this.id})},e.prototype.is_touching=function(t){if(!this.current_style)return!1;var e=this.data.get_texture_points_color_data(this.current_style.texture_id);if(!e)return!1;var i=(0,n.Ri)(t,this),r=(0,n.$1)({width:this.texture.width,height:this.texture.height}),o=(0,n.OX)(i);return!(o.x>r.width||o.y>r.height||o.x<0||o.y<0)&&e[o.y*r.width+o.x]>>>24>0},e.prototype.get_vertices=function(){var t=this.app.get_app().view,e=t.width/2,i=t.height/2,r=this.getBounds();return{max_x:r.x+r.width-e,min_x:r.x-e,max_y:r.y+r.height-i,min_y:r.y-i}},e.prototype.has_left_stage=function(){var t=this.getBounds(),e=this.app.get_app().view,i=e.width,r=e.height,n=t.y+t.height,o=r-t.y,a=t.x+t.width,s=i-t.x;return n<=0||o<=0||a<=0||s<=0},e.prototype.is_tiny_sprite=function(t){return t.width*t.height<2*this.min_points_for_collision},e.prototype.rotate_around_actor=function(t,e){var i,r=this.data.get_internal_actor(t);if(!r)return new u("Cannot find actor "+t);if(this.current_rotate_around_actor&&this.current_rotate_around_actor.actor_id===t||(this.current_rotate_around_actor={actor_id:t,offset:new s.E9(this.get_position().x-r.get_position().x,this.get_position().y-r.get_position().y),is_rotating:!0}),this.current_rotate_around_actor.is_rotating=!0,this.id===(null===(i=r.current_rotate_around_actor)||void 0===i?void 0:i.actor_id)){var o=(0,n.r6)(this.get_position(),r.get_position(),e),a=o.x,_=o.y;this.set_position(a,_)}else this.current_rotate_around_actor.offset=(0,n.r6)(this.current_rotate_around_actor.offset,{x:0,y:0},e),this.set_position(this.current_rotate_around_actor.offset.x+r.get_position().x,this.current_rotate_around_actor.offset.y+r.get_position().y);this.set_rotation(this.get_rotation()+e),this.current_rotate_around_actor.is_rotating=!1},e}(s.jy),wt=function(){function t(t,e,i){this.app=t,this.data=e,this.actor=i}return t.prototype.load_actor=function(t){var e=t.actor_id,i=t.parent_scene_id,r=t.position,n=t.scale,o=t.rotation_type,a=t.rotation,s=t.visible,_=t.group;if(this.data.get_internal_actor(e))return c.error("Actor "+e+" already exists. Please use new actor id");var u=this.data.get_internal_scene(i);if(!u)return c.error("Scene "+i+" should be loaded before loading actor "+e);var p=this.actor({actor_id:e,parent_scene:u,app:this.app,data:this.data});return r&&(p.set_position_x(r.x),p.set_position_y(r.y)),n&&p.set_scale(n.x,n.y),void 0!==a&&p.set_rotation(a),void 0!==o&&p.set_rotation_type(o),void 0!==s&&p.set_visible(s),void 0!==_&&p.set_group(_),c.success(p)},t.prototype.destroy_actor=function(t){var e=this.data.get_internal_actor(t);if(!e)return new u("Cannot find actor "+t);e.destroy()},t.prototype.destroy_all_actors=function(){var t=this;this.app.get_scene_container().children.forEach((function(e){(0,n.Jf)(e)&&e.get_actor_ids().forEach((function(e){var i=t.data.get_internal_actor(e);i&&i.destroy()}))})),this.data.clear_all_actors_cache()},t.prototype.get_actor_ids=function(t){var e=[];return this.app.get_scene_container().children.forEach((function(i){(0,n.Jf)(i)&&(e=e.concat(i.get_actor_ids(t)))})),e},t.prototype.get_actor=function(t){var e=this.data.get_internal_actor(t);return e?c.success(e):c.error("Cannot find actor "+t)},t}(),xt=function(t,e,i,r){var n,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},kt=function(t,e){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(t,e)},Ot=function(t,e){return function(i,r){e(i,r,t)}},Et=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},It=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},Tt=function(){function t(t,e,i,r,n,o,a,s){this.app=t,this.data=e(t),this.textures=i(this.data),this.scenes=r(t,this.data),this.actors=n(t,this.data),this.stage_animation=o(this.data),this.physics=a(t,this.data),this.events=s}return t.prototype.init=function(t){this.app.init(t)},t.prototype.render=function(){this.app.render()},t.prototype.start_rendering=function(){this.app.get_app().ticker.start()},t.prototype.stop_rendering=function(){this.app.get_app().ticker.stop()},t.prototype.get_view=function(){return this.app.get_app().view},t.prototype.get_screenshot=function(t){return Et(this,void 0,void 0,(function(){var e=this;return It(this,(function(i){return[2,new Promise((function(i,r){e.app.get_screenshot(t).then(i).catch(r)}))]}))}))},t.prototype.extract_pixels=function(t,e,i,r){var n=this.get_view(),o=n.width,a=n.height,_=new s.TI(new s.jd({width:o,height:a}));if(this.app.get_app().renderer.render(this.app.get_app().stage,{renderTexture:_}),this.app.get_renderer_type()===s.N3.WEBGL)return _.frame=this.get_render_texture_frame(t,e,i,r),this.app.get_extract_module().pixels(_);var c=this.app.get_extract_module().canvas(_).getContext("2d");return c?c.getImageData(t,e,i,r).data:void 0},t.prototype.extract_canvas=function(t,e,i,r){var n=this.get_view(),o=n.width,a=n.height,_=new s.TI(new s.jd({width:o,height:a}));return this.app.get_app().renderer.render(this.app.get_app().stage,{renderTexture:_}),_.frame=this.get_render_texture_frame(t,e,i,r),this.app.get_extract_module().canvas(_)},t.prototype.get_render_texture_frame=function(t,e,i,r){var n=this.get_view(),o=n.width,a=n.height;return t=(0,ot.Z)(0,o-1,t),i=(0,ot.Z)(1,o-t,i),e=(0,ot.Z)(0,a-1,e),r=(0,ot.Z)(1,a-e,r),new s.Ae(t,e,i,r)},t.prototype.resize=function(t,e){this.app.resize(t,e)},t.prototype.set_background_color=function(t){this.app.get_app().renderer.backgroundColor=t},t.prototype.set_background_alpha=function(t){this.app.get_app().renderer.backgroundAlpha=t},t.prototype.add_rendering_update_listener=function(t){this.app.get_app().ticker.add(t)},t.prototype.remove_rendering_update_listener=function(t){this.app.get_app().ticker.remove(t)},t.prototype.destroy=function(){this.data.clear_all_actors_cache(),this.data.clear_all_scenes_cache(),this.data.clear_all_sprite_sheet_cache(),this.data.clear_all_textures_points_cache(),this.app.destroy()},t=xt([(0,o.b2)(),Ot(0,(0,o.f3)(_.App)),Ot(1,(0,o.f3)(_.Data)),Ot(2,(0,o.f3)(_.Textures)),Ot(3,(0,o.f3)(_.Scenes)),Ot(4,(0,o.f3)(_.Actors)),Ot(5,(0,o.f3)(_.StageAnimation)),Ot(6,(0,o.f3)(_.Physics)),Ot(7,(0,o.f3)(_.Events)),kt("design:paramtypes",[Object,Function,Function,Function,Function,Function,Function,Object])],t)}(),Nt=function(){return Nt=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},Nt.apply(this,arguments)},St=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},At=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},Ct=function(t,e){var i={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(i[r]=t[r]);if(null!=t&&"function"===typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(t);n<r.length;n++)e.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(t,r[n])&&(i[r[n]]=t[r[n]])}return i},Mt=function(t,e){var i="function"===typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a},Pt=function(){function t(t){this.data=t}return t.prototype.init=function(){return St(this,void 0,void 0,(function(){var t,e;return At(this,(function(r){switch(r.label){case 0:return!this.cmao_gsap?(t=this,[4,i.e(4142).then(i.bind(i,59507))]):[3,2];case 1:t.cmao_gsap=r.sent(),r.label=2;case 2:return!this.cmao_custom_ease?(e=this,[4,i.e(4142).then(i.bind(i,9287))]):[3,4];case 3:e.cmao_custom_ease=r.sent(),r.label=4;case 4:return this.cmao_gsap&&this.cmao_custom_ease&&this.cmao_gsap.gsap.registerPlugin(this.cmao_custom_ease.CustomEase),[2]}}))}))},t.prototype.create_ease_function=function(t,e){if(this.cmao_custom_ease)return this.cmao_custom_ease.CustomEase.create(t,e)},t.prototype.compose_timeline=function(t,e,i){var r=this;if(this.cmao_gsap&&this.data.get_internal_actor(t)){var n,o,a;i&&(n=i.on_start,o=i.on_update,a=i.on_complete);var s=new this.cmao_gsap.TimelineLite({onStart:n,onUpdate:o,onComplete:a});return e.forEach((function(e){var i=e.tween_opt,n=e.timeline_pos,o=r.compose_tween(t,i);o&&s.add(o,n)})),s}},t.prototype.compose_tween=function(t,e){var i=this.data.get_internal_actor(t);if(this.cmao_gsap&&i){var r,n;switch(e.variation_type){case nt.M5.TO:n=this.manufacture_tween_vars(i,[e.tween_vars]),r=this.cmao_gsap.TweenLite.to(n.target,n.vars[0]);break;case nt.M5.FROM:n=this.manufacture_tween_vars(i,[e.tween_vars]),r=this.cmao_gsap.TweenLite.from(n.target,n.vars[0]);break;case nt.M5.FROM_TO:n=this.manufacture_tween_vars(i,[e.tween_vars.from,e.tween_vars.to]),r=this.cmao_gsap.TweenLite.fromTo(n.target,n.vars[0],n.vars[1])}return i.on("destroy",(function(){return r.kill()})),r}},t.prototype.manufacture_tween_vars=function(e,i){var r=this,n={},o=[],a=Object.keys(t.HOOK_FACTORY);return i.forEach((function(i){var s=i.on_start,_=i.on_update,c=i.on_complete,u=Ct(i,["on_start","on_update","on_complete"]),p=(0,O.Z)(u),d=Math.random().toString();p.id=d;var l=!1;if(r.cmao_gsap){var h=r.cmao_gsap,f=[],g=[],m={},v=Object.keys(u);a.forEach((function(i){if((0,y.Z)(i,v)){"undefined"===typeof n[i]&&(n[i]=0);var r=Mt(t.HOOK_FACTORY[i](e,n),3),o=r[0],a=r[1],s=r[2];f.push(o),g.push(a),s&&(m[i]=s)}})),f.push((function(){l=!0;var t=h.gsap.getById(d);t&&t.invalidate()})),s&&f.push(s),_&&g.push(_),o.push(Nt(Nt({},p),{modifiers:m,onStart:function(){f.forEach((function(t){return t()}))},onUpdate:function(){l&&g.forEach((function(t){return t()}))},onComplete:c}))}})),{target:n,vars:o}},t.HOOK_FACTORY={position_x:function(t,e){return[function(){e.position_x=t.position.x},function(){var i=t.position.y;t.set_pixi_position(e.position_x,i)}]},position_y:function(t,e){return[function(){e.position_y=-t.position.y},function(){var i=t.position.x;t.set_pixi_position(i,-e.position_y)}]},scale_x:function(t,e){return[function(){e.scale_x=t.scale.x},function(){var i=t.scale.y;t.set_pixi_scale(e.scale_x,i)}]},scale_y:function(t,e){return[function(){e.scale_y=t.scale.y},function(){var i=t.scale.x;t.set_pixi_scale(i,e.scale_y)}]},rotation:function(t,e){return[function(){e.rotation=t.rotation_value},function(){t.set_rotation(e.rotation)},function(t){return(0,n.k4)(t)}]},pixi_rotation:function(t,e){return[function(){e.pixi_rotation=t.rotation},function(){t.set_pixi_rotation(e.pixi_rotation)},function(t){return(0,n.k4)(t)}]},alpha:function(t,e){return[function(){e.alpha=t.alpha},function(){t.set_alpha(e.alpha)}]}},t}(),Rt=i(4001),Bt=i(21392),jt=i(53273),Dt=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),Lt=function(){function t(t,e,i,r,n,o){if(this.app=t,this.data=e,this.box2d=i,this.scene_world=r,this.actor=n,this.get_strength=o,this.type=Rt.O.ELASTIC,this.position_cache=new this.box2d.Vec2,this.particle_system=this.scene_world.world.m_particleSystemList,this.start_rotation=this.actor.rotation,!this.particle_system)throw Error("Trying to init elastic body before particle system initialized. ")}return t.get_max_anchors=function(){if(this._max_anchors)return this._max_anchors;var t=document.createElement("canvas").getContext("webgl");if(!t)throw Error("[Elastic Body]: WebGL not supported");var e=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),i=Math.floor(e/5);return this._max_anchors=Math.floor((i-1)/2),this._max_anchors},t.prototype.set_enabled=function(t){var e;if(t&&!this.particle_group){var i=(0,n.kF)(this.actor,this.actor.position);this.init({x:(0,Bt.Gl)(i.x),y:(0,Bt.Gl)(i.y)},null===(e=this.actor.current_style)||void 0===e?void 0:e.texture_id)}else!t&&this.particle_group&&this.clear()},t.prototype.set_dynamic=function(){},t.prototype.set_fixed_rotation=function(t){},t.prototype.set_sensor=function(t){},t.prototype.set_mass=function(t){},t.prototype.get_linear_velocity=function(){if(this.particle_group){var t=this.particle_group.GetLinearVelocity();return new this.box2d.Vec2(t.x,-t.y)}return this.box2d.Vec2_zero},t.prototype.set_linear_velocity=function(t,e){if(this.particle_group)for(var i=this.particle_group.m_firstIndex;i<this.particle_group.m_lastIndex;i++)this.particle_system.m_velocityBuffer.data[i].Set(t,-e)},t.prototype.get_particle_group_rotation=function(){if(!this.particle_group)return 0;if(!this.particle_group_start_rotation)return this.particle_group.GetAngle();var t=this.particle_system.m_positionBuffer.data[this.particle_group.m_firstIndex],e=this.particle_group.GetAnchorPosition(),i=new this.box2d.Vec2;return this.box2d.Vec2.SubVV(t,e,i),i.SelfNormalize(),this.box2d.Atan2(i.y,i.x)-this.box2d.Atan2(this.particle_group_start_rotation.y,this.particle_group_start_rotation.x)},t.prototype.get_rotation=function(){return this.particle_group?this.start_rotation+this.get_particle_group_rotation():this.start_rotation},t.prototype.set_rotation=function(t){if(this.particle_group)for(var e=t-this.get_rotation(),i=this.get_position(),r=this.particle_group.m_firstIndex;r<this.particle_group.m_lastIndex;r++){var o=(0,n.r6)(this.particle_system.m_positionBuffer.data[r],i,e);this.particle_system.m_positionBuffer.data[r]=new this.box2d.Vec2(o.x,o.y)}else this.start_rotation=t},t.prototype.get_position=function(){if(!this.particle_group||!this.particle_group_anchor_offset)return this.position_cache;var t=this.particle_group.GetAnchorPosition(),e=this.get_particle_group_rotation(),i=(0,n.r6)(this.particle_group_anchor_offset,{x:0,y:0},e);return new this.box2d.Vec2(t.x-i.x,t.y-i.y)},t.prototype.set_position=function(t){if(this.particle_group)for(var e=this.get_position(),i=t.x-e.x,r=t.y-e.y,n=this.particle_group.m_firstIndex;n<this.particle_group.m_lastIndex;n++)this.particle_system.m_positionBuffer.data[n].SelfAddXY(i,r)},t.prototype.scale_points=function(t,e,i){if(!i){for(var r=1/0,n=1/0,o=-1/0,a=-1/0,s=0;s<t.length;s++)r=Math.min(r,t[s].x),n=Math.min(n,t[s].y),o=Math.max(o,t[s].x),a=Math.max(a,t[s].y);i={x:(o+r)/2,y:(a+n)/2}}var _=[];for(s=0;s<t.length;s++){var c={x:t[s].x,y:t[s].y},u=c.x-i.x;c.x=u>0?Math.ceil(u*e+i.x)+1:Math.floor(u*e+i.x)-1;var p=c.y-i.y;c.y=p>0?Math.ceil(p*e+i.y)+1:Math.floor(p*e+i.y)-1,_.push(c)}return _},t.prototype.init=function(t,e){if(e){var i=this.generate_position_data(e);if(i){this.clear();var r=i.points,n=i.triangles,o=new this.box2d.ParticleGroupDef;o.positionData=r,o.flags=this.box2d.ParticleFlag.b2_elasticParticle|this.box2d.ParticleFlag.b2_waterParticle|this.box2d.ParticleFlag.b2_particleContactListenerParticle|this.box2d.ParticleFlag.b2_particleContactFilterParticle|this.box2d.ParticleFlag.b2_fixtureContactListenerParticle|this.box2d.ParticleFlag.b2_fixtureContactFilterParticle,o.groupFlags=this.box2d.ParticleGroupFlag.b2_solidParticleGroup,o.color.SetRGBA(255,255,255,.5),o.strength=this.get_strength(),o.position.Set(t.x,t.y),o.angle=this.actor.rotation,o.id=this.actor.id,this.particle_group=this.particle_system.CreateParticleGroup(o),this.start_rotation=this.actor.rotation;var a=this.particle_group.GetAnchorPosition();this.particle_group_anchor_offset=new this.box2d.Vec2,this.box2d.Vec2.SubVV(a,t,this.particle_group_anchor_offset);var s=this.particle_system.m_positionBuffer.data[this.particle_group.m_firstIndex];this.particle_group_start_rotation=new this.box2d.Vec2,this.box2d.Vec2.SubVV(s,a,this.particle_group_start_rotation),this.particle_group_start_rotation.SelfNormalize();var _=this.particle_group.GetParticleCount(),c=this.particle_group.m_firstIndex;if(!n.length)for(var u=0;u<this.particle_system.GetTriadCount();u++){var p=this.particle_system.GetTriads()[u],d=p.indexA,l=p.indexB,h=p.indexC;this.particle_group.ContainsParticle(d)&&this.particle_group.ContainsParticle(l)&&this.particle_group.ContainsParticle(h)&&n.push([d-c,h-c,l-c])}this.soft_filter=new jt.S({max_num_anchors:_,triangles:n}),this.soft_filter.enabled=!0,this.filters_cache=this.actor.filters,this.actor.filters=[this.soft_filter]}}},t.prototype.clear=function(){this.position_cache=this.get_position(),this.particle_group&&(this.particle_group.DestroyParticles(!1),this.particle_system.DestroyParticleGroup(this.particle_group),this.particle_group=void 0,this.particle_group_anchor_offset=void 0,this.particle_group_start_rotation=void 0,this.soft_filter=void 0,this.actor.filters=this.filters_cache||[],this.filters_cache=void 0)},t.prototype.destroy=function(){this.clear()},t.prototype.on_tick=function(){if(this.soft_filter&&this.particle_group){for(var t=this.get_particle_group_rotation(),e=[],i=this.particle_group.GetAnchorPosition(),r=0;r<this.particle_group.GetParticleCount();r++){var o=this.particle_group.relativePositions[r],a={x:i.x+o.x,y:i.y+o.y};a=(0,n.r6)(a,i,t);var s=this.particle_system.m_positionBuffer.data[r+this.particle_group.m_firstIndex];e.push([this.map_physics_coord_to_pixi(a),this.map_physics_coord_to_pixi(s)])}var _=this.app.get_app().view,c=_.width,u=_.height;this.soft_filter.set_anchors(e,c,u)}},t.prototype.apply_force=function(t){var e;null===(e=this.particle_group)||void 0===e||e.ApplyForce(t)},t.prototype.generate_position_data=function(e){var i=this,r=this.data.get_texture(e),o=this.data.get_texture_bounds_points(e);if(o&&r){var a=this.actor.get_scale(),_=this.particle_system.GetRadius()*Math.SQRT2,c=(0,Bt.Gl)(r.width*a.x),u=(0,Bt.Gl)(r.height*a.y),p=Math.sqrt(Math.pow(c+_,2)+Math.pow(u+_,2))/Math.sqrt(Math.pow(c,2)+Math.pow(u,2)),d=this.scale_points(o,p).map((function(t){var e=(0,n.ck)(new s.E9(t.x,t.y));return new s.E9((0,Bt.Gl)((e.x-r.width/2)*i.actor.scale.x),(0,Bt.Gl)((e.y-r.height/2)*i.actor.scale.y))})),l=[];d&&E(d,l);var h=new this.box2d.ParticleSystem_CompositeShape(l.map((function(t){var e=new i.box2d.PolygonShape;return e.Set(t),e}))),f=[],g=new Set,y=this.particle_system.GetParticleStride(),m=c*u,v=.5*t.get_max_anchors(),b=Math.max(Math.ceil(Math.sqrt(m/v)/y),1),w=this.box2d.Transform.IDENTITY,x=new this.box2d.AABB;for(h.ComputeAABB(x,w,0);!g.size;){for(var k=0,O=Math.floor(x.lowerBound.y/y)*y;O<x.upperBound.y;O+=y){g.size>0&&k++;for(var I=k%b===0||O+y>=x.upperBound.y,T=!1,N=Math.floor(x.lowerBound.x/y)*y,S=0;N<x.upperBound.x;){T&&S++;var A=S%b===0,C=new this.box2d.Vec2(N,O),M=f.length;h.TestPoint(w,C)&&(T||(N+=y/2,C.Set(N,O)),I&&A&&g.add(M),f.push(C),T=!0),T?N+=y:N++}I&&T&&g.add(f.length-1)}g.size>v&&(b++,f.length=0,g.clear())}for(var P=f.length,R=t.get_max_anchors()-v,B=Math.floor(d.length/R),j=new Set;g.size<t.get_max_anchors();){for(var D=function(t){var e=d[t];f.every((function(t){return i.box2d.Vec2.DistanceVV(t,e)>=i.particle_system.GetRadius()}))&&(j.add(f.length),f.push(new L.box2d.Vec2(e.x,e.y)))},L=this,G=0;G<d.length;G+=B)D(G);if(g.size+j.size<=t.get_max_anchors())break;f.length=P,j.clear(),B++}if(g.size===f.length)return{points:f,triangles:[]};var F=[],U=new this.box2d.VoronoiDiagram(g.size+j.size);return g.forEach((function(t){U.AddGenerator(f[t],t,!0)})),j.forEach((function(t){U.AddGenerator(f[t],t,!0)})),U.Generate(y/2,2*y),U.GetNodes((function(t,e,i){F.push([t,e,i])})),{points:f,triangles:F}}},t.prototype.map_physics_coord_to_pixi=function(t){var e=(0,Bt.RQ)(t.x),i=(0,Bt.RQ)(t.y),r=this.app.get_app().view;return{x:e+r.width/2,y:i+r.height/2}},t.prototype.get_dragged_body=function(t){var e=this,i=new this.box2d.CircleShape;i.m_p.Copy(t),i.m_radius=2*this.particle_system.GetRadius();var r=new this.box2d.BodyDef;r.type=this.box2d.BodyType.b2_dynamicBody,r.position.Copy(t),r.id="ParticleJoint",r.fixedRotation=!1;var n=this.scene_world.world.CreateBody(r),o=new this.box2d.MassData,a=[],s=new this.box2d.AABB;i.ComputeAABB(s,this.box2d.Transform.IDENTITY,0);var _=function(t){function e(e){var i=t.call(this)||this;return i.ReportParticle=e,i}return Dt(e,t),e.prototype.ReportFixture=function(t){return!1},e}(this.box2d.QueryCallback);this.scene_world.world.QueryAABB(new _((function(i,r){return a.push({index:r,offset:e.box2d.Vec2.SubVV(i.m_positionBuffer.data[r],t,new e.box2d.Vec2)}),!0})),s);for(var c=0;c<a.length;c++)o.mass=this.particle_system.m_groupBuffer[a[c].index].GetMass();return n.SetMassData(o),this.update_callback&&this.scene_world.update_callbacks.has(this.update_callback)&&this.scene_world.update_callbacks.delete(this.update_callback),this.update_callback=function(){var t=n.GetLinearVelocity(),i=n.GetPosition();a.forEach((function(r){var n=r.index,o=r.offset;e.particle_system.GetVelocityBuffer()[n].Copy(t);var a=e.box2d.Vec2.AddVV(i,o,new e.box2d.Vec2);e.particle_system.m_positionConstraintBuffer[n]=[a,a]}))},this.scene_world.update_callbacks.add(this.update_callback),n},t.prototype.on_end_drag=function(){this.update_callback&&(this.scene_world.update_callbacks.delete(this.update_callback),this.update_callback=void 0)},t.prototype.refilter=function(){},t}(),Gt=function(){function t(t,e,i,r,n,o,a){this.data=t,this.box2d=e,this.scene_world=i,this.actor=r,this.type=Rt.O.NORMAL;var s=new this.box2d.BodyDef;s.type=this.box2d.BodyType.b2_staticBody,s.enabled=!1,s.fixedRotation=!0,s.id=this.actor.id,this.body=this.scene_world.world.CreateBody(s),this.fixture_def=new this.box2d.FixtureDef,this.fixture_def.density=n||Bt.I1,this.fixture_def.friction=o||Bt.V9,this.fixture_def.restitution=a||Bt.QB}return t.prototype.set_enabled=function(t){this.body.SetEnabled(t)},t.prototype.set_dynamic=function(t){this.body.SetType(t?this.box2d.BodyType.b2_dynamicBody:this.box2d.BodyType.b2_staticBody)},t.prototype.set_fixed_rotation=function(t){this.body.SetFixedRotation(t)},t.prototype.set_sensor=function(t){var e=this.body.GetFixtureList();if(t!==(null===e||void 0===e?void 0:e.IsSensor()))for(;e;)e.SetSensor(t),e=e.m_next},t.prototype.set_mass=function(t){var e=this.get_mass();0===e&&(e=1),this.set_density(this.get_density()*t/e)},t.prototype.get_mass=function(){return this.body.GetMass()},t.prototype.set_density=function(t){this.set_physics_property(0,t),this.body.ResetMassData(),this.fixture_def.density=t},t.prototype.get_density=function(){var t=this.body.GetFixtureList();return t?t.GetDensity():0},t.prototype.set_friction=function(t){this.set_physics_property(1,t)},t.prototype.get_friction=function(){var t=this.body.GetFixtureList();return t?t.GetFriction():0},t.prototype.set_restitution=function(t){this.set_physics_property(2,t)},t.prototype.get_restitution=function(){var t=this.body.GetFixtureList();return t?t.GetRestitution():0},t.prototype.get_linear_velocity=function(){var t=this.body.GetLinearVelocity(),e=t.x,i=t.y;return new this.box2d.Vec2(e,-i)},t.prototype.set_linear_velocity=function(t,e){this.body.SetLinearVelocity(new this.box2d.Vec2(t,-e))},t.prototype.get_rotation=function(){return this.body.GetAngle()},t.prototype.set_rotation=function(t){this.body.SetAngle(t),this.body.SetAwake(!0)},t.prototype.get_position=function(){return this.body.GetPosition()},t.prototype.set_position=function(t){this.body.SetPosition(t),this.body.SetAwake(!0)},t.prototype.init=function(t,e){for(var i=this.body.GetFixtureList();i;)this.body.DestroyFixture(i),i=this.body.GetFixtureList();this.body.SetPositionXY(t.x,t.y),this.body.SetAngle(this.actor.rotation),e&&this.create_fixture(e)},t.prototype.destroy=function(){this.scene_world.world.DestroyBody(this.body)},t.prototype.on_tick=function(){},t.prototype.apply_force=function(t){this.body.ApplyForceToCenter(t,!0)},t.prototype.create_fixture=function(t){var e=this;if(this.body&&t){var i=this.data.get_texture_convex_groups(t),r=this.data.get_texture(t);i&&r&&i.forEach((function(t){var i,o=new e.box2d.PolygonShape,a=[];t.forEach((function(t){var i=(0,n.ck)(t);a.push(new e.box2d.Vec2((0,Bt.Gl)(i.x-r.width/2)*e.actor.scale.x,(0,Bt.Gl)(i.y-r.height/2)*e.actor.scale.y))})),o.Set(a),e.fixture_def.shape=o,null===(i=e.body)||void 0===i||i.CreateFixture(e.fixture_def)}))}},t.prototype.set_physics_property=function(t,e){for(var i=this.body.GetFixtureList();i;){switch(t){case 0:i.SetDensity(e);break;case 1:i.SetFriction(e);break;case 2:i.SetRestitution(e);break;default:return}i=i.m_next}},t.prototype.refilter=function(){for(var t=this.body.GetFixtureList();t;)t.Refilter(),t=t.m_next},t.prototype.get_dragged_body=function(){return this.body},t.prototype.on_end_drag=function(){},t}(),Ft=function(){function t(t,e,i,r,o){var a,_=this;this.app=t,this.data=e,this.box2d=i,this.scene_world=r,this.force_handler_cache=new Set,this.collision_filter=new Set,this.bodies_cache=[],this.should_recreate_body=!1,this.on_actor_change=function(t){var e;if(t.texture||t.scale||t.pivot){if(!_.is_enabled())return void(_.should_recreate_body=!0);_.physics_body.init(_.convert_pixi_to_physics_position(_.actor.position),null===(e=_.actor.get_current_style())||void 0===e?void 0:e.texture_id)}},this.on_actor_destroy=function(){return _.destroy()},this.set_strength=function(t){_.group_strength=t;var e=_.bodies_cache[Rt.O.ELASTIC];(null===e||void 0===e?void 0:e.particle_group)&&(e.particle_group.m_strength=_.group_strength)},this.get_strength=function(){return _.group_strength},this.physics_set_pixi_position=function(t,e){if(!_.actor.is_dragging()||!_.is_enabled()){var i=_.convert_pixi_to_physics_position(new s.E9(t,e));_.bodies_cache.forEach((function(t){return t.set_position(i)})),_.fork_set_pixi_position(t,e)}},this.physics_set_pixi_rotation=function(t){_.bodies_cache.forEach((function(e){return e.set_rotation(t)})),_.fork_set_pixi_rotation(t)},this.handler=function(){if(_.is_enabled()){var t=_.physics_body.get_rotation(),e=_.physics_body.get_position(),i=e.x,r=e.y,n=_.convert_physics_to_pixi_position(i,r,t);_.fork_set_pixi_rotation(t),_.fork_set_pixi_position(n.x,n.y),_.actor.set_rotation_value(_.convert_to_rotation_value(t))}_.update_body_state(),_.physics_body.on_tick(),_.force_handler_cache.size&&_.force_handler_cache.forEach((function(t){return t()}))},this.drag_start=function(t){if((_.collidable||_.forceable)&&_.actor.get_draggable()){_.mouse_joint&&_.scene_world.world.DestroyJoint(_.mouse_joint);var e=t.data.getLocalPosition(_.actor.parent),i={x:(0,Bt.Gl)(e.x),y:(0,Bt.Gl)(e.y)},r=_.physics_body.get_dragged_body(i),n=new _.box2d.MouseJointDef;n.bodyA=_.mouse_joint_dummy_body,n.bodyB=r,n.target.Set(i.x,i.y),n.maxForce=Bt.Xg*r.m_mass,n.stiffness=Bt.iu,n.damping=Bt.RA,_.mouse_joint=_.scene_world.world.CreateJoint(n),r.SetAwake(!0)}},this.drag_move=(0,n.P2)((function(t){if((_.collidable||_.forceable)&&_.actor.is_dragging()&&_.mouse_joint){var e=_.app.get_app().view,i=e.width,r=e.height,o=t.data.getLocalPosition(_.actor.parent);if((0,n.yZ)(o,{width:i,height:r})){var a={x:(0,Bt.Gl)(o.x),y:(0,Bt.Gl)(o.y)};_.mouse_joint.GetTarget().Set(a.x,a.y),_.mouse_joint.GetBodyB().SetAwake(!0)}}}),n.VS),this.drag_end=function(){(_.collidable||_.forceable)&&_.mouse_joint&&(_.scene_world.world.DestroyJoint(_.mouse_joint),_.mouse_joint=void 0,_.physics_body.on_end_drag())},this.on_destroy=o.on_destroy,this.actor=o.actor,this.actor_id=o.actor.id,this.mouse_joint_dummy_body=o.mouse_joint_dummy_body,this.collidable=o.collidable,this.forceable=o.forceable,this.elastic=o.elastic,this.group_strength=o.strength||1;var c=o.density,u=o.friction,p=o.restitution;this.physics_body=this.get_normal_body(c,u,p),this.elastic&&(this.physics_body=this.get_elastic_body());var d=null===(a=this.actor.get_current_style())||void 0===a?void 0:a.texture_id,l=this.convert_pixi_to_physics_position(this.actor.position);this.bodies_cache.forEach((function(t){return t.init(l,d)})),this.update_body_state(),this.app.get_app().ticker.add(this.handler),this.fork_set_pixi_position=this.actor.set_pixi_position.bind(this.actor),this.actor.set_pixi_position=this.physics_set_pixi_position.bind(this),this.fork_set_pixi_rotation=this.actor.set_pixi_rotation.bind(this.actor),this.actor.set_pixi_rotation=this.physics_set_pixi_rotation.bind(this),this.actor.add_listener("change",this.on_actor_change),this.actor.add_listener("destroy",this.on_actor_destroy),this.actor.addListener("mousedown",this.drag_start),this.actor.addListener("mousemove",this.drag_move),this.actor.addListener("mouseup",this.drag_end),this.actor.addListener("mouseupoutside",this.drag_end),this.actor.addListener("touchstart",this.drag_start),this.actor.addListener("touchmove",this.drag_move),this.actor.addListener("touchend",this.drag_end),this.actor.addListener("touchendoutside",this.drag_end)}return t.prototype.update_body_state=function(){var t,e=this.is_enabled();if(this.physics_body.set_enabled(e),e){this.should_recreate_body&&(this.physics_body.init(this.convert_pixi_to_physics_position(this.actor.position),null===(t=this.actor.get_current_style())||void 0===t?void 0:t.texture_id),this.should_recreate_body=!1),this.physics_body.set_dynamic(this.forceable);var i=this.forceable&&!this.collidable;this.physics_body.set_sensor(i)}},t.prototype.get_elastic_body=function(){if(this.bodies_cache[Rt.O.ELASTIC])return this.bodies_cache[Rt.O.ELASTIC];var t=new Lt(this.app,this.data,this.box2d,this.scene_world,this.actor,this.get_strength);return this.bodies_cache[Rt.O.ELASTIC]=t,t},t.prototype.get_normal_body=function(t,e,i){if(this.bodies_cache[Rt.O.NORMAL])return this.bodies_cache[Rt.O.NORMAL];var r=new Gt(this.data,this.box2d,this.scene_world,this.actor,t,e,i);return this.bodies_cache[Rt.O.NORMAL]=r,r},t.prototype.convert_pixi_to_physics_position=function(t){var e=(0,n.kF)(this.actor,t);return{x:(0,Bt.Gl)(e.x),y:(0,Bt.Gl)(e.y)}},t.prototype.convert_physics_to_pixi_position=function(t,e,i){var r={x:(0,Bt.RQ)(t),y:(0,Bt.RQ)(e)},o={x:r.x+this.actor.pivot.x*this.actor.scale.x,y:r.y+this.actor.pivot.y*this.actor.scale.y};return(0,n.r6)(o,r,i)},t.prototype.add_ids_to_collision_filter=function(t){var e=this;if(0!==t.length){var i=!1;t.forEach((function(t){e.collision_filter.has(t)||(e.collision_filter.add(t),!i&&(i=!0))})),i&&this.physics_body.refilter()}},t.prototype.remove_ids_from_collision_filter=function(t){var e=this;t.forEach((function(t){e.collision_filter.has(t)&&e.collision_filter.delete(t)}))},t.prototype.prevent_collision_with_actors=function(t){this.add_ids_to_collision_filter(t)},t.prototype.prevent_collision_with_edges=function(t){var e=[];t.forEach((function(t){e.push(t.toString())})),this.add_ids_to_collision_filter(e)},t.prototype.enable_collision_with_actors=function(t){this.remove_ids_from_collision_filter(t)},t.prototype.enable_collision_with_edges=function(t){var e=[];t.forEach((function(t){e.push(t.toString())})),this.remove_ids_from_collision_filter(e)},t.prototype.set_collidable=function(t){this.collidable=t},t.prototype.set_forceable=function(t){this.forceable=t},t.prototype.is_enabled=function(){return this.actor.visible&&(this.collidable||this.forceable)},t.prototype.is_dynamic=function(){return this.forceable},t.prototype.set_fixed_rotation=function(t){this.bodies_cache.forEach((function(e){return e.set_fixed_rotation(t)}))},t.prototype.get_collision_filter=function(){return this.collision_filter},t.prototype.set_mass=function(t){this.get_normal_body().set_mass(t)},t.prototype.get_mass=function(){return this.get_normal_body().get_mass()},t.prototype.set_density=function(t){this.get_normal_body().set_density(t)},t.prototype.get_density=function(){return this.get_normal_body().get_density()},t.prototype.set_friction=function(t){this.get_normal_body().set_friction(t)},t.prototype.get_friction=function(){return this.get_normal_body().get_friction()},t.prototype.set_restitution=function(t){this.get_normal_body().set_restitution(t)},t.prototype.get_restitution=function(){return this.get_normal_body().get_restitution()},t.prototype.set_elastic=function(t){var e;if(t!==this.elastic){var i=this.physics_body.get_rotation(),r=this.physics_body.get_position(),n=this.physics_body.get_linear_velocity(),o=this.is_enabled();this.physics_body.set_enabled(!1),this.physics_body=t?this.get_elastic_body():this.get_normal_body(),this.physics_body.type===Rt.O.NORMAL&&this.physics_body.init(this.convert_pixi_to_physics_position(this.actor.position),null===(e=this.actor.get_current_style())||void 0===e?void 0:e.texture_id),this.physics_body.set_enabled(o),this.physics_body.set_rotation(i),this.physics_body.set_position(r),this.physics_body.set_linear_velocity(n.x,n.y),this.elastic=t}},t.prototype.get_linear_velocity=function(){return this.physics_body.get_linear_velocity()},t.prototype.set_linear_velocity=function(t,e){this.physics_body.set_linear_velocity(t,e)},t.prototype.apply_force=function(t,e){var i=new this.box2d.Vec2(t,-e);this.physics_body.apply_force(i)},t.prototype.apply_force_in_time=function(t){var e=this,i=t.time,r=t.x,n=t.y,o=t.on_complete,a=Math.round(i/Bt.BK),s=1;this.force_handler_cache.add((function t(){if(s>a)return e.force_handler_cache.delete(t),void o();e.apply_force(r,n),s++}))},t.prototype.destroy=function(){this.app.get_app().ticker.remove(this.handler),this.actor.removeListener("mousedown",this.drag_start),this.actor.removeListener("mousemove",this.drag_move),this.actor.removeListener("mouseup",this.drag_end),this.actor.removeListener("mouseupoutside",this.drag_end),this.actor.removeListener("touchstart",this.drag_start),this.actor.removeListener("touchmove",this.drag_move),this.actor.removeListener("touchend",this.drag_end),this.actor.removeListener("touchendoutside",this.drag_end),this.actor.remove_listener("change",this.on_actor_change),this.actor.remove_listener("destroy",this.on_actor_destroy),this.mouse_joint&&this.scene_world.world.DestroyJoint(this.mouse_joint),this.bodies_cache.forEach((function(t){return t.destroy()})),this.actor.set_pixi_position=this.fork_set_pixi_position,this.actor.set_pixi_rotation=this.fork_set_pixi_rotation,this.on_destroy()},t.prototype.convert_to_rotation_value=function(t){var e=(0,n.k4)(-t);return this.actor.is_rotation_flipped?(0,n.k4)(e+Math.PI):e},t.prototype.get_velocity_direction=function(){var t=this.physics_body.get_linear_velocity();return(0,n.OI)(Math.atan2(t.y,t.x))},t.prototype.get_current_physics_body=function(){return this.physics_body},t}(),Ut=function(t){var e="function"===typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"===typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},Vt=function(){function t(t,e,i,r,n){var o=this;this.app=t,this.data=e,this.scene=i,this.box2d=r,this.body_list=new Map,this.collision_list=new Set,this.edge_list=new Map,this.update_callbacks=new Set,this.update=function(){o.world.Step(Bt.BK,Bt.pg,Bt.yC),o.update_callbacks.forEach((function(t){return t()}))},this.on_scene_destroy=function(){return o.destroy()},this.world=new r.World(new r.Vec2(0,n||Bt.TN));var a=new this.box2d.ParticleSystemDef;a.radius=1.2,this.world.CreateParticleSystem(a);var s=new r.ContactListener,_=function(t,e){if(t&&e&&t!==e){var i=(0,Bt.bB)(t,e),r=(0,Bt.bB)(e,t);o.collision_list.add(i),o.collision_list.add(r)}};s.BeginContact=function(t){return _(t.GetFixtureA().GetBody().GetId(),t.GetFixtureB().GetBody().GetId())},s.BeginContactBodyParticleGroup=function(t,e){var i;return _(e.body.GetId(),(null===(i=t.m_groupBuffer[e.index])||void 0===i?void 0:i.id)||"")},s.BeginContactParticleGroupParticleGroup=function(t,e){var i,r;return _((null===(i=t.m_groupBuffer[e.GetIndexA()])||void 0===i?void 0:i.id)||"",(null===(r=t.m_groupBuffer[e.GetIndexB()])||void 0===r?void 0:r.id)||"")};var c=function(t,e){if(t&&e&&t!==e){var i=(0,Bt.bB)(t,e),r=(0,Bt.bB)(e,t);o.collision_list.delete(i),o.collision_list.delete(r)}};s.EndContact=function(t){return c(t.GetFixtureA().GetBody().GetId(),t.GetFixtureB().GetBody().GetId())},s.EndContactBodyParticleGroup=function(t,e){var i;return c(e.body.GetId(),(null===(i=t.m_groupBuffer[e.index])||void 0===i?void 0:i.id)||"")},s.EndContactParticleGroupParticleGroup=function(t,e){var i,r;return c((null===(i=t.m_groupBuffer[e.GetIndexA()])||void 0===i?void 0:i.id)||"",(null===(r=t.m_groupBuffer[e.GetIndexB()])||void 0===r?void 0:r.id)||"")};var u=function(t,e){var i=o.body_list.get(t),r=o.body_list.get(e);return!(null===i||void 0===i?void 0:i.get_collision_filter().has(e))&&!(null===r||void 0===r?void 0:r.get_collision_filter().has(t))},p=new r.ContactFilter;p.ShouldCollide=function(t,e){return u(t.GetBody().GetId(),e.GetBody().GetId())},p.ShouldCollideFixtureParticle=function(t,e,i){var r;return u(t.GetBody().GetId(),(null===(r=e.m_groupBuffer[i])||void 0===r?void 0:r.id)||"")},p.ShouldCollideParticleParticle=function(t,e,i){var r,n;return u((null===(r=t.m_groupBuffer[e])||void 0===r?void 0:r.id)||"",(null===(n=t.m_groupBuffer[i])||void 0===n?void 0:n.id)||"")},this.world.SetContactListener(s),this.world.SetContactFilter(p),this.scene.add_listener("destroy",this.on_scene_destroy),this.mouse_joint_dummy_body=this.world.CreateBody(),this.app.get_app().ticker.add(this.update)}return t.prototype.create_body=function(t){var e=this,i=this.data.get_internal_actor(t.actor_id);if(i){var r=t.density,n=t.friction,o=t.restitution,a=t.strength,s=new Ft(this.app,this.data,this.box2d,this,{on_destroy:function(){e.body_list.delete(t.actor_id)},actor:i,mouse_joint_dummy_body:this.mouse_joint_dummy_body,collidable:!!t.collidable,forceable:!!t.forceable,elastic:!!t.elastic,density:r,friction:n,restitution:o,strength:a});return this.body_list.set(t.actor_id,s),s}},t.prototype.create_edges=function(t){var e,i;if(0!==t.length){var r=this.app.get_app().view,n=r.width,o=r.height,a=(0,Bt.Gl)(n)/2,s=(0,Bt.Gl)(o)/2;try{for(var _=Ut(t),c=_.next();!c.done;c=_.next()){var u=c.value;if(!this.edge_list.get(u)){var p=0,d=0;switch(u){case nt.su.TOP:d=-s-Bt.Ly;break;case nt.su.BOTTOM:d=s+Bt.Ly;break;case nt.su.LEFT:p=-a-Bt.Ly;break;case nt.su.RIGHT:p=a+Bt.Ly;break;default:return}var l=this.world.CreateBody({id:u.toString()}),h=new this.box2d.PolygonShape;h.SetAsBox(Bt.Ly,Bt.Ly),l.CreateFixture(h,Bt.K9),l.SetPositionXY(p,d),this.edge_list.set(u,l)}}}catch(f){e={error:f}}finally{try{c&&!c.done&&(i=_.return)&&i.call(_)}finally{if(e)throw e.error}}}},t.prototype.destroy_edges=function(t){var e,i;if(0!==t.length&&0!==this.edge_list.size)try{for(var r=Ut(t),n=r.next();!n.done;n=r.next()){var o=n.value,a=this.edge_list.get(o);a&&(a.GetWorld().DestroyBody(a),this.edge_list.delete(o))}}catch(s){e={error:s}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}},t.prototype.destroy_body=function(t){var e=this.body_list.get(t);e&&e.destroy()},t.prototype.destroy=function(){this.app.get_app().ticker.remove(this.update),this.scene.remove_listener("destroy",this.on_scene_destroy),this.body_list.forEach((function(t){t.destroy()})),this.edge_list.forEach((function(t){t.GetWorld().DestroyBody(t)})),this.body_list.clear(),this.edge_list.clear(),this.collision_list.clear()},t.prototype.get_body=function(t){return this.body_list.get(t)},t.prototype.set_gravity=function(t,e){this.world.SetGravity(new this.box2d.Vec2(t,-e))},t.prototype.check_bumped=function(t,e){var i=this.data.get_internal_actor(t),r=this.data.get_internal_actor(e);if(!i||i.has_left_stage()||!r||r.has_left_stage())return!1;var n=this.get_body(t),o=this.get_body(e);if(!n||!n.is_enabled()||!o||!o.is_enabled())return!1;var a=(0,Bt.bB)(t,e),s=(0,Bt.bB)(e,t);return this.collision_list.has(a)||this.collision_list.has(s)},t.prototype.check_collision_with_edge=function(t,e){var i,r,n=this.data.get_internal_actor(t);if(!n||n.has_left_stage())return!1;var o=this.get_body(t);if(!o||!o.is_enabled())return!1;var a=e?[e]:[nt.su.TOP,nt.su.BOTTOM,nt.su.LEFT,nt.su.RIGHT];try{for(var s=Ut(a),_=s.next();!_.done;_=s.next()){var c=_.value,u=this.edge_list.get(c);if(u){var p=u.GetId(),d=(0,Bt.bB)(t,p),l=(0,Bt.bB)(p,t);if(this.collision_list.has(d)||this.collision_list.has(l))return!0}}}catch(h){i={error:h}}finally{try{_&&!_.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return!1},t}(),zt=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},Ht=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},qt=function(t){var e="function"===typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"===typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},Wt=function(){function t(t,e){this.app=t,this.data=e,this.world_list=new Map}return t.prototype.init=function(t){var e;return zt(this,void 0,void 0,(function(){var r,n,o,a,s,_,c=this;return Ht(this,(function(u){switch(u.label){case 0:return this.box2d?[3,2]:(r=this,[4,i.e(8358).then(i.bind(i,28358))]);case 1:r.box2d=u.sent(),u.label=2;case 2:return!t||this.debug_draw?[3,4]:(n=this.app.get_app().view).parentElement?((o=document.createElement("canvas")).width=n.width,o.height=n.height,o.style.width=n.style.width,o.style.height=n.style.height,o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.pointerEvents="none",n.parentElement.appendChild(o),[4,Promise.all([i.e(8358),i.e(7494)]).then(i.bind(i,97494))]):[2];case 3:a=u.sent().DebugDraw,this.debug_draw=new a(o),s=this.box2d.DrawFlags,_=s.e_none,_|=s.e_shapeBit,_|=s.e_particleBit,null===(e=this.debug_draw)||void 0===e||e.SetFlags(_),this.draw_handler=function(t){var e,i,r;null===(i=null===(e=c.debug_draw)||void 0===e?void 0:e.m_ctx)||void 0===i||i.clearRect(0,0,o.width,o.height),t&&(null===(r=c.latest_world)||void 0===r||r.world.DebugDraw())},u.label=4;case 4:return[2]}}))}))},t.prototype.create_world=function(t,e){var i=this.data.get_internal_scene(t);if(this.box2d&&i){var r=new Vt(this.app,this.data,i,this.box2d,e);return this.debug_draw&&(r.world.SetDebugDraw(this.debug_draw),0===this.world_list.size&&this.draw_handler&&this.app.get_app().ticker.add(this.draw_handler)),this.world_list.set(t,r),this.latest_world=r,r}},t.prototype.destroy_world=function(t){var e,i=this.world_list.get(t);if(!i)return new u("Can not find world with id "+t);this.world_list.delete(t),i.destroy(),this.latest_world===i&&(this.latest_world=void 0),this.draw_handler&&0===this.world_list.size&&(this.app.get_app().ticker.remove(this.draw_handler),null===(e=this.draw_handler)||void 0===e||e.call(this,0))},t.prototype.destroy_all_worlds=function(){var t,e;try{for(var i=qt(this.world_list.keys()),r=i.next();!r.done;r=i.next()){var n=r.value;this.destroy_world(n)}}catch(o){t={error:o}}finally{try{r&&!r.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}},t.prototype.get_world=function(t){var e=this.world_list.get(t);return this.latest_world=e||this.latest_world,e},t}(),Kt=new o.W2;Kt.bind(_.Events).to(z).inSingletonScope(),Kt.bind(_.App).to(g),Kt.bind(_.Data).toFactory((function(){return function(t){return new U(t)}})),Kt.bind(_.Textures).toFactory((function(){return function(t){return new Q(t)}})),Kt.bind(_.Transition).toFactory((function(){return function(t){return new rt(t)}})),Kt.bind(_.StageAnimation).toFactory((function(){return function(t){return new Pt(t)}})),Kt.bind(_.Physics).toFactory((function(){return function(t,e){return new Wt(t,e)}})),Kt.bind(_.Scene).toFactory((function(t){var e=t.container.get(_.Events);return function(t,i,r,n,o){return new pt(t,i,r,n,o,e)}})),Kt.bind(_.Scenes).toFactory((function(t){var e=t.container.get(_.Events),i=t.container.get(_.Transition),r=t.container.get(_.Scene);return function(t,n){return new dt(t,n,i,r,e)}})),Kt.bind(_.Actor).toFactory((function(t){return function(e){var i=t.container.get(_.Events),r=Object.assign({},e,{events:i});return new bt(r)}})),Kt.bind(_.Actors).toFactory((function(t){var e=t.container.get(_.Actor);return function(t,i){return new wt(t,i,e)}})),Kt.bind(_.Stage).to(Tt);var Xt=function(){function t(){this.loader=s.aN.shared,this.tasks=[],this.is_loading=!1}return t.prototype.add=function(t){this.tasks.push(t),this.is_loading||this.execute()},t.prototype.get_resources=function(){return this.loader.resources},t.prototype.execute=function(){var t=this;this.is_loading=!0;var e=this.tasks.shift();if(e){var i=this.loader.resources[e.url];if(i)return e.on_success&&e.on_success(i),void this.execute();this.loader.add(e.url).load((function(i,r){var n=r[e.url];if(!n||n.error){var o=n?n.error:new Error("No available resource.");e.on_error&&e.on_error(o),n&&delete r[e.url]}n&&!n.error&&e.on_success&&e.on_success(n),t.execute()}))}else this.is_loading=!1},t}(),Yt=function(){function t(t,e){var i=this;this.on_actor_destroy=function(){return i.hide()},this.on_actor_change=function(t){},this.app=t,this.data=e,this.actor_editor=new s.W2,this.actor_editor.interactive=!0,this.actor_editor.visible=!1,this.app.get_app().stage.addChild(this.actor_editor)}return t.prototype.destroy=function(){this.hide(),this.actor_editor.destroy({children:!0,texture:!0,baseTexture:!0})},t.prototype.set_target_actor=function(t){var e=this.data.get_internal_actor(t);if(!e)return new u("Cannot find actor "+t);this.actor!==e&&(this.get_displayed()&&this.hide(),this.actor=e,this.actor_editor.name=this.actor.get_id(),this.actor_editor.visible=this.actor.get_visible(),this.draw_editor(this.actor),this.actor.add_listener("change",this.on_actor_change),this.actor.add_listener("destroy",this.on_actor_destroy),this.app.render())},t.prototype.hide=function(){this.actor&&(this.actor.remove_listener("change",this.on_actor_change),this.actor.remove_listener("destroy",this.on_actor_destroy),this.actor=void 0,this.actor_editor.name="",this.actor_editor.visible=!1,this.app.render())},t.prototype.get_displayed=function(){return!!this.actor},t.prototype.get_hit_target=function(t){var e=this.app.get_interaction_manager().hitTest(t.data.global,this.app.get_scene_container());if((0,n.YH)(e)){var i=this.data.get_internal_actor(e.id);if(i)return this.set_target_actor(i.id),i}if(this.actor_editor.name)return this.data.get_internal_actor(this.actor_editor.name)},t.prototype.check_mouse_pos_is_in_stage=function(t){var e=t.data.getLocalPosition(this.app.get_app().stage),i=this.app.get_app().view,r=i.width,n=i.height;return!(e.x>r/2||e.x<-r/2||e.y>n/2||e.y<-n/2)},t}(),Jt=i(2173),Zt=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();var Qt=s.tq.any||!!/CTHarmonyNext/i.test(navigator.userAgent),$t=function(t){function e(e,i,r,o,a){var _=t.call(this,i,r)||this;return _.old_scale=new s.E9,_.old_mouse_r=0,_.is_dragging_scale_btn=!1,_.is_dragging_rotate_btn=!1,_.is_touching_remove_btn=!1,_.old_mouse_rotation=0,_.old_position=new s.E9,_.old_rotate_center_pos=new s.E9,_.on_actor_change=function(t){_.actor&&(void 0!==t.visible&&(_.actor_editor.visible=t.visible),t.position&&_.update_editor_position(_.actor),(void 0!==t.rotation||t.scale||t.pivot||t.texture)&&_.draw_editor(_.actor))},_.cancel_cursor_when_hover=function(){_.is_dragging_rotate_btn||_.is_dragging_scale_btn||(_.cursor_scale.visible||_.cursor_rotate.visible||_.cursor_remove)&&(_.app.get_app().stage.cursor="default",_.cursor_remove=!1,_.cursor_scale.visible=!1,_.cursor_rotate.visible=!1,_.app.render())},_.set_cursor_when_hover=function(t){if(!Qt&&!_.is_dragging_rotate_btn&&!_.is_dragging_scale_btn){if(t.target&&(t.target.name===Jt.dL.ROTATE_BTN||t.target.name===Jt.dL.SCALE_BTN||t.target.name===Jt.dL.REMOVE_BTN)){var e=t.data.getLocalPosition(_.hover_container);switch(t.target.name){case Jt.dL.ROTATE_BTN:return _.app.get_app().stage.cursor="none",_.cursor_rotate.visible=!0,_.cursor_rotate.position.set(e.x,e.y),void _.app.render();case Jt.dL.SCALE_BTN:return _.app.get_app().stage.cursor="none",_.cursor_scale.visible=!0,_.cursor_scale.position.set(e.x,e.y),void _.app.render();case Jt.dL.REMOVE_BTN:return _.cursor_remove=!0,void(_.app.get_app().stage.cursor="pointer");default:return}}_.cancel_cursor_when_hover()}},_.drag_start_scale_btn=function(t){_.is_dragging_scale_btn=!0;var e=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);if(e){var i=(0,n.kF)(e,e.position);_.old_mouse_r=Math.hypot(t.x-i.x,t.y-i.y),_.old_scale.set(e.scale.x,e.scale.y),_.events.fire("editor_scale_btn:drag_start",{target_id:e.id})}},_.drag_move_scale_btn=function(t){var e=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);if(e){var i=Math.hypot(e.width/e.scale.x/2,e.height/e.scale.y/2),r=(0,n.kF)(e,e.position),o=(Math.hypot(t.x-r.x,t.y-r.y)-_.old_mouse_r)/i,a=function(t){var e=Math.max(Math.abs(t)+o,.01);return t<0?-e:e},c=a(_.old_scale.x),u=a(_.old_scale.y),p=new s.E9(e.pivot.x/e.scale.x*c,e.pivot.y/e.scale.y*u),d=_.app.get_app().stage.toLocal(p,e);e.set_pixi_position(d.x,d.y),e.set_pixi_scale(c,u),_.events.fire("actor:update",{target_id:e.id,data:{scale:e.get_scale()}}),_.events.fire("editor_scale_btn:drag_move",{target_id:e.id}),_.app.render()}},_.drag_start_rotate_btn=function(t){_.is_dragging_rotate_btn=!0;var e=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);if(e){var i=_.app.get_app().stage.toLocal(new s.E9(0,0),e);_.old_rotate_center_pos.set(i.x,i.y);var r=t.data.getLocalPosition(_.app.get_app().stage);_.old_mouse_rotation=(0,n.g3)(r.x-i.x,r.y-i.y),_.old_position.set(e.position.x,e.position.y),_.events.fire("editor_rotate_btn:drag_start",{target_id:e.id})}},_.drag_move_rotate_btn=function(t){var e=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);if(e){var i=(0,n.g3)(t.x-_.old_rotate_center_pos.x,t.y-_.old_rotate_center_pos.y),r=i-_.old_mouse_rotation;_.old_mouse_rotation=i;var o=(0,n.r6)(_.old_position,_.old_rotate_center_pos,r);_.old_position.set(o.x,o.y),e.set_pixi_position(o.x,o.y);var a=(0,n.k4)(-e.rotation-r),s=e.is_rotation_flipped?(0,n.k4)(a+Math.PI):a;e.set_rotation_value(s),e.set_pixi_rotation(-a),_.events.fire("actor:update",{target_id:e.id,data:{rotation:e.rotation_value}}),_.events.fire("editor_rotate_btn:drag_move",{target_id:e.id}),_.app.render()}},_.drag_end_rotate_btn=function(t){_.is_dragging_rotate_btn=!1;var e=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);e&&(e.set_rotation(e.rotation_value),_.events.fire("actor:update",{target_id:e.id,data:{rotation:e.rotation_value}}),_.events.fire("editor_rotate_btn:drag_end",{target_id:e.id}),_.app.render())},_.drag_start=function(t){var e=t.data.getLocalPosition(_.app.get_app().stage),i=t.data.getLocalPosition(_.hover_container);switch(t.target.name){case Jt.dL.SCALE_BTN:return _.set_btn_drag_start_status("cursor_scale",i),void _.drag_start_scale_btn(e);case Jt.dL.ROTATE_BTN:return _.set_btn_drag_start_status("cursor_rotate",i),void _.drag_start_rotate_btn(t);case Jt.dL.REMOVE_BTN:return}if(Qt&&_.actor_editor.name){var r=_.data.get_internal_actor(_.actor_editor.name);if(!r)return;var n=_.get_hit_target(t);n&&n.id!==r.id&&r.get_z_index()<n.get_z_index()?n.drag_start(t):r.drag_start(t)}else{var o=_.get_hit_target(t);o&&o.drag_start(t)}},_.drag_move=function(t){if(_.check_mouse_pos_is_in_stage(t)){var e=t.data.getLocalPosition(_.app.get_app().stage),i=t.data.getLocalPosition(_.hover_container);if(_.is_dragging_scale_btn)return _.cursor_scale.position.set(i.x,i.y),void _.drag_move_scale_btn(e);if(_.is_dragging_rotate_btn)return _.cursor_rotate.position.set(i.x,i.y),void _.drag_move_rotate_btn(e);var r=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);r&&r.drag_move()}},_.drag_end=function(t){var e=_.actor_editor.name&&_.data.get_internal_actor(_.actor_editor.name);if(e)return _.is_dragging_scale_btn?(_.is_dragging_scale_btn=!1,_.set_btn_drag_end_status("cursor_scale",t),_.events.fire("actor:update",{target_id:e.id,data:{scale:e.get_scale()}}),_.events.fire("editor_scale_btn:drag_end",{target_id:e.id}),void _.app.render()):_.is_dragging_rotate_btn?(_.set_btn_drag_end_status("cursor_rotate",t),void _.drag_end_rotate_btn(t)):void e.drag_end(t)},_.emit_remove_btn_event=function(t){switch(t.type){case"mousedown":case"touchstart":return void(_.is_touching_remove_btn=!0);case"mouseup":case"touchend":return void(_.is_touching_remove_btn&&(_.is_touching_remove_btn=!1,_.actor_editor.name&&_.events.fire("editor_remove_btn:click",{target_id:_.actor_editor.name})));case"mouseupoutside":case"touchendoutside":return void(_.is_touching_remove_btn=!1)}},_.on_break=function(t){var e;t&&t!==(null===(e=_.actor)||void 0===e?void 0:e.id)||(_.is_dragging_rotate_btn&&_.set_btn_drag_end_status("cursor_rotate"),_.is_dragging_scale_btn&&_.set_btn_drag_end_status("cursor_scale"),_.is_dragging_scale_btn=!1,_.is_dragging_rotate_btn=!1)},_.events=o,_.loader=a,_.MOVE_CURSOR=e.cursor_url,_.editor_box=new s.TC,_.editor_box.name=Jt.dL.EDITOR_BOX,e.cursor_url&&(_.editor_box.cursor="url("+_.MOVE_CURSOR+") 12 12, auto"),_.editor_box.interactive=!0,_.editor_box.setParent(_.actor_editor),_.scale_btn=s.jy.from(e.scale_btn_img),_.scale_btn.name=Jt.dL.SCALE_BTN,_.scale_btn.anchor.set(.5),_.scale_btn.interactive=!0,_.scale_btn.setParent(_.actor_editor),_.rotate_btn=s.jy.from(e.rotate_btn_img),_.rotate_btn.name=Jt.dL.ROTATE_BTN,_.rotate_btn.anchor.set(.5),_.rotate_btn.interactive=!0,_.rotate_btn.setParent(_.actor_editor),_.remove_btn=s.jy.from(e.remove_btn_img),_.remove_btn.name=Jt.dL.REMOVE_BTN,_.remove_btn.anchor.set(.5),_.remove_btn.interactive=!0,_.remove_btn.setParent(_.actor_editor),_.rotation_centre=new s.TC,_.rotation_centre.name=Jt.dL.ROTATION_CENTRE,_.rotation_centre.setParent(_.actor_editor),_.hide_text=new s.xv("\u5df2\u9690\u85cf",{fontFamily:"NotoSansCJKsc-Medium",fontSize:14,fontWeight:"500",fill:16777215,align:"center"}),_.hide_text.name=Jt.dL.HIDE_TEXT,_.hide_text.setParent(_.actor_editor),_.hide_text.visible=!1,_.actor_editor.filters=[new s.pt({rotation:0,distance:0,blur:3,alpha:.3})],_.hover_container=new s.W2,_.actor_editor.addChild(_.hover_container),_.cursor_scale=new s.jy,_.cursor_scale.anchor.set(.5),_.cursor_scale.scale.set(1.5,1.5),_.cursor_scale.visible=!1,_.hover_container.addChild(_.cursor_scale),_.cursor_rotate=new s.jy,_.cursor_rotate.anchor.set(.5),_.cursor_rotate.scale.set(1.5,1.5),_.cursor_rotate.visible=!1,_.hover_container.addChild(_.cursor_rotate),_.cursor_remove=!1,_.loader.add({url:e.texture_url,on_success:function(t){var i=t.textures;if(i){var r=e.texture_name,n=r.cursor_rotate,o=r.cursor_scale;_.cursor_scale.texture=i[o],_.cursor_rotate.texture=i[n],_.app.render()}}}),_.actor_editor.on("mousedown",_.drag_start),_.actor_editor.on("mousemove",(0,n.P2)(_.drag_move,16)),_.actor_editor.on("mouseup",_.drag_end),_.actor_editor.on("mouseupoutside",_.drag_end),_.actor_editor.on("mousemove",_.set_cursor_when_hover),_.actor_editor.on("mouseout",_.cancel_cursor_when_hover),_.actor_editor.on("touchstart",_.drag_start),_.actor_editor.on("touchmove",(0,n.P2)(_.drag_move,16)),_.actor_editor.on("touchend",_.drag_end),_.actor_editor.on("touchendoutside",_.drag_end),_.actor_editor.on("touchcancel",_.drag_end),_.remove_btn.on("mousedown",_.emit_remove_btn_event),_.remove_btn.on("touchstart",_.emit_remove_btn_event),_.remove_btn.on("mouseup",_.emit_remove_btn_event),_.remove_btn.on("touchend",_.emit_remove_btn_event),_.remove_btn.on("mouseupoutside",_.emit_remove_btn_event),_.remove_btn.on("touchendoutside",_.emit_remove_btn_event),_.events.event_emitter.addListener("break",_.on_break),_.app.get_app().stage.addListener("touchendoutside",_.drag_end),_}return Zt(e,t),e.prototype.destroy=function(){t.prototype.destroy.call(this),this.events.event_emitter.removeListener("break",this.on_break)},e.prototype.set_target_actor=function(e){var i=t.prototype.set_target_actor.call(this,e);return this.actor&&this.actor.id===e&&(this.actor_editor.visible=this.actor.visible),i},e.prototype.hide=function(){t.prototype.hide.call(this)},e.prototype.update_editor_position=function(t){this.actor_editor.pivot.set(t.pivot.x*t.scale.x,t.pivot.y*t.scale.y),this.actor_editor.position.set(t.position.x,t.position.y)},e.prototype.draw_centre=function(){this.rotation_centre.clear(),this.rotation_centre.lineStyle(4,16777215,1),this.rotation_centre.drawCircle(this.actor_editor.pivot.x,this.actor_editor.pivot.y,12),this.rotation_centre.beginFill(16777215,1),this.rotation_centre.drawCircle(this.actor_editor.pivot.x,this.actor_editor.pivot.y,4),this.rotation_centre.endFill()},e.prototype.draw_editor=function(t){if(this.update_editor_position(t),this.is_dragging_rotate_btn||t.rotation_type===nt.MO.ALL)this.actor_editor.rotation=-t.rotation_value;else switch(t.rotation_type){case nt.MO.LEFT_RIGHT:this.actor_editor.rotation=t.is_rotation_flipped?Math.PI:0;break;case nt.MO.NONE:this.actor_editor.rotation=0}var e=Math.max(t.width,30+this.remove_btn.width/2+this.rotate_btn.width/2),i=Math.max(t.height,30+this.rotate_btn.width/2+this.scale_btn.width/2);this.editor_box.clear(),this.editor_box.lineStyle(2,16777215,1),this.editor_box.drawRect(-e/2,-i/2,e,i),this.editor_box.endFill(),this.editor_box.hitArea=new s.Ae(-this.editor_box.width/2,-this.editor_box.height/2,this.editor_box.width,this.editor_box.height),this.scale_btn.position.set(e/2,i/2),this.rotate_btn.position.set(e/2,-i/2),this.remove_btn.position.set(-e/2,-i/2),this.hide_text.position.set(-e/2,i/2+4),this.draw_centre()},e.prototype.set_remove_btn_visible=function(t){this.remove_btn.visible=t},e.prototype.set_scale_btn_visible=function(t){this.scale_btn.visible=t},e.prototype.set_rotate_btn_visible=function(t){this.rotate_btn.visible=t},e.prototype.set_rotation_centre_visible=function(t){this.rotation_centre.visible=t},e.prototype.set_hide_text_visible=function(t){this.hide_text.visible=t},e.prototype.set_btn_drag_start_status=function(t,e){Qt||(this.app.get_app().stage.cursor="none",this.set_box_cursor("none"),this[t].visible=!0,this[t].position.set(e.x,e.y))},e.prototype.set_box_cursor=function(t){if("none"===t)this.editor_box.cursor="none";else{var e="url("+this.MOVE_CURSOR+") 8 8, auto";this.editor_box.cursor=e}},e.prototype.set_btn_drag_end_status=function(t,e){if(!Qt){var i=this.app.get_app().stage,r=this.app.get_interaction_manager();i.cursor="default",this.set_box_cursor("move");var n=e&&r.hitTest(e.data.global,this.actor_editor),o="cursor_scale"===t?Jt.dL.SCALE_BTN:Jt.dL.ROTATE_BTN,a=n&&n.name===o;this[t].visible=!!a}},e}(Yt),te=function(){function t(t,e,i,r){var n=this;this.visible=!1,this.show_filter=!1,this.on_stage_resize=function(t){if(t.target_id===n.app.get_app().stage.name){var e=n.app.get_app().view,i=e.width,r=e.height;n.coordinate.texture=i>r?n.bg_landscape_texture:n.bg_portrait_texture}},this.app=e,this.events=r,this.data=i,this.bg_portrait_texture=s.xE.from(t.grid_img),this.bg_landscape_texture=s.xE.from(t.grid_landscape_img),this.coordinate=new s.jy(this.bg_portrait_texture),this.background=new s.TC,this.background.beginFill(11648505,.9);var o=this.app.get_app().stage.hitArea;this.background.drawRect(-o.width/2,-o.height/2,o.width,o.height),this.coordinate.anchor.set(.5),this.background.interactive=!0,this.events.add_listener("stage:resize",this.on_stage_resize)}return t.prototype.set_target_actor=function(t,e){if(void 0===e&&(e=!1),!t){var i=this.app.get_app().stage.getChildIndex(this.app.get_scene_container());return this.app.get_app().stage.addChildAt(this.background,i+1),this.app.get_app().stage.addChildAt(this.coordinate,i+2),this.visible=!0,void(this.actor=void 0)}var r=this.data.get_internal_actor(t);if(!r)return new u("Cannot find actor "+t);if(this.actor&&this.actor.id!==t&&this.hide(),e?(r.filters=[new s.Ag(9807091)],r.visible=!0):r.filters=null,this.show_filter=e,!this.actor||this.actor.id!==t){this.actor=r;var n=this.actor.wrapper,o=this.actor.parent_scene.get_actor_container();n.addChildAt(this.background,0),n.addChildAt(this.coordinate,2),this.origin_index=this.actor.get_z_index(),this.actor.set_z_index(o.children.length-1),this.visible=!0}},t.prototype.hide=function(){this.actor&&void 0!==this.origin_index?(this.actor.wrapper.removeChild(this.background),this.actor.wrapper.removeChild(this.coordinate),this.actor.set_z_index(this.origin_index),this.show_filter&&(this.actor.filters=null,this.actor.visible=!1,this.show_filter=!1)):(this.app.get_app().stage.removeChild(this.background),this.app.get_app().stage.removeChild(this.coordinate)),this.actor=void 0,this.origin_index=void 0,this.visible=!1,this.app.render()},t.prototype.get_displayed=function(){return this.visible},t.prototype.destroy=function(){this.background.destroy({children:!0,texture:!0,baseTexture:!0}),this.events.remove_listener("stage:resize",this.on_stage_resize)},t}(),ee=function(){return ee=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},ee.apply(this,arguments)},ie=40,re=function(){function t(t,e,i,r){var n=this;void 0===r&&(r=""),this.PATH_EFFECT=[12,4],this.is_dragging=!1,this.show_filter=!1,this.on_mousemove=function(t){var e=t.data.getLocalPosition(n.app.get_app().stage);if(!n.in_stage_view(e))return n.draw_crosshair(),void n.app.render();n.crosshair.clear(),n.draw_vertical_line(e.x,e.y),n.draw_horizontal_line(e.x,e.y),n.app.render()},this.on_mouseup=function(t){var e=t.data.getLocalPosition(n.app.get_app().stage);if(n.clamp_pos(e),n.actor){n.actor.set_pivot_by_stage_point(e.x,-e.y);var i=t.data.getLocalPosition(n.app.get_app().stage),r=i.x,o=i.y;n.events.fire("pivot:out_center_range",{position:{x:r,y:o}})}},this.drag_start=function(t){if(n.actor){var e=n.get_drag_incline_range(),i=e.left,r=e.right,o=e.top,a=e.bottom,s=t.data.getLocalPosition(n.app.get_app().stage),_=s.x,c=s.y;_>=i&&_<=r&&c>=o&&c<=a&&(n.is_dragging=!0,n.events.fire("pivot:drag_start",{target_id:n.actor.id}))}},this.drag_move=function(t){if(n.is_dragging&&n.actor){var e=t.data.getLocalPosition(n.app.get_app().stage);if(n.in_offset_stage_view(e,ie/2))return;n.drag_incline.position.set(e.x,e.y),e.x=e.x-ie,e.y=e.y-ie,n.move(e),n.events.fire("pivot:drag_move",{target_id:n.actor.id,position:ee({},e)})}},this.drag_end=function(t){if(n.is_dragging&&n.actor){n.is_dragging=!1;var e=t.data.getLocalPosition(n.app.get_app().stage);n.in_offset_stage_view(e,ie/2)?(e.x=n.center.position.x,e.y=n.center.position.y):(n.clamp_pos(e),e.x=e.x-ie,e.y=e.y-ie),n.actor.set_pivot_by_stage_point(e.x,-e.y),n.events.fire("pivot:drag_end",{target_id:n.actor.id,position:ee({},e)})}},this.on_actor_change=function(t){if(t.pivot&&n.actor){n.drag_incline.position.set(n.actor.position.x+ie,n.actor.position.y+ie);var e=n.actor.position;n.center.position.set(e.x,e.y),n.draw_crosshair(),n.app.render()}},this.on_stage_resize=function(t){if(t.target_id===n.app.get_app().stage.name){var e=n.app.get_app().view,i=e.width,r=e.height;n.pivot.hitArea=new s.Ae(-i/2,-r/2,i,r)}},this.app=t,this.data=e,this.events=i,this.pivot=new s.W2,this.background=new s.TC,this.center=new s.TC,this.crosshair=new s.TC,this.pivot.addChild(this.crosshair),this.drag_incline=s.jy.from(r),s.tq.any?(this.drag_incline.visible=s.tq.any,this.drag_incline.anchor.set(.5,.5),this.drag_incline.scale.set(1,1),this.pivot.addChild(this.drag_incline),this.pivot.addListener("touchstart",this.drag_start),this.pivot.addListener("touchmove",this.drag_move),this.pivot.addListener("touchend",this.drag_end),this.pivot.addListener("touchendoutside",this.drag_end)):(this.pivot.addChild(this.center),this.pivot.addListener("click",this.on_mouseup)),this.pivot.interactive=!0;var o=this.app.get_app().view,a=o.width,_=o.height;this.pivot.hitArea=new s.Ae(-a/2,-_/2,a,_),this.events.add_listener("stage:resize",this.on_stage_resize),this.app.get_app().stage.addListener("touchendoutside",this.drag_end)}return t.prototype.draw_background=function(){var t=this.app.get_app().view,e=t.width,i=t.height;this.background.beginFill(11648505,.9),this.background.drawRect(-e/2,-i/2,e,i)},t.prototype.move=function(t){this.clamp_pos(t),this.center.position.set(t.x,t.y),this.draw_crosshair(),this.app.render()},t.prototype.clamp_pos=function(t){var e=this.app.get_app().view,i=e.width,r=e.height;t.set((0,ot.Z)(-i/2,i/2,t.x),(0,ot.Z)(-r/2,r/2,t.y))},t.prototype.get_drag_incline_range=function(){var t=this.drag_incline.getBounds(),e=t.width,i=t.height,r=this.drag_incline.position,n=r._x,o=r._y;return{left:n-e/2,right:n+e/2,top:o-i/2,bottom:o+i/2}},t.prototype.in_stage_view=function(t){var e=this.app.get_app().view,i=e.width,r=e.height;return t.x===(0,ot.Z)(-i/2,i/2,t.x)&&t.y===(0,ot.Z)(-r/2,r/2,t.y)},t.prototype.in_offset_stage_view=function(t,e){var i=this.app.get_app().view,r=i.width,n=i.height;return t.x- -r/2<e||r/2-t.x<e||t.y- -n/2<e||n/2-t.y<e},t.prototype.set_target_actor=function(t,e){void 0===e&&(e=!1);var i=this.data.get_internal_actor(t);if(!i)return new u("Cannot find actor "+t);if(this.actor&&this.actor.id!==t&&this.hide(),e?(i.filters=[new s.Ag(9807091)],i.visible=!0,this.app.render()):i.filters=null,this.show_filter=e,!this.actor||this.actor.id!==t){this.draw_background();var r=this.app.get_app().stage.children.length;this.app.get_app().stage.addChildAt(this.pivot,r);var n=i.wrapper,o=i.parent_scene.get_actor_container();n.addChildAt(this.background,0),this.actor=i,this.origin_index=this.actor.get_z_index(),this.actor.set_z_index(o.children.length-1),this.draw_center(),this.draw_crosshair(),this.drag_incline.position.set(this.actor.position.x+ie,this.actor.position.y+ie),this.app.get_app().stage.cursor="pointer",this.app.render(),this.actor.add_listener("change",this.on_actor_change),!s.tq.any&&this.app.get_app().stage.addListener("mousemove",this.on_mousemove),s.tq.any&&i.set_alpha(.4)}},t.prototype.hide=function(){var t;s.tq.any&&(null===(t=this.actor)||void 0===t||t.set_alpha(1)),!s.tq.any&&this.app.get_app().stage.removeListener("mousemove",this.on_mousemove),this.app.get_app().stage.cursor="default",this.actor&&void 0!==this.origin_index&&(this.app.get_app().stage.removeChild(this.pivot),this.actor.wrapper.removeChild(this.background),this.actor.set_z_index(this.origin_index),this.actor.remove_listener("change",this.on_actor_change),this.show_filter&&(this.actor.filters=null,this.actor.visible=!1,this.show_filter=!1),this.actor=void 0,this.origin_index=void 0,this.background.clear())},t.prototype.get_displayed=function(){return!!this.actor},t.prototype.destroy=function(){this.events.remove_listener("stage:resize",this.on_stage_resize),this.pivot.destroy({children:!0,texture:!0,baseTexture:!0}),this.actor=void 0},t.prototype.draw_center=function(){this.center.clear(),this.actor&&(this.center.position.set(this.actor.position.x,this.actor.position.y),this.center.lineStyle(4,16777215,1),this.center.drawCircle(0,0,12),this.center.beginFill(16777215,1),this.center.drawCircle(0,0,4),this.center.endFill())},t.prototype.draw_crosshair=function(){this.crosshair.clear();var t=this.center,e=t.position.x,i=t.position.y;this.draw_vertical_line(e,i),this.draw_horizontal_line(e,i)},t.prototype.draw_vertical_line=function(t,e){var i=this.app.get_app().view.height;this.crosshair.lineStyle(4,2696291,.4);var r=0;for(this.crosshair.moveTo(t,e-r);r<i;)r=Math.min(this.PATH_EFFECT[0]+r,i),this.crosshair.lineTo(t,e-r),r=Math.min(this.PATH_EFFECT[1]+r,i),this.crosshair.moveTo(t,e-r);for(r=0,this.crosshair.moveTo(t,e+r);r<i;)r=Math.min(this.PATH_EFFECT[0]+r,i),this.crosshair.lineTo(t,e+r),r=Math.min(this.PATH_EFFECT[1]+r,i),this.crosshair.moveTo(t,e+r)},t.prototype.draw_horizontal_line=function(t,e){var i=this.app.get_app().view.width;this.crosshair.lineStyle(4,2696291,.4);var r=0;for(this.crosshair.moveTo(t+r,e);r<i;)r=Math.min(this.PATH_EFFECT[0]+r,i),this.crosshair.lineTo(t+r,e),r=Math.min(this.PATH_EFFECT[1]+r,i),this.crosshair.moveTo(t+r,e);for(r=0,this.crosshair.moveTo(t-r,e);r<i;)r=Math.min(this.PATH_EFFECT[0]+r,i),this.crosshair.lineTo(t-r,e),r=Math.min(this.PATH_EFFECT[1]+r,i),this.crosshair.moveTo(t-r,e)},t}(),ne=(function(){function t(t,e){this.actor_dialogs=new Map,this.dialog_containers=new Map,this.actor_destroy_handlers=new Map,this.app=t,this.data=e}t.prototype.load_dialog=function(t,e){var i=t.parent_scene,r=this.get_dialog_container(i);this.actor_dialogs.set(t.get_id(),e),r.addChild(e.get_graphics())},t.prototype.destroy_actor_dialog=function(t){var e=this.actor_dialogs.get(t);if(!e)return new u("Actor dialog "+t+" has not been found");var i=this.data.get_internal_actor(t),r=this.actor_destroy_handlers.get(t);i&&r&&(i.remove_listener("destroy",r),this.actor_destroy_handlers.delete(t)),this.actor_dialogs.delete(t),e.destroy()},t.prototype.destroy_all_actor_dialogs=function(){var t=this;this.dialog_containers.forEach((function(e){t.destroy_dialog_container(e)}))},t.prototype.set_container_z_index=function(){console.warn("Method deprecated. It will not change anything.")},t.prototype.destroy=function(){this.destroy_all_actor_dialogs()},t.prototype.get_dialog_container=function(t){var e=this,i=t.get_id(),r=this.dialog_containers.get(i);return r||(r=new s.W2,t.addChild(r),this.dialog_containers.set(i,r),t.add_listener("destroy",(function(){var t=e.dialog_containers.get(i);t&&e.destroy_dialog_container(t)}))),r},t.prototype.destroy_dialog_container=function(t){var e=this,i=t.parent;(0,n.Jf)(i)&&(this.dialog_containers.delete(i.get_id()),t.removeChildren().forEach((function(t){t.name&&e.actor_dialogs.delete(t.name),t.destroy()})));t.destroy()}}(),function(){function t(t,e,i){var r=this;this.actor_dialog=new s.TC,this.text=new s.xv(""),this.content_width=0,this.content_height=0,this.on_change=function(t){r.update_on_change(t)},this.update_on_change=function(t){(t.position||t.scale||t.rotation)&&r.update_dialog_position(),void 0!==t.alpha&&r.update_dialog_alpha(),(t.position||t.scale||t.rotation||void 0!==t.visible)&&r.update_dialog_visible()},this.actor_dialog.name=t.id,this.text.name="text",this.actor=t,this.STAGE_WIDTH=e,this.STAGE_HEIGHT=i,this.actor_dialog.addChild(this.text),this.actor.add_listener("change",this.on_change)}return t.prototype.update_dialog_alpha=function(){this.actor_dialog.alpha=this.actor.get_alpha()},t.prototype.update_dialog_visible=function(){var t=this.actor.get_visible()&&0!==this.actor.get_scale().x;this.actor_dialog.visible=t},t.prototype.update_dialog_position=function(){var t=(0,n.kF)(this.actor,this.actor.position);this.actor_dialog.position.set(t.x,t.y-this.actor.height/2-this.actor_dialog.height),this.actor_dialog.scale.x=1,this.text.scale.x=1;var e=this.content_width===this.DIALOG_MIN_WIDTH?(this.content_width-this.text.width)/2:this.TEXT_PADDING;this.text.position.x=e,this.text.position.y=this.TEXT_PADDING,this.calibrate_edge_detection(this.actor_dialog.getBounds(),t)},t.prototype.calibrate_edge_detection=function(t,e){var i=this.STAGE_WIDTH/2,r=this.STAGE_HEIGHT/2,n=t.x+t.width>this.STAGE_WIDTH,o=t.x<0,a=t.y<0,s=t.y+t.height>this.STAGE_HEIGHT;n&&this.actor_dialog.scale.x>0&&(this.actor_dialog.scale.x=-1,this.text.scale.x=-1,this.text.position.x=this.content_width-this.text.position.x,e.x>i&&(this.actor_dialog.position.x=i)),o&&(this.actor_dialog.position.x=-i),a&&(this.actor_dialog.position.y=-r),s&&(this.actor_dialog.position.y=r-this.actor_dialog.height)},t.prototype.actor_is_in_stage=function(){var t=this.actor.getBounds();return t.x<this.STAGE_WIDTH&&t.x>-t.width&&t.y<this.STAGE_HEIGHT&&t.y>-t.height},t.prototype.destroy=function(){this.actor.remove_listener("change",this.on_change),this.actor_dialog.destroy({children:!0,texture:!0})},t.prototype.get_graphics=function(){return this.actor_dialog},t}()),oe=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),ae={fontSize:"26px",fontFamily:["PingFangSC-Medium","Microsoft YaHei"],fill:"#666666",wordWrap:!0,wordWrapWidth:208,breakWords:!0,lineHeight:36},se=function(){function t(t,e){this.dialog_cache=new Map,this.app=t,this.data=e}return t.prototype.load_actor_dialog=function(t,e,i){var r=this,n=this.data.get_internal_actor(t);if(!n)return new u("Actor "+t+" has not been found");var o=this.dialog_cache.get(t),a=this.app.get_renderer_type();if(!o){var s=this.app.get_app().renderer,_=s.width,c=s.height;(o=new _e(n,i,_,c,a)).get_graphics().setParent(n.wrapper),this.dialog_cache.set(t,o),n.add_listener("destroy",(function(){r.destroy_actor_dialog(t)}))}o.update(e,i)},t.prototype.destroy_actor_dialog=function(t){var e=this.dialog_cache.get(t);if(!e)return new u("Actor dialog "+t+" has not been found");this.dialog_cache.delete(t),e.destroy()},t.prototype.destroy_all_actor_dialogs=function(){this.dialog_cache.forEach((function(t){t.destroy()})),this.dialog_cache.clear()},t.prototype.destroy=function(){this.destroy_all_actor_dialogs()},t}(),_e=function(t){function e(e,i,r,n,o){var a=t.call(this,e,r,n)||this;return a.DIALOG_MIN_WIDTH=108,a.DIALOG_MAX_WIDTH=248,a.TEXT_PADDING=20,a.bubbles=new s.TC,a.border=new s.TC,a.type=i,a.actor=e,a.render_type=o,a.text.style=ae,a.bubbles.name="bubbles",o===s.N3.WEBGL&&a.actor_dialog.addChildAt(a.border,0),a.actor_dialog.addChild(a.bubbles),a.update_dialog_style(),a}return oe(e,t),e.prototype.update=function(t,e){var i=t===this.text.text,r=e===this.type;i&&r||(this.text.text=t,this.type=e,this.update_dialog_style()),this.update_dialog_alpha(),this.update_dialog_visible(),this.update_dialog_position()},e.prototype.update_dialog_style=function(){this.content_height=this.text.height+30;var t=this.text.width+2*this.TEXT_PADDING;this.content_width=(0,ot.Z)(this.DIALOG_MIN_WIDTH,this.DIALOG_MAX_WIDTH,t);var e=this.isWebglRenderType(),i={start_x:.1*this.DIALOG_MAX_WIDTH,center_x:.1*this.DIALOG_MAX_WIDTH-5},r={x:25,y:this.content_height+20},n={x:5,y:this.content_height+40},o=this.content_height>80?40:this.content_height/2;switch(this.actor_dialog.clear(),e?(this.actor_dialog.beginFill(15658734,1),this.border.clear(),this.border.beginFill(16777215,1)):(this.actor_dialog.lineStyle(2,15658734,1),this.actor_dialog.beginFill(16777215,1)),this.bubbles.clear(),this.type){case Jt.s8.SAYING:e?(this.border.drawRoundedRect(0,0,this.content_width,this.content_height,16),this.border.moveTo(i.start_x,this.content_height),this.border.lineTo(i.center_x,this.content_height+25),this.border.lineTo(i.start_x+50,this.content_height),this.border.endFill(),this.actor_dialog.drawRoundedRect(-2,-2,this.content_width+4,this.content_height+4,16),this.actor_dialog.moveTo(i.start_x-2,this.content_height-2),this.actor_dialog.lineTo(i.center_x-2,this.content_height+25+3),this.actor_dialog.lineTo(i.start_x+50+4,this.content_height)):(this.actor_dialog.drawRoundedRect(0,0,this.content_width,this.content_height,16),this.actor_dialog.moveTo(i.start_x,this.content_height),this.actor_dialog.lineTo(i.center_x,this.content_height+25),this.actor_dialog.lineTo(i.start_x+50,this.content_height)),this.actor_dialog.endFill(),this.actor_dialog.lineStyle(2,16777215,1),this.actor_dialog.moveTo(i.start_x,this.content_height),this.actor_dialog.lineTo(i.start_x+50,this.content_height),this.bubbles.visible=!1;break;case Jt.s8.THINKING:e?(this.bubbles.beginFill(15658734),this.bubbles.drawEllipse(r.x,r.y,15,12),this.bubbles.drawEllipse(n.x,n.y,10,8),this.bubbles.beginFill(16777215),this.bubbles.drawEllipse(r.x,r.y,13,10),this.bubbles.drawEllipse(n.x,n.y,8,6),this.bubbles.endFill(),this.bubbles.visible=!0,this.border.drawRoundedRect(0,0,this.content_width,this.content_height,o),this.border.endFill(),this.actor_dialog.drawRoundedRect(-2,-2,this.content_width+4,this.content_height+4,o)):(this.bubbles.lineStyle(2,15658734,1),this.bubbles.beginFill(16777215),this.bubbles.drawEllipse(r.x,r.y,13,10),this.bubbles.drawEllipse(n.x,n.y,8,6),this.bubbles.endFill(),this.bubbles.visible=!0,this.actor_dialog.drawRoundedRect(0,0,this.content_width,this.content_height,o)),this.actor_dialog.endFill()}},e.prototype.isWebglRenderType=function(){return this.render_type===s.N3.WEBGL},e}(ne),ce=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),ue=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},pe=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},de=function(t){function e(e,i,r,o){var a=t.call(this)||this;return a.is_draggable=!0,a.is_origin_in_center=!1,a.drag_start=function(t){a.is_draggable&&(a.drag_data={event_data:t.data,old_pos:t.data.getLocalPosition(a.parent)},a.emit_event("drag_start",void 0))},a.drag_move=function(){if(a.is_draggable&&a.drag_data){var t=a.drag_data.event_data.getLocalPosition(a.parent),e=a.app.get_app().view,i=e.width,r=e.height;t.set((0,ot.Z)(-i/2,i/2,t.x),(0,ot.Z)(-r/2,r/2,t.y));var n=new s.E9(a.position.x+t.x-a.drag_data.old_pos.x,a.position.y+t.y-a.drag_data.old_pos.y);a.drag_data.old_pos=t;var o=a.getBounds(),_={left:0,right:-o.width,top:0,bottom:-o.height};a.is_origin_in_center&&(_.left=o.width/2,_.right=-o.width/2,_.top=o.height/2,_.bottom=-o.height/2);var c=-i/2+_.left,u=i/2+_.right,p=-r/2+_.top,d=r/2+_.bottom;n.x=(0,ot.Z)(Math.min(c,u),Math.max(c,u),n.x),n.y=(0,ot.Z)(Math.min(p,d),Math.max(p,d),n.y),a.position.set(n.x,n.y),a.emit_event("change",{position:a.position}),a.emit_event("drag_move",void 0),a.app.render()}},a.drag_end=function(){a.drag_data&&(a.drag_data=void 0,a.app.render(),a.is_draggable&&a.emit_event("drag_end",void 0))},a.on_break=function(t){t&&t!==a.id||(a.drag_data=void 0)},a.app=r,a.events=o,a.id=e,a.interactive=!0,a.setParent(i),a.addListener("mousedown",a.drag_start),a.addListener("mousemove",(0,n.P2)(a.drag_move,n.VS)),a.addListener("mouseup",a.drag_end),a.addListener("mouseupoutside",a.drag_end),a.addListener("touchstart",a.drag_start),a.addListener("touchmove",(0,n.P2)(a.drag_move,n.VS)),a.addListener("touchend",a.drag_end),a.addListener("touchendoutside",a.drag_end),a.events.event_emitter.addListener("break",a.on_break),a.app.get_app().stage.addListener("touchendoutside",a.drag_end),a}return ce(e,t),e.prototype.emit_event=function(t,e){this.emit(t,e)},e.prototype.add_listener=function(t,e){this.on(t,e)},e.prototype.remove_listener=function(t,e){this.off(t,e)},e.prototype.load_texture=function(t){return ue(this,void 0,void 0,(function(){var e;return pe(this,(function(i){return t&&s.P6.TextureCache[t]?[2,s.P6.TextureCache[t]]:t&&s.P6.BaseTextureCache[t]?[2,new s.xE(s.P6.BaseTextureCache[t])]:(e=t?s.xE.from(t):s.xE.EMPTY).valid?[2,e]:[2,new Promise((function(t,i){e.baseTexture.on("loaded",(function(){t(e)})),e.baseTexture.on("update",(function(){t(e)})),e.baseTexture.on("error",(function(t){e.destroy(!0),i(t)}))}))]}))}))},e.prototype.set_origin_in_center=function(t){this.is_origin_in_center=t},e.prototype.set_draggable=function(t){this.is_draggable=t,this.emit_event("change",{draggable:this.is_draggable})},e.prototype.set_visible=function(t){this.visible=t,this.emit_event("change",{visible:this.visible})},e.prototype.get_draggable=function(){return this.is_draggable},e.prototype.get_visible=function(){return this.visible},e.prototype.get_size=function(){return{width:this.width,height:this.height}},e.prototype.is_dragging=function(){return!!this.drag_data},e.prototype.destroy=function(e){this.emit_event("destroy",void 0),t.prototype.destroy.call(this,e),this.events.event_emitter.removeListener("break",this.on_break)},e}(s.W2),le=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),he=function(t){var e="function"===typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"===typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},fe=function(t,e){var i="function"===typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a},ge={fontSize:"21px",lineHeight:18,fontFamily:"PingFangSC-Medium",fill:"#B14C00",fontWeight:"500"},ye={fontSize:"21px",lineHeight:21,fontFamily:"PingFangSC-Medium",fill:"#624026",fontWeight:"500"},me={fontSize:"24px",lineHeight:24,fontFamily:"PingFangSC-Medium",fill:"#45372E",fontWeight:"500"},ve={fontSize:"44px",lineHeight:44,fontFamily:"PingFangSC-Semibold",fill:"#43372E",fontWeight:"600"},be=function(t){function e(e,i,r){var n=t.call(this)||this;return n.cache=new Map,n.app=i,n.events=r,n.source=e,n.variable_list_container=new s.W2,n.timer_container=new s.W2,n.setParent(n.app.get_app().stage),n.addChildAt(n.variable_list_container,0),n.addChildAt(n.timer_container,1),n}return le(e,t),e.prototype.load_variable=function(t){var e=new we(t.id,"variable",t.variable_name,this.variable_list_container,this.app,this.events,this.cache,this.source.cloud_public_icon,this.source.cloud_private_icon,t.actor_name,t.cloud_type);return e.set_value(t.value),e},e.prototype.load_list=function(t){return new we(t.id,"list",t.list_name,this.variable_list_container,this.app,this.events,this.cache,this.source.cloud_public_icon,this.source.cloud_private_icon,t.actor_name)},e.prototype.get_variable=function(t){var e,i,r=this.cache.get(t);if(r)return r;var n=this.variable_list_container.children;try{for(var o=he(n),a=o.next();!a.done;a=o.next()){var s=a.value;if(this.is_variable(s)&&s.id===t)return this.cache.set(t,s),s}}catch(_){e={error:_}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},e.prototype.get_list=function(t){var e,i,r=this.cache.get(t);if(r)return r;var n=this.variable_list_container.children;try{for(var o=he(n),a=o.next();!a.done;a=o.next()){var s=a.value;if(this.is_list(s)&&s.id===t)return this.cache.set(t,s),s}}catch(_){e={error:_}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},e.prototype.get_timer=function(){return this.timer||(this.timer=new xe(this.timer_container,this.app,this.events,this.source.timer_bg)),this.timer},e.prototype.get_variable_ids=function(){var t=this,e=[];return this.variable_list_container.children.forEach((function(i){t.is_variable(i)&&e.push(i.id)})),e},e.prototype.get_list_ids=function(){var t=this,e=[];return this.variable_list_container.children.forEach((function(i){t.is_list(i)&&e.push(i.id)})),e},e.prototype.get_variable_list_ids=function(){var t=this,e=[];return this.variable_list_container.children.forEach((function(i){(t.is_variable(i)||t.is_list(i))&&e.push(i.id)})),e},e.prototype.destroy_all_variables_lists=function(){var t=this;this.variable_list_container.removeChildren().forEach((function(e){(t.is_variable(e)||t.is_list(e))&&e.destroy()}))},e.prototype.set_visible=function(t){this.visible=t},e.prototype.is_variable=function(t){return t&&"variable"===t.type},e.prototype.is_list=function(t){return t&&"list"===t.type},e.prototype.destroy=function(){t.prototype.destroy.call(this,{children:!0,texture:!0})},e}(s.W2),we=function(t){function e(e,i,r,n,o,a,_,c,u,p,d){var l=t.call(this,e,n,o,a)||this;if(l.pointer_down_time=0,l.CLOUD_ICON_SIZE=24,l.BG_HEIGHT=54,l.BG_RADIUS=27,l.VALUE_BG_HEIGHT=42,l.MIN_VALUE_BG_WIDTH=69,l.VALUE_BG_RADIUS=23,l.VALUE_TEXT_MARGIN=12,l.VARIABLE_NAME_TEXT_MARGIN=18,l.ACTOR_NAME_MARGIN_RIGHT=6,l.LIST_ICON_MARGIN_RIGHT=12,l.LIST_ICON_MARGIN_TOP=21,l.cloud_ICON_MARGIN_RIGHT=6,l.on_pointer_down=function(){l.pointer_down_time=(new Date).getTime()},l.on_pointer_up=function(){"list"===l.type&&(new Date).getTime()-l.pointer_down_time<300&&l.events.fire("list:click",{target_id:l.id})},l.cache=_,l.type=i,l.cloud_type=d,l.background=new s.jy,l.addChild(l.background),l.graphics=new s.TC,l.variable_name=new s.xv("",ye),l.cloud_type){var h=l.load_texture(u),f=l.load_texture(c);Promise.all([h,f]).then((function(t){var e=fe(t,2),i=e[0],r=e[1];l.cloud_icon=new s.jy,l.cloud_icon.texture="private"===l.cloud_type?i:r,l.cloud_icon.width=l.CLOUD_ICON_SIZE,l.cloud_icon.height=l.CLOUD_ICON_SIZE,l.background.addChildAt(l.cloud_icon,0),l.resize(),l.app.render()})).catch((function(t){console.warn(t)}))}switch(p&&(l.actor_name=new s.xv("",ge),l.background.addChild(l.actor_name),l.actor_name.text=p+" \xb7"),l.background.addChild(l.variable_name),l.variable_name.text=r,l.type){case"variable":l.value_sprite=new s.jy,l.value_sprite.anchor.set(.5),l.value=new s.xv("",me),l.value.anchor.set(.5),l.background.addChild(l.value_sprite),l.value_sprite.addChild(l.value);break;case"list":l.list_icon=new s.TC,l.list_icon.beginFill(6766368),l.list_icon.moveTo(0,0),l.list_icon.lineTo(10,0),l.list_icon.lineTo(5,7.5),l.list_icon.endFill(),l.background.addChild(l.list_icon)}return l.resize(),l.add_listener("drag_end",(function(){l.events.fire("variables_and_lists:drag_end",{target_id:l.id,data:{position:{x:l.get_position().x,y:l.get_position().y}}})})),l.addListener("mousedown",l.on_pointer_down),l.addListener("mouseup",l.on_pointer_up),l.addListener("mouseupoutside",l.on_pointer_up),l.addListener("touchstart",l.on_pointer_down),l.addListener("touchend",l.on_pointer_up),l.addListener("touchendoutside",l.on_pointer_up),l}return le(e,t),e.prototype.set_position_x=function(t){this.position.set(t,this.position.y)},e.prototype.set_position_y=function(t){this.position.set(this.position.x,-t)},e.prototype.set_actor_name=function(t){if(this.actor_name){var e=this.actor_name.width;this.actor_name.text=t+" \xb7",e!==this.actor_name.width&&this.resize()}},e.prototype.set_variable_name=function(t){var e=this.variable_name.width;this.variable_name.text=t,e!==this.variable_name.width&&this.resize()},e.prototype.set_value=function(t){if(this.value){var e=this.value.width;this.value.text=t,e!==this.value.width&&(this.value.width+2*this.VALUE_TEXT_MARGIN>this.MIN_VALUE_BG_WIDTH||e+2*this.VALUE_TEXT_MARGIN>this.MIN_VALUE_BG_WIDTH)&&this.resize()}},e.prototype.get_position=function(){return{x:this.position.x,y:-this.position.y}},e.prototype.get_actor_name=function(){if(this.actor_name)return this.actor_name.text.substring(0,this.actor_name.text.length-2)},e.prototype.get_variable_name=function(){return this.variable_name.text},e.prototype.get_value=function(){if(this.value)return this.value.text},e.prototype.destroy=function(){this.cache.delete(this.id),t.prototype.destroy.call(this,{children:!0,texture:!0})},e.prototype.resize=function(){this.draw_value_bg(),this.draw_bg(),this.cloud_icon&&this.cloud_icon.position.set(this.VARIABLE_NAME_TEXT_MARGIN,this.BG_HEIGHT/4);var t=this.cloud_icon&&this.cloud_icon.width+this.cloud_ICON_MARGIN_RIGHT||0;this.actor_name&&this.actor_name.position.set(this.VARIABLE_NAME_TEXT_MARGIN+t,this.BG_HEIGHT/4);var e=this.actor_name&&this.actor_name.width+this.ACTOR_NAME_MARGIN_RIGHT||0;this.variable_name.position.set(this.VARIABLE_NAME_TEXT_MARGIN+t+e,this.BG_HEIGHT/4),this.value_sprite&&this.value_sprite.position.set(this.variable_name.position.x+this.variable_name.width+this.value_sprite.width/2+this.VALUE_TEXT_MARGIN,this.BG_HEIGHT/2),this.list_icon&&this.list_icon.position.set(this.variable_name.position.x+this.variable_name.width+this.LIST_ICON_MARGIN_RIGHT,this.LIST_ICON_MARGIN_TOP)},e.prototype.draw_value_bg=function(){if("variable"===this.type&&this.value_sprite&&this.value){var t=Math.max(this.MIN_VALUE_BG_WIDTH,this.value.width+2*this.VALUE_TEXT_MARGIN);this.graphics.clear(),this.graphics.beginFill(16777215),this.graphics.drawRoundedRect(0,0,t,this.VALUE_BG_HEIGHT,this.VALUE_BG_RADIUS),this.graphics.endFill(),this.graphics.lineStyle(1.5,15894822),this.graphics.drawRoundedRect(0,0,t,this.VALUE_BG_HEIGHT,this.VALUE_BG_RADIUS),this.graphics.endFill(),this.value_sprite.texture.destroy(!0);var e=this.app.get_app().renderer.generateTexture(this.graphics,s.aH.NEAREST,1);this.value_sprite.texture=e}},e.prototype.draw_bg=function(){var t="variable"===this.type?15894822:16630576,e="variable"===this.type?16750644:16767551,i=this.variable_name.width+2*this.VARIABLE_NAME_TEXT_MARGIN+(this.cloud_icon&&this.cloud_icon.width+this.cloud_ICON_MARGIN_RIGHT||0)+(this.actor_name&&this.actor_name.width+this.ACTOR_NAME_MARGIN_RIGHT||0)+(this.value_sprite&&this.value_sprite.width||0)+(this.list_icon&&this.list_icon.width+this.LIST_ICON_MARGIN_RIGHT||0);this.graphics.clear(),this.graphics.beginFill(0,.2),this.graphics.drawRoundedRect(4,4,i,this.BG_HEIGHT,this.BG_RADIUS),this.graphics.endFill(),this.graphics.beginFill(t),this.graphics.drawRoundedRect(2,2,i,this.BG_HEIGHT,this.BG_RADIUS),this.graphics.endFill(),this.graphics.beginFill(e),this.graphics.drawRoundedRect(0,0,i,this.BG_HEIGHT,this.BG_RADIUS),this.graphics.endFill(),this.background.texture.destroy(!0);var r=this.app.get_app().renderer.generateTexture(this.graphics,s.aH.NEAREST,1);this.background.texture=r},e}(de),xe=function(t){function e(e,i,r,n){var o=t.call(this,"timer",e,i,r)||this;return o.background=new s.jy,o.addChild(o.background),o.background.width=164,o.background.height=108,o.load_texture(n).then((function(t){o.background.texture=t,o.app.render()})).catch((function(t){console.warn(t)})),o.time=new s.xv("00:00",ve),o.time.anchor.set(.5),o.time.position.set(o.background.width/2,o.background.height/2+7),o.visible=!1,o.addChild(o.time),o.add_listener("drag_end",(function(){o.events.fire("timer:drag_end",{position:{x:o.get_position().x,y:o.get_position().y}})})),o}return le(e,t),e.prototype.set_time=function(t){this.time.text=t},e.prototype.set_position_x=function(t){this.position.set(t,this.position.y)},e.prototype.set_position_y=function(t){this.position.set(this.position.x,-t)},e.prototype.get_position=function(){return{x:this.position.x,y:-this.position.y}},e}(de),ke=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),Oe=function(t){function e(e,i){var r=t.call(this)||this;return r.LINE_WIDTH=2,r.LINE_COLOR=16777215,r.LINE_ALPHA=.5,r.draw_border_box=function(t){r.update_transform(t),r.clear(),r.lineStyle(r.LINE_WIDTH,r.LINE_COLOR,r.LINE_ALPHA),r.drawRect(-t.width/2,-t.height/2,t.width,t.height),r.endFill()},r.on_target_change=function(t){r.target&&(0,n.YH)(r.target)&&(void 0!==t.visible&&(r.visible=t.visible),t.scale||t.texture?r.draw_border_box(r.target):(t.position||t.pivot||t.rotation)&&r.update_transform(r.target))},r.on_target_destroy=function(){r.hide()},r.set_parent=function(t){r.setParent(t)},r.app=e,r.data=i,r.visible=!1,r.setParent(r.app.get_app().stage),r}return ke(e,t),e.prototype.set_target_actor=function(t){var e=this.data.get_internal_actor(t);if(!e)return new u("Cannot find actor "+t);this.target!==e&&(this.target=e,this.visible=this.target.get_visible(),this.draw_border_box(this.target),this.target.add_listener("change",this.on_target_change),this.target.add_listener("destroy",this.on_target_destroy),this.app.render())},e.prototype.get_target_actor=function(){var t;return null===(t=this.target)||void 0===t?void 0:t.id},e.prototype.destroy=function(){(0,n.YH)(this.target)&&this.target.remove_listener("destroy",this.on_target_destroy),t.prototype.destroy.call(this,!0)},e.prototype.update_transform=function(t){this.position.set(t.position.x,t.position.y),this.pivot.set(t.pivot.x*t.scale.x,t.pivot.y*t.scale.y),this.rotation=t.rotation},e.prototype.hide=function(){this.target&&(this.target.removeListener("change",this.on_target_change),this.target.removeListener("destroy",this.on_target_destroy),this.target=void 0,this.visible=!1,this.app.render())},e}(s.TC),Ee=i(24039),Ie=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),Te=function(t,e,i,r){return new(i||(i=Promise))((function(n,o){function a(t){try{_(r.next(t))}catch(e){o(e)}}function s(t){try{_(r.throw(t))}catch(e){o(e)}}function _(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}_((r=r.apply(t,e||[])).next())}))},Ne=function(t,e){var i,r,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"===typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(s){o=[6,s],r=0}finally{i=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}},Se="undefined"!==typeof navigator,Ae=Se&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,Ce=Se&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),Me=Se&&/MicroMessenger/i.test(navigator.userAgent),Pe=!(!Ae&&!Ce);var Re=function(t){function e(e,i,r){var n=t.call(this)||this;return n.app=e,n.data=i,n.events=r,n.video=document.createElement("video"),n.canvas=document.createElement("canvas"),n.camera_status=Jt.mG.TURN_OFF,n.workspace=[],n.scene_id="",n.ticker=new Ee.vB,n.container=new s.W2,n.update_fps=50,n.resource_canvas=document.createElement("canvas"),n.last_update_frame=0,n.resource_type="video",n.on_parent_scene_change=function(t){var e,i,r,o;if(t!==n.scene_id){if(n.scene_id){var a=null===(e=n.data)||void 0===e?void 0:e.get_internal_scene(n.scene_id);null===(i=null===a||void 0===a?void 0:a.get_background())||void 0===i||i.removeChild(n.container),n.render_camera()}var s=null===(r=n.data)||void 0===r?void 0:r.get_internal_scene(t);if(s)n.scene_id=t,null===(o=null===s||void 0===s?void 0:s.get_background())||void 0===o||o.addChild(n.container)}},n.adjust_stage_scale=function(){var t=n.app.get_app().view,e=t.width,i=t.height,r=n.video,o=r.videoWidth,a=r.videoHeight;if(0!==o&&0!==a){var s=Math.max(i/a,e/o);n.scale.set(-s,s),n.resource_canvas.width=o,n.resource_canvas.height=a}},n.set_parent=function(t){n.setParent(t)},n.render_camera=function(){n.app.render()},n.start_render_camera=function(){n.check_and_add_camera_layer(),n.ticker.start()},n.stop_render_camera=function(){n.ticker.stop(),n.render_camera()},n.update_canvas=function(){var t=n.resource_canvas.getContext("2d");if(n.camera_status===Jt.mG.IS_TURNED_ON&&t){var e=n.video,i=e.videoWidth,r=e.videoHeight,o=Date.now();n.last_update_frame+n.update_fps<o&&(t.resetTransform(),t.drawImage(n.video,0,0,i,r),n.last_update_frame=o,n.texture.update()),requestAnimationFrame(n.update_canvas)}},n.anchor.set(.5),n.texture=s.xE.from(n.video),n.visible=!1,n.events.add_listener("scene:current_scene_changed",n.on_parent_scene_change),n.ticker.add(n.render_camera),n.container.name="camera_layer",n.setParent(n.container),n}return Ie(e,t),Object.defineProperty(e.prototype,"status",{get:function(){return this.camera_status},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stream_status",{get:function(){var t;return null===(t=this.stream)||void 0===t?void 0:t.active},enumerable:!1,configurable:!0}),e.prototype.turn_on=function(t){var e=this;return this.camera_status===Jt.mG.IS_TURNED_ON?(this.start_render_camera(),Promise.resolve()):this.camera_status===Jt.mG.TURNING_ON&&this.turning_on_lock?this.turning_on_lock:(this.camera_status=Jt.mG.TURNING_ON,this.turning_on_lock=new Promise((function(i,r){Pe?function(t){return Ae?navigator.mediaDevices.getUserMedia(t):new Promise((function(e,i){if(!Ce)return i("getUserMedia is not implemented in this browser");Ce.call(navigator,t,e,i)}))}(t).then((function(r){if(e.camera_status!==Jt.mG.TURN_OFF){if(e.constraints=t,e.stream=r,e.video.autoplay=!0,e.video.playsInline=!0,e.video.muted=!0,"srcObject"in e.video)try{e.video.srcObject=r}catch(n){e.video.src=window.URL.createObjectURL(r)}else e.video.src=window.URL.createObjectURL(r);Me&&e.video.play();e.video.addEventListener("loadeddata",(function t(){e.video.removeEventListener("loadeddata",t),e.camera_status!==Jt.mG.TURN_OFF?(e.adjust_stage_scale(),e.camera_status=Jt.mG.IS_TURNED_ON,e.turning_on_lock=void 0,"canvas"===e.resource_type&&(e.video.onplay=function(){e.update_canvas()}),e.visible=!0,e.video.play(),e.start_render_camera(),e.video.addEventListener("resize",e.adjust_stage_scale),i()):i()}))}else i()})).catch(r):r("getUserMedia is not implemented in this browser")})))},e.prototype.turn_off=function(){var t;this.camera_status!==Jt.mG.TURN_OFF&&(this.camera_status=Jt.mG.TURN_OFF,null===(t=this.stream)||void 0===t||t.getVideoTracks().forEach((function(t){return t.stop()})),this.stream=void 0,this.turning_on_lock=void 0,this.visible=!1,this.stop_render_camera(),this.video.removeEventListener("resize",this.adjust_stage_scale))},e.prototype.pause=function(){this.camera_status!==Jt.mG.PAUSED&&(this.camera_status=Jt.mG.PAUSED,!this.video.paused&&this.video.pause(),this.stop_render_camera())},e.prototype.restart=function(){var t;return Te(this,void 0,void 0,(function(){return Ne(this,(function(e){switch(e.label){case 0:return this.camera_status===Jt.mG.IS_TURNED_ON?[2]:(null===(t=this.stream)||void 0===t?void 0:t.active)?(this.camera_status=Jt.mG.IS_TURNED_ON,this.video.play(),this.start_render_camera(),[3,3]):[3,1];case 1:return[4,this.turn_on(this.constraints)];case 2:e.sent(),e.label=3;case 3:return[2]}}))}))},e.prototype.get_frame=function(t){var e=t||{},i=e.dimensions,r=e.cacheTimeout,n=void 0===r?this.update_fps:r,o=e.format,a=void 0===o?Jt.jX.FORMAT_IMAGE_DATA:o,s=this.canvas.getContext("2d");if(this.camera_status===Jt.mG.IS_TURNED_ON&&s){var _=this.video,c=_.videoWidth,u=_.videoHeight,p=this.app.get_app().view,d=p.width,l=p.height,h=(null===i||void 0===i?void 0:i[0])?Math.round(i[0]):d,f=(null===i||void 0===i?void 0:i[1])?Math.round(i[1]):l,g=this.get_workspace({dimensions:[h,f]}),y=g.lastUpdate,m=g.cacheData,v=Date.now();if(y+n<v){this.canvas.width=h,this.canvas.height=f,s.resetTransform(),s.scale(-1,1),s.translate(-1*h,0);var b=void 0,w=void 0;f/u>h/c?(b=Math.round(h/f*u),w=u):(b=c,w=Math.round(f/h*c));var x=(c-b)/2,k=(u-w)/2;s.drawImage(this.video,x,k,b,w,0,0,h,f),g.lastUpdate=v}m[a]||(m[a]={lastUpdate:0,lastData:null});var O=m[a];return O.lastUpdate+n<v&&(a===Jt.jX.FORMAT_IMAGE_DATA?O.lastData=s.getImageData(0,0,h,f):a===Jt.jX.FORMAT_CANVAS?(O.lastUpdate=1/0,O.lastData=this.canvas):(console.error("video io error - unimplemented format "+a),O.lastUpdate=1/0,O.lastData=null),O.lastUpdate=Math.max(g.lastUpdate,O.lastUpdate)),O.lastData}},e.prototype.get_workspace=function(t){var e=t.dimensions,i=this.workspace.find((function(t){return t.dimensions.join("-")===e.join("-")}));return i||(i={dimensions:e,lastUpdate:0,cacheData:{}},this.workspace.push(i)),i},e.prototype.set_alpha=function(t){this.alpha=t},e.prototype.destroy=function(){t.prototype.destroy.call(this,{children:!0,texture:!0,baseTexture:!0}),this.events.remove_listener("scene:current_scene_changed",this.on_parent_scene_change),this.ticker.remove(this.render_camera)},e.prototype.check_and_add_camera_layer=function(){var t;if(this.scene_id){var e=null===(t=this.data)||void 0===t?void 0:t.get_internal_scene(this.scene_id);if(e){var i=null===e||void 0===e?void 0:e.get_background();((null===i||void 0===i?void 0:i.children)||[]).some((function(t){return"camera_layer"===(null===t||void 0===t?void 0:t.name)}))||null===i||void 0===i||i.addChild(this.container)}}},e.prototype.set_resource=function(t){if(this.resource_type!==t){this.texture.destroy();var e="video"===t?this.video:this.resource_canvas;this.texture=s.xE.from(e),this.resource_type=t}},e}(s.jy),Be=function(){function t(t,e,i){this.app=t,this.data=e,this.events=i,this.loader=new Xt}return t.prototype.init=function(t){!this.actor_editor&&t.editor&&(this.actor_editor=new $t(t.editor,this.app,this.data,this.events,this.loader)),!this.grid&&t.grid&&(this.grid=new te(t.grid,this.app,this.data,this.events)),!this.pivot&&t.pivot&&(this.pivot=new re(this.app,this.data,this.events,t.pivot.pivot_img)),!this.actor_dialog_manager&&t.actor_dialog_manager&&(this.actor_dialog_manager=new se(this.app,this.data)),!this.draggable_container&&t.draggable_container&&(this.draggable_container=new be(t.draggable_container,this.app,this.events)),!this.border_box&&t.border_box&&(this.border_box=new Oe(this.app,this.data)),!this.camera&&t.camera&&(this.camera=new Re(this.app,this.data,this.events))},t.prototype.destroy=function(t){this.actor_editor&&t.editor&&(this.actor_editor.destroy(),this.actor_editor=void 0),this.grid&&t.grid&&(this.grid.destroy(),this.grid=void 0),this.pivot&&t.pivot&&(this.pivot.destroy(),this.pivot=void 0),this.actor_dialog_manager&&t.actor_dialog_manager&&(this.actor_dialog_manager.destroy(),this.actor_dialog_manager=void 0),this.draggable_container&&t.draggable_container&&(this.draggable_container.destroy(),this.draggable_container=void 0),this.border_box&&t.border_box&&(this.border_box.destroy(),this.border_box=void 0),this.camera&&t.camera&&(this.camera.destroy(),this.camera=void 0)},t.prototype.get_actor_editor=function(){return this.actor_editor},t.prototype.get_grid=function(){return this.grid},t.prototype.get_pivot=function(){return this.pivot},t.prototype.get_actor_dialog_manager=function(){return this.actor_dialog_manager},t.prototype.get_draggable_container=function(){return this.draggable_container},t.prototype.get_border_box=function(){return this.border_box},t.prototype.get_camera=function(){return this.camera},t}(),je={Components:Symbol("Components"),NekoStage:Symbol("NekoStage")},De=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}(),Le=function(t,e,i,r){var n,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(n=t[s])&&(a=(o<3?n(a):o>3?n(e,i,a):n(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a},Ge=function(t,e){if("object"===typeof Reflect&&"function"===typeof Reflect.metadata)return Reflect.metadata(t,e)},Fe=function(t,e){return function(i,r){e(i,r,t)}},Ue=function(t){function e(e,i,r,n,o,a,s,_,c){var u=t.call(this,e,r,n,o,a,s,_,i)||this;return u.events=i,u.components=c(u.app,u.data),u}return De(e,t),e.prototype.get_size=function(){var t=this.app.get_app().renderer;return{width:t.width,height:t.height}},e=Le([(0,o.b2)(),Fe(0,(0,o.f3)(_.App)),Fe(1,(0,o.f3)(_.Events)),Fe(2,(0,o.f3)(_.Data)),Fe(3,(0,o.f3)(_.Textures)),Fe(4,(0,o.f3)(_.Scenes)),Fe(5,(0,o.f3)(_.Actors)),Fe(6,(0,o.f3)(_.StageAnimation)),Fe(7,(0,o.f3)(_.Physics)),Fe(8,(0,o.f3)(je.Components)),Ge("design:paramtypes",[Object,Object,Function,Function,Function,Function,Function,Function,Function])],e)}(Tt),Ve=Kt;Ve.bind(je.Components).toFactory((function(t){var e=t.container.get(_.Events);return function(t,i){return new Be(t,i,e)}})),Ve.bind(je.NekoStage).to(Ue);var ze=i(83172).i8;function He(){return t=je.NekoStage,Ve.get(t);var t}console.log("%cWelcome to \u2764 Codemao Stage - v"+ze+" \u2764 for Neko o(*\uffe3\u25bd\uffe3*)\u30d6","\n  color: #6049bd;\n  text-shadow: 0 1px 0 #404182;")},83172:function(t){t.exports={i8:"0.6.5"}}}]);
//# sourceMappingURL=crc_stage_heart.597c18ca.js.map